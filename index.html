<!-- /index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ â€¢ Grup Ders Planlama (tablÄ±)</title>
<style>
/* =========================================
   1. GLOBAL DEÄÄ°ÅKENLER & TEMEL AYARLAR
   ========================================= */
:root {
  /* Renk Paleti */
  --bg: #f3f6f9;
  --panel: #ffffff;
  --text-main: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  
  /* Marka Renkleri */
  --primary: #4f46e5;       /* Ana Mor/Mavi */
  --primary-light: #e0e7ff;
  --secondary: #0ea5e9;     /* Ä°kincil Mavi */
  --danger: #ef4444;
  --success: #10b981;
  --warn: #f59e0b;
  
  /* Boyutlar */
  --radius: 12px;
  --header-h: 60px;
  --max-w: 1800px; /* 12 ders iÃ§in geniÅŸlik artÄ±rÄ±ldÄ± */
  
  /* Ders Renkleri (Otomatik Atama & GÃ¶rsel) */
  --c-mat: #dbeafe; --b-mat: #2563eb;
  --c-fen: #dcfce7; --b-fen: #16a34a;
  --c-trk: #ffedd5; --b-trk: #ea580c;
  --c-sos: #cffafe; --b-sos: #0891b2;
  --c-ing: #fef9c3; --b-ing: #ca8a04;
  --c-din: #f3e8ff; --b-din: #9333ea;
  --c-def: #f1f5f9; --b-def: #475569;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text-main);
  font-family: 'Inter', system-ui, -apple-system, sans-serif; /* Daha modern font */
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

h1, h2, h3 { margin: 0; font-weight: 700; color: #0f172a; }
h1 { font-size: 24px; }
h2 { font-size: 18px; margin-bottom: 10px; }
h3 { font-size: 15px; margin-bottom: 8px; }

.app {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* =========================================
   2. BÄ°LEÅENLER (Buton, Input, Kart)
   ========================================= */

/* Kartlar */
.card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
  transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }

/* Header AlanÄ± */
.top {
  display: flex; justify-content: space-between; align-items: center;
  background: var(--panel); padding: 12px 20px; border-radius: var(--radius);
  border: 1px solid var(--border);
}
.brand { display: flex; align-items: center; gap: 12px; }
.brand .logo {
  width: 40px; height: 40px; border-radius: 8px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
}

/* Sekmeler (Tabs) */
.tabs {
  display: flex; gap: 8px; border-bottom: 2px solid var(--border);
  padding-bottom: 0; margin-bottom: 16px; overflow-x: auto;
}
.tab {
  background: transparent; border: none; padding: 10px 20px;
  font-weight: 600; color: var(--text-muted); cursor: pointer;
  border-radius: 8px 8px 0 0; transition: all 0.2s;
  white-space: nowrap;
}
.tab:hover { background: #f1f5f9; color: var(--text-main); }
.tab[aria-selected="true"] {
  background: var(--panel); color: var(--primary);
  box-shadow: 0 -2px 0 0 var(--primary) inset; /* Alt Ã§izgi efekti */
}

/* Butonlar */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; font-size: 13px;
  cursor: pointer; transition: all 0.2s; gap: 6px;
  background: var(--primary); color: #fff;
  box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
}
.btn:hover { background: #4338ca; transform: translateY(-1px); }
.btn:active { transform: translateY(0); }

.btn.sec { background: var(--secondary); box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2); }
.btn.ghost { background: #f1f5f9; color: #334155; box-shadow: none; border: 1px solid var(--border); }
.btn.ghost:hover { background: #e2e8f0; }
.btn.warn { background: var(--warn); color: #fff; }
.btn.danger { background: var(--danger); color: #fff; }
.btn.xs { padding: 4px 8px; font-size: 11px; border-radius: 6px; }

/* Form ElemanlarÄ± */
input, select, textarea {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
  font-size: 13px; outline: none; transition: border-color 0.2s;
  min-width: 120px;
}
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

.row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
.flex { display: flex; gap: 10px; align-items: center; }
.right { margin-left: auto; }
.chips { display: flex; gap: 8px; flex-wrap: wrap; margin: 5px 0; }
.pill {
  padding: 4px 10px; border-radius: 99px; background: var(--primary-light);
  color: var(--primary); font-size: 12px; font-weight: 600;
}
.pill.bad { background: #fee2e2; color: #b91c1c; }
.tag {
  background: #f1f5f9; color: #475569; padding: 2px 6px;
  border-radius: 4px; font-size: 11px; font-weight: 700; border: 1px solid var(--border);
}

/* =========================================
   3. IZGARA SÄ°STEMÄ° (GRID & SLOTS) - YENÄ°DEN TASARLANDI
   ========================================= */

/* Temel Grid YapÄ±sÄ± (.kgrid):
   - 1. SÃ¼tun: BaÅŸlÄ±k (GÃ¼n/Saat) -> Sabit veya min-width
   - DiÄŸer SÃ¼tunlar: Ders SlotlarÄ± (dinamik)
   - 12 Dersi sÄ±ÄŸdÄ±rmak iÃ§in 'minmax' deÄŸerlerini daralttÄ±k.
*/
.kgrid {
  display: grid;
  /* Ä°lk sÃ¼tun 110px, geri kalanlar eÅŸit daÄŸÄ±lÄ±r ama en az 55px olur */
  grid-template-columns: 110px repeat(var(--cols), minmax(55px, 1fr));
  gap: 6px;
  margin-bottom: 6px;
  width: 100%;
  overflow-x: auto; /* KÃ¼Ã§Ã¼k ekranlarda yatay kaydÄ±rma */
  padding-bottom: 4px; /* Scroll bar payÄ± */
}

/* Grid Ä°Ã§indeki HÃ¼creler (.kcell) */
.kcell {
  position: relative;
  min-height: 54px; /* YÃ¼kseklik biraz kÄ±sÄ±ldÄ± */
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 2px 4px;
  cursor: pointer;
  user-select: none;
  font-size: 11px;
  line-height: 1.2;
  transition: all 0.15s ease;
}

/* HÃ¼cre EtkileÅŸimleri */
.kcell:hover { border-color: var(--primary); z-index: 1; }
.kcell.busy { background: #f8fafc; color: var(--text-muted); cursor: default; }

/* Durum Renkleri (MÃ¼saitlik) */
.kcell.ok { background: #f0fdf4; border-color: #86efac; color: #166534; font-weight: 700; }
.kcell.bad { background: #fef2f2; border-color: #fca5a5; color: #991b1b; }

/* AtanmÄ±ÅŸ Ders GÃ¶rÃ¼nÃ¼mÃ¼ (Dersin Rengine GÃ¶re) */
.kcell.assigned {
  border-width: 0 0 0 3px; /* Sadece sol kenarlÄ±k renkli */
  border-style: solid;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  padding-left: 6px; /* KenarlÄ±k iÃ§in pay */
}
/* Ä°Ã§erik metinleri */
.kcell.assigned b { display: block; font-size: 11px; margin-bottom: 2px; text-transform: uppercase; }
.kcell.assigned .mini2 { font-size: 10px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

/* Ders Renk SÄ±nÄ±flarÄ± (kcell ile birleÅŸir) */
.kcell.assigned.mat { background: var(--c-mat); border-left-color: var(--b-mat); color: #1e3a8a; }
.kcell.assigned.fen { background: var(--c-fen); border-left-color: var(--b-fen); color: #14532d; }
.kcell.assigned.trk { background: var(--c-trk); border-left-color: var(--b-trk); color: #7c2d12; }
.kcell.assigned.sos { background: var(--c-sos); border-left-color: var(--b-sos); color: #155e75; }
.kcell.assigned.ing { background: var(--c-ing); border-left-color: var(--b-ing); color: #713f12; }
.kcell.assigned.din { background: var(--c-din); border-left-color: var(--b-din); color: #581c87; }

/* Ä°lk SÃ¼tun (BaÅŸlÄ±klar: Pazartesi vb.) */
.kgrid > div:first-child, 
.kgrid .kcell.busy:first-child {
  background: #f1f5f9;
  font-weight: 800;
  color: #334155;
  border-color: #cbd5e1;
  display: flex; align-items: center; justify-content: center;
}

/* =========================================
   4. STEP Ã–ZEL DÃœZENLEMELERÄ°
   ========================================= */

/* Step 2: Ders ProgramÄ± Ä°skele */
/* SlotlarÄ±n Ã§okluÄŸunda baÅŸlÄ±klarÄ±n sÄ±kÄ±ÅŸmamasÄ± iÃ§in */
#step2 #progGridWrap .kgrid {
  /* GÃ¼n isimleri biraz daha geniÅŸ olabilir */
  grid-template-columns: 130px repeat(var(--cols), minmax(60px, 1fr));
}
#slotLabelsWrap .kcell {
  /* Saat etiketlerini girerken biraz daha rahat olsun */
  min-height: 40px;
}

/* Step 3: MÃ¼saitlikler - Yan Yana Kartlar */
/* .avGrid: KartlarÄ± tutan kapsayÄ±cÄ± */
.avGrid {
  display: grid;
  /* Ekran geniÅŸse yan yana 2 kart sÄ±ÄŸdÄ±r, Ã§ok daralÄ±rsa alta at */
  grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
  gap: 20px;
  align-items: start;
}
.avGrid .card {
  /* Kart iÃ§i grid 12 slotu sÄ±ÄŸdÄ±rmak iÃ§in min-width kullanÄ±r */
  overflow: hidden; 
}
.avGrid .kgrid {
  /* Kart iÃ§inde scroll bar Ã§Ä±karsa Ã§irkin durmasÄ±n */
  padding-bottom: 8px;
}

/* Step 5: Atama Paneli */
/* Kartlar zaten .cards sÄ±nÄ±fÄ± ile Ä±zgara yapÄ±sÄ±nda */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(650px, 1fr)); /* GeniÅŸ ekran kartlarÄ± */
  gap: 16px;
}
.cards .card .flex {
  /* Kart baÅŸlÄ±ÄŸÄ± */
  padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px;
}

/* =========================================
   5. DÄ°ÄER (Dialog, Tablo, Print)
   ========================================= */

/* Dialog (Manuel Atama) */
dialog {
  border: none; border-radius: 16px; padding: 0;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  max-width: 500px; width: 90%;
  backdrop-filter: blur(5px);
}
dialog::backdrop { background: rgba(0, 0, 0, 0.4); }
dialog header {
  padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid var(--border);
  font-weight: 700; font-size: 16px;
}
dialog section { padding: 20px; }
dialog footer {
  padding: 12px 20px; background: #f8fafc; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 10px;
}
.inline-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.inline-grid label { font-size: 12px; font-weight: 600; color: var(--text-muted); }
.inline-grid input, .inline-grid select { width: 100%; margin-top: 4px; }

/* Tablolar (Veri KaynaÄŸÄ± vb.) */
table { width: 100%; border-collapse: collapse; }
th, td { padding: 10px 14px; border-bottom: 1px solid var(--border); text-align: left; }
th { background: #f8fafc; color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
tr:hover td { background: #f1f5f9; }

/* YazdÄ±rma AyarlarÄ± (A4 Optimizasyonu) */
@media print {
  body { background: #fff; font-size: 11px; }
  .no-print, .top, .tabs, .btn { display: none !important; }
  .app { max-width: 100%; padding: 0; margin: 0; }
  .card { box-shadow: none; border: none; padding: 0; }
  
  /* YazdÄ±rma Tablosu */
  .print-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 10px; }
  .print-table th, .print-table td {
    border: 1px solid #000; padding: 4px; font-size: 10px; vertical-align: middle;
  }
  .print-table th { background: #eee !important; -webkit-print-color-adjust: exact; }
  
  /* Ders Renklerinin YazÄ±cÄ±da Ã‡Ä±kmasÄ± Ä°Ã§in */
  .print-table td.mat { background: var(--c-mat) !important; }
  .print-table td.fen { background: var(--c-fen) !important; }
  .print-table td.trk { background: var(--c-trk) !important; }
  .print-table td.sos { background: var(--c-sos) !important; }
  .print-table td.ing { background: var(--c-ing) !important; }
  .print-table td.din { background: var(--c-din) !important; }
  .print-table td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  
  .print-page { break-after: page; page-break-after: always; margin-bottom: 20px; }
  .avoid-break { break-inside: avoid; }
}
</style>
  
</head>
<body>
<div class="app">
  <div class="top no-print">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Fenomen Ã‡ocuk KulÃ¼bÃ¼</h1>
        <small>Grup dersleri planlama â€¢ TablÄ±</small>
      </div>
    </div>
    <div class="flex">
      <!-- Yerel kaydet/yÃ¼kle dÃ¼ÄŸmeleri kaldÄ±rÄ±ldÄ±; Firebase iÅŸlemleri sekme bazlÄ± eklendi -->
    </div>
  </div>

  <!-- ÃœST SEKMELER -->
  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri KaynaÄŸÄ±</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders ProgramÄ±</button>
    <button class="tab" data-panel="step3" role="tab">3. MÃ¼saitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Grup Talepleri</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">YazdÄ±r</button>
  </div>

  <!-- STEP 1 -->
  <section class="content grid tabpanel" id="step1" role="tabpanel">
    <div class="section-title">
      <h2>1) Google Sheet BaÄŸlantÄ±sÄ± (YALNIZCA OKUMA)</h2>
      <div class="chips">
        <span class="pill">Ogretmenler: OGRETMEN_ADI, BRANS</span>
        <span class="pill">Ogrenciler: NO, ADSOYAD, SINIF, Grubu</span>
        <span class="pill">BranÅŸlar: FEN BÄ°LÄ°MLERÄ°, MATEMATÄ°K, TÃœRKÃ‡E, SOSYAL BÄ°LGÄ°LER, Ä°NGÄ°LÄ°ZCE, DÄ°N KÃœLTÃœRÃœ</span>
      </div>
    </div>
    <div class="row">
      <label class="wide">Spreadsheet ID
        <input class="wide" type="text" id="sheetId" value="1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg" />
      </label>
      <button class="btn" id="btnFetch">Verileri Oku</button>
      <button class="btn ghost" id="btnClear">Temizle</button>
    </div>
    <div id="readStatus" class="notice">Durum: HazÄ±r.</div>
    <div class="grid">
      <div class="card">
        <h3>Ã–ÄŸretmenler (filtreli)</h3>
        <table id="tblTeachers"><thead><tr><th>#</th><th>Ã–ÄŸretmen</th><th>BranÅŸ</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Ã–ÄŸrenciler (Grubu dolu olanlar)</h3>
        <table id="tblStudents"><thead><tr><th>NO</th><th>Ad Soyad</th><th>SÄ±nÄ±f</th><th>Grup</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Gruplar</h3>
        <div id="groupSummary" class="chips"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn sec right" id="goto2">Devam â†’ Ders ProgramÄ±</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="content grid tabpanel" id="step2" role="tabpanel" hidden>
    <div class="section-title">
      <h2>2) Ders ProgramÄ± Ä°skele</h2>
      <div class="chips"><span class="pill">JSON Kaydet/YÃ¼kle</span></div>
    </div>
    <div class="row">
      <label>GÃ¼nler (virgÃ¼l ayÄ±r)<br/>
        <input type="text" id="daysInput" value="Pazartesi,SalÄ±,Ã‡arÅŸamba,PerÅŸembe,Cuma" />
      </label>
      <label>Saat/Slot sayÄ±sÄ±<br/>
        <input type="number" id="slotsInput" value="8" min="1" max="12" />
      </label>
      <label>Atama politikasÄ±<br/>
        <select id="assignPolicy" title="Program deÄŸiÅŸince atamalarÄ± nasÄ±l ele alalÄ±m?">
          <option value="keep" selected>KoruyabildiÄŸini koru (taÅŸanlarÄ± at)</option>
          <option value="reset">Tamamen sÄ±fÄ±rla</option>
        </select>
      </label>
      <button class="btn" id="btnBuildGrid">OluÅŸtur/GÃ¼ncelle</button>
      <button class="btn ghost" id="btnProgExport">JSON DÄ±ÅŸa Aktar</button>
      <input id="fileProgImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnProgImport">JSON Ä°Ã§eri Al</button>
      <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri -->
      <button class="btn ghost" id="btnProgSaveFb">Firebase Kaydet</button>
      <button class="btn ghost" id="btnProgLoadFb">Firebase YÃ¼kle</button>
      <button class="btn ghost" id="btnProgDeleteFb">Firebase Sil</button>
    </div>

    <!-- Saat etiketleri dÃ¼zenleyici -->
    <div id="slotLabelsWrap" class="card"></div>

    <div id="progGridWrap" class="card"></div>
    <div class="row">
      <button class="btn sec right" id="goto3">Devam â†’ MÃ¼saitlikler</button>
    </div>
  </section>

  <!-- STEP 3 -->
  <section class="content grid tabpanel" id="step3" role="tabpanel" hidden>
    <div class="section-title">
      <h2>3) MÃ¼saitlikler</h2>
      <div class="legend">
        <span>â— Ã–ÄŸretmen MÃ¼saitliÄŸi (Ã§ift tÄ±k gÃ¼n baÅŸlÄ±ÄŸÄ±: gÃ¼nÃ¼ kopyala)</span>
        <span>â— Grup MÃ¼saitliÄŸi (Ã§ift tÄ±k gÃ¼n baÅŸlÄ±ÄŸÄ±: gÃ¼nÃ¼ kopyala)</span>
      </div>
    </div>

    <div class="tabs no-print" role="tablist" aria-label="MÃ¼saitlik Sekmeleri">
      <button class="tab" id="tabTeach" role="tab" aria-selected="true">Ã–ÄŸretmen MÃ¼saitlik</button>
      <button class="tab" id="tabGroup" role="tab" aria-selected="false">Grup MÃ¼saitlik</button>
    </div>

    <div id="panelTeach" role="tabpanel">
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport">JSON DÄ±ÅŸa Aktar</button>
        <input id="fileAvailImport" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport">JSON Ä°Ã§eri Al</button>
        <button class="btn warn" id="btnAvailClear">TÃ¼m MÃ¼saitlikleri Temizle</button>
        <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri: Ã¶ÄŸretmen & grup mÃ¼saitliÄŸi ortak kullanÄ±r -->
        <button class="btn ghost" id="btnAvailSaveFb">Firebase Kaydet</button>
        <button class="btn ghost" id="btnAvailLoadFb">Firebase YÃ¼kle</button>
        <button class="btn ghost" id="btnAvailDeleteFb">Firebase Sil</button>
      </div>
      <div class="card">
        <h3>Ã–ÄŸretmen MÃ¼saitlikleri</h3>
        <div id="teacherAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div id="panelGroup" role="tabpanel" hidden>
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport2">JSON DÄ±ÅŸa Aktar</button>
        <input id="fileAvailImport2" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport2">JSON Ä°Ã§eri Al</button>
        <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri: Ã¶ÄŸretmen & grup mÃ¼saitliÄŸi ortak kullanÄ±r (ayrÄ± id'ler) -->
        <button class="btn ghost" id="btnAvailSaveFb2">Firebase Kaydet</button>
        <button class="btn ghost" id="btnAvailLoadFb2">Firebase YÃ¼kle</button>
        <button class="btn ghost" id="btnAvailDeleteFb2">Firebase Sil</button>
      </div>
      <div class="card">
        <h3>Grup MÃ¼saitlikleri</h3>
        <div id="groupAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div class="row">
      <button class="btn sec right" id="goto4">Devam â†’ Grup Talepleri</button>
    </div>
  </section>

  <!-- STEP 4 -->
  <section class="content grid tabpanel" id="step4" role="tabpanel" hidden>
    <div class="section-title">
      <h2>4) GruplarÄ±n HaftalÄ±k Ders Talepleri</h2>
      <div class="chips" id="branchChips"></div>
    </div>

    <div class="row">
      <label>Grup SeÃ§in<br/>
        <select id="reqGroupSelect"></select>
      </label>
      <button class="btn ghost" id="btnReqExport">JSON DÄ±ÅŸa Aktar</button>
      <input id="fileReqImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnReqImport">JSON Ä°Ã§eri Al</button>
      <button class="btn warn" id="btnReqClear">TÃ¼m Talepleri SÄ±fÄ±rla</button>
      <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri -->
      <button class="btn ghost" id="btnReqSaveFb">Firebase Kaydet</button>
      <button class="btn ghost" id="btnReqLoadFb">Firebase YÃ¼kle</button>
      <button class="btn ghost" id="btnReqDeleteFb">Firebase Sil</button>
    </div>

    <div id="reqWrap" class="grid"></div>

    <div class="row">
      <button class="btn sec right" id="goto5">Devam â†’ Atama Paneli</button>
    </div>
  </section>

  <!-- STEP 5 -->
  <section class="content grid tabpanel" id="step5" role="tabpanel" hidden>
    <div class="section-title">
      <h2>5) Atama Paneli</h2>
      <div class="chips">
        <span class="pill">AynÄ± gruba ardÄ±ÅŸÄ±k aynÄ± branÅŸ verilmez</span>
        <span class="pill">BranÅŸa gÃ¶re Ã¶ÄŸretmen yÃ¼kÃ¼ dengelenir</span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnAutoAssign">Otomatik Atama</button>
      <button class="btn ghost" id="btnAssgnExport">JSON DÄ±ÅŸa Aktar</button>
      <input id="fileAssgnImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnAssgnImport">JSON Ä°Ã§eri Al</button>
      <button class="btn warn" id="btnAssgnClear">AtamalarÄ± Temizle</button>
      <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri -->
      <button class="btn ghost" id="btnAssgnSaveFb">Firebase Kaydet</button>
      <button class="btn ghost" id="btnAssgnLoadFb">Firebase YÃ¼kle</button>
      <button class="btn ghost" id="btnAssgnDeleteFb">Firebase Sil</button>
    </div>
    <div id="assignCards" class="cards"></div>

    <dialog id="dlgAssign">
      <header>Manuel Atama</header>
      <section>
        <div class="grid">
          <div class="inline-grid">
            <label>Grup<br/><input type="text" id="dlgGroup" readonly></label>
            <label>GÃ¼n / Saat<br/><input type="text" id="dlgWhen" readonly></label>
          </div>
          <div class="inline-grid">
            <label>BranÅŸ<br/><select id="dlgBranch"></select></label>
            <label>Ã–ÄŸretmen<br/><select id="dlgTeacher"></select></label>
          </div>
        </div>
      </section>
     <footer>
  <button class="btn ghost" id="dlgCancel">VazgeÃ§</button>
  <button class="btn danger" id="dlgDelete" hidden>AtamayÄ± Sil</button>
  <button class="btn" id="dlgOk">Kaydet</button>
</footer>
    </dialog>

    <div class="row">
      <button class="btn sec right" id="goto6">Devam â†’ YazdÄ±r</button>
    </div>
  </section>

  <!-- STEP 6 -->
  <section class="content grid tabpanel" id="step6" role="tabpanel" hidden>
    <div class="section-title">
      <h2>YazdÄ±r / Rapor</h2>
      <div class="chips no-print">
        <span class="pill">A4 Ã§Ä±ktÄ±, sayfa baÅŸÄ± Ã¶ÄŸretmen/grup</span>
        <span class="pill">Sadece atama varsa</span>
      </div>
    </div>
    <div class="row no-print">
      <label>GÃ¶rÃ¼nÃ¼m<br/>
        <select id="printMode">
          <option value="group">Gruba gÃ¶re</option>
          <option value="teacher">Ã–ÄŸretmene gÃ¶re</option>
        </select>
      </label>
      <label>Filtre<br/>
        <select id="printFilter"></select>
      </label>
      <button class="btn" id="btnRenderPrint">Ã–nizleme</button>
      <button class="btn sec" id="btnPrint" onclick="window.print()">YazdÄ±r</button>
    </div>
    <div id="printPreview" class="grid printable"></div>
  </section>
</div>

<script>
/* ===== Global Durum ===== */
const ALLOWED_BRANCHES = [
  'FEN BÄ°LÄ°MLERÄ°','MATEMATÄ°K','TÃœRKÃ‡E','SOSYAL BÄ°LGÄ°LER','Ä°NGÄ°LÄ°ZCE','DÄ°N KÃœLTÃœRÃœ'
];
window.state = {
  teachers: [], students: [], groups: {}, branches: [],
  program: { days:["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"], slots:8, slotLabels:[], cells:{} },
  availability: { teachers:{}, groups:{} },
  requests: {}, assignments: []
};

/* ===== YardÄ±mcÄ±lar ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name; a.click();
};
const openFile = (inputEl, cb) => { inputEl.onchange = e=>{
  try{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => { try{ cb(JSON.parse(r.result)); }catch(err){ alert('GeÃ§ersiz JSON: '+err.message); } };
    r.readAsText(f); inputEl.value='';
  }catch(err){ alert('Dosya okunamadÄ±: '+err.message); }
}; inputEl.click(); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

// ========== Branch Color Helpers ==========
// In order to visually distinguish different course assignments in the schedule,
// we generate pastel colors based off of the branch name. These colors are
// deterministic (same branch â†’ same color) and cached for performance. The
// lightness and saturation values are tuned for good contrast while keeping
// the colors soft. A slightly darker border color is also produced to
// delineate the cells.
const branchColorCache = {};
function getColorForBranch(branch) {
  if (!branch) return null;
  if (branchColorCache[branch]) return branchColorCache[branch];
  let sum = 0;
  for (let i = 0; i < branch.length; i++) {
    sum = (sum + branch.charCodeAt(i)) & 0xffff;
  }
  const hue = (sum * 37) % 360;
  const color = `hsl(${hue}, 70%, 85%)`;
  branchColorCache[branch] = color;
  return color;
}
function getBorderColorForBranch(branch) {
  if (!branch) return null;
  let sum = 0;
  for (let i = 0; i < branch.length; i++) {
    sum = (sum + branch.charCodeAt(i)) & 0xffff;
  }
  const hue = (sum * 37) % 360;
  return `hsl(${hue}, 65%, 75%)`;
}

/* Grup sÄ±ralama:  G1-7A, G2-7A, G3-7A, ... G1-7B ... */
function parseGroupName(name){
  const s=String(name||'').trim().toUpperCase();
  // G<number>-<grade><section> -> G1-7A
  let m=s.match(/^G(\d+)-(\d+)\s*([A-ZÃ‡ÄÄ°Ã–ÅÃœ])$/i);
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  // Fallback: G<number>-<label>
  m=s.match(/^G(\d+)-(.+)$/i);
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}

/* ===== Ãœst Sekmeler ===== */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(id===panelId) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=> tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false'));

  if(panelId==='step2'){ buildProgramGrid(true); renderSlotLabels(); }
  if(panelId==='step3'){ reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); }
  if(panelId==='step4'){ refreshReqFilterOptions(); renderRequests(); }
  if(panelId==='step5'){ renderAssignCards(); }
  if(panelId==='step6'){ refreshPrintFilters(); renderPrintPreview(); }
}
function bindTopTabs(){ $$('#topTabs .tab').forEach(tab=> tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel))); }

/* ===== 1) Veri KaynaÄŸÄ± ===== */
async function gvizFetch(sheetId, sheetName, selectRange){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&headers=1${selectRange?`&range=${encodeURIComponent(selectRange)}`:''}`;
  const res = await fetch(url, {mode:'cors'}); const txt = await res.text();
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/)[1]);
  const cols = json.table.cols.map(c=>c.label);
  const rows = (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')); // why: boÅŸ hÃ¼creler iÃ§in
  return {columns:cols, rows};
}
function renderTeachers(){
  const tb = $("#tblTeachers tbody"); tb.innerHTML='';
  state.teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td><span class="tag">${t.branch}</span></td>`;
    tb.appendChild(tr);
  });
}
function renderStudents(){
  const tb = $("#tblStudents tbody"); tb.innerHTML='';
  state.students.forEach(st=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="nowrap">${st.no}</td><td>${st.name}</td><td>${st.cls}</td><td><b>${st.group}</b></td>`;
    tb.appendChild(tr);
  });
}
function buildGroupsFromStudents(){
  state.groups = {};
  state.students.forEach(st=>{
    const gid = st.group;
    if(!state.groups[gid]) state.groups[gid] = { id:gid, name:gid, students:[] };
    state.groups[gid].students.push(st.no);
  });
}
function renderGroupSummary(){
  const wrap = $("#groupSummary"); wrap.innerHTML='';
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const el = document.createElement('span'); el.className='pill';
    el.textContent = `${g.name} â€¢ ${g.students.length} Ã¶ÄŸrenci`;
    wrap.appendChild(el);
  });
}
async function fetchAll(){
  const sheetId = $("#sheetId").value.trim();
  $("#readStatus").textContent = "Okunuyor...";
  try{
    const t = await gvizFetch(sheetId, 'Ogretmenler');
    const cT = t.columns.map(s=>s.toUpperCase());
    const ixName = cT.indexOf('OGRETMEN_ADI');
    const ixBr   = cT.indexOf('BRANS');
    if(ixName<0 || ixBr<0) throw new Error("Ogretmenler sayfasÄ±nda 'OGRETMEN_ADI' ve 'BRANS' yok.");
    state.teachers = t.rows.map(r=>{
      const name = (r[ixName]||'').toString().trim();
      const bRaw = (r[ixBr]||'').toString().trim().toUpperCase();
      return { id: toId(name||("T"+Math.random())), name, branch:bRaw };
    }).filter(x=>x.name && ALLOWED_BRANCHES.includes(x.branch));
    if(state.teachers.length===0) throw new Error("Filtre sonrasÄ± Ã¶ÄŸretmen bulunamadÄ±.");

    const s = await gvizFetch(sheetId, 'Ogrenciler');
    const cS = s.columns.map(s=>s.toUpperCase());
    const ixNo = cS.indexOf('NO');
    const ixAd = cS.indexOf('ADSOYAD');
    const ixSn = cS.indexOf('SINIF');
    const ixGr = cS.indexOf('GRUBU');
    if(ixNo<0 || ixAd<0 || ixSn<0 || ixGr<0) throw new Error("Ogrenciler: NO/ADSOYAD/SINIF/Grubu eksik.");
    state.students = s.rows.map(r=>({
      no: r[ixNo], name: r[ixAd], cls: r[ixSn], group: (r[ixGr]||'').toString().trim()
    })).filter(x=>x.group);

    buildGroupsFromStudents();
    state.branches = Array.from(new Set(state.teachers.map(t=>t.branch))).sort((a,b)=>a.localeCompare(b));

    renderTeachers(); renderStudents(); renderGroupSummary();
    $("#readStatus").textContent = `Tamam: ${state.teachers.length} Ã¶ÄŸretmen, ${state.students.length} Ã¶ÄŸrenci, ${Object.keys(state.groups).length} grup.`;

    reconcileAllToProgram(getAssignPolicy());
  }catch(err){
    $("#readStatus").textContent = "Hata: " + err.message;
  }
}

/* ===== 2) Program ===== */
function getAssignPolicy(){ return $("#assignPolicy").value; }

function ensureSlotLabels(){ // why: yazdÄ±r ve mÃ¼saitlikte saatleri kullanmak
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  for(let i=0;i<S;i++) if(typeof state.program.slotLabels[i] !== 'string') state.program.slotLabels[i]='';
  if(state.program.slotLabels.length>S) state.program.slotLabels.length = S;
}
function renderSlotLabels(){
  ensureSlotLabels();
  const S = state.program.slots;
  const wrap = $("#slotLabelsWrap"); wrap.innerHTML='';
  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'Saat Etiketleri',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const c=document.createElement('div'); c.className='kcell';
    const lab = state.program.slotLabels[s]||'';
    c.innerHTML = `<div class="mini">${s+1}. Ders</div><div>${lab||'â€”'}</div>`;
    c.title='TÄ±kla: saat gir (Ã¶r. 16:30-17:10). Alt+tÄ±k: bu etiketi boÅŸ slotlara kopyala.';
    c.addEventListener('click', (e)=>{
      const v = prompt(`${s+1}. ders iÃ§in saat etiketi (Ã¶r. 16:30-17:10):`, state.program.slotLabels[s]||'');
      if(v!==null){ state.program.slotLabels[s]=v.trim(); renderSlotLabels(); }
    });
    c.addEventListener('auxclick', e=>{ e.preventDefault(); });
    c.addEventListener('mousedown', e=>{
      if(e.altKey){ // why: hÄ±zlÄ± kopya
        const val = state.program.slotLabels[s]||'';
        for(let k=0;k<S;k++) if(!state.program.slotLabels[k]) state.program.slotLabels[k]=val;
        renderSlotLabels();
      }
    });
    head.appendChild(c);
  }
  wrap.appendChild(head);

  const tools=document.createElement('div'); tools.className='row';
  tools.innerHTML = `
    <div class="qty">
      <button class="xs" id="btnFillForward">BoÅŸlarÄ± soldan doldur</button>
    </div>
    <input id="bulkSlotLabels" class="wide" type="text" placeholder="Toplu yapÄ±ÅŸtÄ±r: 16:30-17:10; 17:20-18:00; ..." />
    <button class="btn ghost" id="btnApplyBulk">Uygula</button>
    <button class="btn ghost" id="btnClearLabels">Temizle</button>
  `;
  wrap.appendChild(tools);
  $("#btnFillForward").onclick = ()=>{
    for(let i=1;i<S;i++){ if(!state.program.slotLabels[i]) state.program.slotLabels[i]=state.program.slotLabels[i-1]||''; }
    renderSlotLabels();
  };
  $("#btnApplyBulk").onclick = ()=>{
    const txt = $("#bulkSlotLabels").value.trim();
    if(!txt) return;
    const parts = txt.split(';').map(x=>x.trim());
    for(let i=0;i<S;i++) state.program.slotLabels[i]=parts[i]||state.program.slotLabels[i]||'';
    renderSlotLabels();
  };
  $("#btnClearLabels").onclick = ()=>{ state.program.slotLabels = Array(S).fill(''); renderSlotLabels(); };
}

function buildProgramGrid(fromRestore=false){
  if(!fromRestore){
    state.program.days = $("#daysInput").value.split(',').map(s=>s.trim()).filter(Boolean);
    state.program.slots = clamp(parseInt($("#slotsInput").value||"8"), 1, 12);
  }
  ensureSlotLabels();
  const days = state.program.days, S = state.program.slots;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';

  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'GÃ¼n / Saat',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const label = state.program.slotLabels[s]||'';
    const hc = document.createElement('div'); hc.className='kcell busy';
    hc.innerHTML = `<div>${s+1}</div><div class="mini2">${label||''}</div>`;
    head.appendChild(hc);
  }
  wrap.appendChild(head);

  days.forEach((d,di)=>{
    const row = document.createElement('div');
    row.className = 'kgrid'; row.style.setProperty('--cols', S);
    const lbl = document.createElement('div'); lbl.textContent = d; lbl.style.fontWeight='800'; row.appendChild(lbl);
    for(let si=0; si<S; si++){
      const key = keyDS(di,si);
      const cell = document.createElement('div'); cell.className='kcell';
      cell.textContent = state.program.cells[key] || '';
      cell.title = "Not girmek iÃ§in tÄ±klayÄ±n (opsiyonel)";
      cell.onclick = ()=>{
        const val = prompt(`${d} - ${si+1}. saat iÃ§in not:`, state.program.cells[key]||'');
        if(val!==null){ state.program.cells[key]=val.trim(); cell.textContent=state.program.cells[key]||''; }
      };
      row.appendChild(cell);
    }
    wrap.appendChild(row);
  });

  reconcileAllToProgram(getAssignPolicy());
}

/* Programla uyum */
function reconcileAllToProgram(policy='keep'){
  const D = state.program.days.length, S = state.program.slots;

  state.teachers.forEach(t=>{
    const cur = state.availability.teachers[t.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.teachers[t.id] = next;
  });
  Object.values(state.groups).forEach(g=>{
    const cur = state.availability.groups[g.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.groups[g.id] = next;
  });

  if(policy==='reset') state.assignments = [];
  else state.assignments = state.assignments.filter(a=> a.day<D && a.slot<S);
}

/* ===== 3) MÃ¼saitlik ===== */
function slotHeadCells(container,S){
  for(let s=0;s<S;s++){
    const lab = state.program.slotLabels?.[s] || '';
    const hd = document.createElement('div'); hd.className='kcell busy';
    hd.innerHTML = `<div>${s+1}</div><div class="mini2">${lab}</div>`;
    container.appendChild(hd);
  }
}
function renderAvailGrids(){
  const D=state.program.days.length, S=state.program.slots, days=state.program.days;

  const tWrap=$("#teacherAvailWrap"); tWrap.innerHTML='';
  if(state.teachers.length===0){
    tWrap.innerHTML = '<div class="muted">Ã–ÄŸretmen verisi yok. LÃ¼tfen "Verileri Oku" ile yÃ¼kleyin.</div>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>ğŸ‘¤ ${t.name}</b><span class="tag">${t.branch}</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='TÃ¼mÃ¼nÃ¼ Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='TÃ¼mÃ¼nÃ¼ DeÄŸil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.teachers[t.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.teachers[t.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.teachers[t.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='GÃ¼n / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='Ã‡ift tÄ±kla: bu gÃ¼nÃ¼ tÃ¼m gÃ¼nlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gÃ¼nÃ¼nÃ¼ kopyala?`)){ copyDayPattern(state.availability.teachers[t.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.teachers[t.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'DeÄŸil';
          cell.onclick = ()=>{
            const cur = state.availability.teachers[t.id][d][s] = !state.availability.teachers[t.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'DeÄŸil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); tWrap.appendChild(card);
    });
  }

  const gWrap=$("#groupAvailWrap"); gWrap.innerHTML='';
  const groups = Object.values(state.groups);
  if(groups.length===0){
    gWrap.innerHTML = '<div class="muted">Grup verisi yok. Ã–ÄŸrencilerden gruplar tÃ¼retilir.</div>';
  }else{
    groups.sort(groupComparator).forEach(g=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='TÃ¼mÃ¼nÃ¼ Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='TÃ¼mÃ¼nÃ¼ DeÄŸil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.groups[g.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.groups[g.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.groups[g.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='GÃ¼n / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='Ã‡ift tÄ±kla: bu gÃ¼nÃ¼ tÃ¼m gÃ¼nlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gÃ¼nÃ¼nÃ¼ kopyala?`)){ copyDayPattern(state.availability.groups[g.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.groups[g.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'DeÄŸil';
          cell.onclick = ()=>{
            const cur = state.availability.groups[g.id][d][s] = !state.availability.groups[g.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'DeÄŸil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); gWrap.appendChild(card);
    });
  }
}
function bulkSet(matrix, val){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=val; }
function bulkToggle(matrix){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=!matrix[d][s]; }
function copyDayPattern(matrix, fromDay){ const row = matrix[fromDay].slice(); for(let d=0; d<matrix.length; d++){ matrix[d] = row.slice(); } }

/* ===== 4) Talepler ===== */
function ensureRequests(){
  Object.values(state.groups).forEach(g=>{
    state.requests[g.id] = state.requests[g.id] || {};
    state.branches.forEach(b=>{
      if(typeof state.requests[g.id][b] !== 'number') state.requests[g.id][b] = 0;
    });
  });
}
function refreshReqFilterOptions(){
  const sel = $("#reqGroupSelect"); sel.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(Grup seÃ§in)'; sel.appendChild(opt0);
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
  });
}
function totalRequestForGroup(gid){
  const req = state.requests[gid]||{};
  return Object.values(req).reduce((a,b)=>a+(+b||0),0);
}

function renderRequests(){
  ensureRequests();

  // Neden: BranÅŸ toplam/kalan rozetlerini her Ã§izimde gÃ¼ncel tutmak iÃ§in
  if (typeof renderBranchChipsSummary === 'function') {
    renderBranchChipsSummary();
  } else {
    // Yedek: helper yoksa en azÄ±ndan branÅŸ isimlerini gÃ¶ster
    const bc = $("#branchChips");
    if (bc) {
      bc.innerHTML = '';
      state.branches.forEach(b=>{
        const x = document.createElement('span');
        x.className = 'pill';
        x.textContent = b;
        bc.appendChild(x);
      });
    }
  }

  const selVal = $("#reqGroupSelect").value;
  const wrap = $("#reqWrap");
  wrap.innerHTML = '';

  if(!selVal){
    wrap.innerHTML = '<div class="muted">Soldan bir grup seÃ§in. SeÃ§ilen gruba ait talepleri dÃ¼zenleyin.</div>';
    return;
  }

  const g = state.groups[selVal];
  if(!g){
    wrap.innerHTML = '<div class="muted">SeÃ§ilen grup bulunamadÄ±.</div>';
    return;
  }

  const card = document.createElement('div');
  card.className = 'card';

  const total = totalRequestForGroup(g.id);
  const capacity = state.program.days.length * state.program.slots;
  const chip = document.createElement('span');
  chip.className = 'pill' + (total > capacity ? ' bad' : '');
  chip.textContent = `Toplam: ${total} â€¢ Kapasite: ${capacity}`;

  const head = document.createElement('div');
  head.className = 'flex';
  head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span>`;
  head.appendChild(chip);
  card.appendChild(head);

  const tbl = document.createElement('table');
  tbl.style.borderSpacing = '0 6px';
  tbl.innerHTML = `<thead><tr><th>BranÅŸ</th><th style="width:240px">Saat</th></tr></thead><tbody></tbody>`;

  state.branches.forEach(b=>{
    const tr = document.createElement('tr');

    const td1 = document.createElement('td');
    td1.textContent = b;
    tr.appendChild(td1);

    const td2 = document.createElement('td');
    const box = document.createElement('div'); box.className = 'qty';

    const minus = document.createElement('button'); minus.textContent = 'â€“';
    const inp = document.createElement('input'); inp.type = 'number'; inp.min = '0'; inp.value = state.requests[g.id][b] || 0;
    const plus = document.createElement('button'); plus.textContent = '+';

    minus.onclick = ()=>{
      inp.value = Math.max(0, (+inp.value || 0) - 1);
      inp.dispatchEvent(new Event('input'));
    };
    plus.onclick  = ()=>{
      inp.value = (+inp.value || 0) + 1;
      inp.dispatchEvent(new Event('input'));
    };

    inp.oninput = (e)=>{
      // Neden: istenmeyen deÄŸerleri engelle, Ã¶zetleri canlÄ± gÃ¼ncelle
      state.requests[g.id][b] = clamp(parseInt(e.target.value || '0'), 0, 999);

      const t = totalRequestForGroup(g.id);
      chip.className = 'pill' + (t > capacity ? ' bad' : '');
      chip.textContent = `Toplam: ${t} â€¢ Kapasite: ${capacity}`;

      if (typeof renderBranchChipsSummary === 'function') {
        renderBranchChipsSummary(); // branÅŸ kalan/kapasite Ã¶zetlerini canlÄ± gÃ¼ncelle
      }
    };

    box.append(minus, inp, plus);
    td2.appendChild(box);
    tr.appendChild(td2);

    tbl.querySelector('tbody').appendChild(tr);
  });

  card.appendChild(tbl);
  wrap.appendChild(card);
}
const exportReq = ()=>download('grup-talepleri.json', state.requests);
const importReq = obj=>{
  if(!obj || typeof obj!=='object') return alert('GeÃ§ersiz talepler JSON.');
  state.requests = obj;
  refreshReqFilterOptions();
  renderRequests();
};

/* ===== 5) Atama ===== */
function findTeacherOptions(branch){ return state.teachers.filter(t=>t.branch===branch); }
function isTeacherBusy(teacherId, day, slot){ return state.assignments.some(a=>a.teacherId===teacherId && a.day===day && a.slot===slot); }
function isGroupBusy(groupId, day, slot){ return state.assignments.some(a=>a.group===groupId && a.day===day && a.slot===slot); }
function prevGroupSubject(groupId, day, slot){
  if(slot>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day && x.slot===slot-1); return a ? a.branch : null; }
  if(day>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day-1 && x.slot===state.program.slots-1); return a ? a.branch : null; }
  return null;
}
function hasAssignmentsForGroup(gid){ return state.assignments.some(a=>a.group===gid); }
/* BranÅŸ ismini CSS sÄ±nÄ±fÄ±na Ã§eviren yardÄ±mcÄ± */
function getBranchClass(branchName) {
    if (!branchName) return '';
    const b = branchName.toUpperCase();
    if (b.includes('MATEMATÄ°K')) return 'mat';
    if (b.includes('FEN')) return 'fen';
    if (b.includes('TÃœRKÃ‡E')) return 'trk';
    if (b.includes('SOSYAL')) return 'sos';
    if (b.includes('Ä°NGÄ°LÄ°ZCE')) return 'ing';
    if (b.includes('DÄ°N')) return 'din';
    return ''; // TanÄ±msÄ±zsa varsayÄ±lan gri kalÄ±r
}
  
  function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;

  const groups = Object.values(state.groups).slice()
    .sort((a,b)=> (hasAssignmentsForGroup(b.id)?1:0)-(hasAssignmentsForGroup(a.id)?1:0) || groupComparator(a,b));

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='flex';
    const count = state.assignments.filter(a=>a.group===g.id).length;
    head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span><span class="pill">${count} atama</span>`;
    card.appendChild(head);

    const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
    const headRow = document.createElement('div'); headRow.textContent='GÃ¼n / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
    slotHeadCells(grid,S);

    for(let d=0; d<days.length; d++){
      const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
      row.appendChild(Object.assign(document.createElement('div'),{textContent:days[d],style:'font-weight:700'}));
      for(let s=0; s<S; s++){
        const cell = document.createElement('div');
        cell.className = 'kcell';
        cell.dataset.d = d;
        cell.dataset.s = s;

        // Duruma gÃ¶re uygunluk rengini uygula (mÃ¼saitse yeÅŸil, deÄŸilse kÄ±rmÄ±zÄ±).
        // Bu renkler yalnÄ±zca boÅŸ hÃ¼creler iÃ§in kullanÄ±lÄ±r; atamasÄ± olan hÃ¼creler
        // kendi ders renkleriyle gÃ¶sterilecektir.
        const avail = state.availability?.groups?.[g.id]?.[d]?.[s] === true;
        cell.classList.add(avail ? 'ok' : 'bad');

        // Mevcut bir atama var mÄ±? Varsa hÃ¼creyi ders rengine dÃ¶nÃ¼ÅŸtÃ¼r.
        const cur = state.assignments.find(a => a.group === g.id && a.day === d && a.slot === s);
     if (cur) {
    // 1. SÄ±nÄ±flarÄ± temizle ve ders rengini ekle
    cell.classList.remove('ok', 'bad', 'busy');
    cell.classList.add('assigned', getBranchClass(cur.branch));

    // 2. Ã–ÄŸretmen ismini veriden bul
    const teacherObj = state.teachers.find(t => t.id === cur.teacherId);
    // Ä°sim varsa al, yoksa boÅŸ string dÃ¶ndÃ¼r (icon yanÄ±na boÅŸluk gelmemesi iÃ§in)
    const teacherName = teacherObj ? teacherObj.name : '';

    // 3. Ä°Ã‡ERÄ°K HTML - GÃœNCELLENDÄ°
    cell.innerHTML = `
      <div style="
          display:flex; 
          flex-direction:column; 
          justify-content:center; 
          align-items:center; 
          height:100%; 
          width:100%; 
          pointer-events:none; 
          padding-bottom: 4px; /* Bu satÄ±r iÃ§eriÄŸi yukarÄ± iter */
      ">
        
        <div style="
            font-weight:900; 
            font-size:14px; 
            line-height:1; 
            margin-bottom:3px; 
            text-align:center; 
            letter-spacing: -0.3px; /* Harfleri hafif sÄ±kÄ±ÅŸtÄ±rarak sÄ±ÄŸdÄ±rÄ±r */
        ">
            ${cur.branch}
        </div>
        
        <div class="mini2" style="
            font-size:11px; 
            font-weight:700; 
            opacity:0.9; 
            line-height:1; 
            white-space:nowrap; 
            overflow:hidden; 
            text-overflow:ellipsis; 
            max-width:98%;
        ">
            ğŸ‘¤ ${teacherName}
        </div>

      </div>`;
}
        cell.onclick = () => {
          openAssignDialog(g.id, d, s);
        };
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }

    card.appendChild(grid);
    wrap.appendChild(card);
  });
}
const dlg = $("#dlgAssign"); let dlgCtx = null;

function openAssignDialog(group, day, slot) {
  dlgCtx = { group, day, slot };
  $("#dlgGroup").value = group;

  const time = state.program.slotLabels?.[slot] || `${slot + 1}. saat`;
  $("#dlgWhen").value = `${state.program.days[day]} â€¢ ${time}`;

  // BranÅŸ seÃ§enekleri
  const selB = $("#dlgBranch");
  selB.innerHTML = '';
  state.branches.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b; opt.textContent = b;
    selB.appendChild(opt);
  });
  selB.onchange = fillTeachersForBranch;

  // Mevcut atama var mÄ±?
  const current = state.assignments.find(a => a.group === group && a.day === day && a.slot === slot);

  // EÄŸer hÃ¼crede atama varsa, o branÅŸÄ± Ã¶n-seÃ§
  if (current) selB.value = current.branch;

  // Ã–ÄŸretmen listesini branÅŸa gÃ¶re doldur
  fillTeachersForBranch();

  // Ã–ÄŸretmen Ã¶n-seÃ§imi (mevcut atama varsa)
  if (current) {
    // Not: Ã–ÄŸretmen baÅŸka yerde atanmÄ±ÅŸsa UI'da "atanmÄ±ÅŸ" olarak gÃ¶rÃ¼nebilir.
    // Sil butonunu gÃ¶stermek asÄ±l hedef; seÃ§im baÅŸarÄ±sÄ±z olsa da sorun deÄŸil.
    const selT = $("#dlgTeacher");
    selT.value = current.teacherId;
    $("#dlgDelete").hidden = false;
  } else {
    $("#dlgDelete").hidden = true;
  }

  dlg.showModal();
}
$("#dlgDelete").onclick = () => {
  if (!dlgCtx) return;
  const { group, day, slot } = dlgCtx;
  const has = state.assignments.some(a => a.group === group && a.day === day && a.slot === slot);
  if (!has) { dlg.close(); return; }

  if (confirm("Bu atamayÄ± silmek istiyor musunuz?")) {
    state.assignments = state.assignments.filter(a => !(a.group === group && a.day === day && a.slot === slot));
    dlg.close();
    renderAssignCards(); // why: Ã¶ÄŸretmen anÄ±nda tekrar 'mÃ¼sait' gÃ¶rÃ¼nsÃ¼n
  }
};

function hasAnyAssignments(){ return Array.isArray(state.assignments) && state.assignments.length > 0; }
function getTeacherAssignmentsMap(){
  const m = new Map();
  for (const a of state.assignments) {
    if (!m.has(a.teacherId)) m.set(a.teacherId, []);
    m.get(a.teacherId).push(a);
  }
  return m;
}

/**
 * Compute the total number of lesson slots a teacher could be assigned given
 * current group requests. This capacity is the sum of all requested lesson
 * counts for the teacher's branch across all groups. It serves as an upper
 * bound on how many lessons the teacher might teach in the plan. If no
 * requests exist for that branch the capacity will be zero.
 * @param {string} tid - teacher ID
 * @returns {number} total slots requested for this teacher's branch
 */
function teacherCapacity(tid) {
  const tObj = state.teachers.find(x => x.id === tid);
  if (!tObj) return 0;
  const br = tObj.branch;
  let total = 0;
  for (const gid of Object.keys(state.requests)) {
    const req = state.requests[gid] || {};
    const n = req[br];
    if (typeof n === 'number' && !isNaN(n)) total += n;
  }
  return total;
}

/**
 * Calculate how many lesson slots a teacher is available for based on the
 * current availability matrix. Each true entry in state.availability.teachers
 * counts as one potential lesson the teacher could teach. This is used in
 * the manual assignment panel to show a teacher's capacity (mÃ¼saitlik) to
 * take on lessons as opposed to the total requested lesson count. Without
 * this helper the UI displayed confusing large numbers like 24 or 26. The
 * user explicitly requested that the availability count and the active
 * assignment count be shown next to each teacher in the manual assignment
 * panel.
 * @param {string} tid - teacher ID
 * @returns {number} number of available slots for this teacher
 */
function teacherAvailabilityCount(tid) {
  const avail = state.availability?.teachers?.[tid] || [];
  const D = state.program?.days?.length || 0;
  const S = state.program?.slots || 0;
  let total = 0;
  for (let d = 0; d < D; d++) {
    const row = avail[d] || [];
    for (let s = 0; s < S; s++) {
      if (row[s] === true) total++;
    }
  }
  return total;
}

function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const {day, slot} = dlgCtx || {};
  const selT = $("#dlgTeacher"); selT.innerHTML = '';

  // Precompute current assignment counts for teachers once per invocation
  const assignMap = getTeacherAssignmentsMap();
  findTeacherOptions(branch).forEach(t => {
    const availOk = state.availability.teachers[t.id]?.[day]?.[slot] === true;
    const busyNow = isTeacherBusy(t.id, day, slot);

    const ok = availOk && !busyNow;

    const opt = document.createElement('option');
    opt.value = t.id;

    // Determine how many slots the teacher is available for and currently assigned
    const totalAssigned = (assignMap.get(t.id) || []).length;
    const availCount = teacherAvailabilityCount(t.id);

    // Build label showing availability and active assignment counts
    // Format: (mÃ¼saitlik / atama) e.g. (10/3)
    const countLabel = `(${availCount}/${totalAssigned})`;

    if (ok) {
      // Teacher is available; display counts next to name
      opt.textContent = `${t.name} ${countLabel}`;
    } else {
      // Teacher not suitable now; still show counts and reason
      const reason = busyNow ? 'Ã§akÄ±ÅŸÄ±yor' : 'uygun deÄŸil';
      opt.textContent = `${t.name} ${countLabel} â€¢ ${reason}`;
      opt.disabled = true;
    }
    selT.appendChild(opt);
  });

  // VarsayÄ±lan olarak ilk uygun Ã¶ÄŸretmeni seÃ§
  const firstEnabled = Array.from(selT.options).find(o => !o.disabled);
  if (firstEnabled) selT.value = firstEnabled.value;
}

$("#dlgCancel").onclick = ()=> dlg.close();
$("#dlgOk").onclick = () => {
  const {group, day, slot} = dlgCtx;
  const branch = $("#dlgBranch").value;
  const teacherId = $("#dlgTeacher").value;

  // 1) Ã–ÄŸretmen uygunluk kontrolÃ¼
  if (state.availability.teachers[teacherId]?.[day]?.[slot] !== true){
    alert("SeÃ§ilen Ã¶ÄŸretmen bu gÃ¼n/saati iÃ§in mÃ¼sait deÄŸil. LÃ¼tfen uygun bir Ã¶ÄŸretmen seÃ§in.");
    return;
  }

  // 2) Grup uygunluk kontrolÃ¼ (isteÄŸe baÄŸlÄ±)
  if (state.availability.groups[group]?.[day]?.[slot] !== true){
    alert("Bu grup bu gÃ¼n/saati iÃ§in mÃ¼sait deÄŸil.");
    return;
  }

  // 3) Ã‡akÄ±ÅŸma uyarÄ±larÄ± (yalnÄ±z aynÄ± saat)
  if (isTeacherBusy(teacherId, day, slot))
    if(!confirm("Ã–ÄŸretmen bu saatte baÅŸka derste. Yine de ata?")) return;
  if (isGroupBusy(group, day, slot))
    if(!confirm("Bu gruba bu saatte baÅŸka atama var. Ãœzerine yazÄ±lsÄ±n mÄ±?")) return;

  // 4) AtamayÄ± yaz
  state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
  state.assignments.push({group, day, slot, branch, teacherId});
  dlg.close();
  renderAssignCards(); // why: UI ve uygunluk anÄ±nda gÃ¼ncellensin

  // YazdÄ±r sekmesi aÃ§Ä±ksa anÄ±nda tazele (why: manuel atama sonrasÄ± Ã¶nizleme gÃ¼ncel kalsÄ±n)
  const printPanel = $('#step6');
  if (printPanel && !printPanel.hasAttribute('hidden')) {
    refreshPrintFilters();
    renderPrintPreview();
  }
};
// index.html â€” Auto Assign (V4.1): Maks YerleÅŸim OdaklÄ±, YÃ¼k Dengesi YOK

/**
 * AmaÃ§: Ã–ÄŸretmen yÃ¼k dengesini tamamen devre dÄ±ÅŸÄ± bÄ±rakarak,
 * mÃ¼mkÃ¼n olan EN Ã‡OK derse atama yapan varyasyonu bulup uygulamak.
 */
function autoAssign() {
  const D = state.program.days.length;
  const S = state.program.slots;

  // --------- Ayarlar ---------
  // GeliÅŸtirilmiÅŸ ayarlar: daha uzun zaman limiti ve daha fazla deneme,
  // bÃ¶ylece algoritma ilk Ã§alÄ±ÅŸtÄ±rmada daha iyi sonuÃ§lar bulabilir.
  const TIME_LIMIT_MS = 10000; // Ã¶nceki 2500
  const AVOID_SAME_BRANCH_SOFT = true;
  const MAX_FREE_TEACHER_SUGGESTIONS = 5;
  const MAX_CONFLICT_ROWS_IN_UI = 20;
  // ---------------------------

  // --- YardÄ±mcÄ±lar ---
  const makeGrid = (rows, cols, fill=null) => Array.from({length:rows}, () => Array(cols).fill(fill));
  const keyCell = (g,d,s) => `${g}|${d}|${s}`;
  const rndInt = (n) => Math.floor(Math.random()*n);
  const shuffle = (arr) => { for (let i=arr.length-1;i>0;i--){ const j=rndInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
  const prevBranchOf = (gGrid, gid, d, s) => {
    if (s > 0) return gGrid[gid]?.[d]?.[s-1]?.branch || null;
    if (d > 0) return gGrid[gid]?.[d-1]?.[S-1]?.branch || null;
    return null;
  };
  const canUse = (gGrid, tGrid, gid, tid, d, s) => {
    if (state.availability.groups[gid]?.[d]?.[s] !== true) return false;
    if (state.availability.teachers[tid]?.[d]?.[s] !== true) return false;
    if (gGrid[gid]?.[d]?.[s]) return false;
    if (tGrid[tid]?.[d]?.[s]) return false;
    return true;
  };

  const getTeacherName = (tid) => {
    const tObj = typeof state.teachers === 'object' && !Array.isArray(state.teachers) ? state.teachers[tid] : null;
    if (tObj?.name) return tObj.name;
    if (Array.isArray(state.teachers)) {
      const t = state.teachers.find(x => x.id === tid);
      if (t?.name) return t.name;
    }
    const p = state.people?.teachers;
    if (p) {
      const pt = Array.isArray(p) ? p.find(x => x.id === tid) : p[tid];
      if (pt?.name) return pt.name;
    }
    return String(tid);
  };

  // Ã–ÄŸretmenin branÅŸ(lar)Ä±nÄ± bul (cache'li)
  const teacherBranchesCache = new Map();
  const getTeacherBranches = (tid) => {
    if (teacherBranchesCache.has(tid)) return teacherBranchesCache.get(tid);
    const out = new Set();
    const addFromObj = (obj) => {
      if (!obj) return;
      const candidates = obj.branches || obj.subjects || obj.branch || obj.subject;
      if (Array.isArray(candidates)) candidates.forEach(b => b && out.add(String(b)));
      else if (typeof candidates === 'string') out.add(candidates);
    };
    const tObj = typeof state.teachers === 'object' && !Array.isArray(state.teachers) ? state.teachers[tid] : null;
    addFromObj(tObj);
    if (Array.isArray(state.teachers)) addFromObj(state.teachers.find(x => x.id === tid));
    const p = state.people?.teachers;
    if (p) addFromObj(Array.isArray(p) ? p.find(x => x.id === tid) : p[tid]);

    // findTeacherOptions ile Ã§Ä±karÄ±m
    if (Array.isArray(state.branches)) {
      for (const b of state.branches) {
        try {
          const arr = findTeacherOptions(b) || [];
          if (arr.some(t => t.id === tid)) out.add(String(b));
        } catch { /* ignore */ }
      }
    }
    const result = Array.from(out);
    teacherBranchesCache.set(tid, result);
    return result;
  };

  // O gÃ¼n/saat boÅŸta Ã¶ÄŸretmenleri listele (branÅŸ + isim)
  const listFreeTeachersAt = (d, s, max = MAX_FREE_TEACHER_SUGGESTIONS) => {
    const tAvail = state.availability?.teachers || {};
    const tids = Object.keys(tAvail);
    const busyAt = new Set(state.assignments.filter(a => a.day === d && a.slot === s).map(a => a.teacherId));
    const res = [];
    for (const tid of tids) {
      if (tAvail[tid]?.[d]?.[s] === true && !busyAt.has(tid)) {
        const branches = getTeacherBranches(tid);
        res.push({ id: tid, name: getTeacherName(tid), branches });
      }
    }
    res.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
    return res.slice(0, max);
  };

  // Manuel "seÃ§â€“ata" (branÅŸ: Ã¶ÄŸretmenin branÅŸÄ± âˆ© ihtiyaÃ§; yoksa Ã¶ÄŸretmenin ilk branÅŸÄ±)
  function performManualAssign(gid, d, s, tid, branch) {
    if (state.availability.groups[gid]?.[d]?.[s] !== true) { alert('Grup bu saatte mÃ¼sait deÄŸil.'); return false; }
    if (state.availability.teachers[tid]?.[d]?.[s] !== true) { alert('Ã–ÄŸretmen bu saatte mÃ¼sait deÄŸil.'); return false; }
    if (state.assignments.some(a => a.group===gid && a.day===d && a.slot===s)) { alert('Bu slot dolu.'); return false; }
    if (state.assignments.some(a => a.teacherId===tid && a.day===d && a.slot===s)) { alert('Ã–ÄŸretmen bu saatte baÅŸka derste.'); return false; }

    if (!branch) {
      const tBranches = getTeacherBranches(tid);
      const counts = Object.fromEntries(state.branches.map(b => [b, +(state.requests[gid]?.[b] || 0)]));
      state.assignments.filter(a=>a.group===gid).forEach(a => counts[a.branch] = Math.max(0, (counts[a.branch]||0)-1));
      const needed = Object.entries(counts).filter(([,v])=>v>0).map(([b])=>b);
      const inter = tBranches.filter(b => needed.includes(b));
      branch = inter[0] || tBranches[0] || state.branches?.[0] || 'GENEL';
    }

    state.assignments.push({ group: gid, day: d, slot: s, branch, teacherId: tid });
    renderAssignCards();
    return true;
  }

  // --- Sabit atamalar (korunur) ---
  const fixed = state.assignments.map(a => ({...a}));

  // HÄ±zlÄ± eriÅŸim Ä±zgaralarÄ± (yalnÄ±z sabitler)
  const gGridBase = {};
  const tGridBase = {};
  const ensure = (mat, id, rows, cols) => (mat[id] ||= makeGrid(rows, cols));
  const placeBase = a => {
    ensure(gGridBase, a.group, D, S)[a.day][a.slot] = a;
    ensure(tGridBase, a.teacherId, D, S)[a.day][a.slot] = a;
  };
  fixed.forEach(placeBase);

  // Ä°htiyaÃ§ listeleri (group -> [branch, ...])
  const needsByGroup = {};
  for (const g of Object.values(state.groups)) {
    const req = state.requests[g.id] || {};
    const have = {};
    fixed.forEach(a => { if (a.group === g.id) have[a.branch] = (have[a.branch]||0) + 1; });
    const list = [];
    for (const [b, cnt] of Object.entries(req)) {
      const need = Math.max(0, (cnt|0) - (have[b]||0));
      for (let i=0;i<need;i++) list.push(b);
    }
    needsByGroup[g.id] = list;
  }

  // Ä°htiyaÃ§ yoksa sadece yeniden Ã§iz ve rapor
  const remainingNeedsCount = Object.values(needsByGroup).reduce((acc, arr) => acc + (arr?.length || 0), 0);
  if (remainingNeedsCount === 0) {
    renderAssignCards();
    showAutoAssignReport(buildAutoAssignReport(fixed.length));
    return;
  }

  // Deneme sayÄ±sÄ± (ihtiyaca gÃ¶re dinamik)
  // GeliÅŸtirilmiÅŸ deÄŸerler: daha yÃ¼ksek baÅŸlangÄ±Ã§ ve ihtiyaÃ§ baÅŸÄ±na deneme sayÄ±sÄ±,
  // ayrÄ±ca maksimum deneme sayÄ±sÄ± artÄ±rÄ±ldÄ±.
  const BASE_RESTARTS = 200;
  const RESTARTS_PER_NEED = 10;
  const MAX_RESTARTS = 5000;
  const TARGET_RESTARTS = Math.min(MAX_RESTARTS, BASE_RESTARTS + remainingNeedsCount * RESTARTS_PER_NEED);

  // HÃ¼cre sÄ±ra paternleri
  const orderings = {
    randomAll(D,S) { const cells = []; for (let d=0; d<D; d++) for (let s=0; s<S; s++) cells.push([d,s]); return shuffle(cells); },
    dayMajorRandom(D,S) {
      const days = shuffle([...Array(D).keys()]); const slots = shuffle([...Array(S).keys()]);
      const cells = []; for (const d of days) for (const s of slots) cells.push([d,s]); return cells;
    },
    slotMajorRandom(D,S) {
      const days = shuffle([...Array(D).keys()]); const slots = shuffle([...Array(S).keys()]);
      const cells = []; for (const s of slots) for (const d of days) cells.push([d,s]); return cells;
    },
    serpentine(D,S) {
      const days = shuffle([...Array(D).keys()]); const cells = [];
      for (let i=0;i<days.length;i++){ const d = days[i];
        if (i%2===0) for (let s=0;s<S;s++) cells.push([d,s]); else for (let s=S-1;s>=0;s--) cells.push([d,s]);
      } return cells;
    }
  };
  const orderingKeys = Object.keys(orderings);

  // Ã‡oklu denemeler
  const startTime = performance.now();
  const groupsAll = Object.values(state.groups).map(x => x.id);

  let bestScore = -1;
  let bestSolution = null;
  let restartsDone = 0;

  while (restartsDone < TARGET_RESTARTS && (performance.now() - startTime) < TIME_LIMIT_MS) {
    restartsDone++;

    const gGrid = {};
    const tGrid = {};
    for (const gid of Object.keys(gGridBase)) gGrid[gid] = gGridBase[gid].map(row => row.slice());
    for (const tid of Object.keys(tGridBase)) tGrid[tid] = tGridBase[tid].map(row => row.slice());
    const needs = JSON.parse(JSON.stringify(needsByGroup));

    const pattern = orderingKeys[rndInt(orderingKeys.length)];
    const cells = orderings[pattern](D, S);

    const groupOrder = groupsAll
      .map(gid => ({ gid, need: needs[gid]?.length || 0 }))
      .sort((a,b) => a.need - b.need || (Math.random()-0.5))
      .map(x => x.gid);

    let placedCount = 0;

    for (const [d,s] of cells) {
      const localGroups = groupOrder.slice();
      if (Math.random() < 0.5) shuffle(localGroups);

      for (const gid of localGroups) {
        const needArr = needs[gid];
        if (!needArr || needArr.length === 0) continue;
        if (state.availability.groups[gid]?.[d]?.[s] !== true) continue;
        if (gGrid[gid]?.[d]?.[s]) continue;

        const lastB = AVOID_SAME_BRANCH_SOFT ? prevBranchOf(gGrid, gid, d, s) : null;
        const uniqBranches = Array.from(new Set(needArr));
        shuffle(uniqBranches);
        if (lastB) {
          const ix = uniqBranches.indexOf(lastB);
          if (ix > -1) { uniqBranches.splice(ix,1); uniqBranches.push(lastB); }
        }

        let placedHere = false;

        for (const branch of uniqBranches) {
          // TÃ¼m aday Ã¶ÄŸretmenleri filtrele (uygunluk ve boÅŸluk kontrolÃ¼)
          const allCandidates = findTeacherOptions(branch)
            .filter(t => state.availability.teachers[t.id]?.[d]?.[s] === true && !(tGrid[t.id] || [])[d]?.[s]);
          if (allCandidates.length === 0) continue;

          // Daha Ã¶nce bu gruba aynÄ± branÅŸ iÃ§in atanmÄ±ÅŸ Ã¶ÄŸretmenleri belirle
          const usedTeachers = new Set();
          const gRows = gGrid[gid] || [];
          for (let dd = 0; dd < D; dd++) {
            const row = gRows[dd] || [];
            for (let ss = 0; ss < S; ss++) {
              const a2 = row[ss];
              if (a2 && a2.branch === branch) usedTeachers.add(a2.teacherId);
            }
          }

          // Ã–ncelikli olarak henÃ¼z kullanÄ±lmamÄ±ÅŸ Ã¶ÄŸretmenleri listele
          const preferred = allCandidates.filter(t => !usedTeachers.has(t.id));
          const candidateList = preferred.length > 0 ? preferred : allCandidates;

          shuffle(candidateList);

          for (const t of candidateList) {
            if (!canUse(gGrid, tGrid, gid, t.id, d, s)) continue;

            const a = { group: gid, day: d, slot: s, branch, teacherId: t.id };
            (gGrid[gid] ||= makeGrid(D, S))[d][s] = a;
            (tGrid[t.id] ||= makeGrid(D, S))[d][s] = a;

            const idx = needArr.indexOf(branch);
            if (idx > -1) needArr.splice(idx, 1);

            placedCount++;
            placedHere = true;
            break;
          }
          if (placedHere) break;
        }
      }

      if ((performance.now() - startTime) >= TIME_LIMIT_MS) break;
    }

    const solution = [];
    for (const a of fixed) solution.push({...a});
    for (const gid of Object.keys(gGrid)) {
      for (let d=0; d<D; d++) {
        for (let s=0; s<S; s++) {
          const a = gGrid[gid][d][s];
          if (!a) continue;
          if (!gGridBase[gid]?.[d]?.[s]) solution.push(a);
        }
      }
    }

    if (placedCount > bestScore) {
      bestScore = placedCount;
      bestSolution = solution;
      if (bestScore === remainingNeedsCount) break;
    }
  }

  // En iyi sonucu uygula
    if (bestSolution) {
      const seen = new Set();
      const merged = [];
      for (const a of bestSolution) {
        const k = keyCell(a.group, a.day, a.slot);
        if (seen.has(k)) continue;
        seen.add(k);
        merged.push({group:a.group, day:a.day, slot:a.slot, branch:a.branch, teacherId:a.teacherId});
      }
      state.assignments = merged;
    }

    /**
     * Fill any remaining unassigned course requests using a backtracking search.
     *
     * After the greedy/random phase above, there may still be unmet requests
     * for some group/branch combinations. This helper builds the current
     * assignment grids and then attempts to place the remaining requests
     * deterministically. It explores available time slots and candidate
     * teachers for each outstanding (group, branch) pair in a depthâ€‘first
     * manner. If a complete placement is found, the new assignments are
     * appended to state.assignments. Otherwise, the existing assignments are
     * left untouched.
     */
    function fillRemainingAssignments() {
      // Build grids based off the current assignments
      const gGrid = {};
      const tGrid = {};
      const ensureGrid = (mat, id) => (mat[id] ||= Array.from({ length: D }, () => Array(S).fill(null)));
      for (const a of state.assignments) {
        ensureGrid(gGrid, a.group)[a.day][a.slot] = a;
        ensureGrid(tGrid, a.teacherId)[a.day][a.slot] = a;
      }

      // Build a list of outstanding tasks: one entry for each unmet request
      const tasks = [];
      for (const g of Object.values(state.groups)) {
        const req = state.requests[g.id] || {};
        // Count existing assignments per branch for this group
        const have = {};
        for (const a of state.assignments) {
          if (a.group === g.id) have[a.branch] = (have[a.branch] || 0) + 1;
        }
        for (const [b, cnt] of Object.entries(req)) {
          const needed = Math.max(0, (cnt | 0) - (have[b] || 0));
          for (let i = 0; i < needed; i++) tasks.push({ group: g.id, branch: b });
        }
      }
      if (tasks.length === 0) return; // nothing to place

      // Helper to compute candidate placements for a task
      function getCandidates(task) {
        const { group: gid, branch } = task;
        const candidates = [];
        for (let d = 0; d < D; d++) {
          for (let s = 0; s < S; s++) {
            // group availability and no assignment in this slot
            if (state.availability.groups[gid]?.[d]?.[s] !== true) continue;
            if (gGrid[gid]?.[d]?.[s]) continue;
            // avoid consecutive same branch for the group
            if (AVOID_SAME_BRANCH_SOFT) {
              const lastB = prevBranchOf(gGrid, gid, d, s);
              if (lastB && lastB === branch) continue;
            }
            // list candidate teachers for this branch at (d,s)
            const teachers = findTeacherOptions(branch)
              .filter(t => state.availability.teachers[t.id]?.[d]?.[s] === true)
              .filter(t => !tGrid[t.id]?.[d]?.[s]);
            if (teachers.length === 0) continue;
            // prefer teachers not already teaching this branch to this group
            const used = new Set();
            const gRows = gGrid[gid] || [];
            for (let dd = 0; dd < D; dd++) {
              const row = gRows[dd] || [];
              for (let ss = 0; ss < S; ss++) {
                const a2 = row[ss];
                if (a2 && a2.branch === branch) used.add(a2.teacherId);
              }
            }
            const pref = teachers.filter(t => !used.has(t.id));
            const finalList = pref.length ? pref : teachers;
            for (const t of finalList) {
              candidates.push({ day: d, slot: s, teacherId: t.id });
            }
          }
        }
        return candidates;
      }

      // Sort tasks by the number of candidate placements (most constrained first)
      tasks.sort((a, b) => getCandidates(a).length - getCandidates(b).length);

      const newAssignments = [];

      function backtrack(index) {
        if (index === tasks.length) return true;
        const task = tasks[index];
        const cand = getCandidates(task);
        // If no placements possible, fail
        if (cand.length === 0) return false;
        // Heuristic: sort candidate placements to use least busy teachers first
        cand.sort((c1, c2) => {
          // count existing classes for teacher in final assignments
          const t1Count = state.assignments.concat(newAssignments).filter(a => a.teacherId === c1.teacherId).length;
          const t2Count = state.assignments.concat(newAssignments).filter(a => a.teacherId === c2.teacherId).length;
          return t1Count - t2Count;
        });
        for (const { day: d, slot: s, teacherId: tid } of cand) {
          // tentative assign
          const assignment = { group: task.group, day: d, slot: s, branch: task.branch, teacherId: tid };
          // mark in grids
          ensureGrid(gGrid, task.group)[d][s] = assignment;
          ensureGrid(tGrid, tid)[d][s] = assignment;
          newAssignments.push(assignment);
          // recurse
          if (backtrack(index + 1)) return true;
          // backtrack: remove
          newAssignments.pop();
          gGrid[task.group][d][s] = null;
          tGrid[tid][d][s] = null;
        }
        return false;
      }

      backtrack(0);
      // append found assignments
      if (newAssignments.length > 0) {
        state.assignments = state.assignments.concat(newAssignments);
      }
    }

    // Attempt to fill any remaining unassigned needs deterministically
    fillRemainingAssignments();

    renderAssignCards();

    // --- Raporu hesapla ve gÃ¶ster ---
    showAutoAssignReport(buildAutoAssignReport(fixed.length));

  // ---------- Rapor yardÄ±mcÄ±larÄ± ----------
  function buildAutoAssignReport(prevCount) {
    const groups = Object.values(state.groups);
    const totalCells = groups.length * D * S;

    let groupAvailableCells = 0;
    for (const g of groups) {
      const mat = state.availability.groups[g.id] || [];
      for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
        if (mat?.[d]?.[s] === true) groupAvailableCells++;
      }
    }
    const blockedByGroup = totalCells - groupAvailableCells;

    const totalAssigned = state.assignments.length;
    const newlyAssigned = totalAssigned - prevCount;

    // Kalan ihtiyaÃ§lar (grup->branÅŸ->sayÄ±)
    const needsLeft = {};
    for (const g of groups) {
      const counts = Object.fromEntries(state.branches.map(b => [b, +(state.requests[g.id]?.[b] || 0)]));
      state.assignments
        .filter(a => a.group === g.id)
        .forEach(a => counts[a.branch] = Math.max(0, (counts[a.branch] || 0) - 1));
      needsLeft[g.id] = counts;
    }

    const emptyDetails = [];
    let emptyCount = 0;
    let reasonStats = { grup_musait_degildi:0, talep_kalmadi:0, ogretmen_yok_veya_mecbur_cakisiyor:0 };

    const isAssigned = (gid,d,s) => state.assignments.some(a => a.group===gid && a.day===d && a.slot===s);

    for (const g of groups) {
      for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
        if (isAssigned(g.id,d,s)) continue;

        emptyCount++;

        if (state.availability.groups[g.id]?.[d]?.[s] !== true) {
          reasonStats.grup_musait_degildi++;
          emptyDetails.push({ group:g.id, day:d, slot:s, reason:'grup_musait_degildi' });
          continue;
        }

        const totalLeft = Object.values(needsLeft[g.id]).reduce((a,b)=>a+b,0);
        if (totalLeft <= 0) {
          reasonStats.talep_kalmadi++;
          emptyDetails.push({
            group:g.id, day:d, slot:s, reason:'talep_kalmadi',
            suggestion:['EtÃ¼t/Ã–dev Ã‡alÄ±ÅŸmasÄ±','Okuma Saati','Rehberlik','Tekrar/Teknik drill']
          });
          continue;
        }

        // Talep var
        const neededBranches = Object.entries(needsLeft[g.id])
          .filter(([,cnt]) => cnt > 0)
          .sort((a,b)=>b[1]-a[1])
          .map(([b]) => b);

        let branchSuggestions = [];
        for (const b of neededBranches) {
          const teachers = findTeacherOptions(b)
            .filter(t => state.availability.teachers[t.id]?.[d]?.[s] === true)
            .filter(t => !state.assignments.some(a => a.teacherId===t.id && a.day===d && a.slot===s))
            .map(t => t.name);
          if (teachers.length) branchSuggestions.push({branch:b, teachers: teachers.slice(0,3)});
        }

        if (branchSuggestions.length === 0) {
          // Ã‡AKIÅMA/ATANAMADI â†’ branÅŸ fark etmeksizin boÅŸta Ã¶ÄŸretmenleri ekle
          reasonStats.ogretmen_yok_veya_mecbur_cakisiyor++;
          emptyDetails.push({
            group:g.id, day:d, slot:s, reason:'ogretmen_yok_veya_mecbur_cakisiyor',
            neededBranches,                       // [en Ã§ok ihtiyaÃ§, ...]
            freeTeachers: listFreeTeachersAt(d,s) // [{id,name,branches}]
          });
        } else {
          emptyDetails.push({
            group:g.id, day:d, slot:s, reason:'uygun_kombo_var_ama_yerlesmedi',
            suggestion: branchSuggestions.slice(0,2)
          });
        }
      }
    }

    return {
      totals: {
        groups: groups.length,
        days: D,
        slotsPerDay: S,
        totalCells,
        blockedByGroup,
        effectiveCapacity: groupAvailableCells,
        totalAssigned,
        newlyAssigned,
        emptyOnAvailable: Math.max(0, groupAvailableCells - totalAssigned),
        emptyAll: emptyCount
      },
      reasons: reasonStats,
      details: emptyDetails
    };
  }

  function showAutoAssignReport(report) {
    let dlg = document.getElementById('dlgAutoAssignReport');
    if (!dlg) {
      dlg = document.createElement('dialog');
      dlg.id = 'dlgAutoAssignReport';
      dlg.style.padding = '16px';
      dlg.style.borderRadius = '14px';
      dlg.style.maxWidth = '1200px';              // geniÅŸletildi
      dlg.style.width = 'min(98vw, 1200px)';      // geniÅŸletildi
      dlg.innerHTML = `
        <header style="font-weight:800;font-size:18px;margin-bottom:8px">ğŸ§¾ Otomatik Atama Raporu</header>
        <section id="autoAssignReportBody" style="max-height:60vh;overflow:auto"></section>
        <footer style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="btnRptCopy" class="btn ghost">Metni Kopyala</button>
          <button id="btnRptClose" class="btn">Kapat</button>
        </footer>
      `;
      document.body.appendChild(dlg);
      dlg.querySelector('#btnRptClose').onclick = () => dlg.close();
      dlg.querySelector('#btnRptCopy').onclick = () => {
        const txt = dlg.querySelector('#autoAssignReportBody').innerText;
        navigator.clipboard?.writeText(txt);
      };

      // Event delegation: Ã¶ÄŸretmen seÃ§imi -> branÅŸlarÄ± filtrele
      const bodyEl = dlg.querySelector('#autoAssignReportBody');
      bodyEl.addEventListener('change', (e) => {
        if (!e.target.matches('.sel-teacher')) return;
        const li = e.target.closest('li.conflict-row');
        if (!li) return;
        const selB = li.querySelector('select.sel-branch');
        const teacherBranches = (e.target.selectedOptions?.[0]?.dataset.branches || '').split('|').filter(Boolean);
        const needed = (li.dataset.needed || '').split('|').filter(Boolean);

        let options = teacherBranches.filter(b => needed.includes(b));
        let suffix = '';
        if (options.length === 0) { options = teacherBranches.slice(); suffix = ' (ihtiyaÃ§ dÄ±ÅŸÄ±)'; }
        if (options.length === 0) { options = state.branches?.slice?.() || []; suffix = ' (tanÄ±msÄ±z)'; }

        selB.innerHTML = options.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b+suffix)}</option>`).join('');
      });

      // Event delegation: "Ata"
      bodyEl.addEventListener('click', (e) => {
        if (!e.target.matches('.btn-assign-free')) return;
        const li = e.target.closest('li.conflict-row');
        if (!li) return;

        const gid = li.dataset.gid;
        const d = +li.dataset.day;
        const s = +li.dataset.slot;
        const selT = li.querySelector('select.sel-teacher');
        const selB = li.querySelector('select.sel-branch');

        const tid = selT?.value;
        let branch = selB?.value || '';

        if (!tid) { alert('LÃ¼tfen Ã¶ÄŸretmen seÃ§iniz.'); return; }
        if (!branch) {
          const tBranches = (selT.selectedOptions?.[0]?.dataset.branches || '').split('|').filter(Boolean);
          const needed = (li.dataset.needed || '').split('|').filter(Boolean);
          const inter = tBranches.filter(b => needed.includes(b));
          branch = inter[0] || tBranches[0] || state.branches?.[0] || 'GENEL';
        }

        const ok = performManualAssign(gid, d, s, tid, branch);
        if (!ok) return;

        const base = +(dlg.dataset.baseAssigned || state.assignments.length);
        const refreshed = buildAutoAssignReport(base);
        renderReportBody(refreshed); // modal aÃ§Ä±k kalÄ±r
      });
    }

    renderReportBody(report);
    if (!dlg.open) dlg.showModal();

    // Ä°Ã§erik render'Ä±
    function renderReportBody(rep) {
      const el = document.querySelector('#dlgAutoAssignReport #autoAssignReportBody');
      const t = rep.totals, r = rep.reasons;

      if (!dlg.dataset.baseAssigned) dlg.dataset.baseAssigned = String(t.totalAssigned);

      const fmtSlot = (d,s) => {
        const day = state.program.days[d];
        const lbl = state.program.slotLabels?.[s] || `${s+1}. saat`;
        return `${day} â€¢ ${lbl}`;
      };

      const topBranchSuggestions = rep.details
        .filter(x => x.reason === 'uygun_kombo_var_ama_yerlesmedi')
        .slice(0, 10)
        .map(x => {
          const br = x.suggestion[0];
          const teacherList = Array.isArray(br?.teachers) ? br.teachers.join(', ') : '';
          return `<li><b>${escapeHtml(String(x.group))}</b> â€” ${escapeHtml(fmtSlot(x.day,x.slot))} â†’ <b>${escapeHtml(br.branch)}</b> (${escapeHtml(teacherList)})</li>`;
        }).join('');

      // Ã‡akÄ±ÅŸan slotlar iÃ§in interaktif liste + Ä°HTÄ°YAÃ‡ DERS ADI (yalnÄ±z isim)
      const conflictRows = rep.details
        .filter(x => x.reason === 'ogretmen_yok_veya_mecbur_cakisiyor')
        .slice(0, MAX_CONFLICT_ROWS_IN_UI)
        .map(x => {
          const teacherOpts = (x.freeTeachers||[])
            .map(t => {
              const branches = (t.branches || []).map(b => String(b)).join('|');
              const label = `${t.name || t.id}${t.branches?.length ? ' ('+t.branches.join(', ')+')' : ''}`;
              return `<option value="${escapeHtml(String(t.id))}" data-branches="${escapeAttr(branches)}">${escapeHtml(label)}</option>`;
            }).join('');
          const neededPipe = (x.neededBranches||[]).map(b => String(b)).join('|');

          const firstTeacherBranches = (x.freeTeachers?.[0]?.branches || []).map(b => String(b));
          const interDefault = firstTeacherBranches.filter(b => (x.neededBranches||[]).includes(b));
          const defaultBranchOpts = (interDefault.length ? interDefault : firstTeacherBranches)
            .map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b + (interDefault.length ? '' : ' (ihtiyaÃ§ dÄ±ÅŸÄ±)'))}</option>`)
            .join('') || `<option value="">(branÅŸ yok)</option>`;

          const topNeed = (x.neededBranches && x.neededBranches[0]) ? String(x.neededBranches[0]) : '';

          return `
            <li class="conflict-row" data-gid="${escapeAttr(String(x.group))}" data-day="${x.day}" data-slot="${x.slot}" data-needed="${escapeAttr(neededPipe)}" style="margin:6px 0">
              <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between">
                <div style="display:flex;gap:8px;align-items:center;min-width:300px">
                  <div><b>${escapeHtml(String(x.group))}</b> â€” ${escapeHtml(fmtSlot(x.day,x.slot))}</div>
                  ${topNeed ? `<span class="need-chip" title="Ä°htiyaÃ§" style="padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;line-height:1.6">${escapeHtml(topNeed)}</span>` : ``}
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
                  <label>Ã–ÄŸretmen:
                    <select class="sel-teacher" style="min-width:220px">
                      <option value="">SeÃ§iniz</option>
                      ${teacherOpts}
                    </select>
                  </label>
                  <label>BranÅŸ:
                    <select class="sel-branch" style="min-width:160px">
                      ${defaultBranchOpts}
                    </select>
                  </label>
                  <button class="btn btn-assign-free">Ata</button>
                </div>
              </div>
            </li>`;
        }).join('');

      el.innerHTML = `
        <div class="grid" style="gap:8px">
          <div class="pill">Toplam Atama: <b>${t.totalAssigned}</b> â€¢ Bu oturumda yeni: <b>${t.newlyAssigned}</b></div>
          <div class="pill">Etkin Kapasite (grup mÃ¼sait): <b>${t.effectiveCapacity}</b> â€¢ BoÅŸ (etkin): <b>${t.emptyOnAvailable}</b></div>
          <div class="pill">Bloklu (grup mÃ¼sait deÄŸil): <b>${t.blockedByGroup}</b> â€¢ TÃ¼m BoÅŸ: <b>${t.emptyAll}</b></div>

          <div class="card">
            <h3>Sebep KÄ±rÄ±lÄ±mÄ±</h3>
            <ul style="margin:6px 0 0 18px">
              <li>Grup mÃ¼sait deÄŸildi: <b>${r.grup_musait_degildi}</b></li>
              <li>Talep kalmadÄ±: <b>${r.talep_kalmadi}</b></li>
              <li>Ã–ÄŸretmen yok / mecbur Ã§akÄ±ÅŸÄ±yor: <b>${r.ogretmen_yok_veya_mecbur_cakisiyor}</b></li>
            </ul>
          </div>

          <div class="card">
            <h3>BoÅŸ Slotlar iÃ§in BranÅŸa Uygun Ã–neriler (Ä°lk 10)</h3>
            ${topBranchSuggestions ? `<ol style="margin:6px 0 0 18px">${topBranchSuggestions}</ol>`
                                   : `<div class="muted">Bu turda branÅŸ bazlÄ± eÅŸleÅŸme Ã¶nerisi oluÅŸmadÄ±.</div>`}
          </div>

          <div class="card">
            <h3>Atanamayan (Ã‡akÄ±ÅŸma) Slotlar: BranÅŸ Farketmez Ã–ÄŸretmen SeÃ§â€“Ata</h3>
            ${conflictRows ? `<ol style="margin:6px 0 0 18px">${conflictRows}</ol>`
                           : `<div class="muted">Ã‡akÄ±ÅŸma kaynaklÄ± atanamayan slot kalmadÄ±.</div>`}
            <div class="muted" style="margin-top:6px">Not: Ã–ÄŸretmen/branÅŸ seÃ§ip <b>Ata</b> dediÄŸinizde modal kapanmadan liste gÃ¼ncellenir.</div>
          </div>
        </div>
      `;
    }
  }

  // Mini utils â€” XSS'e karÅŸÄ± kaÃ§Ä±ÅŸ
  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }
  function escapeAttr(s) { return escapeHtml(s).replaceAll('"','&quot;'); }
}
const exportAssgn = ()=>download('atamalar.json', state.assignments);
const importAssgn = obj=>{
  if(!Array.isArray(obj)) return alert('GeÃ§ersiz atamalar JSON.');
  state.assignments = obj;
  reconcileAllToProgram(getAssignPolicy());
  renderAssignCards();
};

/*
 * Birden Ã§ok otomatik atama Ã§alÄ±ÅŸtÄ±rarak mÃ¼mkÃ¼n olan en iyi yerleÅŸimi elde etmek iÃ§in
 * sarmalayÄ±cÄ± fonksiyon. KullanÄ±cÄ± dÃ¼ÄŸmesine baÄŸlanÄ±r ve `autoAssign()` fonksiyonunu
 * art arda Ã§aÄŸÄ±rÄ±r. Her Ã§aÄŸrÄ±dan sonra kalan ihtiyaÃ§larÄ± hesaplar ve hedef tÃ¼m
 * talepler karÅŸÄ±lanÄ±ncaya kadar veya `maxAttempts` kadar denemeye devam eder.
 * BÃ¶ylece kullanÄ±cÄ± manuel olarak aynÄ± dÃ¼ÄŸmeye birkaÃ§ kez tÄ±klamak zorunda kalmaz.
 */
function doAutoAssign(maxAttempts = 3) {
  let attempts = 0;
  while (attempts < maxAttempts) {
    autoAssign();
    // Kalan ihtiyaÃ§larÄ± hesapla: her grup iÃ§in talep edilen derslerden atananlar Ã§Ä±kartÄ±lÄ±r
    let remaining = 0;
    for (const g of Object.values(state.groups)) {
      const req = state.requests[g.id] || {};
      // Mevcut atamalar iÃ§inde bu gruba ait ders sayÄ±sÄ±
      const have = {};
      state.assignments.filter(a => a.group === g.id).forEach(a => {
        have[a.branch] = (have[a.branch] || 0) + 1;
      });
      for (const [b, cnt] of Object.entries(req)) {
        const need = Math.max(0, (cnt | 0) - (have[b] || 0));
        remaining += need;
      }
    }
    // TÃ¼m ihtiyaÃ§lar karÅŸÄ±landÄ±ysa dÃ¶ngÃ¼den Ã§Ä±k
    if (remaining === 0) break;
    attempts++;
  }
}

/* ===== 6) YazdÄ±r ===== */
function hasAnyAssignments(){ return state.assignments && state.assignments.length>0; }
function refreshPrintFilters(){
  const mode = $("#printMode").value;
  const sel = $("#printFilter"); sel.innerHTML='';
  if(mode==='group'){
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(TÃ¼m Gruplar)'; sel.appendChild(opt0);
    Object.values(state.groups).sort(groupComparator).forEach(g=>{
      const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
    });
  }else{
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(TÃ¼m Ã–ÄŸretmenler)'; sel.appendChild(opt0);
    state.teachers.forEach(t=>{
      const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} â€” ${t.branch}`; sel.appendChild(opt);
    });
  }
}
function renderPrintPreview(){
  const div = $("#printPreview"); div.innerHTML='';
  const mode = $("#printMode").value;
  const filter = $("#printFilter").value;
  const S = state.program.slots, days = state.program.days, labels = state.program.slotLabels || [];

  if(!hasAnyAssignments()){
    div.innerHTML = '<div class="muted">Atama yok. Ã–nce atama yapÄ±n.</div>';
    $("#btnPrint").disabled = true; return;
  }
  $("#btnPrint").disabled = false;

  const hdr = document.createElement('div'); hdr.className='print-header';
  hdr.innerHTML = `<h2>Fenomen Ã‡ocuk KulÃ¼bÃ¼ â€” ${mode==='group'?'Grup':'Ã–ÄŸretmen'} Ders PlanÄ±</h2>`;
  div.appendChild(hdr);

  if(mode==='group'){
    const groups = (filter ? [state.groups[filter]] : Object.values(state.groups))
      .filter(Boolean)
      .filter(g=>state.assignments.some(a=>a.group===g.id))
      .sort(groupComparator);

    groups.forEach(g=>{
      const aForG = state.assignments.filter(a=>a.group===g.id);
      const daysWith = Array.from(new Set(aForG.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // Ã–ÄŸrenciler â€“ iki sÃ¼tun ğŸ‘¤
      const students = state.students.filter(st=>st.group===g.id).map(s=>s.name);
      const title = document.createElement('div'); title.className='print-sub';
      title.innerHTML = `<b>${g.name}</b> â€¢ Ã–ÄŸrenciler:`;
      wr.appendChild(title);

      const stCol = document.createElement('div'); stCol.className='students-2col';
      const ul = document.createElement('ul');
      students.forEach(n=>{
        const li=document.createElement('li'); li.innerHTML=`ğŸ‘¤ ${n}`; ul.appendChild(li);
      });
      stCol.appendChild(ul); wr.appendChild(stCol);

      // Tablo â€“ ortalÄ± Ã¶ÄŸretmen isimleri
      const t = document.createElement('table'); t.className='print-table tight';
      const thead = `<tr><th>GÃ¼n / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      days.forEach((d,di)=>{
        let row=`<tr><td><b>${days[di]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForG.find(x=>x.day===di && x.slot===s);
          const txt = a ? `<div style="text-align:center"><b>${a.branch}</b><br/>ğŸ‘¤ ${state.teachers.find(t=>t.id===a.teacherId)?.name||''}</div>` : '';
          row += `<td>${txt}</td>`;
        }
        row+='</tr>'; body+=row;
      });
      t.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(t);

      page.appendChild(wr); div.appendChild(page);
    });

  } else {
    const teachers = (filter ? [state.teachers.find(t=>t.id===filter)] : state.teachers)
      .filter(Boolean)
      .filter(t=>state.assignments.some(a=>a.teacherId===t.id));

    teachers.forEach(t=>{
      const aForT = state.assignments.filter(a=>a.teacherId===t.id);
      const daysWith = Array.from(new Set(aForT.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // Ãœst tablo â€” Ã¶ÄŸretmene gÃ¶re, ortalÄ±
      const tTbl = document.createElement('table'); tTbl.className='print-table tight';
      const thead = `<tr><th colspan="${S+1}" style="text-align:center">${t.name} â€” ${t.branch}</th></tr>
                     <tr><th>GÃ¼n / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      daysWith.forEach(d=>{
        let row=`<tr><td><b>${days[d]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForT.find(x=>x.day===d && x.slot===s);
          row += a ? `<td style="text-align:center"><b>${a.branch}</b><br/>Grup: ${state.groups[a.group]?.name||''}</td>` : `<td></td>`;
        }
        row+='</tr>'; body+=row;
      });
      tTbl.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(tTbl);

      // Yoklama bloklarÄ± â€” her grup iÃ§in kÃ¼Ã§Ã¼k tablo
      const groupsForT = Array.from(new Set(aForT.map(a=>a.group))).map(gid=>state.groups[gid]).filter(Boolean).sort(groupComparator);
      groupsForT.forEach(g=>{
        const blockTitle = document.createElement('div'); blockTitle.className='print-sub';
        blockTitle.innerHTML = `<b>${g.name}</b> â€¢ Ã–ÄŸrenci Yoklama`;
        wr.appendChild(blockTitle);

        const att = document.createElement('table'); att.className='att-table';
        att.innerHTML = `<thead>
            <tr><th>ğŸ‘¤ Ã–ÄŸrenci</th><th>Geldi</th><th>Gelmedi</th><th>GeÃ§ Geldi</th><th>Ä°zinli</th></tr>
          </thead><tbody></tbody>`;
        const tbody = att.querySelector('tbody');
        state.students.filter(s=>s.group===g.id).forEach(st=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${st.name}</td><td>â–¡</td><td>â–¡</td><td>â–¡</td><td>â–¡</td>`;
          tbody.appendChild(tr);
        });
        wr.appendChild(att);
      });

      page.appendChild(wr); div.appendChild(page);
    });
  }
}

/* ===== Olaylar ===== */
$("#btnFetch").onclick = fetchAll;
$("#btnClear").onclick = ()=>{
  state.teachers=[]; state.students=[]; state.groups={}; state.branches=[];
  renderTeachers(); renderStudents(); renderGroupSummary();
  $("#readStatus").textContent='Temizlendi.';
  reconcileAllToProgram(getAssignPolicy());
};

$("#btnBuildGrid").onclick = ()=>{ buildProgramGrid(false); renderSlotLabels(); };
$("#btnProgExport").onclick = ()=>download('ders-programi.json', state.program);
$("#btnProgImport").onclick = ()=>openFile($("#fileProgImport"), obj=>{
  if(!obj || !Array.isArray(obj.days) || typeof obj.slots!=='number') return alert('GeÃ§ersiz program JSON.');
  state.program = obj; if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels=[];
  $("#daysInput").value = obj.days.join(','); $("#slotsInput").value = obj.slots;
  buildProgramGrid(true); renderSlotLabels();
  reconcileAllToProgram(getAssignPolicy());
  renderAvailGrids(); renderAssignCards(); refreshPrintFilters();
});

$("#btnAvailExport").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport").onclick = ()=>openFile($("#fileAvailImport"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('GeÃ§ersiz mÃ¼saitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});
$("#btnAvailClear").onclick = ()=>{ state.availability={teachers:{},groups:{}}; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); };
$("#btnAvailExport2").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport2").onclick = ()=>openFile($("#fileAvailImport2"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('GeÃ§ersiz mÃ¼saitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});

$("#goto2").onclick = ()=> showTopTab('step2');
$("#goto3").onclick = ()=> showTopTab('step3');
$("#goto4").onclick = ()=> showTopTab('step4');
$("#goto5").onclick = ()=> showTopTab('step5');
$("#goto6").onclick = ()=> showTopTab('step6');

$("#btnReqExport").onclick = exportReq;
$("#btnReqImport").onclick = ()=>openFile($("#fileReqImport"), importReq);
$("#btnReqClear").onclick = ()=>{ state.requests={}; renderRequests(); };
$("#reqGroupSelect").onchange = renderRequests;

// Otomatik Atama dÃ¼ÄŸmesi birden fazla deneme yapacak ÅŸekilde sarmalayÄ±cÄ±yÄ± Ã§aÄŸÄ±rÄ±r.
$("#btnAutoAssign").onclick = () => doAutoAssign();
$("#btnAssgnExport").onclick = exportAssgn;
$("#btnAssgnImport").onclick = ()=>openFile($("#fileAssgnImport"), importAssgn);
$("#btnAssgnClear").onclick = ()=>{ state.assignments=[]; renderAssignCards(); };

$("#printMode").onchange = ()=> { refreshPrintFilters(); renderPrintPreview(); };
$("#btnRenderPrint").onclick = renderPrintPreview;

// Yerel kaydet/yÃ¼kle fonksiyonlarÄ± kaldÄ±rÄ±ldÄ±; Firebase tabanlÄ± iÅŸlemler eklenecek

/* Alt sekmeler (MÃ¼saitlik) */
function showAvailTab(which){
  const teachActive = which==='teach';
  $("#panelTeach").toggleAttribute('hidden', !teachActive);
  $("#panelGroup").toggleAttribute('hidden', teachActive);
  $("#tabTeach").setAttribute('aria-selected', String(teachActive));
  $("#tabGroup").setAttribute('aria-selected', String(!teachActive));
}
$("#tabTeach").addEventListener('click', ()=>showAvailTab('teach'));
$("#tabGroup").addEventListener('click', ()=>showAvailTab('group'));

/* BaÅŸlangÄ±Ã§ */
bindTopTabs();
buildProgramGrid(true);
renderSlotLabels();
showTopTab('step1');
</script>
  
<script>
  function computeBranchTeacherCapacity(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const caps = Object.fromEntries(state.branches.map(b => [b, 0]));

  // neden: branÅŸ eÅŸleÅŸen her Ã¶ÄŸretmenin tÃ¼m true hÃ¼creleri ayrÄ± kapasitedir (eÅŸzamanlÄ± sÄ±nÄ±flar)
  state.teachers.forEach(t => {
    const b = t.branch;
    const mat = state.availability.teachers[t.id] || [];
    for (let d = 0; d < D; d++){
      const row = mat[d] || [];
      for (let s = 0; s < S; s++){
        if (row[s] === true) caps[b] = (caps[b] || 0) + 1;
      }
    }
  });
  return caps;
}

// === BranÅŸ bazlÄ± toplam talepler (tÃ¼m gruplarÄ±n toplam talebi) ===
function computeBranchRequestsTotal(){
  const totals = Object.fromEntries(state.branches.map(b => [b, 0]));
  Object.values(state.requests || {}).forEach(reqByBranch => {
    state.branches.forEach(b => {
      totals[b] += +(reqByBranch?.[b] || 0);
    });
  });
  return totals;
}

// === BaÅŸlÄ±k altÄ± Ã¶zet rozetler: {branÅŸ}: Kalan/Toplam (Kalan = Kapasite - Talep) ===
// === BaÅŸlÄ±k altÄ± Ã¶zet rozetler: {branÅŸ}: Kalan/Toplam (Kalan = Kapasite - Talep) ===
function renderBranchChipsSummary(){
  const host = document.getElementById('branchChips');
  if(!host) return;
  host.innerHTML = '';

  const caps = computeBranchTeacherCapacity();
  const reqs = computeBranchRequestsTotal();

  state.branches.forEach(b => {
    const total = caps[b] || 0;
    const used = reqs[b] || 0;
    const left = Math.max(0, total - used);

    const chip = document.createElement('span');
    chip.className = 'pill' + (left <= 0 && total > 0 ? ' bad' : '');
    chip.textContent = `${b} â€” ${left}/${total} mÃ¼sait`;
    host.appendChild(chip);
  });
}

</script>
<script>
/* ==== BaÄŸÄ±msÄ±z: sÄ±nÄ±f gruplarÄ± (5-8) iÃ§in tam liste yazdÄ±r ==== */
// Bu fonksiyon, atanmÄ±ÅŸ gruplarÄ±n sÄ±nÄ±f dÃ¼zeylerine gÃ¶re (5, 6, 7, 8) kompakt bir
// tablo halinde yazdÄ±rÄ±lmasÄ±nÄ± saÄŸlar. EÄŸer ilgili sÄ±nÄ±f dÃ¼zeyi iÃ§in grup ve
// atama yoksa o sayfa oluÅŸturulmaz. Her sÄ±nÄ±f bÃ¶lÃ¼mÃ¼ yeni bir sayfada baÅŸlar.
(function injectPrintAllButton(){
  const host = document.querySelector('#step6 .row.no-print');
  if (!host || document.getElementById('btnPrintAll')) return;
  const btn = document.createElement('button');
  btn.id = 'btnPrintAll';
  btn.className = 'btn warn';
  btn.textContent = 'TÃ¼m listeyi yazdÄ±r';
  // DeÄŸiÅŸtirilen fonksiyon Ã§aÄŸrÄ±sÄ±: tÃ¼m sÄ±nÄ±flar iÃ§in liste yazdÄ±rÄ±lÄ±r
  btn.addEventListener('click', printAllGrades);
  host.appendChild(btn);
})();

/**
 * AtanmÄ±ÅŸ gruplarÄ± 5, 6, 7 ve 8. sÄ±nÄ±f dÃ¼zeylerine gÃ¶re yazdÄ±rÄ±r. Her bir sÄ±nÄ±f
 * bÃ¶lÃ¼mÃ¼ yeni bir sayfada baÅŸlar. EÄŸer bir sÄ±nÄ±fa ait grup yoksa veya o sÄ±nÄ±f
 * iÃ§in atama bulunmuyorsa, o bÃ¶lÃ¼m atlanÄ±r.
 */
function printAllGrades() {
  const hasAny = Array.isArray(state.assignments) && state.assignments.length > 0;
  if (!hasAny) { alert('Atama yok. Ã–nce atama yapÄ±n.'); return; }

  const days   = state.program?.days || ["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"];
  const S      = +state.program?.slots || 8;
  const labels = Array.isArray(state.program?.slotLabels) ? state.program.slotLabels : [];

  const esc = s => String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');

  // Belirli bir sÄ±nÄ±f dÃ¼zeyine ait, atamasÄ± yapÄ±lmÄ±ÅŸ gruplarÄ± getirir
  const byGrade = (grade) => Object.values(state.groups || {})
    .filter(g => (parseGroupName(g.name || g.id || '')?.grade === grade))
    .filter(g => state.assignments.some(a => a.group === g.id))
    .sort(groupComparator);

  // YazdÄ±rma penceresini oluÅŸtur
  const w = window.open('', '_blank');
  const css = `
    @page { size: A4; margin: 8mm; }
    * { box-sizing: border-box; }
    body { font: 11px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; color:#0a0a0a; }
    h1 { font-size: 16px; margin: 0 0 6px; text-align:center; font-weight:800; }
    h2 { font-size: 13px; margin: 8px 0 6px; font-weight:800; border-bottom:1px solid #ddd; padding-bottom:3px; }
    .grade-section + .grade-section { break-before: page; page-break-before: always; }
    .group-block { margin: 6px 0 10px; page-break-inside: avoid; }
    .g-head { font-weight:700; margin-bottom:4px; }
    .students { font-weight: 500; color:#374151; }
    table { width:100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border:1px solid #dcdcdc; padding: 2px 4px; vertical-align: top; }
    th { background:#f3f4f6; font-weight:700; text-align:center; }
    td.day { white-space:nowrap; font-weight:700; }
    .mini { font-size: 10px; color:#374151; }
    .tight th, .tight td { padding: 2px 4px; }
    .grade-badge { display:inline-block; padding:2px 8px; border-radius:8px; background:#eef2ff; color:#1e3a8a; font-weight:800; }
    .muted { color:#6b7280; }
    th,td { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  `;

  w.document.write(`<!DOCTYPE html><html lang="tr"><head>
    <meta charset="utf-8">
    <title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ birebir ve Grup Listesi</title>
     </head><body>`);

  w.document.write(`<h1>Fenomen Ã‡ocuk KulÃ¼bÃ¼ birebir ve Grup Listesi</h1>`);

  // BaskÄ±ya dahil edilecek sÄ±nÄ±f dÃ¼zeyleri; 5-8 arasÄ±ndaki tÃ¼m sÄ±nÄ±flar
  [5,6,7,8].forEach(grade => {
    const groups = byGrade(grade);
    if (groups.length === 0) return; // Bu sÄ±nÄ±f iÃ§in grup veya atama yoksa atla

    w.document.write(`<section class="grade-section">`);
    w.document.write(`<h2><span class="grade-badge">${grade}. SÄ±nÄ±flar</span></h2>`);

    groups.forEach(g => {
      const aForG = state.assignments.filter(a => a.group === g.id);
      const daysWith = Array.from(new Set(aForG.map(a => a.day))).sort((a,b)=>a-b);
      if (daysWith.length === 0) return;

      const studentNames = (state.students || [])
        .filter(s => s.group === g.id)
        .map(s => esc(s.name));

      w.document.write(`<div class="group-block">`);
      w.document.write(`<div class="g-head">${esc(g.name)} â€” <span class="students">${studentNames.join(', ') || '<span class="muted">Ã¶ÄŸrenci yok</span>'}</span></div>`);

      let thead = `<tr><th style="width:90px">GÃ¼n / Saat</th>${
        Array.from({length:S}, (_,i)=>`<th>${esc(labels[i] || (String(i+1)+'. Ders'))}</th>`).join('')
      }</tr>`;

      let body = '';
      daysWith.forEach(d => {
        let row = `<tr><td class="day">${esc(days[d] || '')}</td>`;
        for (let s=0; s<S; s++) {
          const a = aForG.find(x => x.day === d && x.slot === s);
          if (a) {
            const tname = state.teachers.find(t => t.id === a.teacherId)?.name || '';
            row += `<td><div style="text-align:center"><b>${esc(a.branch)}</b><br><span class="mini">${esc(tname)}</span></div></td>`;
          } else {
            row += `<td></td>`;
          }
        }
        row += `</tr>`;
        body += row;
      });

      w.document.write(`<table class="tight"><thead>${thead}</thead><tbody>${body}</tbody></table>`);
      w.document.write(`</div>`);
    });

    w.document.write(`</section>`);
  });

  w.document.write(`</body></html>`);
  w.document.close();
  w.focus();
  setTimeout(() => { try { w.print(); } catch(_){} }, 50);
}
</script>
<!-- ==== TEACHER PRINT V2 â€“ KOMPAKT, TEK A4 ==== -->

<script>
/* =========================================================
   PRINT: Ã–ÄŸretmen V2 â€” LÃ¼ks TasarÄ±m + 6 slot / sayfa kuralÄ±
   ========================================================= */

/* ==== BUTON EKLE ==== */
(function injectTeacherV2Btn(){
  const host = document.querySelector('#step6 .row.no-print') || document.querySelector('#step6') || document.body;
  if(!host || document.getElementById('btnTeacherV2')) return;
  const btn = document.createElement('button');
  btn.id = 'btnTeacherV2';
  btn.className = 'btn';
  btn.textContent = 'Ã–ÄŸretmene gÃ¶re (Yeni TasarÄ±m)';
  btn.addEventListener('click', ()=> printTeachersV2());
  host.appendChild(btn);
})();

/* ==== YARDIMCILAR ==== */
function mmToPx(mm){
  const el = document.createElement('div');
  el.style.width='1mm'; el.style.position='absolute'; el.style.visibility='hidden';
  document.body.appendChild(el);
  const one = el.getBoundingClientRect().width || 3.78; el.remove();
  return one * mm;
}
function esc(s){
  return String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function getTeacherAssignmentsMap(){
  const map = new Map();
  (state.assignments || []).forEach(a=>{
    if(!map.has(a.teacherId)) map.set(a.teacherId, []);
    map.get(a.teacherId).push(a);
  });
  return map;
}
function groupBy(arr, keyFn){
  const m = new Map();
  arr.forEach(x=>{
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  });
  return m;
}
function uniq(arr){ return Array.from(new Set(arr)); }

/* ==== SAYFAYI A4'E SIÄDIR ==== */
function fitPageToA4(rootEl){
  const A4H = 297, MARGIN = 12; // mm
  const usableH = mmToPx(A4H - 2*MARGIN);

  // BaÅŸlangÄ±Ã§: yÃ¼kselt â†’ gerekiyorsa kÄ±s
  let font = 12.5, pad = 5;
  const MIN_F = 8, MAX_F = 13.5;
  const apply = ()=>{
    rootEl.style.setProperty('--tpv2-font', font+'px');
    rootEl.style.setProperty('--tpv2-pad', pad+'px');
    rootEl.style.setProperty('--tpv2-gap', Math.max(6, Math.round(font*0.75))+'px');
  };
  font = Math.min(MAX_F, font); pad = Math.max(2, Math.round(font*0.36)); apply();

  if(rootEl.scrollHeight > usableH){
    let guard = 50;
    while(rootEl.scrollHeight > usableH && font > MIN_F && guard--){
      font -= 0.5; pad = Math.max(1, Math.round(font*0.33)); apply();
    }
  }else{
    let guard = 20;
    while(rootEl.scrollHeight < usableH*0.96 && font < MAX_F && guard--){
      font += 0.5; pad = Math.max(2, Math.round(font*0.36)); apply();
      if(rootEl.scrollHeight > usableH){ font -= 0.5; pad = Math.max(1, Math.round(font*0.33)); apply(); break; }
    }
  }
}

/* ==== YardÄ±m: veriler ==== */
const getGroup = id => (state.groups || {})[id] || { id, name:id };
const getTeacher = id => (state.teachers || []).find(t=>t.id===id) || { id, name:'-' };

/* ==== HTML Ã¼reticiler ==== */
function renderSchedTableForWindow(days, labels, byDay, S, start, end){
  const cols = [];
  for(let s=start; s<end; s++){
    const lab = esc(labels?.[s] || ((s+1)+'. Ders'));
    cols.push(`<th class="slot-head">${lab}</th>`);
  }
  const thead = `
    <thead>
      <tr>
        <th>GÃ¼n / Saat</th>
        ${cols.join('')}
      </tr>
    </thead>
  `;

  const bodyRows = days.map((dName, dIdx)=>{
    const list = byDay.get(dIdx) || [];
    const cells = [];
    for(let s=start; s<end; s++){
      const a = list.find(x=>x.slot===s);
      if(!a){ cells.push('<td></td>'); continue; }
      const g = getGroup(a.group);
      const br = esc(a.branch || '');
      const gname = esc(g.name || g.id);
      const room = g.room ? ` â€¢ ${esc(g.room)}` : '';
      cells.push(`<td><b>${gname}</b><small>${br}${room}</small></td>`);
    }
    return `<tr><td><b>${esc(dName)}</b></td>${cells.join('')}</tr>`;
  }).join('');

  return `<table class="sched">${thead}<tbody>${bodyRows}</tbody></table>`;
}

function renderAttendance(groups, ATT_HEADERS){
  if(groups.length===0) return '';
  const cards = groups.map(g=>{
    const students = (state.students || []).filter(s=>s.group===g.id);
    const rows = (students.length
      ? students.map(st=>`
        <tr>
          <td>${esc(st.name || '')}</td>
          ${ATT_HEADERS.map(()=>'<td>â–¡</td>').join('')}
        </tr>`).join('')
      : `<tr><td colspan="${1+ATT_HEADERS.length}" class="muted">Ã–ÄŸrenci yok</td></tr>`
    );
    return `
      <div class="att-card">
        <div class="g-title">${esc(g.name || g.id)}</div>
        <table class="att">
          <thead>
            <tr>
              <th style="width:46%">Ã–ÄŸrenci</th>
              ${ATT_HEADERS.map(h=>`<th>${esc(h)}</th>`).join('')}
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }).join('');
  return `
    <div class="att-head">Ã–ÄŸrenci Yoklama</div>
    <div class="att-grid">${cards}</div>
  `;
}

/* ==== YENÄ° TASARIM: Ã–ÄRETMENE GÃ–RE YAZDIR ==== */
function printTeachersV2(){
  const asgByTeacher = getTeacherAssignmentsMap();
  if(!asgByTeacher.size){
    alert('Atama yok. Ã–nce atama yapÄ±n.');
    return;
  }

  const days = state.program?.days || ["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"];
  const S = Math.min(12, +state.program?.slots || 8); // 12â€™ye kadar destek
  const labels = Array.isArray(state.program?.slotLabels)
    ? state.program.slotLabels
    : Array.from({length:S},(_,i)=> (i+1)+'. Ders');

  const ATT_HEADERS = ['Var','Yok','GeÃ§','Ä°zin'];

  const w = window.open('', '_blank');
  const baseCSS = Array.from(document.querySelectorAll('style')).map(s=>s.innerHTML).join('\n');

  w.document.write(`<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Ã–ÄŸretmen YazdÄ±r (Yeni)</title>
  </head>
<body class="print-teacher-v2">
</body></html>`);

  const addPage = (html)=> w.document.body.insertAdjacentHTML('beforeend', `<section class="page">${html}</section>`);

  // === YENÄ°: Toplam sayfa ve global sayfa sayacÄ± ===
  const windowsPerTeacher = Math.max(1, Math.ceil(S / 6));              // her Ã¶ÄŸretmene dÃ¼ÅŸen sayfa
  const totalPages = asgByTeacher.size * windowsPerTeacher;              // toplam sayfa
  let pageNo = 0;                                                        // global sayaÃ§

  asgByTeacher.forEach((asgList, tId)=>{
    const t = getTeacher(tId);
    const byDay = groupBy(asgList, a=>a.day);

    // GruplarÄ±, Ã¶ÄŸretmenin haftalÄ±k ders sÄ±rasÄ±na gÃ¶re sÄ±rala (Pazartesi 1. dersten Cuma 4. derse kadar)
    const groupFirstSlot = new Map();
    asgList.forEach(a => {
      const score = a.day * 100 + a.slot;
      const prev = groupFirstSlot.get(a.group);
      if (prev == null || score < prev) groupFirstSlot.set(a.group, score);
    });

    const groups = uniq(asgList.map(a=>a.group))
      .sort((g1, g2) => {
        const k1 = groupFirstSlot.get(g1) ?? 999999;
        const k2 = groupFirstSlot.get(g2) ?? 999999;
        if (k1 !== k2) return k1 - k2;
        const n1 = (state.groups?.[g1]?.name || g1);
        const n2 = (state.groups?.[g2]?.name || g2);
        return String(n1).localeCompare(String(n2), 'tr');
      })
      .map(getGroup);

    const windows = windowsPerTeacher;
    for(let wIx=0; wIx<windows; wIx++){
      const start = wIx*6;
      const end   = Math.min(start+6, S);

      const head = `
        <div class="brandbar">
          <div class="org">Fenomen Ã‡ocuk KulÃ¼bÃ¼</div>
          <div class="chip">${++pageNo}. Sayfa / ${totalPages}</div>
        </div>
        <div class="title">Ã–ÄŸretmen Ders PlanÄ±</div>
        <div class="t-meta">
          <div>${esc(t.name)}</div>
          ${t.branch ? `<div class="muted">â€” ${esc(t.branch)}</div>` : ''}
        </div>
      `;

      const sched = renderSchedTableForWindow(days, labels, byDay, S, start, end);

      // Yoklama: tek sayfa ise aynÄ± sayfada; iki sayfa ise 2. sayfada
      const showAttendanceHere = (windows === 1) || (windows > 1 && wIx === windows-1);
      const att = showAttendanceHere ? renderAttendance(groups, ATT_HEADERS) : '';

      const foot = `
        <div class="foot">
          <span class="muted">Ã–ÄŸretmen: ${esc(t.name)}${t.branch?` â€¢ ${esc(t.branch)}`:''}</span>
        </div>
      `;

      addPage(`${head}${sched}${att}${foot}`);
    }
  });

  w.document.close();

  const onReady = ()=>{
    const pages = w.document.querySelectorAll('.print-teacher-v2 .page');
    pages.forEach(pg=> fitPageToA4(pg));
    try{ w.focus(); w.print(); }catch(_){}
  };
  if (w.document.readyState === 'complete') onReady();
  else w.addEventListener('load', onReady);
}

</script>

<!-- Firebase entegrasyonu: program, mÃ¼saitlikler, talepler ve atamalar iÃ§in kaydet/yÃ¼kle/sil iÅŸlemleri -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

// Firebase yapÄ±landÄ±rmasÄ± (kullanÄ±cÄ± tarafÄ±ndan saÄŸlandÄ±)
const firebaseConfig = {
  apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
  authDomain: "odevfeno.firebaseapp.com",
  databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "odevfeno",
  storageBucket: "odevfeno.firebasestorage.app",
  messagingSenderId: "662757516934",
  appId: "1:662757516934:web:0042188832f63deb6fd307",
  measurementId: "G-4Q99NQRB38"
};

// Firebase baÅŸlatma
const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

// Veriyi Firebase Realtime Database'e kaydet
async function saveDataToFirebase(path, data) {
  try {
    await set(ref(db, path), data);
    alert('Firebase kaydedildi.');
  } catch (err) {
    alert('Firebase kayÄ±t hatasÄ±: ' + err.message);
  }
}

// Firebase'den veri yÃ¼kle
async function loadDataFromFirebase(path, callback) {
  try {
    const snapshot = await get(ref(db, path));
    if (snapshot.exists()) {
      callback(snapshot.val());
      alert('Firebase yÃ¼klendi.');
    } else {
      alert('Firebase kayÄ±t bulunamadÄ±.');
    }
  } catch (err) {
    alert('Firebase yÃ¼kleme hatasÄ±: ' + err.message);
  }
}

// Firebase'deki veriyi sil
async function deleteDataFromFirebase(path) {
  try {
    await remove(ref(db, path));
    alert('Firebase silindi.');
  } catch (err) {
    alert('Firebase silme hatasÄ±: ' + err.message);
  }
}

// Program iÃ§in Firebase dÃ¼ÄŸmeleri
const btnProgSaveFb = document.getElementById('btnProgSaveFb');
const btnProgLoadFb = document.getElementById('btnProgLoadFb');
const btnProgDeleteFb = document.getElementById('btnProgDeleteFb');
if (btnProgSaveFb) {
  btnProgSaveFb.addEventListener('click', () => {
    saveDataToFirebase('program', state.program);
  });
}
if (btnProgLoadFb) {
  btnProgLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('program', obj => {
      // 1. Veri kontrolÃ¼
      if (!obj || !Array.isArray(obj.days) || typeof obj.slots !== 'number') {
        alert('GeÃ§ersiz program verisi veya kayÄ±t yok.');
        return;
      }

      // 2. Global state'i gÃ¼ncelle
      // ModÃ¼l iÃ§inden global state'e eriÅŸim iÃ§in window.state veya direkt state kullanÄ±lÄ±r 
      // (1. maddedeki deÄŸiÅŸikliÄŸi yaptÄ±ysanÄ±z)
      state.program = obj;

      // 3. Eksik alt objeleri tamamla (Hata Ã¶nleyici kritik kÄ±sÄ±m)
      if (!state.program.cells) state.program.cells = {};
      if (!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];

      // 4. InputlarÄ± gÃ¼ncelle
      const daysInp = document.getElementById('daysInput');
      const slotsInp = document.getElementById('slotsInput');
      if (daysInp) daysInp.value = obj.days.join(',');
      if (slotsInp) slotsInp.value = obj.slots;

      // 5. Gridleri ve gÃ¶rÃ¼nÃ¼mÃ¼ yenile
      // Global fonksiyonlarÄ± Ã§aÄŸÄ±rÄ±yoruz
      if (typeof buildProgramGrid === 'function') {
        buildProgramGrid(true);
        renderSlotLabels();
        reconcileAllToProgram(getAssignPolicy());
        renderAvailGrids();
        renderAssignCards();
        if (typeof refreshPrintFilters === 'function') refreshPrintFilters();
      }
    });
  });
}
if (btnProgDeleteFb) {
  btnProgDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('program');
  });
}

// MÃ¼saitlik iÃ§in Firebase dÃ¼ÄŸmeleri (Ã¶ÄŸretmen paneli)
const btnAvailSaveFb = document.getElementById('btnAvailSaveFb');
const btnAvailLoadFb = document.getElementById('btnAvailLoadFb');
const btnAvailDeleteFb = document.getElementById('btnAvailDeleteFb');
if (btnAvailSaveFb) {
  btnAvailSaveFb.addEventListener('click', () => {
    saveDataToFirebase('availability', state.availability);
  });
}
if (btnAvailLoadFb) {
  btnAvailLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('availability', obj => {
      if (!obj || !obj.teachers || !obj.groups) {
        alert('GeÃ§ersiz mÃ¼saitlik verisi.');
        return;
      }
      state.availability = obj;
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
    });
  });
}
if (btnAvailDeleteFb) {
  btnAvailDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('availability');
  });
}

// MÃ¼saitlik iÃ§in Firebase dÃ¼ÄŸmeleri (grup paneli) â€“ aynÄ± veriyi kullanÄ±r
const btnAvailSaveFb2 = document.getElementById('btnAvailSaveFb2');
const btnAvailLoadFb2 = document.getElementById('btnAvailLoadFb2');
const btnAvailDeleteFb2 = document.getElementById('btnAvailDeleteFb2');
if (btnAvailSaveFb2) {
  btnAvailSaveFb2.addEventListener('click', () => {
    saveDataToFirebase('availability', state.availability);
  });
}
if (btnAvailLoadFb2) {
  btnAvailLoadFb2.addEventListener('click', () => {
    loadDataFromFirebase('availability', obj => {
      if (!obj || !obj.teachers || !obj.groups) {
        alert('GeÃ§ersiz mÃ¼saitlik verisi.');
        return;
      }
      state.availability = obj;
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
    });
  });
}
if (btnAvailDeleteFb2) {
  btnAvailDeleteFb2.addEventListener('click', () => {
    deleteDataFromFirebase('availability');
  });
}

// Talepler iÃ§in Firebase dÃ¼ÄŸmeleri
const btnReqSaveFb = document.getElementById('btnReqSaveFb');
const btnReqLoadFb = document.getElementById('btnReqLoadFb');
const btnReqDeleteFb = document.getElementById('btnReqDeleteFb');
if (btnReqSaveFb) {
  btnReqSaveFb.addEventListener('click', () => {
    saveDataToFirebase('requests', state.requests);
  });
}
if (btnReqLoadFb) {
  btnReqLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('requests', obj => {
      state.requests = obj || {};
      renderRequests();
    });
  });
}
if (btnReqDeleteFb) {
  btnReqDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('requests');
  });
}

// Atamalar iÃ§in Firebase dÃ¼ÄŸmeleri
const btnAssgnSaveFb = document.getElementById('btnAssgnSaveFb');
const btnAssgnLoadFb = document.getElementById('btnAssgnLoadFb');
const btnAssgnDeleteFb = document.getElementById('btnAssgnDeleteFb');
if (btnAssgnSaveFb) {
  btnAssgnSaveFb.addEventListener('click', () => {
    saveDataToFirebase('assignments', state.assignments);
  });
}
if (btnAssgnLoadFb) {
  btnAssgnLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('assignments', obj => {
      state.assignments = Array.isArray(obj) ? obj : [];
      renderAssignCards();
    });
  });
}
if (btnAssgnDeleteFb) {
  btnAssgnDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('assignments');
  });
}
</script>

</body>
</html>

