<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ â€¢ Grup Ders Planlama</title>
<style>
  /* =========================================
     1. AKILLI DEÄžÄ°ÅžKENLER (SMART VARIABLES)
     ========================================= */
  :root {
    /* Ana Renk Paleti */
    --bg: #f8fafc;
    --panel: #ffffff;
    --ink: #1e293b;
    --muted: #64748b;
    --border: #e2e8f0;
    
    /* Marka ve Aksiyon Renkleri */
    --pri: #2563eb;       /* Ana Mavi */
    --pri-hover: #1d4ed8;
    --pri-light: #eff6ff;
    --sec: #6366f1;       /* Ä°kincil Mor/Mavi */
    --danger: #ef4444;
    --warn: #f59e0b;
    --success: #10b981;
    
    /* Ders (BranÅŸ) Renkleri - Pastel Tonlar */
    --b-mat: #6366f1; /* Matematik */
    --b-fen: #10b981; /* Fen */
    --b-trk: #f97316; /* TÃ¼rkÃ§e */
    --b-sos: #06b6d4; /* Sosyal */
    --b-ing: #8b5cf6; /* Ä°ngilizce */
    --b-din: #ec4899; /* Din */
    
    /* Grid ve BoyutlandÄ±rma */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    
    --slot-min-w: 85px;
    --slot-h: 64px;
  }

  /* =========================================
     2. TEMEL SIFIRLAMA VE TÄ°POGRAFÄ°
     ========================================= */
  html, body { height: 100%; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--ink);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  h1, h2, h3 { margin: 0 0 0.5rem; font-weight: 700; letter-spacing: -0.025em; }
  h1 { font-size: clamp(20px, 2.5vw, 24px); color: #0f172a; }
  h2 { font-size: 18px; color: #334155; }
  h3 { font-size: 15px; font-weight: 600; }

  /* =========================================
     3. BÄ°LEÅžENLER (COMPONENTS)
     ========================================= */
  
  /* Layout */
  .app { max-width: 1800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
  .top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
  .content { background: var(--panel); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 20px; border: 1px solid var(--border); }
  
  /* Buttons */
  .btn {
    appearance: none; border: none; cursor: pointer;
    display: inline-flex; align-items: center; justify-content: center;
    padding: 8px 16px; border-radius: var(--radius-md);
    font-weight: 600; font-size: 13px; transition: all 0.2s;
    background: var(--pri); color: white; box-shadow: var(--shadow-sm);
  }
  .btn:hover { background: var(--pri-hover); transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  
  .btn.sec { background: var(--sec); }
  .btn.ghost { background: white; border: 1px solid var(--border); color: var(--ink); box-shadow: none; }
  .btn.ghost:hover { background: var(--bg); border-color: #cbd5e1; }
  .btn.warn { background: var(--warn); color: #fff; }
  .btn.danger { background: var(--danger); color: white; }
  .btn.xs { padding: 4px 10px; font-size: 11px; border-radius: var(--radius-sm); height: 28px; }

  /* Inputs */
  input, select, textarea {
    padding: 8px 12px; border-radius: var(--radius-md); border: 1px solid var(--border);
    background: #fff; font-size: 13px; color: var(--ink); outline: none; transition: border-color 0.2s;
  }
  input:focus, select:focus { border-color: var(--pri); box-shadow: 0 0 0 3px var(--pri-light); }
  label { display: flex; flex-direction: column; gap: 4px; font-weight: 500; font-size: 12px; color: var(--muted); }

  /* Cards */
  .card {
    background: #fff; border: 1px solid var(--border); border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm); overflow: hidden; display: flex; flex-direction: column;
  }
  .card .flex { padding: 12px; border-bottom: 1px solid var(--border); background: #fbfbfb; display: flex; align-items: center; justify-content: space-between; }
  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); gap: 16px; }

  /* Tabs */
  .tabs { display: flex; gap: 4px; border-bottom: 2px solid var(--border); margin-bottom: 16px; overflow-x: auto; padding-bottom: 2px; }
  .tab {
    padding: 8px 16px; background: transparent; border: none; border-radius: var(--radius-md);
    cursor: pointer; font-weight: 600; color: var(--muted); transition: all 0.2s; white-space: nowrap;
  }
  .tab:hover { background: var(--border); color: var(--ink); }
  .tab[aria-selected="true"] { background: var(--pri-light); color: var(--pri); }
  .tabpanel[hidden] { display: none; }

  /* Chips & Pills */
  .chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .pill {
    display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px;
    background: var(--bg); font-size: 11px; font-weight: 600; color: var(--ink); border: 1px solid var(--border);
  }
  .pill.bad { background: #fef2f2; color: var(--danger); border-color: #fca5a5; }
  .tag { background: var(--border); color: var(--ink); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }

  /* =========================================
     4. K-GRID & K-CELL (MODERN SLOT DESIGN)
     ========================================= */
  .kgrid { display: grid; gap: 8px; padding: 12px; }
  .kgrid[data-cols] { grid-template-columns: 100px repeat(var(--cols), minmax(var(--slot-min-w), 1fr)); }
  
  /* SatÄ±r BaÅŸlÄ±klarÄ± */
  .kgrid > div:first-child, .kgrid > div.busy {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-weight: 700; color: var(--muted); font-size: 12px; text-align: center;
    min-height: var(--slot-h);
  }

  /* Slot HÃ¼cresi - Modern TasarÄ±m */
  .kcell {
    position: relative;
    min-height: var(--slot-h);
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; cursor: pointer; user-select: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 4px; overflow: hidden;
  }
  
  /* Hover Efektleri */
  .kcell:hover:not(.busy) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--pri);
    z-index: 2;
  }

  /* Durumlar (MÃ¼saitlik) */
  .kcell.ok { background: #f0fdf4; border-color: #bbf7d0; color: #15803d; } /* YeÅŸilimsi */
  .kcell.bad { background: #fef2f2; border-color: #fecaca; color: #b91c1c; opacity: 0.8; } /* KÄ±rmÄ±zÄ±msÄ± */
  
  /* AtanmÄ±ÅŸ Ders GÃ¶rÃ¼nÃ¼mÃ¼ (Assigned) */
  .kcell.assigned {
    background: white; border-width: 0 0 0 4px; /* Sol kenar renkli Ã§izgi */
    box-shadow: var(--shadow-sm);
    align-items: stretch; justify-content: flex-start;
    padding: 6px;
  }
  
  .kcell.assigned > div:first-child { /* BranÅŸ Ä°smi */
    font-weight: 800; font-size: 12px; margin-bottom: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .kcell.assigned .mini2 { /* Ã–ÄŸretmen Ä°smi */
    font-size: 10px; font-weight: 500; color: var(--muted);
    display: flex; align-items: center; gap: 4px; justify-content: center;
  }

  /* Dinamik Ders Renklendirmesi (Smart Colors) */
  /* Border-color sol ÅŸerit iÃ§in, background hafif ton */
  .kcell.assigned.mat { border-left-color: var(--b-mat); background: linear-gradient(to right, #eef2ff, #fff 40%); }
  .kcell.assigned.mat > div:first-child { color: var(--b-mat); }

  .kcell.assigned.fen { border-left-color: var(--b-fen); background: linear-gradient(to right, #ecfdf5, #fff 40%); }
  .kcell.assigned.fen > div:first-child { color: var(--b-fen); }

  .kcell.assigned.trk { border-left-color: var(--b-trk); background: linear-gradient(to right, #fff7ed, #fff 40%); }
  .kcell.assigned.trk > div:first-child { color: var(--b-trk); }

  .kcell.assigned.sos { border-left-color: var(--b-sos); background: linear-gradient(to right, #ecfeff, #fff 40%); }
  .kcell.assigned.sos > div:first-child { color: var(--b-sos); }

  .kcell.assigned.ing { border-left-color: var(--b-ing); background: linear-gradient(to right, #f5f3ff, #fff 40%); }
  .kcell.assigned.ing > div:first-child { color: var(--b-ing); }

  .kcell.assigned.din { border-left-color: var(--b-din); background: linear-gradient(to right, #fdf2f8, #fff 40%); }
  .kcell.assigned.din > div:first-child { color: var(--b-din); }

  /* =========================================
     5. YARDIMCILAR VE PRINT
     ========================================= */
  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
  .grid { display: grid; gap: 16px; }
  .wide { width: 100%; }
  .right { margin-left: auto; }
  .hidden { display: none !important; }
  .mini { font-size: 11px; }

  /* Miktar SeÃ§ici (Talepler iÃ§in) */
  .qty { display: flex; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
  .qty button { border: none; background: #f1f5f9; width: 32px; cursor: pointer; font-weight: bold; }
  .qty button:hover { background: #e2e8f0; }
  .qty input { border: none; width: 50px; text-align: center; border-radius: 0; padding: 4px; }

  /* Dialog (Modal) */
  dialog {
    border: none; border-radius: var(--radius-lg); padding: 0;
    box-shadow: var(--shadow-lg); max-width: 500px; width: 90%;
  }
  dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
  dialog header { padding: 16px; background: var(--bg); border-bottom: 1px solid var(--border); font-weight: 700; }
  dialog section { padding: 16px; }
  dialog footer { padding: 12px 16px; background: var(--bg); border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }

  @media print {
    .no-print, .tabs, .btn { display: none !important; }
    .app { max-width: none; padding: 0; }
    .content { box-shadow: none; border: none; padding: 0; }
    body { background: white; -webkit-print-color-adjust: exact; }
    /* Print Tablo stilleri */
    .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
    .print-table th, .print-table td { border: 1px solid #000; padding: 4px; }
    .print-page { break-after: page; page-break-after: always; margin-bottom: 20px; }
    .att-table th { font-size: 8pt; background: #f3f4f6; }
  }
</style>
</head>
<body>

<div class="app">
  <div class="top no-print">
    <div style="display:flex; align-items:center; gap:12px;">
      <div style="width:40px; height:40px; background: linear-gradient(135deg, var(--pri), var(--sec)); border-radius:10px;"></div>
      <div>
        <h1 style="margin:0; font-size:20px;">Fenomen Ã‡ocuk KulÃ¼bÃ¼</h1>
        <div style="font-size:12px; color:var(--muted);">Grup Ders Planlama Sistemi v4.2</div>
      </div>
    </div>
  </div>

  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri KaynaÄŸÄ±</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders ProgramÄ±</button>
    <button class="tab" data-panel="step3" role="tab">3. MÃ¼saitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Talepler</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">YazdÄ±r</button>
  </div>

  <section class="content tabpanel" id="step1" role="tabpanel">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <h2>Veri KaynaÄŸÄ± (Google Sheets)</h2>
      <div class="chips">
        <span class="pill">Ã–ÄŸretmenler</span>
        <span class="pill">Ã–ÄŸrenciler</span>
        <span class="pill">Gruplar</span>
      </div>
    </div>
    
    <div class="row">
      <label style="flex:1;">Spreadsheet ID
        <input type="text" id="sheetId" value="1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg" placeholder="Google Sheet ID" />
      </label>
      <button class="btn" id="btnFetch">Verileri Oku (Fetch)</button>
      <button class="btn ghost" id="btnClear">Temizle</button>
    </div>

    <div id="readStatus" style="margin-bottom:12px; font-weight:600; color:var(--sec);">Durum: Bekleniyor...</div>

    <div class="cards">
      <div class="card">
        <div class="flex"><b>Ã–ÄŸretmenler</b> <span class="tag" id="countT">0</span></div>
        <div style="max-height:200px; overflow:auto;">
           <table id="tblTeachers" style="width:100%; border-collapse:collapse; font-size:12px;">
             <thead><tr style="background:#f1f5f9; text-align:left;"><th>#</th><th>Ä°sim</th><th>BranÅŸ</th></tr></thead>
             <tbody></tbody>
           </table>
        </div>
      </div>
      <div class="card">
        <div class="flex"><b>Ã–ÄŸrenciler</b> <span class="tag" id="countS">0</span></div>
        <div style="max-height:200px; overflow:auto;">
           <table id="tblStudents" style="width:100%; border-collapse:collapse; font-size:12px;">
             <thead><tr style="background:#f1f5f9; text-align:left;"><th>No</th><th>Ä°sim</th><th>SÄ±nÄ±f</th><th>Grup</th></tr></thead>
             <tbody></tbody>
           </table>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:16px;">
      <button class="btn sec right" id="goto2">Devam â†’ Ders ProgramÄ±</button>
    </div>
  </section>

  <section class="content tabpanel" id="step2" role="tabpanel" hidden>
    <div class="row" style="justify-content:space-between;">
      <h2>Ders ProgramÄ± Ä°skeleti</h2>
      <div class="chips">
        <button class="btn xs ghost" id="btnProgSaveFb">FB Kaydet</button>
        <button class="btn xs ghost" id="btnProgLoadFb">FB YÃ¼kle</button>
        <button class="btn xs ghost" id="btnProgDeleteFb">FB Sil</button>
      </div>
    </div>

    <div class="row">
      <label>GÃ¼nler (VirgÃ¼l ile)
        <input type="text" id="daysInput" value="Pazartesi,SalÄ±,Ã‡arÅŸamba,PerÅŸembe,Cuma" style="width:300px;" />
      </label>
      <label>Ders SayÄ±sÄ±
        <input type="number" id="slotsInput" value="8" min="1" max="12" style="width:80px;" />
      </label>
      <label>Atama PolitikasÄ±
        <select id="assignPolicy">
          <option value="keep">Mevcut AtamalarÄ± Koru</option>
          <option value="reset">SÄ±fÄ±rla</option>
        </select>
      </label>
      <button class="btn" id="btnBuildGrid">OluÅŸtur / GÃ¼ncelle</button>
    </div>

    <div class="row">
       <button class="btn ghost" id="btnProgExport">JSON Ä°ndir</button>
       <button class="btn ghost" id="btnProgImport">JSON YÃ¼kle</button>
       <input type="file" id="fileProgImport" hidden accept=".json" />
    </div>

    <div class="card" style="margin-bottom:16px;">
      <div class="flex"><b>Saat Etiketleri</b> <small class="muted">(Ã–rn: 09:00 - 09:40)</small></div>
      <div id="slotLabelsWrap" style="padding:10px;"></div>
    </div>

    <div class="card">
      <div class="flex"><b>Program Åžablonu (Not AlanÄ±)</b></div>
      <div id="progGridWrap" style="overflow-x:auto;"></div>
    </div>

    <div class="row" style="margin-top:16px;">
      <button class="btn sec right" id="goto3">Devam â†’ MÃ¼saitlikler</button>
    </div>
  </section>
  <section class="content tabpanel" id="step3" role="tabpanel" hidden>
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2>MÃ¼saitlik DurumlarÄ±</h2>
      <div class="legend" style="display:flex; gap:8px; font-size:11px;">
        <span class="pill" style="background:#f0fdf4; color:#15803d; border-color:#bbf7d0;">YeÅŸil: Uygun</span>
        <span class="pill" style="background:#fef2f2; color:#b91c1c; border-color:#fecaca;">KÄ±rmÄ±zÄ±: Uygun DeÄŸil</span>
        <small class="muted" style="align-self:center;">(GÃ¼n baÅŸlÄ±ÄŸÄ±na Ã§ift tÄ±klayarak o gÃ¼nÃ¼ kopyalayabilirsiniz)</small>
      </div>
    </div>

    <div class="tabs" style="border-bottom:none; margin-bottom:8px;">
      <button class="tab" id="tabTeach" aria-selected="true" style="font-size:13px;">Ã–ÄŸretmen MÃ¼saitliÄŸi</button>
      <button class="tab" id="tabGroup" aria-selected="false" style="font-size:13px;">Grup MÃ¼saitliÄŸi</button>
    </div>
    <div style="height:1px; background:var(--border); margin-bottom:16px;"></div>

    <div id="panelTeach">
      <div class="row">
        <button class="btn ghost" id="btnAvailExport">JSON Ä°ndir</button>
        <button class="btn ghost" id="btnAvailImport">JSON YÃ¼kle</button>
        <input type="file" id="fileAvailImport" hidden accept=".json" />
        <button class="btn warn" id="btnAvailClear">Temizle</button>
        <div class="right chips">
          <button class="btn xs ghost" id="btnAvailSaveFb">FB Kaydet</button>
          <button class="btn xs ghost" id="btnAvailLoadFb">FB YÃ¼kle</button>
          <button class="btn xs ghost" id="btnAvailDeleteFb">FB Sil</button>
        </div>
      </div>
      <div class="card">
        <div id="teacherAvailWrap" class="cards" style="padding:16px;"></div>
      </div>
    </div>

    <div id="panelGroup" hidden>
      <div class="row">
        <button class="btn ghost" id="btnAvailExport2">JSON Ä°ndir</button>
        <button class="btn ghost" id="btnAvailImport2">JSON YÃ¼kle</button>
        <input type="file" id="fileAvailImport2" hidden accept=".json" />
        <div class="right chips">
          <button class="btn xs ghost" id="btnAvailSaveFb2">FB Kaydet</button>
          <button class="btn xs ghost" id="btnAvailLoadFb2">FB YÃ¼kle</button>
          <button class="btn xs ghost" id="btnAvailDeleteFb2">FB Sil</button>
        </div>
      </div>
      <div class="card">
        <div id="groupAvailWrap" class="cards" style="padding:16px;"></div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <button class="btn sec right" id="goto4">Devam â†’ Grup Talepleri</button>
    </div>
  </section>

  <section class="content tabpanel" id="step4" role="tabpanel" hidden>
    <div class="row" style="justify-content:space-between;">
      <h2>GruplarÄ±n HaftalÄ±k Ders Talepleri</h2>
      <div id="branchChips" class="chips"></div> </div>

    <div class="row">
      <label>Grup SeÃ§in
        <select id="reqGroupSelect" style="min-width:200px;"></select>
      </label>
      <button class="btn ghost" id="btnReqExport">JSON Ä°ndir</button>
      <button class="btn ghost" id="btnReqImport">JSON YÃ¼kle</button>
      <input type="file" id="fileReqImport" hidden accept=".json" />
      <button class="btn warn" id="btnReqClear">TÃ¼mÃ¼nÃ¼ SÄ±fÄ±rla</button>
      
      <div class="right chips">
        <button class="btn xs ghost" id="btnReqSaveFb">FB Kaydet</button>
        <button class="btn xs ghost" id="btnReqLoadFb">FB YÃ¼kle</button>
        <button class="btn xs ghost" id="btnReqDeleteFb">FB Sil</button>
      </div>
    </div>

    <div id="reqWrap" class="grid">
      <div class="card" style="padding:20px; text-align:center; color:var(--muted);">
        LÃ¼tfen soldaki menÃ¼den bir grup seÃ§iniz.
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <button class="btn sec right" id="goto5">Devam â†’ Atama Paneli</button>
    </div>
  </section>

  <section class="content tabpanel" id="step5" role="tabpanel" hidden>
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div>
        <h2>Atama Paneli</h2>
        <small class="muted">HÃ¼crelere tÄ±klayarak manuel atama yapabilir veya otomatik daÄŸÄ±tÄ±cÄ±yÄ± kullanabilirsiniz.</small>
      </div>
      <div class="chips">
         <span class="pill" style="border-color:var(--b-mat); color:var(--b-mat);">Matematik</span>
         <span class="pill" style="border-color:var(--b-fen); color:var(--b-fen);">Fen</span>
         <span class="pill" style="border-color:var(--b-trk); color:var(--b-trk);">TÃ¼rkÃ§e</span>
         <span class="pill" style="border-color:var(--b-sos); color:var(--b-sos);">Sosyal</span>
         <span class="pill" style="border-color:var(--b-ing); color:var(--b-ing);">Ä°ngilizce</span>
      </div>
    </div>

    <div class="row" style="background:#f1f5f9; padding:12px; border-radius:var(--radius-md); border:1px solid var(--border);">
      <button class="btn" id="btnAutoAssign" style="background:linear-gradient(135deg, #2563eb, #4f46e5); box-shadow:0 4px 10px rgba(37,99,235,0.3);">
        âš¡ Otomatik DaÄŸÄ±t (Auto-Assign)
      </button>
      
      <div style="width:1px; height:30px; background:var(--border); margin:0 8px;"></div>

      <button class="btn ghost" id="btnAssgnExport">JSON Ä°ndir</button>
      <button class="btn ghost" id="btnAssgnImport">JSON YÃ¼kle</button>
      <input type="file" id="fileAssgnImport" hidden accept=".json" />
      <button class="btn warn" id="btnAssgnClear">Temizle</button>

      <div class="right chips">
        <button class="btn xs ghost" id="btnAssgnSaveFb">FB Kaydet</button>
        <button class="btn xs ghost" id="btnAssgnLoadFb">FB YÃ¼kle</button>
        <button class="btn xs ghost" id="btnAssgnDeleteFb">FB Sil</button>
      </div>
    </div>

    <div id="assignCards" class="cards"></div>

    <dialog id="dlgAssign">
      <header>Manuel Ders Atama</header>
      <section class="grid">
        <div class="row">
          <label class="wide">Grup
            <input type="text" id="dlgGroup" readonly style="background:#f1f5f9; font-weight:bold;" />
          </label>
          <label class="wide">Zaman
            <input type="text" id="dlgWhen" readonly style="background:#f1f5f9;" />
          </label>
        </div>
        <div class="row">
          <label class="wide">BranÅŸ SeÃ§imi
            <select id="dlgBranch" style="padding:10px; font-weight:600;"></select>
          </label>
        </div>
        <div class="row">
          <label class="wide">Ã–ÄŸretmen SeÃ§imi
            <select id="dlgTeacher" size="5" style="padding:8px; overflow-y:auto; font-family:monospace;"></select>
            <small class="muted">Format: Ä°sim (MÃ¼saitlik / Åžu Anki YÃ¼kÃ¼) â€¢ Durum</small>
          </label>
        </div>
      </section>
      <footer>
        <button class="btn ghost" id="dlgCancel">Ä°ptal</button>
        <button class="btn danger" id="dlgDelete" hidden>AtamayÄ± Sil</button>
        <button class="btn" id="dlgOk">Kaydet & Ata</button>
      </footer>
    </dialog>

    <div class="row" style="margin-top:16px;">
      <button class="btn sec right" id="goto6">Devam â†’ YazdÄ±r / Rapor</button>
    </div>
  </section>
  <section class="content tabpanel" id="step6" role="tabpanel" hidden>
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2>YazdÄ±rma ve Raporlama</h2>
      <div class="chips no-print">
        <span class="pill">A4 Ã‡Ä±ktÄ±</span>
        <span class="pill">Otomatik Sayfalama</span>
      </div>
    </div>

    <div class="row no-print" style="background:#f8fafc; padding:16px; border-radius:var(--radius-md); border:1px solid var(--border);">
      <div class="grid wide">
        <div class="row">
          <label>GÃ¶rÃ¼nÃ¼m Modu
            <select id="printMode">
              <option value="group">Gruplara GÃ¶re (Klasik)</option>
              <option value="teacher">Ã–ÄŸretmenlere GÃ¶re (Klasik)</option>
            </select>
          </label>
          <label>Filtre (Opsiyonel)
            <select id="printFilter"></select>
          </label>
          <button class="btn" id="btnRenderPrint">Ã–nizle</button>
          <button class="btn sec" id="btnPrint" onclick="window.print()">YazdÄ±r (Ctrl+P)</button>
        </div>
        
        <div class="row" style="border-top:1px dashed var(--border); padding-top:12px; margin-top:4px;">
          <button class="btn ghost" id="btnTeacherV2">âš¡ Ã–ÄŸretmen Listesi (V2 LÃ¼ks TasarÄ±m)</button>
          <button class="btn ghost" id="btnPrintAll">ðŸ“„ TÃ¼m SÄ±nÄ±flarÄ± YazdÄ±r (Toplu)</button>
        </div>
      </div>
    </div>

    <div id="printPreview" class="grid printable" style="margin-top:20px;"></div>
  </section>
</div> <script>
/* 1. GLOBAL STATE & CONFIG */
const ALLOWED_BRANCHES = [
  'FEN BÄ°LÄ°MLERÄ°','MATEMATÄ°K','TÃœRKÃ‡E','SOSYAL BÄ°LGÄ°LER','Ä°NGÄ°LÄ°ZCE','DÄ°N KÃœLTÃœRÃœ'
];

// BranÅŸ -> CSS SÄ±nÄ±fÄ± EÅŸleÅŸmesi
const BRANCH_CLASS = {
  'MATEMATÄ°K':'mat', 'FEN BÄ°LÄ°MLERÄ°':'fen', 'TÃœRKÃ‡E':'trk',
  'SOSYAL BÄ°LGÄ°LER':'sos', 'Ä°NGÄ°LÄ°ZCE':'ing', 'DÄ°N KÃœLTÃœRÃœ':'din'
};

window.state = {
  teachers: [], students: [], groups: {}, branches: [],
  program: { days:["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"], slots:8, slotLabels:[], cells:{} },
  availability: { teachers:{}, groups:{} },
  requests: {}, assignments: []
};

/* 2. TEMEL YARDIMCILAR */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const bcls = b => BRANCH_CLASS[b] || toId(b); // BranÅŸ rengi sÄ±nÄ±fÄ± getir

const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name; a.click();
};

const openFile = (inputEl, cb) => { 
  inputEl.onchange = e => {
    try{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = () => { try{ cb(JSON.parse(r.result)); }catch(err){ alert('JSON HatasÄ±: '+err.message); } };
      r.readAsText(f); inputEl.value='';
    }catch(err){ alert('Dosya okunamadÄ±: '+err.message); }
  }; 
  inputEl.click(); 
};

/* Grup SÄ±ralama ve Parse YardÄ±mcÄ±larÄ± */
function parseGroupName(name){
  const s=String(name||'').trim().toUpperCase();
  let m=s.match(/^G(\d+)-(\d+)\s*([A-ZÃ‡ÄžÄ°Ã–ÅžÃœ])$/i); // G1-7A
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  m=s.match(/^G(\d+)-(.+)$/i); // G1-EtÃ¼t
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}

/* 3. TAB YÃ–NETÄ°MÄ° */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(id===panelId) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=> tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false'));

  // Sekme deÄŸiÅŸince tetiklenecek iÅŸlemler
  if(panelId==='step2'){ buildProgramGrid(true); renderSlotLabels(); }
  if(panelId==='step3'){ reconcileAllToProgram($("#assignPolicy").value); renderAvailGrids(); }
  if(panelId==='step4'){ refreshReqFilterOptions(); renderRequests(); }
  if(panelId==='step5'){ renderAssignCards(); }
  if(panelId==='step6'){ refreshPrintFilters(); renderPrintPreview(); }
}
$$('#topTabs .tab').forEach(tab=> tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel)));

/* 4. VERÄ° KAYNAÄžI (STEP 1) */
async function gvizFetch(sheetId, sheetName, selectRange){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&headers=1${selectRange?`&range=${encodeURIComponent(selectRange)}`:''}`;
  const res = await fetch(url); const txt = await res.text();
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/)[1]);
  return {
    columns: json.table.cols.map(c=>c.label),
    rows: (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:''))
  };
}

async function fetchAll(){
  const sheetId = $("#sheetId").value.trim();
  const status = $("#readStatus");
  status.textContent = "BaÄŸlanÄ±yor ve veri okunuyor..."; status.style.color="var(--pri)";
  
  try {
    // 1. Ã–ÄŸretmenleri Ã‡ek
    const tData = await gvizFetch(sheetId, 'Ogretmenler');
    const cT = tData.columns.map(s=>s.toUpperCase());
    const ixName = cT.indexOf('OGRETMEN_ADI'), ixBr = cT.indexOf('BRANS');
    
    if(ixName<0 || ixBr<0) throw new Error("Ogretmenler sayfasÄ±nda 'OGRETMEN_ADI' ve 'BRANS' sÃ¼tunlarÄ± bulunamadÄ±.");
    
    state.teachers = tData.rows.map(r=>{
      const name = (r[ixName]||'').toString().trim();
      const bRaw = (r[ixBr]||'').toString().trim().toUpperCase();
      return { id: toId(name||("T"+Math.random())), name, branch:bRaw };
    }).filter(x=>x.name && ALLOWED_BRANCHES.includes(x.branch));

    // 2. Ã–ÄŸrencileri Ã‡ek
    const sData = await gvizFetch(sheetId, 'Ogrenciler');
    const cS = sData.columns.map(s=>s.toUpperCase());
    const ixNo=cS.indexOf('NO'), ixAd=cS.indexOf('ADSOYAD'), ixSn=cS.indexOf('SINIF'), ixGr=cS.indexOf('GRUBU');
    
    if(ixNo<0||ixAd<0||ixSn<0||ixGr<0) throw new Error("Ogrenciler: NO, ADSOYAD, SINIF, Grubu sÃ¼tunlarÄ± eksik.");
    
    state.students = sData.rows.map(r=>({
      no:r[ixNo], name:r[ixAd], cls:r[ixSn], group:(r[ixGr]||'').toString().trim()
    })).filter(x=>x.group);

    // 3. GruplarÄ± OluÅŸtur
    state.groups = {};
    state.students.forEach(st=>{
      if(!state.groups[st.group]) state.groups[st.group] = { id:st.group, name:st.group, students:[] };
      state.groups[st.group].students.push(st.no);
    });

    state.branches = Array.from(new Set(state.teachers.map(t=>t.branch))).sort();

    // UI GÃ¼ncelle
    renderTeachers(); renderStudents();
    $("#countT").textContent = state.teachers.length;
    $("#countS").textContent = state.students.length;
    status.textContent = `BaÅŸarÄ±lÄ±! ${state.teachers.length} Ã–ÄŸretmen, ${state.students.length} Ã–ÄŸrenci, ${Object.keys(state.groups).length} Grup yÃ¼klendi.`;
    status.style.color = "var(--success)";
    
    // Veriler deÄŸiÅŸtiÄŸi iÃ§in programÄ± uyumla
    reconcileAllToProgram($("#assignPolicy").value);
    
  } catch(err){
    status.textContent = "Hata: " + err.message;
    status.style.color = "var(--danger)";
    console.error(err);
  }
}

function renderTeachers(){
  const tb = $("#tblTeachers tbody"); tb.innerHTML='';
  state.teachers.forEach((t,i)=>{
    tb.innerHTML += `<tr><td>${i+1}</td><td><b>${t.name}</b></td><td><span class="pill">${t.branch}</span></td></tr>`;
  });
}
function renderStudents(){
  const tb = $("#tblStudents tbody"); tb.innerHTML='';
  state.students.forEach(st=>{
    tb.innerHTML += `<tr><td>${st.no}</td><td>${st.name}</td><td>${st.cls}</td><td><b>${st.group}</b></td></tr>`;
  });
}
$("#btnFetch").onclick = fetchAll;
$("#btnClear").onclick = ()=>{ 
  state.teachers=[]; state.students=[]; state.groups={}; 
  renderTeachers(); renderStudents(); $("#readStatus").textContent="Temizlendi."; 
};

/* 5. DERS PROGRAMI (STEP 2) */
function ensureSlotLabels(){
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  for(let i=0;i<S;i++) if(!state.program.slotLabels[i]) state.program.slotLabels[i]='';
}

function renderSlotLabels(){
  ensureSlotLabels();
  const S = state.program.slots;
  const wrap = $("#slotLabelsWrap"); wrap.innerHTML='';
  
  const grid = document.createElement('div'); 
  grid.className='kgrid'; grid.style.setProperty('--cols', S);
  
  // BaÅŸlÄ±k hÃ¼cresi
  grid.innerHTML = `<div>Etiketler</div>`;
  
  for(let s=0; s<S; s++){
    const val = state.program.slotLabels[s];
    const cell = document.createElement('div');
    cell.className = 'kcell';
    cell.innerHTML = `<div style="font-weight:bold;">${s+1}. Ders</div><div class="mini2">${val||'--:--'}</div>`;
    cell.title = "Saati deÄŸiÅŸtirmek iÃ§in tÄ±klayÄ±n";
    
    cell.onclick = () => {
      const nov = prompt(`${s+1}. Ders saati (Ã–rn: 09:00-09:40):`, val);
      if(nov!==null){ state.program.slotLabels[s]=nov.trim(); renderSlotLabels(); }
    };
    // Alt+Click ile saÄŸa doldurma
    cell.onmousedown = (e) => {
      if(e.altKey){
        for(let k=s; k<S; k++) state.program.slotLabels[k] = val;
        renderSlotLabels();
      }
    };
    grid.appendChild(cell);
  }
  wrap.appendChild(grid);
}

function buildProgramGrid(restore=false){
  if(!restore){
    state.program.days = $("#daysInput").value.split(',').map(x=>x.trim()).filter(Boolean);
    state.program.slots = clamp(+$("#slotsInput").value||8, 1, 12);
  }
  const {days, slots:S} = state.program;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';
  
  const grid = document.createElement('div');
  grid.className = 'kgrid'; grid.style.setProperty('--cols', S);
  
  // Header Row
  let hRow = `<div class="busy">GÃ¼n / Saat</div>`;
  for(let i=0;i<S;i++) hRow += `<div class="busy">${i+1}</div>`;
  grid.innerHTML += hRow;
  
  // Day Rows
  days.forEach((d, di)=>{
    const dLbl = document.createElement('div'); 
    dLbl.className='busy'; dLbl.textContent=d;
    grid.appendChild(dLbl);
    
    for(let s=0; s<S; s++){
      const key = keyDS(di,s);
      const cell = document.createElement('div');
      cell.className = 'kcell';
      cell.textContent = state.program.cells[key]||'';
      cell.title = "Not eklemek iÃ§in tÄ±klayÄ±n";
      cell.onclick = ()=>{
        const n = prompt(`Not (${d} - ${s+1}. Ders):`, state.program.cells[key]||'');
        if(n!==null){ state.program.cells[key]=n.trim(); cell.textContent=n.trim(); }
      };
      grid.appendChild(cell);
    }
  });
  wrap.appendChild(grid);
  reconcileAllToProgram($("#assignPolicy").value);
}
$("#btnBuildGrid").onclick = ()=> { buildProgramGrid(false); renderSlotLabels(); };

/* Matris Senkronizasyonu */
function reconcileAllToProgram(policy){
  const D = state.program.days.length, S = state.program.slots;
  
  // Matris boyutlandÄ±rma fonksiyonu
  const resize = (oldMat) => {
    return Array.from({length:D}, (_,d) => 
      Array.from({length:S}, (_,s) => (oldMat?.[d]?.[s] ?? true))
    );
  };
  
  state.teachers.forEach(t => state.availability.teachers[t.id] = resize(state.availability.teachers[t.id]));
  Object.values(state.groups).forEach(g => state.availability.groups[g.id] = resize(state.availability.groups[g.id]));
  
  if(policy==='reset') state.assignments = [];
  else state.assignments = state.assignments.filter(a => a.day < D && a.slot < S);
}

/* 6. MÃœSAÄ°TLÄ°KLER (STEP 3) */
function renderAvailGrids(){
  const D=state.program.days.length, S=state.program.slots, days=state.program.days;
  
  // YardÄ±mcÄ±lar
  const createGrid = (title, meta, matrix, onChange, isTeacher) => {
    const card = document.createElement('div'); card.className='card';
    
    // Header
    const head = document.createElement('div'); head.className='flex';
    head.innerHTML = `<b>${title}</b> <span class="tag">${meta}</span>`;
    
    const actions = document.createElement('div'); actions.className='right flex';
    ['TÃ¼mÃ¼ Uygun','TÃ¼mÃ¼ DeÄŸil','Tersine'].forEach((lbl,i)=>{
      const b = document.createElement('button'); b.className='btn xs ghost'; b.textContent=lbl;
      b.onclick = () => {
        for(let d=0;d<D;d++) for(let s=0;s<S;s++){
          matrix[d][s] = (i===0 ? true : (i===1 ? false : !matrix[d][s]));
        }
        onChange();
      };
      actions.appendChild(b);
    });
    head.appendChild(actions); card.appendChild(head);
    
    // Grid
    const g = document.createElement('div'); g.className='kgrid'; g.style.setProperty('--cols',S);
    
    // Slot Numbers
    g.innerHTML += `<div class="busy">GÃ¼n</div>` + 
      Array.from({length:S},(_,s)=>`<div class="busy mini">${s+1}</div>`).join('');
      
    for(let d=0; d<D; d++){
      const dLabel = document.createElement('div'); 
      dLabel.className='busy'; dLabel.textContent=days[d]; dLabel.title="GÃ¼nÃ¼ kopyalamak iÃ§in Ã§ift tÄ±kla";
      dLabel.ondblclick = () => {
        if(confirm(`${days[d]} gÃ¼nÃ¼ diÄŸer gÃ¼nlere kopyalansÄ±n mÄ±?`)){
          const src = matrix[d].slice();
          for(let k=0; k<D; k++) matrix[k] = src.slice();
          onChange();
        }
      };
      g.appendChild(dLabel);
      
      for(let s=0; s<S; s++){
        const cell = document.createElement('div');
        const val = matrix[d][s];
        cell.className = `kcell ${val?'ok':'bad'}`;
        cell.textContent = val ? 'âœ“' : 'âœ—';
        cell.onclick = () => {
          matrix[d][s] = !matrix[d][s];
          onChange(); // Sadece yeniden Ã§izmek yerine DOM update yapÄ±labilir ama bu daha temiz
        };
        g.appendChild(cell);
      }
    }
    card.appendChild(g);
    return card;
  };

  // Ã–ÄŸretmenleri Renderla
  const tWrap = $("#teacherAvailWrap"); tWrap.innerHTML = '';
  if(state.teachers.length===0) tWrap.innerHTML = '<div class="muted">Veri yok.</div>';
  else state.teachers.forEach(t => {
    tWrap.appendChild(createGrid(t.name, t.branch, state.availability.teachers[t.id], renderAvailGrids, true));
  });

  // GruplarÄ± Renderla
  const gWrap = $("#groupAvailWrap"); gWrap.innerHTML = '';
  if(Object.keys(state.groups).length===0) gWrap.innerHTML = '<div class="muted">Veri yok.</div>';
  else Object.values(state.groups).sort(groupComparator).forEach(g => {
    gWrap.appendChild(createGrid(g.name, `${g.students.length} Ã–gr`, state.availability.groups[g.id], renderAvailGrids, false));
  });
}
/* Tab GeÃ§iÅŸleri */
$("#tabTeach").onclick = () => { $("#panelTeach").hidden=false; $("#panelGroup").hidden=true; $("#tabTeach").setAttribute('aria-selected',true); $("#tabGroup").setAttribute('aria-selected',false); };
$("#tabGroup").onclick = () => { $("#panelTeach").hidden=true; $("#panelGroup").hidden=false; $("#tabTeach").setAttribute('aria-selected',false); $("#tabGroup").setAttribute('aria-selected',true); };
$("#btnAvailClear").onclick = () => { state.availability={teachers:{},groups:{}}; reconcileAllToProgram(); renderAvailGrids(); };


/* 7. TALEPLER (STEP 4) */
function renderBranchChipsSummary(){
  const host = $("#branchChips"); if(!host) return; host.innerHTML='';
  
  // Hesaplama: Kapasite vs Talep
  const caps = {}; const reqs = {};
  state.branches.forEach(b => { caps[b]=0; reqs[b]=0; });
  
  // Kapasite (Ã–ÄŸretmen mÃ¼saitlikleri toplamÄ±)
  const D=state.program.days.length, S=state.program.slots;
  state.teachers.forEach(t=>{
    let c=0; const mat=state.availability.teachers[t.id]||[];
    for(let d=0;d<D;d++) for(let s=0;s<S;s++) if(mat[d]?.[s]) c++;
    caps[t.branch] = (caps[t.branch]||0)+c;
  });
  
  // Talepler
  Object.values(state.requests).forEach(r => {
    Object.entries(r).forEach(([b,v]) => reqs[b] = (reqs[b]||0) + (+v||0));
  });
  
  state.branches.forEach(b => {
    const left = (caps[b]||0) - (reqs[b]||0);
    const pill = document.createElement('span');
    pill.className = `pill ${left<0 ? 'bad' : ''}`;
    pill.textContent = `${b}: ${left} / ${caps[b]||0}`;
    pill.title = "Kalan Kapasite / Toplam Kapasite";
    host.appendChild(pill);
  });
}

function renderRequests(){
  const gid = $("#reqGroupSelect").value;
  const wrap = $("#reqWrap"); wrap.innerHTML='';
  renderBranchChipsSummary();
  
  if(!gid) { wrap.innerHTML='<div class="muted card" style="padding:20px;">Grup seÃ§iniz.</div>'; return; }
  const g = state.groups[gid];
  
  // Talep Verisi HazÄ±rla
  if(!state.requests[gid]) state.requests[gid]={};
  state.branches.forEach(b => { if(state.requests[gid][b]===undefined) state.requests[gid][b]=0; });
  
  const card = document.createElement('div'); card.className='card';
  const head = document.createElement('div'); head.className='flex';
  
  const totalReq = Object.values(state.requests[gid]).reduce((a,b)=>a+(+b),0);
  const maxCap = state.program.days.length * state.program.slots;
  
  head.innerHTML = `<b>${g.name} Talepleri</b> <span class="pill ${totalReq>maxCap?'bad':''}">${totalReq} / ${maxCap} Ders</span>`;
  card.appendChild(head);
  
  const tbl = document.createElement('table'); tbl.style.width='100%';
  state.branches.forEach(b => {
    const val = state.requests[gid][b];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="width:40%">${b}</td>`;
    
    const tdControl = document.createElement('td');
    const divQty = document.createElement('div'); divQty.className='qty';
    
    const btnM = document.createElement('button'); btnM.textContent='-';
    const inp = document.createElement('input'); inp.type='number'; inp.value=val; inp.min=0;
    const btnP = document.createElement('button'); btnP.textContent='+';
    
    const update = (v) => {
      let nv = clamp(v, 0, 99);
      inp.value = nv;
      state.requests[gid][b] = nv;
      renderRequests(); // Re-render to update summary
    };
    
    btnM.onclick = ()=>update((+inp.value)-1);
    btnP.onclick = ()=>update((+inp.value)+1);
    inp.onchange = ()=>update(+inp.value);
    
    divQty.append(btnM, inp, btnP);
    tdControl.appendChild(divQty);
    tr.appendChild(tdControl);
    tbl.appendChild(tr);
  });
  card.appendChild(tbl);
  wrap.appendChild(card);
}
function refreshReqFilterOptions(){
  const s = $("#reqGroupSelect"); s.innerHTML='<option value="">-- Grup SeÃ§in --</option>';
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    s.innerHTML += `<option value="${g.id}">${g.name}</option>`;
  });
}
$("#reqGroupSelect").onchange = renderRequests;
$("#btnReqClear").onclick = ()=>{ state.requests={}; renderRequests(); };

/* PART 3 END (DevamÄ± Part 4'te) */
</script>
<script>
function getBranchClass(branchName) {
  if (!branchName) return '';
  return BRANCH_CLASS[branchName] || 'genel';
}

function hasAssignmentsForGroup(gid){ return state.assignments.some(a=>a.group===gid); }

function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;

  // GruplarÄ± sÄ±rala: Ã–nce atamasÄ± olanlar, sonra isme gÃ¶re
  const groups = Object.values(state.groups).slice()
    .sort((a,b)=> (hasAssignmentsForGroup(b.id)?1:0)-(hasAssignmentsForGroup(a.id)?1:0) || groupComparator(a,b));

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    
    // Header
    const count = state.assignments.filter(a=>a.group===g.id).length;
    const reqCount = Object.values(state.requests[g.id]||{}).reduce((a,b)=>a+(+b),0);
    const head = document.createElement('div'); head.className='flex';
    head.innerHTML = `
      <div><b>${g.name}</b> <small class="muted">(${g.students.length} Ã–gr)</small></div>
      <span class="pill ${count<reqCount?'warn':''}">${count} / ${reqCount} AtandÄ±</span>
    `;
    card.appendChild(head);

    // Grid
    const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S);
    
    // Header Row
    grid.innerHTML += `<div class="busy">GÃ¼n</div>` + 
      Array.from({length:S},(_,s)=>`<div class="busy mini">${s+1}</div>`).join('');

    for(let d=0; d<days.length; d++){
      const dayLabel = document.createElement('div'); dayLabel.className='busy'; dayLabel.textContent=days[d];
      grid.appendChild(dayLabel);
      
      for(let s=0; s<S; s++){
        const cell = document.createElement('div');
        const assign = state.assignments.find(a=>a.group===g.id && a.day===d && a.slot===s);
        const isGroupAvail = state.availability.groups[g.id]?.[d]?.[s];
        
        if(assign){
          // ATANMIÅž DERS GÃ–RÃœNÃœMÃœ
          const tName = state.teachers.find(t=>t.id===assign.teacherId)?.name || '??';
          const bClass = bcls(assign.branch);
          cell.className = `kcell assigned ${bClass}`;
          cell.innerHTML = `<div>${assign.branch}</div><div class="mini2">ðŸ‘¤ ${tName}</div>`;
        } else {
          // BOÅž SLOT GÃ–RÃœNÃœMÃœ
          cell.className = `kcell ${isGroupAvail?'ok':'bad'}`;
          cell.innerHTML = isGroupAvail ? '' : '<span style="opacity:0.3">âœ•</span>';
        }
        
        cell.onclick = () => openAssignDialog(g.id, d, s);
        grid.appendChild(cell);
      }
    }
    card.appendChild(grid);
    wrap.appendChild(card);
  });
}

/* MANUEL ATAMA DIALOG Ä°ÅžLEMLERÄ° */
let dlgCtx = null;
const dlg = $("#dlgAssign");

function openAssignDialog(group, day, slot) {
  dlgCtx = { group, day, slot };
  const gName = state.groups[group]?.name || group;
  const time = state.program.slotLabels[slot] || `${slot+1}. Ders`;
  
  $("#dlgGroup").value = gName;
  $("#dlgWhen").value = `${state.program.days[day]} â€¢ ${time}`;

  // BranÅŸlarÄ± Doldur
  const selB = $("#dlgBranch"); selB.innerHTML = '';
  state.branches.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b; opt.textContent = b;
    selB.appendChild(opt);
  });
  
  // Mevcut atama var mÄ±?
  const current = state.assignments.find(a => a.group===group && a.day===day && a.slot===slot);
  if(current) selB.value = current.branch;
  
  // Ã–ÄŸretmenleri Doldur (SeÃ§ili branÅŸa gÃ¶re)
  fillTeachersForBranch();
  selB.onchange = fillTeachersForBranch;
  
  if(current){
    $("#dlgTeacher").value = current.teacherId;
    $("#dlgDelete").hidden = false;
  } else {
    $("#dlgDelete").hidden = true;
  }
  
  dlg.showModal();
}

function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const {day, slot} = dlgCtx;
  const selT = $("#dlgTeacher"); selT.innerHTML = '';
  
  // O branÅŸtaki Ã¶ÄŸretmenler
  const teachers = state.teachers.filter(t=>t.branch===branch);
  
  teachers.forEach(t => {
    const isAvail = state.availability.teachers[t.id]?.[day]?.[slot] === true;
    const busyAssign = state.assignments.find(a => a.teacherId===t.id && a.day===day && a.slot===slot);
    
    // Ä°statistikler
    const totalLoad = state.assignments.filter(a=>a.teacherId===t.id).length;
    let availSlots = 0;
    state.availability.teachers[t.id]?.forEach(row=> row.forEach(c=> {if(c) availSlots++}));
    
    const opt = document.createElement('option');
    opt.value = t.id;
    let txt = `${t.name} (YÃ¼k: ${totalLoad}/${availSlots})`;
    
    if(busyAssign) { 
      txt += " â€¢ DOLU"; 
      opt.disabled = true; 
    } else if(!isAvail) {
      txt += " â€¢ MÃ¼sait DeÄŸil";
      opt.style.color = "#ef4444";
    }
    
    opt.textContent = txt;
    selT.appendChild(opt);
  });
}

$("#dlgCancel").onclick = () => dlg.close();
$("#dlgDelete").onclick = () => {
  if(confirm("AtamayÄ± silmek istiyor musunuz?")){
    const {group, day, slot} = dlgCtx;
    state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
    renderAssignCards();
    dlg.close();
  }
};
$("#dlgOk").onclick = () => {
  const {group, day, slot} = dlgCtx;
  const branch = $("#dlgBranch").value;
  const teacherId = $("#dlgTeacher").value;
  
  if(!teacherId) return alert("LÃ¼tfen bir Ã¶ÄŸretmen seÃ§in.");
  
  // Ã‡akÄ±ÅŸma kontrol (Manuelde izin veriyoruz ama uyaralÄ±m)
  const isAvail = state.availability.teachers[teacherId]?.[day]?.[slot];
  if(!isAvail && !confirm("Ã–ÄŸretmen bu saatte 'MÃ¼sait DeÄŸil' gÃ¶rÃ¼nÃ¼yor. Yine de atansÄ±n mÄ±?")) return;
  
  // Ã–nceki atamayÄ± sil ve yenisini ekle
  state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
  state.assignments.push({ group, day, slot, branch, teacherId });
  
  renderAssignCards();
  dlg.close();
};

/* 9. OTOMATÄ°K ATAMA (STEP 5 - BASÄ°T VERSÄ°YON) */
/* Not: Daha karmaÅŸÄ±k algoritma istenirse buraya eklenebilir. 
   Åžu an basit, rastgele ve kural bazlÄ± bir daÄŸÄ±tÄ±cÄ±. */
$("#btnAutoAssign").onclick = () => {
  if(!confirm("Mevcut atamalarÄ±n Ã¼zerine otomatik daÄŸÄ±tÄ±m yapÄ±lacak. Devam edilsin mi?")) return;
  
  const D=state.program.days.length, S=state.program.slots;
  let changed = 0;

  // 1. Ä°htiyaÃ§larÄ± Belirle
  const needs = [];
  Object.keys(state.requests).forEach(gid => {
    Object.entries(state.requests[gid]).forEach(([br, count]) => {
      // Zaten atanmÄ±ÅŸlarÄ± dÃ¼ÅŸ
      const current = state.assignments.filter(a=>a.group===gid && a.branch===br).length;
      const needed = (+count) - current;
      for(let i=0; i<needed; i++) needs.push({gid, br});
    });
  });

  // 2. Rastgele KarÄ±ÅŸtÄ±r
  needs.sort(() => Math.random() - 0.5);

  // 3. DaÄŸÄ±tmaya Ã‡alÄ±ÅŸ
  needs.forEach(req => {
    // Uygun slot ara
    const candidates = [];
    for(let d=0; d<D; d++){
      for(let s=0; s<S; s++){
        // Grup mÃ¼sait mi?
        if(!state.availability.groups[req.gid]?.[d]?.[s]) continue;
        // Grup dolu mu?
        if(state.assignments.some(a=>a.group===req.gid && a.day===d && a.slot===s)) continue;
        
        // Bu branÅŸta ve saatte mÃ¼sait Ã¶ÄŸretmen var mÄ±?
        const teachers = state.teachers.filter(t=>
          t.branch === req.br &&
          state.availability.teachers[t.id]?.[d]?.[s] &&
          !state.assignments.some(a=>a.teacherId===t.id && a.day===d && a.slot===s)
        );
        
        if(teachers.length > 0) {
          // Rastgele bir Ã¶ÄŸretmen seÃ§
          const t = teachers[Math.floor(Math.random()*teachers.length)];
          candidates.push({d, s, tid: t.id});
        }
      }
    }
    
    if(candidates.length > 0){
      // En boÅŸ slotu veya rastgele seÃ§
      const pick = candidates[Math.floor(Math.random()*candidates.length)];
      state.assignments.push({
        group: req.gid, day: pick.d, slot: pick.s, branch: req.br, teacherId: pick.tid
      });
      changed++;
    }
  });
  
  alert(`${changed} ders otomatik atandÄ±.`);
  renderAssignCards();
};


/* 10. YAZDIRMA VE RAPORLAMA (STEP 6) */
function refreshPrintFilters(){
  const mode = $("#printMode").value;
  const s = $("#printFilter"); s.innerHTML = '<option value="">-- TÃ¼mÃ¼ --</option>';
  if(mode==='group'){
    Object.values(state.groups).sort(groupComparator).forEach(g=> s.innerHTML+=`<option value="${g.id}">${g.name}</option>`);
  } else {
    state.teachers.forEach(t=> s.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
  }
}
$("#printMode").onchange = refreshPrintFilters;

function renderPrintPreview(){
  const div = $("#printPreview"); div.innerHTML='';
  const mode = $("#printMode").value;
  const filter = $("#printFilter").value;
  const days = state.program.days;
  const S = state.program.slots;
  const labels = state.program.slotLabels;

  if(state.assignments.length===0){
    div.innerHTML='<div class="muted">HenÃ¼z atama yapÄ±lmamÄ±ÅŸ.</div>'; return;
  }

  // HEADER HTML
  const getTableHead = (title) => `
    <div style="margin-bottom:10px; border-bottom:2px solid #000; padding-bottom:5px;">
      <h3 style="margin:0;">Fenomen Ã‡ocuk KulÃ¼bÃ¼ - ${title}</h3>
    </div>
    <table class="print-table">
      <thead>
        <tr><th style="width:80px;">GÃ¼n/Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||(i+1)}</th>`).join('')}</tr>
      </thead>
      <tbody>
  `;

  // --- GRUP MODU ---
  if(mode==='group'){
    const targetGroups = filter ? [state.groups[filter]] : Object.values(state.groups).sort(groupComparator);
    
    targetGroups.forEach(g => {
      // AtamasÄ± var mÄ±?
      const assigns = state.assignments.filter(a=>a.group===g.id);
      if(assigns.length===0 && filter==='') return; 
      
      let html = `<div class="print-page">`;
      html += getTableHead(`${g.name} Ders ProgramÄ±`);
      
      days.forEach((dName, dIdx) => {
        html += `<tr><td style="font-weight:bold">${dName}</td>`;
        for(let s=0; s<S; s++){
          const a = assigns.find(x=>x.day===dIdx && x.slot===s);
          if(a){
            const t = state.teachers.find(x=>x.id===a.teacherId);
            html += `<td class="${bcls(a.branch)}" style="text-align:center;">
              <b>${a.branch}</b><br><span class="mini">${t?.name||''}</span>
            </td>`;
          } else {
            html += `<td></td>`;
          }
        }
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      
      // Ã–ÄŸrenci Listesi
      const stList = state.students.filter(s=>s.group===g.id).map(s=>s.name).join(', ');
      html += `<div style="margin-top:10px; font-size:11px;"><b>Ã–ÄŸrenciler:</b> ${stList}</div>`;
      html += `</div>`; // Page break
      div.innerHTML += html;
    });
  } 
  // --- Ã–ÄžRETMEN MODU ---
  else {
    const targetTeachers = filter ? [state.teachers.find(t=>t.id===filter)] : state.teachers;
    
    targetTeachers.forEach(t => {
      const assigns = state.assignments.filter(a=>a.teacherId===t.id);
      if(assigns.length===0 && filter==='') return;
      
      let html = `<div class="print-page">`;
      html += getTableHead(`${t.name} (${t.branch}) ProgramÄ±`);
      
      days.forEach((dName, dIdx) => {
        html += `<tr><td style="font-weight:bold">${dName}</td>`;
        for(let s=0; s<S; s++){
          const a = assigns.find(x=>x.day===dIdx && x.slot===s);
          if(a){
            const g = state.groups[a.group];
            html += `<td style="text-align:center; background:#f8fafc;">
              <b>${g?.name||a.group}</b><br><span class="mini">${a.branch}</span>
            </td>`;
          } else {
            html += `<td></td>`;
          }
        }
        html += `</tr>`;
      });
      html += `</tbody></table></div>`;
      div.innerHTML += html;
    });
  }
}
$("#btnRenderPrint").onclick = renderPrintPreview;


/* 11. Ã–ZEL YAZDIRMA FONKSÄ°YONLARI (V2 & TOPLU) */

// V2: Ã–ÄŸretmen LÃ¼ks TasarÄ±m
$("#btnTeacherV2").onclick = () => {
  const S = state.program.slots;
  const w = window.open('','_blank');
  w.document.write(`<html><head><title>Ã–ÄŸretmen Ã‡Ä±ktÄ± V2</title>
  <style>
    body{font-family:sans-serif; -webkit-print-color-adjust:exact;}
    .page{page-break-after:always; padding:20px;}
    table{width:100%; border-collapse:collapse; margin-bottom:10px;}
    th,td{border:1px solid #333; padding:5px; text-align:center; font-size:11px;}
    th{background:#eee;}
    .head{display:flex; justify-content:space-between; border-bottom:2px solid #c2410c; padding-bottom:5px; margin-bottom:10px;}
    .att-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .att-box{border:1px solid #ccc; padding:5px; border-radius:4px;}
  </style>
  </head><body>`);
  
  state.teachers.forEach(t => {
    const myAsg = state.assignments.filter(a=>a.teacherId===t.id);
    if(myAsg.length===0) return;
    
    // GruplarÄ± bul
    const myGroups = [...new Set(myAsg.map(a=>a.group))].map(gid=>state.groups[gid]).filter(Boolean);
    
    let h = `<div class="page">
      <div class="head">
        <div><b>FENOMEN Ã‡OCUK KULÃœBÃœ</b></div>
        <div>${t.name} - ${t.branch}</div>
      </div>
      <table><thead><tr><th>Saat</th>`;
      state.program.days.forEach(d=> h+=`<th>${d}</th>`);
      h+=`</tr></thead><tbody>`;
      
      for(let s=0; s<S; s++){
         h+=`<tr><td><b>${s+1}</b></td>`;
         state.program.days.forEach((d,di)=>{
           const a = myAsg.find(x=>x.day===di && x.slot===s);
           if(a) h+=`<td style="background:#fef3c7"><b>${state.groups[a.group]?.name}</b></td>`;
           else h+=`<td></td>`;
         });
         h+=`</tr>`;
      }
      h+=`</tbody></table>`;
      
      // Yoklama Listesi
      h+=`<div class="att-grid">`;
      myGroups.forEach(g=>{
         h+=`<div class="att-box"><b>${g.name}</b><br>`;
         g.students.forEach(st=> h+=`<div style="border-bottom:1px dotted #ccc; display:flex; justify-content:space-between;"><span>${st.name}</span><span>[ ]</span></div>`);
         h+=`</div>`;
      });
      h+=`</div></div>`; // End Grid & Page
      w.document.write(h);
  });
  w.document.close();
};

// Toplu SÄ±nÄ±f Ã‡Ä±ktÄ±sÄ±
$("#btnPrintAll").onclick = () => {
  const w = window.open('','_blank');
  // Basit stil
  w.document.write(`<html><head><style>
    body{font-family:sans-serif;} .page{page-break-after:always; margin-top:20px;}
    table{width:100%; border-collapse:collapse; font-size:10px;}
    th,td{border:1px solid #ccc; padding:2px;} th{background:#eee;}
  </style></head><body>`);
  
  [5,6,7,8].forEach(grade => {
    const gradeGroups = Object.values(state.groups).filter(g=> {
       const inf = parseGroupName(g.name);
       return inf && inf.grade === grade;
    });
    if(gradeGroups.length===0) return;
    
    w.document.write(`<div class="page"><h1>${grade}. SÄ±nÄ±flar Toplu Liste</h1>`);
    gradeGroups.forEach(g=>{
      w.document.write(`<h3>${g.name}</h3><table><thead><tr><th>GÃ¼n</th>`);
      for(let i=0;i<state.program.slots;i++) w.document.write(`<th>${i+1}</th>`);
      w.document.write(`</tr></thead><tbody>`);
      
      state.program.days.forEach((d,di)=>{
         w.document.write(`<tr><td><b>${d}</b></td>`);
         for(let s=0; s<state.program.slots; s++){
           const a = state.assignments.find(x=>x.group===g.id && x.day===di && x.slot===s);
           if(a){
             const t = state.teachers.find(x=>x.id===a.teacherId);
             w.document.write(`<td><b>${a.branch}</b><br>${t?.name}</td>`);
           } else w.document.write(`<td></td>`);
         }
         w.document.write(`</tr>`);
      });
      w.document.write(`</tbody></table>`);
    });
    w.document.write(`</div>`);
  });
  w.document.close();
};

/* DATA EXPORT/IMPORT LISTENERS */
$("#btnProgExport").onclick = ()=>download('program.json', state.program);
$("#btnAvailExport").onclick = ()=>download('musaitlik_ogr.json', state.availability);
$("#btnAvailExport2").onclick = ()=>download('musaitlik_grp.json', state.availability);
$("#btnReqExport").onclick = ()=>download('talepler.json', state.requests);
$("#btnAssgnExport").onclick = ()=>download('atamalar.json', state.assignments);

// Importlar genel "openFile" helper'Ä±nÄ± kullanÄ±r (YukarÄ±da tanÄ±mlÄ±)
$("#btnProgImport").onclick = ()=>openFile($("#fileProgImport"), d=>{ state.program=d; buildProgramGrid(true); });
$("#btnAvailImport").onclick = ()=>openFile($("#fileAvailImport"), d=>{ state.availability=d; renderAvailGrids(); });
$("#btnAvailImport2").onclick = ()=>openFile($("#fileAvailImport2"), d=>{ state.availability=d; renderAvailGrids(); });
$("#btnReqImport").onclick = ()=>openFile($("#fileReqImport"), d=>{ state.requests=d; renderRequests(); });
$("#btnAssgnImport").onclick = ()=>openFile($("#fileAssgnImport"), d=>{ state.assignments=d; renderAssignCards(); });

/* BAÅžLANGIÃ‡ */
buildProgramGrid(false);
renderSlotLabels();
showTopTab('step1'); // Ä°lk aÃ§Ä±lÄ±ÅŸta Step 1 gÃ¶ster

</script>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
    authDomain: "odevfeno.firebaseapp.com",
    databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odevfeno",
    storageBucket: "odevfeno.firebasestorage.app",
    messagingSenderId: "662757516934",
    appId: "1:662757516934:web:0042188832f63deb6fd307",
    measurementId: "G-4Q99NQRB38"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  const save = async (path, data) => {
    try { await set(ref(db, path), data); alert('KayÄ±t BaÅŸarÄ±lÄ±!'); } 
    catch(e){ alert('Hata: '+e.message); }
  };
  const load = async (path, cb) => {
    try { 
      const s = await get(ref(db, path)); 
      if(s.exists()) { cb(s.val()); alert('YÃ¼klendi!'); } 
      else alert('KayÄ±t bulunamadÄ±.');
    } catch(e){ alert('Hata: '+e.message); }
  };
  const del = async (path) => {
    if(confirm('Silmek istediÄŸinize emin misiniz?')) {
      try { await remove(ref(db, path)); alert('Silindi!'); } 
      catch(e){ alert('Hata: '+e.message); }
    }
  };

  // Event BaÄŸlayÄ±cÄ±lar
  // Program
  document.getElementById('btnProgSaveFb').onclick = ()=>save('program', state.program);
  document.getElementById('btnProgLoadFb').onclick = ()=>load('program', d=>{ 
    state.program=d; window.buildProgramGrid(true); window.renderSlotLabels(); 
  });
  document.getElementById('btnProgDeleteFb').onclick = ()=>del('program');

  // MÃ¼saitlik (Tek buton grubu hem ogr hem grup verisini yÃ¶netir - availability objesi bÃ¼tÃ¼ndÃ¼r)
  const availSave = ()=>save('availability', state.availability);
  const availLoad = ()=>load('availability', d=>{ state.availability=d; window.renderAvailGrids(); });
  const availDel  = ()=>del('availability');
  
  document.getElementById('btnAvailSaveFb').onclick = availSave;
  document.getElementById('btnAvailLoadFb').onclick = availLoad;
  document.getElementById('btnAvailDeleteFb').onclick = availDel;
  // Grup sekmesindeki yedek butonlar
  document.getElementById('btnAvailSaveFb2').onclick = availSave;
  document.getElementById('btnAvailLoadFb2').onclick = availLoad;
  document.getElementById('btnAvailDeleteFb2').onclick = availDel;

  // Talepler
  document.getElementById('btnReqSaveFb').onclick = ()=>save('requests', state.requests);
  document.getElementById('btnReqLoadFb').onclick = ()=>load('requests', d=>{ state.requests=d||{}; window.renderRequests(); });
  document.getElementById('btnReqDeleteFb').onclick = ()=>del('requests');

  // Atamalar
  document.getElementById('btnAssgnSaveFb').onclick = ()=>save('assignments', state.assignments);
  document.getElementById('btnAssgnLoadFb').onclick = ()=>load('assignments', d=>{ state.assignments=d||[]; window.renderAssignCards(); });
  document.getElementById('btnAssgnDeleteFb').onclick = ()=>del('assignments');
  
</script>

</body>
</html>
