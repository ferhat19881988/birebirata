<!-- /index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fenomen EÄŸitim KurumlarÄ± â€¢ Grup Ders Planlama (tablÄ±)</title>
<style>
  :root{
    --bg:#f6f9fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b;
    --pri:#14b8a6; --pri-ink:#083c3a; --acc:#6366f1; --warn:#f59e0b; --danger:#ef4444;
    --chip:#e2f5f2; --grid:#e5e7eb; --radius:16px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  h1,h2,h3{margin:0 0 .4rem}
  h1{font-size:clamp(20px,3vw,28px);font-weight:800}
  h2{font-size:clamp(18px,2.4vw,22px);font-weight:700}
  h3{font-size:clamp(16px,2vw,18px);font-weight:700}
  /* Uygulama geniÅŸliÄŸi bÃ¼yÃ¼tÃ¼ldÃ¼ */
  .app{max-width:1680px;margin:auto;padding:18px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--pri),#8b5cf6)}
  .brand .title small{color:var(--muted)}
  .content{background:var(--panel);border-radius:var(--radius);box-shadow:0 10px 25px rgba(15,23,42,.06);padding:16px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--pri);color:#fff;font-weight:700;cursor:pointer}
  .btn.sm{padding:7px 10px;font-size:13px}
  .btn.xs{padding:6px 8px;font-size:12px;border-radius:10px}
  .btn.sec{background:var(--acc)}
  .btn.ghost{background:#e2e8f0;color:#0f172a}
  .btn.warn{background:var(--warn);color:#111827}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input[type=text], input[type=number], select, textarea{
    padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;min-width:220px
  }
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;background:#fff;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
  th{position:sticky;top:0;background:#f8fafc;z-index:1}
  tr{border-radius:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);font-weight:600;color:var(--pri-ink)}
  .pill.bad{background:#fee2e2;color:#991b1b}
  .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 8px 20px rgba(15,23,42,.06);border:1px solid #e5e7eb;overflow:hidden}
  .kgrid{display:grid;gap:6px}
  .kgrid[data-cols]{grid-template-columns:140px repeat(var(--cols), minmax(72px,1fr));}
  .kcell{border:1px dashed var(--grid);min-height:60px;padding:6px;border-radius:10px;background:#fafafa;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;white-space:pre-line}
  .kcell.busy{background:#eef2ff;border-color:#c7d2fe}
  .kcell.bad{background:#fee2e2;border-color:#fecaca}
  .kcell.ok{background:#dcfce7;border-color:#bbf7d0}
  /* AtanmÄ±ÅŸ (dersli) hÃ¼creler â€“ arka planÄ± JS'de ders rengine boyanÄ±r */
  .kcell.assigned{
    color:var(--ink);
    font-weight:700;
  }
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .legend span{padding:6px 10px;border-radius:20px;background:#f1f5f9}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .wide{width:100%}
  /* GeniÅŸ kart dizilimi */
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(560px,1fr));gap:14px}
  .flex{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .mini{font-size:12px}
  .mini2{font-size:11px;color:#475569}
  .tag{display:inline-block;background:#f1f5f9;padding:2px 8px;border-radius:999px;margin-left:6px;color:#334155}
  .nowrap{white-space:nowrap}

  /* 1. resim â€“ Ã–ÄŸretmen/Grup mÃ¼saitlik kartlarÄ± geniÅŸletildi */
  /* MÃ¼saitlik kartlarÄ± â€“ geliÅŸmiÅŸ hizalama ve stil */
/* ===========================
   MÃœSAÄ°TLÄ°KLER â€“ SIFIRDAN TASARIM (Drop-in)
   Uyum: #step3 (Ã–ÄŸretmen/Grup MÃ¼saitlik)
   =========================== */

#step3 {
  /* Tema deÄŸiÅŸkenleri (aÃ§Ä±k tema) */
  --avail-bg: #ffffff;
  --avail-ink: #0f172a;
  --avail-muted: #64748b;
  --avail-panel: #ffffff;
  --avail-border: #e5e7eb;
  --avail-grid-gap: 8px;

  --day-col-w: 160px;
  --slot-min-w: 88px;
  --cell-min-h: 58px;
  --cell-radius: 12px;

  --head-bg: #f8fafc;
  --head-ink: #0f172a;
  --head-border: #e2e8f0;

  --ok-bg: #dcfce7;
  --ok-ink: #065f46;
  --ok-bd: #bbf7d0;

  --bad-bg: #fee2e2;
  --bad-ink: #991b1b;
  --bad-bd: #fecaca;

  --neutral-bg: #f8fafc;
  --neutral-ink: #334155;
  --neutral-bd: #e2e8f0;

  --ring: #94a3b8;
  --ring-strong: #6366f1;

  color: var(--avail-ink);
}

/* Kart Ä±zgarasÄ± â€“ Ã¶ÄŸretmen/grup kartlarÄ± */
#step3 .avGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(560px, 1fr));
  gap: 16px;
  align-items: stretch;
}

/* Kart iskeleti */
#step3 .avGrid .card {
  display: flex;
  flex-direction: column;
  background: var(--avail-panel);
  border: 1px solid var(--avail-border);
  border-radius: 16px;
  box-shadow: 0 10px 24px rgba(2, 8, 23, 0.06);
  overflow: clip;
  min-width: 0; /* grid overflow fix */
}

/* Kart baÅŸlÄ±ÄŸÄ± (sol: isim/etiket, saÄŸ: aksiyon butonlarÄ±) */
#step3 .avGrid .card .flex {
  padding: 12px 14px;
  gap: 10px;
  border-bottom: 1px solid var(--avail-border);
  background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
}
#step3 .avGrid .card .flex b { font-weight: 800; }
#step3 .avGrid .card .tag {
  background: #eef2ff;
  color: #1f2937;
  border-radius: 999px;
  padding: 2px 10px;
  font-size: 12px;
}

/* Grid: â€œGÃ¼n / Saatâ€ matrisi
   Not: JS tarafÄ± grid[data-cols] ile --cols atÄ±yor. */
#step3 .kgrid {
  display: grid;
  gap: var(--avail-grid-gap);
  padding: 12px;
  background: var(--avail-bg);
}
#step3 .kgrid[data-cols] {
  grid-template-columns: var(--day-col-w) repeat(var(--cols), minmax(var(--slot-min-w), 1fr));
}

/* Sol baÅŸlÄ±k hÃ¼cresi (GÃ¼n adlarÄ± / 'GÃ¼n / Saat') */
#step3 .kgrid > :first-child {
  background: var(--head-bg);
  color: var(--head-ink);
  border: 1px solid var(--head-border);
  border-radius: var(--cell-radius);
  font-weight: 800;
  display: grid;
  place-items: center;
  min-height: var(--cell-min-h);
  text-align: center;
  padding: 6px 8px;
}

/* Slot baÅŸlÄ±k hÃ¼creleri */
#step3 .kcell.busy {
  background: var(--head-bg);
  color: var(--avail-muted);
  border: 1px solid var(--head-border);
  cursor: default;
}

/* Genel hÃ¼cre stili */
#step3 .kcell {
  border: 1px solid var(--neutral-bd);
  background: #ffffff;
  color: var(--neutral-ink);
  min-height: var(--cell-min-h);
  border-radius: var(--cell-radius);
  display: grid;
  place-items: center;
  text-align: center;
  padding: 6px;
  user-select: none;
  transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, border-color .12s ease, color .12s ease;
  outline: none;
  position: relative;
}

/* Durumlar */
#step3 .kcell.ok {
  background: var(--ok-bg);
  color: var(--ok-ink);
  border-color: var(--ok-bd);
  font-weight: 700;
}
#step3 .kcell.bad {
  background: var(--bad-bg);
  color: var(--bad-ink);
  border-color: var(--bad-bd);
  font-weight: 700;
}

/* Hover/active geri bildirimi (sadece tÄ±klanabilir hÃ¼crelerde) */
#step3 .kgrid .kgrid .kcell:hover { /* nested satÄ±r iÃ§indeki tÄ±klanabilirler */
  transform: translateY(-1px);
  box-shadow: 0 4px 14px rgba(2, 8, 23, 0.06);
}
#step3 .kgrid .kgrid .kcell:active {
  transform: translateY(0);
  box-shadow: 0 1px 4px rgba(2, 8, 23, 0.08) inset;
}

/* Klavye odaÄŸÄ± (tabindex verilirse otomatik iÅŸler) */
#step3 .kgrid .kgrid .kcell:focus-visible {
  box-shadow: 0 0 0 3px var(--ring);
}

/* KÃ¼Ã§Ã¼k metinler */
#step3 .mini2 { color: var(--avail-muted); font-size: 11px; }

/* Eylem butonlarÄ± â€“ kart iÃ§i kÃ¼Ã§Ã¼k butonlar */
#step3 .avGrid .card .btn.xs.ghost {
  background: #f1f5f9;
  color: #111827;
  border-radius: 10px;
  padding: 6px 10px;
  border: 1px solid var(--avail-border);
}
#step3 .avGrid .card .btn.xs.ghost:hover {
  background: #e2e8f0;
}

/* Efsane/Legend alanÄ± */
#step3 .legend {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 6px 0 12px;
}
#step3 .legend span {
  background: #f1f5f9;
  color: #334155;
  border-radius: 999px;
  padding: 6px 12px;
  font-weight: 600;
  border: 1px solid var(--avail-border);
}

/* Sekmeler (Step 3 iÃ§i) â€“ var olan .tab ile uyumlu */
#step3 .tabs {
  gap: 8px;
  border: 0;
  margin-bottom: 12px;
  position: relative;
}
#step3 .tabs::after {
  content: "";
  position: absolute; inset-inline: 0; bottom: -1px; height: 1px; background: var(--avail-border);
}
#step3 .tab {
  padding: 10px 14px;
  border-radius: 12px 12px 0 0;
  background: #f1f5f9;
  color: #0f172a;
  font-weight: 800;
  box-shadow: 0 1px 0 var(--avail-border) inset;
  border: 1px solid transparent;
}
#step3 .tab[aria-selected="true"] {
  background: #fff;
  border-color: var(--avail-border);
  border-bottom-color: #fff;
  box-shadow: 0 6px 18px rgba(2, 8, 23, .06);
}

/* Dar ekranlar iÃ§in optimizasyon */
@media (max-width: 920px) {
  #step3 { --day-col-w: 132px; --slot-min-w: 72px; }
  #step3 .avGrid { grid-template-columns: 1fr; }
  #step3 .kgrid { padding: 10px; }
  #step3 .kgrid > :first-child { padding: 6px; }
  #step3 .kcell { min-height: 52px; }
}

/* BÃ¼yÃ¼k ekranlar iÃ§in hafif yoÄŸunluk artÄ±ÅŸÄ± */
@media (min-width: 1600px) {
  #step3 { --slot-min-w: 100px; --cell-min-h: 64px; }
}

/* Az animasyon tercih eden kullanÄ±cÄ±lar */
@media (prefers-reduced-motion: reduce) {
  #step3 .kcell { transition: none; }
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  #step3 {
    --avail-bg: #0b1220;
    --avail-ink: #e5e7eb;
    --avail-muted: #94a3b8;
    --avail-panel: #0f172a;
    --avail-border: #1f2a44;

    --head-bg: #0d1a2d;
    --head-ink: #e5e7eb;
    --head-border: #1f2a44;

    --neutral-bg: #0f172a;
    --neutral-ink: #cbd5e1;
    --neutral-bd: #1f2a44;

    --ok-bg: #073a28;
    --ok-ink: #a7f3d0;
    --ok-bd: #115e43;

    --bad-bg: #3a0c0c;
    --bad-ink: #fecaca;
    --bad-bd: #7f1d1d;

    --ring: #334155;
    --ring-strong: #818cf8;
  }

  #step3 .avGrid .card {
    box-shadow: 0 12px 28px rgba(0,0,0,.36);
  }
  #step3 .avGrid .card .btn.xs.ghost {
    background: #0d1a2d; color: #e2e8f0; border-color: #1f2a44;
  }
  #step3 .avGrid .card .btn.xs.ghost:hover {
    background: #12233c;
  }
}

/* ---- Ä°steÄŸe baÄŸlÄ±: Ä°nteraktif â€œtoggleâ€ imleci sadece tÄ±klanabilir hÃ¼crelerde ---- */
#step3 .kgrid .kgrid .kcell { cursor: pointer; }
#step3 .kcell.busy { cursor: default; }

  /* Ãœst sekmeler */
  .tabs{display:flex;gap:6px;border-bottom:1px solid #e5e7eb;margin-bottom:8px}
  .tab{padding:10px 14px;border-radius:10px 10px 0 0;background:#eef2ff;color:#1f2937;cursor:pointer;font-weight:700;user-select:none}
  .tab[aria-selected="true"]{background:#fff;border:1px solid #e5e7eb;border-bottom-color:#fff}
  .tabpanel[hidden]{display:none !important}

  /* Talep sayacÄ± kutucuklarÄ± */
  .qty{display:inline-flex;align-items:center;border:1px solid #cbd5e1;border-radius:12px;overflow:hidden}
  .qty input{border:0;min-width:56px;text-align:center;padding:8px 10px}
  .qty button{border:0;background:#eef2ff;padding:8px 10px;cursor:pointer}

  /* YazdÄ±rma */
  @media print{
    @page{size:A4;margin:10mm}
    body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .no-print{display:none !important}
    .printable{display:block}
    .print-header{font-weight:900;text-align:center;margin-bottom:6px}
    .print-sub{color:#475569;text-align:center;margin-bottom:8px}
    .print-page{page-break-after:always;break-after:page}
    /* Increased font-size for print clarity */
    .print-table{width:100%;border-collapse:collapse;font-size:11px}
    .print-table th,.print-table td{border:1px solid #000;padding:5px 6px;vertical-align:top}
    .print-table thead th{background:#f3f4f6}
    .tight th,.tight td{padding:4px 5px;font-size:10.5px}
    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    .students-2col{columns:2;column-gap:12px}
    .students-2col ul{margin:0;padding-left:0;list-style:none}
    .students-2col li{break-inside:avoid;padding:2px 0;border-bottom:1px dotted #94a3b8}
    .att-table{width:100%;border-collapse:collapse;font-size:10px;margin-top:6px}
    .att-table th,.att-table td{border:1px solid #000;padding:3px 4px;text-align:center}
    .att-table th:first-child,.att-table td:first-child{text-align:left}
  }

/*
  Manuel atama modalinin boyutu ve iÃ§indeki seÃ§im kutularÄ± bÃ¼yÃ¼tÃ¼ldÃ¼. Ã–ÄŸretmen
  kapasiteleri ve mevcut ders sayÄ±larÄ± gÃ¶sterildiÄŸinden metinler uzayabilir.
  Bu nedenle dialog geniÅŸ bir alana yayÄ±lÄ±r ve Ã¶ÄŸretmen seÃ§enekleri iÃ§in
  minimum geniÅŸlik tanÄ±mlanÄ±r.
*/
#dlgAssign {
  max-width: 600px;
  width: 100%;
}
#dlgAssign select {
  min-width: 280px;
}
/* === 1. KUTU BOYUTUNU ORÄ°JÄ°NAL HALÄ°NE ZORLA === */
.kcell {
    /* Minimum yÃ¼kseklik korunur; yÃ¼kseklik artÄ±k sabit deÄŸil */
    min-height: 60px !important;
    height: auto !important;

    /* Ä°Ã§ boÅŸluÄŸu azaltarak ÅŸiÅŸmeyi Ã¶nle */
    padding: 2px 4px !important;

    /* Ä°Ã§eriÄŸi tam ortala */
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;

    /* VarsayÄ±lan gri/beyaz */
    background: #fff;
}

/* === 2. RENKLER (ARKA PLAN DAHÄ°L) === */
/* MATEMATÄ°K: Mavi Arka Plan */
.kcell.assigned.mat {
    background-color: #dbeafe !important; /* Belirgin AÃ§Ä±k Mavi */
    border: 1px solid #60a5fa !important;
    color: #1e3a8a !important;
}

/* FEN BÄ°LÄ°MLERÄ°: YeÅŸil Arka Plan */
.kcell.assigned.fen {
    background-color: #dcfce7 !important; /* Belirgin AÃ§Ä±k YeÅŸil */
    border: 1px solid #4ade80 !important;
    color: #14532d !important;
}

/* TÃœRKÃ‡E: Turuncu Arka Plan */
.kcell.assigned.trk {
    background-color: #ffedd5 !important; /* Belirgin AÃ§Ä±k Turuncu */
    border: 1px solid #fb923c !important;
    color: #7c2d12 !important;
}

/* SOSYAL BÄ°LGÄ°LER: Cam GÃ¶beÄŸi Arka Plan */
.kcell.assigned.sos {
    background-color: #cffafe !important;
    border: 1px solid #22d3ee !important;
    color: #155e75 !important;
}

/* Ä°NGÄ°LÄ°ZCE: SarÄ± Arka Plan */
.kcell.assigned.ing {
    background-color: #fef9c3 !important;
    border: 1px solid #facc15 !important;
    color: #713f12 !important;
}

/* DÄ°N KÃœLTÃœRÃœ: Mor Arka Plan */
.kcell.assigned.din {
    background-color: #f3e8ff !important;
    border: 1px solid #c084fc !important;
    color: #581c87 !important;
}

/* Atama yapÄ±lmÄ±ÅŸ ama branÅŸÄ± belirsiz olanlar */
.kcell.assigned {
    font-weight: 700;
}

  /*
   * Slot boyutlarÄ±nÄ±n tutarlÄ± kalmasÄ± ve iÃ§eriklerin hÃ¼cre geniÅŸliÄŸini zorlayÄ±p
   * Ä±zgarayÄ± bozmasÄ±nÄ± Ã¶nlemek iÃ§in aÅŸaÄŸÄ±daki ayarlar eklendi. BazÄ± uzun branÅŸ
   * veya Ã¶ÄŸretmen isimleri sÃ¼tunlarÄ± geniÅŸletip diÄŸer slotlarÄ±n boyutunu
   * farklÄ±laÅŸtÄ±rÄ±yordu. Minâ€width'i sÄ±fÄ±ra Ã§ekerek hÃ¼crelerin iÃ§erik
   * taÅŸmalarÄ±na izin veriyoruz ve overflow ile taÅŸan metni gizliyoruz. BÃ¶ylece
   * tÃ¼m kcell'ler aynÄ± geniÅŸlikte kalÄ±yor, metin sÄ±ÄŸmadÄ±ÄŸÄ±nda ise Ã¼Ã§ nokta
   * ile kesiliyor.
   */
  .kgrid .kcell {
  min-width: 0 !important;
  overflow: hidden !important;
  box-sizing: border-box !important;
}

/* Ä°Ã§ kapsayÄ±cÄ± hem yatayda hem dikeyde ortalansÄ±n */
.kgrid .kcell > * {
  width: 100% !important;
  max-width: 100% !important;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Metinler Ã§ok uzunsa satÄ±r atabilsin, Ã¼Ã§ nokta ile kesilmesin */
.kgrid .kcell > * > div {
  white-space: normal !important;
  /* Metni sÄ±ÄŸdÄ±rmak iÃ§in taÅŸÄ±yor fakat gizlemek yerine gÃ¶rÃ¼nÃ¼r bÄ±rakÄ±yoruz */
  overflow: visible !important;
  text-overflow: clip !important;
  line-height: 1.1;
  font-size: clamp(9px, 0.8vw, 12px);  /* ekrana gÃ¶re otomatik kÃ¼Ã§Ã¼lÃ¼r/bÃ¼yÃ¼r */
  text-align: center;
}

/* Atama yapÄ±lmÄ±ÅŸ hÃ¼crelerde ders adÄ± biraz daha bÃ¼yÃ¼k gÃ¶zÃ¼ksÃ¼n */
.kcell.assigned > div:first-child {
  font-weight: 800;
  font-size: clamp(10px, 0.9vw, 13px);
}
  /* === MODERN KART & SCROLL YAPISI (YALNIZCA SLOT KARTLARI) === */
  .grid-scroll-wrapper {
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px;
    margin: 0 -14px;
    padding-left: 14px;
    padding-right: 14px;
  }

  .grid-scroll-wrapper::-webkit-scrollbar {
    height: 8px;
  }
  .grid-scroll-wrapper::-webkit-scrollbar-track {
    background: transparent;
  }
  .grid-scroll-wrapper::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
    border-radius: 4px;
    border: 2px solid #fff;
  }

  /* BaÅŸlÄ±k hÃ¼creleri ve yapÄ±ÅŸkan gÃ¼n sÃ¼tunu */
  .kgrid .head-cell {
    font-weight: 800;
    color: #334155;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 12px;
  }

  /* Sadece satÄ±r baÅŸÄ± gÃ¼n/sÃ¼tun baÅŸlÄ±ÄŸÄ± yapÄ±ÅŸkan olsun */
  .kgrid > div:first-child.head-cell {
    position: sticky;
    left: 0;
    z-index: 20;
    box-shadow: 2px 0 5px rgba(0,0,0,0.03);
  }

  /* Saat baÅŸlÄ±k satÄ±rÄ± */
  .header-row .head-cell,
  .header-row .kcell {
    background: #f1f5f9;
    border-color: #cbd5e1;
    font-weight: 700;
    color: #1e293b;
    min-height: 45px;
    cursor: default;
    box-shadow: none;
  }

  /* Kart hÃ¼cre hover efekti (atanmamÄ±ÅŸ/baÅŸlÄ±k olmayanlar) */
  .kcell:not(.busy):not(.head-cell):hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px -4px rgba(0,0,0,0.10), 0 4px 6px -2px rgba(0,0,0,0.05);
    border-color: var(--pri);
    z-index: 10;
  }

  .kcell.assigned .mini2 {
    font-size: 11px;
    margin-top: 4px;
  }

</style>
</head>
<body>
<div class="app">
  <div class="top no-print">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Fenomen EÄŸitim KurumlarÄ±</h1>
        <small>Grup dersleri planlama â€¢ TablÄ±</small>
      </div>
    </div>
    <div class="flex">
      <!-- Yerel kaydet/yÃ¼kle dÃ¼ÄŸmeleri kaldÄ±rÄ±ldÄ±; Firebase iÅŸlemleri sekme bazlÄ± eklendi -->
    </div>
  </div>

  <!-- ÃœST SEKMELER -->
  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri KaynaÄŸÄ±</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders ProgramÄ±</button>
    <button class="tab" data-panel="step3" role="tab">3. MÃ¼saitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Grup Talepleri</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">YazdÄ±r</button>
  </div>

  <!-- STEP 1 -->
  <section class="content grid tabpanel" id="step1" role="tabpanel">
    <div class="section-title">
      <h2>1) Google Sheet BaÄŸlantÄ±sÄ± (YALNIZCA OKUMA)</h2>
      <div class="chips">
        <span class="pill">Ogretmenler: OGRETMEN_ADI, BRANS</span>
        <span class="pill">Ogrenciler: NO, ADSOYAD, SINIF, Grubu</span>
        <span class="pill">BranÅŸlar: FEN BÄ°LÄ°MLERÄ°, MATEMATÄ°K, TÃœRKÃ‡E, SOSYAL BÄ°LGÄ°LER, Ä°NGÄ°LÄ°ZCE, DÄ°N KÃœLTÃœRÃœ</span>
      </div>
    </div>
    <div class="row">
      <label class="wide">Spreadsheet ID
        <input class="wide" type="text" id="sheetId" value="1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg" />
      </label>
      <button class="btn" id="btnFetch">Verileri Oku</button>
      <button class="btn ghost" id="btnClear">Temizle</button>
    </div>
    <div id="readStatus" class="notice">Durum: HazÄ±r.</div>
    <div class="grid">
      <div class="card">
        <h3>Ã–ÄŸretmenler (filtreli)</h3>
        <table id="tblTeachers"><thead><tr><th>#</th><th>Ã–ÄŸretmen</th><th>BranÅŸ</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Ã–ÄŸrenciler (Grubu dolu olanlar)</h3>
        <table id="tblStudents"><thead><tr><th>NO</th><th>Ad Soyad</th><th>SÄ±nÄ±f</th><th>Grup</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Gruplar</h3>
        <div id="groupSummary" class="chips"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn sec right" id="goto2">Devam â†’ Ders ProgramÄ±</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="content grid tabpanel" id="step2" role="tabpanel" hidden>
    <div class="section-title">
      <h2>2) Ders ProgramÄ± Ä°skele</h2>
      <div class="chips"><span class="pill">JSON Kaydet/YÃ¼kle</span></div>
    </div>
    <div class="row">
      <label>GÃ¼nler (virgÃ¼l ayÄ±r)<br/>
        <input type="text" id="daysInput" value="Pazartesi,SalÄ±,Ã‡arÅŸamba,PerÅŸembe,Cuma" />
      </label>
      <label>Saat/Slot sayÄ±sÄ±<br/>
        <input type="number" id="slotsInput" value="8" min="1" max="12" />
      </label>
      <label>Atama politikasÄ±<br/>
        <select id="assignPolicy" title="Program deÄŸiÅŸince atamalarÄ± nasÄ±l ele alalÄ±m?">
          <option value="keep" selected>KoruyabildiÄŸini koru (taÅŸanlarÄ± at)</option>
          <option value="reset">Tamamen sÄ±fÄ±rla</option>
        </select>
      </label>
      <button class="btn" id="btnBuildGrid">OluÅŸtur/GÃ¼ncelle</button>
      <button class="btn ghost" id="btnProgExport">JSON DÄ±ÅŸa Aktar</button>
      <input id="fileProgImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnProgImport">JSON Ä°Ã§eri Al</button>
      <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri -->
      <button class="btn ghost" id="btnProgSaveFb">Firebase Kaydet</button>
      <button class="btn ghost" id="btnProgLoadFb">Firebase YÃ¼kle</button>
      <button class="btn ghost" id="btnProgDeleteFb">Firebase Sil</button>
    </div>

    <!-- Saat etiketleri dÃ¼zenleyici -->
    <div id="slotLabelsWrap" class="card"></div>

    <div id="progGridWrap" class="card"></div>
    <div class="row">
      <button class="btn sec right" id="goto3">Devam â†’ MÃ¼saitlikler</button>
    </div>
  </section>

  <!-- STEP 3 -->
  <section class="content grid tabpanel" id="step3" role="tabpanel" hidden>
    <div class="section-title">
      <h2>3) MÃ¼saitlikler</h2>
      <div class="legend">
        <span>â— Ã–ÄŸretmen MÃ¼saitliÄŸi (Ã§ift tÄ±k gÃ¼n baÅŸlÄ±ÄŸÄ±: gÃ¼nÃ¼ kopyala)</span>
        <span>â— Grup MÃ¼saitliÄŸi (Ã§ift tÄ±k gÃ¼n baÅŸlÄ±ÄŸÄ±: gÃ¼nÃ¼ kopyala)</span>
      </div>
    </div>

    <div class="tabs no-print" role="tablist" aria-label="MÃ¼saitlik Sekmeleri">
      <button class="tab" id="tabTeach" role="tab" aria-selected="true">Ã–ÄŸretmen MÃ¼saitlik</button>
      <button class="tab" id="tabGroup" role="tab" aria-selected="false">Grup MÃ¼saitlik</button>
    </div>

    <div id="panelTeach" role="tabpanel">
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport">JSON DÄ±ÅŸa Aktar</button>
        <input id="fileAvailImport" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport">JSON Ä°Ã§eri Al</button>
        <button class="btn warn" id="btnAvailClear">TÃ¼m MÃ¼saitlikleri Temizle</button>
        <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri: Ã¶ÄŸretmen & grup mÃ¼saitliÄŸi ortak kullanÄ±r -->
        <button class="btn ghost" id="btnAvailSaveFb">Firebase Kaydet</button>
        <button class="btn ghost" id="btnAvailLoadFb">Firebase YÃ¼kle</button>
        <button class="btn ghost" id="btnAvailDeleteFb">Firebase Sil</button>
      </div>
      <div class="card">
        <h3>Ã–ÄŸretmen MÃ¼saitlikleri</h3>
        <div id="teacherAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div id="panelGroup" role="tabpanel" hidden>
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport2">JSON DÄ±ÅŸa Aktar</button>
        <input id="fileAvailImport2" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport2">JSON Ä°Ã§eri Al</button>
        <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri: Ã¶ÄŸretmen & grup mÃ¼saitliÄŸi ortak kullanÄ±r (ayrÄ± id'ler) -->
        <button class="btn ghost" id="btnAvailSaveFb2">Firebase Kaydet</button>
        <button class="btn ghost" id="btnAvailLoadFb2">Firebase YÃ¼kle</button>
        <button class="btn ghost" id="btnAvailDeleteFb2">Firebase Sil</button>
      </div>
      <div class="card">
        <h3>Grup MÃ¼saitlikleri</h3>
        <div id="groupAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div class="row">
      <button class="btn sec right" id="goto4">Devam â†’ Grup Talepleri</button>
    </div>
  </section>

  <!-- STEP 4 -->
  <section class="content grid tabpanel" id="step4" role="tabpanel" hidden>
    <div class="section-title">
      <h2>4) GruplarÄ±n HaftalÄ±k Ders Talepleri</h2>
      <div class="chips" id="branchChips"></div>
    </div>

    <div class="row">
      <label>Grup SeÃ§in<br/>
        <select id="reqGroupSelect"></select>
      </label>
      <button class="btn ghost" id="btnReqExport">JSON DÄ±ÅŸa Aktar</button>
      <input id="fileReqImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnReqImport">JSON Ä°Ã§eri Al</button>
      <button class="btn warn" id="btnReqClear">TÃ¼m Talepleri SÄ±fÄ±rla</button>
      <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri -->
      <button class="btn ghost" id="btnReqSaveFb">Firebase Kaydet</button>
      <button class="btn ghost" id="btnReqLoadFb">Firebase YÃ¼kle</button>
      <button class="btn ghost" id="btnReqDeleteFb">Firebase Sil</button>
    </div>

    <div id="reqWrap" class="grid"></div>

    <div class="row">
      <button class="btn sec right" id="goto5">Devam â†’ Atama Paneli</button>
    </div>
  </section>

  <!-- STEP 5 -->
  <section class="content grid tabpanel" id="step5" role="tabpanel" hidden>
    <div class="section-title">
      <h2>5) Atama Paneli</h2>
      <div class="chips">
        <span class="pill">AynÄ± gruba ardÄ±ÅŸÄ±k aynÄ± branÅŸ verilmez</span>
        <span class="pill">BranÅŸa gÃ¶re Ã¶ÄŸretmen yÃ¼kÃ¼ dengelenir</span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnAutoAssign">Otomatik Atama</button>
      <button class="btn ghost" id="btnAssgnExport">JSON DÄ±ÅŸa Aktar</button>
      <input id="fileAssgnImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnAssgnImport">JSON Ä°Ã§eri Al</button>
      <button class="btn warn" id="btnAssgnClear">AtamalarÄ± Temizle</button>
      <!-- Firebase kaydet/yÃ¼kle/sil dÃ¼ÄŸmeleri -->
      <button class="btn ghost" id="btnAssgnSaveFb">Firebase Kaydet</button>
      <button class="btn ghost" id="btnAssgnLoadFb">Firebase YÃ¼kle</button>
      <button class="btn ghost" id="btnAssgnDeleteFb">Firebase Sil</button>
    </div>
    <div id="assignCards" class="cards"></div>

    <dialog id="dlgAssign">
      <header>Manuel Atama</header>
      <section>
        <div class="grid">
          <div class="inline-grid">
            <label>Grup<br/><input type="text" id="dlgGroup" readonly></label>
            <label>GÃ¼n / Saat<br/><input type="text" id="dlgWhen" readonly></label>
          </div>
          <div class="inline-grid">
            <label>BranÅŸ<br/><select id="dlgBranch"></select></label>
            <label>Ã–ÄŸretmen<br/><select id="dlgTeacher"></select></label>
          </div>
        </div>
      </section>
     <footer>
  <button class="btn ghost" id="dlgCancel">VazgeÃ§</button>
  <button class="btn danger" id="dlgDelete" hidden>AtamayÄ± Sil</button>
  <button class="btn" id="dlgOk">Kaydet</button>
</footer>
    </dialog>

    <div class="row">
      <button class="btn sec right" id="goto6">Devam â†’ YazdÄ±r</button>
    </div>
  </section>

  <!-- STEP 6 -->
  <section class="content grid tabpanel" id="step6" role="tabpanel" hidden>
    <div class="section-title">
      <h2>YazdÄ±r / Rapor</h2>
      <div class="chips no-print">
        <span class="pill">A4 Ã§Ä±ktÄ±, sayfa baÅŸÄ± Ã¶ÄŸretmen/grup</span>
        <span class="pill">Sadece atama varsa</span>
      </div>
    </div>
    <div class="row no-print">
      <label>GÃ¶rÃ¼nÃ¼m<br/>
        <select id="printMode">
          <option value="group">Gruba gÃ¶re</option>
          <option value="teacher">Ã–ÄŸretmene gÃ¶re</option>
        </select>
      </label>
      <label>Filtre<br/>
        <select id="printFilter"></select>
      </label>
      <button class="btn" id="btnRenderPrint">Ã–nizleme</button>
      <button class="btn sec" id="btnPrint" onclick="window.print()">YazdÄ±r</button>
    </div>
    <div id="printPreview" class="grid printable"></div>
  </section>
</div>

<script>
/* ===== Global Durum ===== */
const ALLOWED_BRANCHES = [
  'FEN BÄ°LÄ°MLERÄ°','MATEMATÄ°K','TÃœRKÃ‡E','SOSYAL BÄ°LGÄ°LER','Ä°NGÄ°LÄ°ZCE','DÄ°N KÃœLTÃœRÃœ'
];
window.state = {
  teachers: [], students: [], groups: {}, branches: [],
  program: { days:["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"], slots:8, slotLabels:[], cells:{} },
  availability: { teachers:{}, groups:{} },
  requests: {}, assignments: []
};

/* ===== YardÄ±mcÄ±lar ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name; a.click();
};
const openFile = (inputEl, cb) => { inputEl.onchange = e=>{
  try{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => { try{ cb(JSON.parse(r.result)); }catch(err){ alert('GeÃ§ersiz JSON: '+err.message); } };
    r.readAsText(f); inputEl.value='';
  }catch(err){ alert('Dosya okunamadÄ±: '+err.message); }
}; inputEl.click(); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

// ========== Branch Color Helpers ==========
// In order to visually distinguish different course assignments in the schedule,
// we generate pastel colors based off of the branch name. These colors are
// deterministic (same branch â†’ same color) and cached for performance. The
// lightness and saturation values are tuned for good contrast while keeping
// the colors soft. A slightly darker border color is also produced to
// delineate the cells.
const branchColorCache = {};
function getColorForBranch(branch) {
  if (!branch) return null;
  if (branchColorCache[branch]) return branchColorCache[branch];
  let sum = 0;
  for (let i = 0; i < branch.length; i++) {
    sum = (sum + branch.charCodeAt(i)) & 0xffff;
  }
  const hue = (sum * 37) % 360;
  const color = `hsl(${hue}, 70%, 85%)`;
  branchColorCache[branch] = color;
  return color;
}
function getBorderColorForBranch(branch) {
  if (!branch) return null;
  let sum = 0;
  for (let i = 0; i < branch.length; i++) {
    sum = (sum + branch.charCodeAt(i)) & 0xffff;
  }
  const hue = (sum * 37) % 360;
  return `hsl(${hue}, 65%, 75%)`;
}

/* Grup sÄ±ralama:  G1-7A, G2-7A, G3-7A, ... G1-7B ... */
function parseGroupName(name){
  const s=String(name||'').trim().toUpperCase();
  // G<number>-<grade><section> -> G1-7A
  let m=s.match(/^G(\d+)-(\d+)\s*([A-ZÃ‡ÄÄ°Ã–ÅÃœ])$/i);
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  // Fallback: G<number>-<label>
  m=s.match(/^G(\d+)-(.+)$/i);
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}

/* ===== Ãœst Sekmeler ===== */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(id===panelId) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=> tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false'));

  if(panelId==='step2'){ buildProgramGrid(true); renderSlotLabels(); }
  if(panelId==='step3'){ reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); }
  if(panelId==='step4'){ refreshReqFilterOptions(); renderRequests(); }
  if(panelId==='step5'){ renderAssignCards(); }
  if(panelId==='step6'){ refreshPrintFilters(); renderPrintPreview(); }
}
function bindTopTabs(){ $$('#topTabs .tab').forEach(tab=> tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel))); }

/* ===== 1) Veri KaynaÄŸÄ± ===== */
async function gvizFetch(sheetId, sheetName, selectRange){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&headers=1${selectRange?`&range=${encodeURIComponent(selectRange)}`:''}`;
  const res = await fetch(url, {mode:'cors'}); const txt = await res.text();
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/)[1]);
  const cols = json.table.cols.map(c=>c.label);
  const rows = (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')); // why: boÅŸ hÃ¼creler iÃ§in
  return {columns:cols, rows};
}
function renderTeachers(){
  const tb = $("#tblTeachers tbody"); tb.innerHTML='';
  state.teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td><span class="tag">${t.branch}</span></td>`;
    tb.appendChild(tr);
  });
}
function renderStudents(){
  const tb = $("#tblStudents tbody"); tb.innerHTML='';
  state.students.forEach(st=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="nowrap">${st.no}</td><td>${st.name}</td><td>${st.cls}</td><td><b>${st.group}</b></td>`;
    tb.appendChild(tr);
  });
}
function buildGroupsFromStudents(){
  state.groups = {};
  state.students.forEach(st=>{
    const gid = st.group;
    if(!state.groups[gid]) state.groups[gid] = { id:gid, name:gid, students:[] };
    state.groups[gid].students.push(st.no);
  });
}
function renderGroupSummary(){
  const wrap = $("#groupSummary"); wrap.innerHTML='';
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const el = document.createElement('span'); el.className='pill';
    el.textContent = `${g.name} â€¢ ${g.students.length} Ã¶ÄŸrenci`;
    wrap.appendChild(el);
  });
}
async function fetchAll(){
  const sheetId = $("#sheetId").value.trim();
  $("#readStatus").textContent = "Okunuyor...";
  try{
    const t = await gvizFetch(sheetId, 'Ogretmenler');
    const cT = t.columns.map(s=>s.toUpperCase());
    const ixName = cT.indexOf('OGRETMEN_ADI');
    const ixBr   = cT.indexOf('BRANS');
    if(ixName<0 || ixBr<0) throw new Error("Ogretmenler sayfasÄ±nda 'OGRETMEN_ADI' ve 'BRANS' yok.");
    state.teachers = t.rows.map(r=>{
      const name = (r[ixName]||'').toString().trim();
      const bRaw = (r[ixBr]||'').toString().trim().toUpperCase();
      return { id: toId(name||("T"+Math.random())), name, branch:bRaw };
    }).filter(x=>x.name && ALLOWED_BRANCHES.includes(x.branch));
    if(state.teachers.length===0) throw new Error("Filtre sonrasÄ± Ã¶ÄŸretmen bulunamadÄ±.");

    const s = await gvizFetch(sheetId, 'Ogrenciler');
    const cS = s.columns.map(s=>s.toUpperCase());
    const ixNo = cS.indexOf('NO');
    const ixAd = cS.indexOf('ADSOYAD');
    const ixSn = cS.indexOf('SINIF');
    const ixGr = cS.indexOf('GRUBU');
    if(ixNo<0 || ixAd<0 || ixSn<0 || ixGr<0) throw new Error("Ogrenciler: NO/ADSOYAD/SINIF/Grubu eksik.");
    state.students = s.rows.map(r=>({
      no: r[ixNo], name: r[ixAd], cls: r[ixSn], group: (r[ixGr]||'').toString().trim()
    })).filter(x=>x.group);

    buildGroupsFromStudents();
    state.branches = Array.from(new Set(state.teachers.map(t=>t.branch))).sort((a,b)=>a.localeCompare(b));

    renderTeachers(); renderStudents(); renderGroupSummary();
    $("#readStatus").textContent = `Tamam: ${state.teachers.length} Ã¶ÄŸretmen, ${state.students.length} Ã¶ÄŸrenci, ${Object.keys(state.groups).length} grup.`;

    reconcileAllToProgram(getAssignPolicy());
  }catch(err){
    $("#readStatus").textContent = "Hata: " + err.message;
  }
}

/* ===== 2) Program ===== */
function getAssignPolicy(){ return $("#assignPolicy").value; }

function ensureSlotLabels(){ // why: yazdÄ±r ve mÃ¼saitlikte saatleri kullanmak
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  for(let i=0;i<S;i++) if(typeof state.program.slotLabels[i] !== 'string') state.program.slotLabels[i]='';
  if(state.program.slotLabels.length>S) state.program.slotLabels.length = S;
}
function renderSlotLabels(){
  ensureSlotLabels();
  const S = state.program.slots;
  const wrap = $("#slotLabelsWrap"); wrap.innerHTML='';
  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'Saat Etiketleri',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const c=document.createElement('div'); c.className='kcell';
    const lab = state.program.slotLabels[s]||'';
    c.innerHTML = `<div class="mini">${s+1}. Ders</div><div>${lab||'â€”'}</div>`;
    c.title='TÄ±kla: saat gir (Ã¶r. 16:30-17:10). Alt+tÄ±k: bu etiketi boÅŸ slotlara kopyala.';
    c.addEventListener('click', (e)=>{
      const v = prompt(`${s+1}. ders iÃ§in saat etiketi (Ã¶r. 16:30-17:10):`, state.program.slotLabels[s]||'');
      if(v!==null){ state.program.slotLabels[s]=v.trim(); renderSlotLabels(); }
    });
    c.addEventListener('auxclick', e=>{ e.preventDefault(); });
    c.addEventListener('mousedown', e=>{
      if(e.altKey){ // why: hÄ±zlÄ± kopya
        const val = state.program.slotLabels[s]||'';
        for(let k=0;k<S;k++) if(!state.program.slotLabels[k]) state.program.slotLabels[k]=val;
        renderSlotLabels();
      }
    });
    head.appendChild(c);
  }
  wrap.appendChild(head);

  const tools=document.createElement('div'); tools.className='row';
  tools.innerHTML = `
    <div class="qty">
      <button class="xs" id="btnFillForward">BoÅŸlarÄ± soldan doldur</button>
    </div>
    <input id="bulkSlotLabels" class="wide" type="text" placeholder="Toplu yapÄ±ÅŸtÄ±r: 16:30-17:10; 17:20-18:00; ..." />
    <button class="btn ghost" id="btnApplyBulk">Uygula</button>
    <button class="btn ghost" id="btnClearLabels">Temizle</button>
  `;
  wrap.appendChild(tools);
  $("#btnFillForward").onclick = ()=>{
    for(let i=1;i<S;i++){ if(!state.program.slotLabels[i]) state.program.slotLabels[i]=state.program.slotLabels[i-1]||''; }
    renderSlotLabels();
  };
  $("#btnApplyBulk").onclick = ()=>{
    const txt = $("#bulkSlotLabels").value.trim();
    if(!txt) return;
    const parts = txt.split(';').map(x=>x.trim());
    for(let i=0;i<S;i++) state.program.slotLabels[i]=parts[i]||state.program.slotLabels[i]||'';
    renderSlotLabels();
  };
  $("#btnClearLabels").onclick = ()=>{ state.program.slotLabels = Array(S).fill(''); renderSlotLabels(); };
}

function buildProgramGrid(fromRestore=false){
  if(!fromRestore){
    state.program.days = $("#daysInput").value.split(',').map(s=>s.trim()).filter(Boolean);
    state.program.slots = clamp(parseInt($("#slotsInput").value||"8"), 1, 12);
  }
  ensureSlotLabels();
  const days = state.program.days, S = state.program.slots;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';

  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'GÃ¼n / Saat',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const label = state.program.slotLabels[s]||'';
    const hc = document.createElement('div'); hc.className='kcell busy';
    hc.innerHTML = `<div>${s+1}</div><div class="mini2">${label||''}</div>`;
    head.appendChild(hc);
  }
  wrap.appendChild(head);

  days.forEach((d,di)=>{
    const row = document.createElement('div');
    row.className = 'kgrid'; row.style.setProperty('--cols', S);
    const lbl = document.createElement('div'); lbl.textContent = d; lbl.style.fontWeight='800'; row.appendChild(lbl);
    for(let si=0; si<S; si++){
      const key = keyDS(di,si);
      const cell = document.createElement('div'); cell.className='kcell';
      cell.textContent = state.program.cells[key] || '';
      cell.title = "Not girmek iÃ§in tÄ±klayÄ±n (opsiyonel)";
      cell.onclick = ()=>{
        const val = prompt(`${d} - ${si+1}. saat iÃ§in not:`, state.program.cells[key]||'');
        if(val!==null){ state.program.cells[key]=val.trim(); cell.textContent=state.program.cells[key]||''; }
      };
      row.appendChild(cell);
    }
    wrap.appendChild(row);
  });

  reconcileAllToProgram(getAssignPolicy());
}

/* Programla uyum */
function reconcileAllToProgram(policy='keep'){
  const D = state.program.days.length, S = state.program.slots;

  state.teachers.forEach(t=>{
    const cur = state.availability.teachers[t.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.teachers[t.id] = next;
  });
  Object.values(state.groups).forEach(g=>{
    const cur = state.availability.groups[g.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.groups[g.id] = next;
  });

  if(policy==='reset') state.assignments = [];
  else state.assignments = state.assignments.filter(a=> a.day<D && a.slot<S);
}

/* ===== 3) MÃ¼saitlik ===== */
function slotHeadCells(container,S){
  for(let s=0;s<S;s++){
    const lab = state.program.slotLabels?.[s] || '';
    const hd = document.createElement('div'); hd.className='kcell busy';
    hd.innerHTML = `<div>${s+1}</div><div class="mini2">${lab}</div>`;
    container.appendChild(hd);
  }
}
function renderAvailGrids(){
  const D=state.program.days.length, S=state.program.slots, days=state.program.days;

  const tWrap=$("#teacherAvailWrap"); tWrap.innerHTML='';
  if(state.teachers.length===0){
    tWrap.innerHTML = '<div class="muted">Ã–ÄŸretmen verisi yok. LÃ¼tfen "Verileri Oku" ile yÃ¼kleyin.</div>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>ğŸ‘¤ ${t.name}</b><span class="tag">${t.branch}</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='TÃ¼mÃ¼nÃ¼ Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='TÃ¼mÃ¼nÃ¼ DeÄŸil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.teachers[t.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.teachers[t.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.teachers[t.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='GÃ¼n / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='Ã‡ift tÄ±kla: bu gÃ¼nÃ¼ tÃ¼m gÃ¼nlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gÃ¼nÃ¼nÃ¼ kopyala?`)){ copyDayPattern(state.availability.teachers[t.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.teachers[t.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'DeÄŸil';
          cell.onclick = ()=>{
            const cur = state.availability.teachers[t.id][d][s] = !state.availability.teachers[t.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'DeÄŸil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); tWrap.appendChild(card);
    });
  }

  const gWrap=$("#groupAvailWrap"); gWrap.innerHTML='';
  const groups = Object.values(state.groups);
  if(groups.length===0){
    gWrap.innerHTML = '<div class="muted">Grup verisi yok. Ã–ÄŸrencilerden gruplar tÃ¼retilir.</div>';
  }else{
    groups.sort(groupComparator).forEach(g=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='TÃ¼mÃ¼nÃ¼ Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='TÃ¼mÃ¼nÃ¼ DeÄŸil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.groups[g.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.groups[g.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.groups[g.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='GÃ¼n / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='Ã‡ift tÄ±kla: bu gÃ¼nÃ¼ tÃ¼m gÃ¼nlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gÃ¼nÃ¼nÃ¼ kopyala?`)){ copyDayPattern(state.availability.groups[g.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.groups[g.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'DeÄŸil';
          cell.onclick = ()=>{
            const cur = state.availability.groups[g.id][d][s] = !state.availability.groups[g.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'DeÄŸil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); gWrap.appendChild(card);
    });
  }
}
function bulkSet(matrix, val){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=val; }
function bulkToggle(matrix){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=!matrix[d][s]; }
function copyDayPattern(matrix, fromDay){ const row = matrix[fromDay].slice(); for(let d=0; d<matrix.length; d++){ matrix[d] = row.slice(); } }

/* ===== 4) Talepler ===== */
function ensureRequests(){
  Object.values(state.groups).forEach(g=>{
    state.requests[g.id] = state.requests[g.id] || {};
    state.branches.forEach(b=>{
      if(typeof state.requests[g.id][b] !== 'number') state.requests[g.id][b] = 0;
    });
  });
}
function refreshReqFilterOptions(){
  const sel = $("#reqGroupSelect"); sel.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(Grup seÃ§in)'; sel.appendChild(opt0);
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
  });
}
function totalRequestForGroup(gid){
  const req = state.requests[gid]||{};
  return Object.values(req).reduce((a,b)=>a+(+b||0),0);
}

function renderRequests(){
  ensureRequests();

  // Neden: BranÅŸ toplam/kalan rozetlerini her Ã§izimde gÃ¼ncel tutmak iÃ§in
  if (typeof renderBranchChipsSummary === 'function') {
    renderBranchChipsSummary();
  } else {
    // Yedek: helper yoksa en azÄ±ndan branÅŸ isimlerini gÃ¶ster
    const bc = $("#branchChips");
    if (bc) {
      bc.innerHTML = '';
      state.branches.forEach(b=>{
        const x = document.createElement('span');
        x.className = 'pill';
        x.textContent = b;
        bc.appendChild(x);
      });
    }
  }

  const selVal = $("#reqGroupSelect").value;
  const wrap = $("#reqWrap");
  wrap.innerHTML = '';

  if(!selVal){
    wrap.innerHTML = '<div class="muted">Soldan bir grup seÃ§in. SeÃ§ilen gruba ait talepleri dÃ¼zenleyin.</div>';
    return;
  }

  const g = state.groups[selVal];
  if(!g){
    wrap.innerHTML = '<div class="muted">SeÃ§ilen grup bulunamadÄ±.</div>';
    return;
  }

  const card = document.createElement('div');
  card.className = 'card';

  const total = totalRequestForGroup(g.id);
  const capacity = state.program.days.length * state.program.slots;
  const chip = document.createElement('span');
  chip.className = 'pill' + (total > capacity ? ' bad' : '');
  chip.textContent = `Toplam: ${total} â€¢ Kapasite: ${capacity}`;

  const head = document.createElement('div');
  head.className = 'flex';
  head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span>`;
  head.appendChild(chip);
  card.appendChild(head);

  const tbl = document.createElement('table');
  tbl.style.borderSpacing = '0 6px';
  tbl.innerHTML = `<thead><tr><th>BranÅŸ</th><th style="width:240px">Saat</th></tr></thead><tbody></tbody>`;

  state.branches.forEach(b=>{
    const tr = document.createElement('tr');

    const td1 = document.createElement('td');
    td1.textContent = b;
    tr.appendChild(td1);

    const td2 = document.createElement('td');
    const box = document.createElement('div'); box.className = 'qty';

    const minus = document.createElement('button'); minus.textContent = 'â€“';
    const inp = document.createElement('input'); inp.type = 'number'; inp.min = '0'; inp.value = state.requests[g.id][b] || 0;
    const plus = document.createElement('button'); plus.textContent = '+';

    minus.onclick = ()=>{
      inp.value = Math.max(0, (+inp.value || 0) - 1);
      inp.dispatchEvent(new Event('input'));
    };
    plus.onclick  = ()=>{
      inp.value = (+inp.value || 0) + 1;
      inp.dispatchEvent(new Event('input'));
    };

    inp.oninput = (e)=>{
      // Neden: istenmeyen deÄŸerleri engelle, Ã¶zetleri canlÄ± gÃ¼ncelle
      state.requests[g.id][b] = clamp(parseInt(e.target.value || '0'), 0, 999);

      const t = totalRequestForGroup(g.id);
      chip.className = 'pill' + (t > capacity ? ' bad' : '');
      chip.textContent = `Toplam: ${t} â€¢ Kapasite: ${capacity}`;

      if (typeof renderBranchChipsSummary === 'function') {
        renderBranchChipsSummary(); // branÅŸ kalan/kapasite Ã¶zetlerini canlÄ± gÃ¼ncelle
      }
    };

    box.append(minus, inp, plus);
    td2.appendChild(box);
    tr.appendChild(td2);

    tbl.querySelector('tbody').appendChild(tr);
  });

  card.appendChild(tbl);
  wrap.appendChild(card);
}
const exportReq = ()=>download('grup-talepleri.json', state.requests);
const importReq = obj=>{
  if(!obj || typeof obj!=='object') return alert('GeÃ§ersiz talepler JSON.');
  state.requests = obj;
  refreshReqFilterOptions();
  renderRequests();
};

/* ===== 5) Atama ===== */
function findTeacherOptions(branch){ return state.teachers.filter(t=>t.branch===branch); }
function isTeacherBusy(teacherId, day, slot){ return state.assignments.some(a=>a.teacherId===teacherId && a.day===day && a.slot===slot); }
function isGroupBusy(groupId, day, slot){ return state.assignments.some(a=>a.group===groupId && a.day===day && a.slot===slot); }
function prevGroupSubject(groupId, day, slot){
  if(slot>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day && x.slot===slot-1); return a ? a.branch : null; }
  if(day>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day-1 && x.slot===state.program.slots-1); return a ? a.branch : null; }
  return null;
}
function hasAssignmentsForGroup(gid){ return state.assignments.some(a=>a.group===gid); }
/* BranÅŸ ismini CSS sÄ±nÄ±fÄ±na Ã§eviren yardÄ±mcÄ± */
function getBranchClass(branchName) {
    if (!branchName) return '';
    const b = branchName.toUpperCase();
    if (b.includes('MATEMATÄ°K')) return 'mat';
    if (b.includes('FEN')) return 'fen';
    if (b.includes('TÃœRKÃ‡E')) return 'trk';
    if (b.includes('SOSYAL')) return 'sos';
    if (b.includes('Ä°NGÄ°LÄ°ZCE')) return 'ing';
    if (b.includes('DÄ°N')) return 'din';
    return ''; // TanÄ±msÄ±zsa varsayÄ±lan gri kalÄ±r
}
  
  function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;

  const groups = Object.values(state.groups).slice()
    .sort((a,b)=> (hasAssignmentsForGroup(b.id)?1:0)-(hasAssignmentsForGroup(a.id)?1:0) || groupComparator(a,b));

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='flex';
    const count = state.assignments.filter(a=>a.group===g.id).length;
    head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span><span class="pill">${count} atama</span>`;
    card.appendChild(head);

    const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
    const headRow = document.createElement('div'); headRow.textContent='GÃ¼n / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
    slotHeadCells(grid,S);

    for(let d=0; d<days.length; d++){
      const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
      row.appendChild(Object.assign(document.createElement('div'),{textContent:days[d],style:'font-weight:700'}));
      for(let s=0; s<S; s++){
        const cell = document.createElement('div');
        cell.className = 'kcell';
        cell.dataset.d = d;
        cell.dataset.s = s;

        // Duruma gÃ¶re uygunluk rengini uygula (mÃ¼saitse yeÅŸil, deÄŸilse kÄ±rmÄ±zÄ±).
        // Bu renkler yalnÄ±zca boÅŸ hÃ¼creler iÃ§in kullanÄ±lÄ±r; atamasÄ± olan hÃ¼creler
        // kendi ders renkleriyle gÃ¶sterilecektir.
        const avail = state.availability?.groups?.[g.id]?.[d]?.[s] === true;
        cell.classList.add(avail ? 'ok' : 'bad');

        // Mevcut bir atama var mÄ±? Varsa hÃ¼creyi ders rengine dÃ¶nÃ¼ÅŸtÃ¼r.
        const cur = state.assignments.find(a => a.group === g.id && a.day === d && a.slot === s);
     if (cur) {
    // 1. SÄ±nÄ±flarÄ± temizle ve ders rengini ekle
    cell.classList.remove('ok', 'bad', 'busy');
    cell.classList.add('assigned', getBranchClass(cur.branch));

    // 2. Ã–ÄŸretmen ismini veriden bul
    const teacherObj = state.teachers.find(t => t.id === cur.teacherId);
    // Ä°sim varsa al, yoksa boÅŸ string dÃ¶ndÃ¼r (icon yanÄ±na boÅŸluk gelmemesi iÃ§in)
    const teacherName = teacherObj ? teacherObj.name : '';

    // 3. Ä°Ã‡ERÄ°K HTML - GÃœNCELLENDÄ°
    cell.innerHTML = `
      <div style="
          display:flex; 
          flex-direction:column; 
          justify-content:center; 
          align-items:center; 
          height:100%; 
          width:100%; 
          pointer-events:none; 
          padding-bottom: 4px; /* Bu satÄ±r iÃ§eriÄŸi yukarÄ± iter */
      ">
        
        <div style="
            font-weight:900; 
            font-size:14px; 
            line-height:1; 
            margin-bottom:3px; 
            text-align:center; 
            letter-spacing: -0.3px; /* Harfleri hafif sÄ±kÄ±ÅŸtÄ±rarak sÄ±ÄŸdÄ±rÄ±r */
        ">
            ${cur.branch}
        </div>
        
        <div class="mini2" style="
            font-size:11px; 
            font-weight:700; 
            opacity:0.9; 
            line-height:1; 
            white-space:nowrap; 
            overflow:hidden; 
            text-overflow:ellipsis; 
            max-width:98%;
        ">
            ğŸ‘¤ ${teacherName}
        </div>

      </div>`;
}
        cell.onclick = () => {
          openAssignDialog(g.id, d, s);
        };
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }

    card.appendChild(grid);
    wrap.appendChild(card);
  });
}
const dlg = $("#dlgAssign"); let dlgCtx = null;

function openAssignDialog(group, day, slot) {
  dlgCtx = { group, day, slot };
  $("#dlgGroup").value = group;

  const time = state.program.slotLabels?.[slot] || `${slot + 1}. saat`;
  $("#dlgWhen").value = `${state.program.days[day]} â€¢ ${time}`;

  // BranÅŸ seÃ§enekleri
  const selB = $("#dlgBranch");
  selB.innerHTML = '';
  state.branches.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b; opt.textContent = b;
    selB.appendChild(opt);
  });
  selB.onchange = fillTeachersForBranch;

  // Mevcut atama var mÄ±?
  const current = state.assignments.find(a => a.group === group && a.day === day && a.slot === slot);

  // EÄŸer hÃ¼crede atama varsa, o branÅŸÄ± Ã¶n-seÃ§
  if (current) selB.value = current.branch;

  // Ã–ÄŸretmen listesini branÅŸa gÃ¶re doldur
  fillTeachersForBranch();

  // Ã–ÄŸretmen Ã¶n-seÃ§imi (mevcut atama varsa)
  if (current) {
    // Not: Ã–ÄŸretmen baÅŸka yerde atanmÄ±ÅŸsa UI'da "atanmÄ±ÅŸ" olarak gÃ¶rÃ¼nebilir.
    // Sil butonunu gÃ¶stermek asÄ±l hedef; seÃ§im baÅŸarÄ±sÄ±z olsa da sorun deÄŸil.
    const selT = $("#dlgTeacher");
    selT.value = current.teacherId;
    $("#dlgDelete").hidden = false;
  } else {
    $("#dlgDelete").hidden = true;
  }

  dlg.showModal();
}
$("#dlgDelete").onclick = () => {
  if (!dlgCtx) return;
  const { group, day, slot } = dlgCtx;
  const has = state.assignments.some(a => a.group === group && a.day === day && a.slot === slot);
  if (!has) { dlg.close(); return; }

  if (confirm("Bu atamayÄ± silmek istiyor musunuz?")) {
    state.assignments = state.assignments.filter(a => !(a.group === group && a.day === day && a.slot === slot));
    dlg.close();
    renderAssignCards(); // why: Ã¶ÄŸretmen anÄ±nda tekrar 'mÃ¼sait' gÃ¶rÃ¼nsÃ¼n
  }
};

function hasAnyAssignments(){ return Array.isArray(state.assignments) && state.assignments.length > 0; }
function getTeacherAssignmentsMap(){
  const m = new Map();
  for (const a of state.assignments) {
    if (!m.has(a.teacherId)) m.set(a.teacherId, []);
    m.get(a.teacherId).push(a);
  }
  return m;
}

/**
 * Compute the total number of lesson slots a teacher could be assigned given
 * current group requests. This capacity is the sum of all requested lesson
 * counts for the teacher's branch across all groups. It serves as an upper
 * bound on how many lessons the teacher might teach in the plan. If no
 * requests exist for that branch the capacity will be zero.
 * @param {string} tid - teacher ID
 * @returns {number} total slots requested for this teacher's branch
 */
function teacherCapacity(tid) {
  const tObj = state.teachers.find(x => x.id === tid);
  if (!tObj) return 0;
  const br = tObj.branch;
  let total = 0;
  for (const gid of Object.keys(state.requests)) {
    const req = state.requests[gid] || {};
    const n = req[br];
    if (typeof n === 'number' && !isNaN(n)) total += n;
  }
  return total;
}

/**
 * Calculate how many lesson slots a teacher is available for based on the
 * current availability matrix. Each true entry in state.availability.teachers
 * counts as one potential lesson the teacher could teach. This is used in
 * the manual assignment panel to show a teacher's capacity (mÃ¼saitlik) to
 * take on lessons as opposed to the total requested lesson count. Without
 * this helper the UI displayed confusing large numbers like 24 or 26. The
 * user explicitly requested that the availability count and the active
 * assignment count be shown next to each teacher in the manual assignment
 * panel.
 * @param {string} tid - teacher ID
 * @returns {number} number of available slots for this teacher
 */
function teacherAvailabilityCount(tid) {
  const avail = state.availability?.teachers?.[tid] || [];
  const D = state.program?.days?.length || 0;
  const S = state.program?.slots || 0;
  let total = 0;
  for (let d = 0; d < D; d++) {
    const row = avail[d] || [];
    for (let s = 0; s < S; s++) {
      if (row[s] === true) total++;
    }
  }
  return total;
}

function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const {day, slot} = dlgCtx || {};
  const selT = $("#dlgTeacher"); selT.innerHTML = '';

  // Precompute current assignment counts for teachers once per invocation
  const assignMap = getTeacherAssignmentsMap();
  findTeacherOptions(branch).forEach(t => {
    const availOk = state.availability.teachers[t.id]?.[day]?.[slot] === true;
    const busyNow = isTeacherBusy(t.id, day, slot);

    const ok = availOk && !busyNow;

    const opt = document.createElement('option');
    opt.value = t.id;

    // Determine how many slots the teacher is available for and currently assigned
    const totalAssigned = (assignMap.get(t.id) || []).length;
    const availCount = teacherAvailabilityCount(t.id);

    // Build label showing availability and active assignment counts
    // Format: (mÃ¼saitlik / atama) e.g. (10/3)
    const countLabel = `(${availCount}/${totalAssigned})`;

    if (ok) {
      // Teacher is available; display counts next to name
      opt.textContent = `${t.name} ${countLabel}`;
    } else {
      // Teacher not suitable now; still show counts and reason
      const reason = busyNow ? 'Ã§akÄ±ÅŸÄ±yor' : 'uygun deÄŸil';
      opt.textContent = `${t.name} ${countLabel} â€¢ ${reason}`;
      opt.disabled = true;
    }
    selT.appendChild(opt);
  });

  // VarsayÄ±lan olarak ilk uygun Ã¶ÄŸretmeni seÃ§
  const firstEnabled = Array.from(selT.options).find(o => !o.disabled);
  if (firstEnabled) selT.value = firstEnabled.value;
}

$("#dlgCancel").onclick = ()=> dlg.close();
$("#dlgOk").onclick = () => {
  const {group, day, slot} = dlgCtx;
  const branch = $("#dlgBranch").value;
  const teacherId = $("#dlgTeacher").value;

  // 1) Ã–ÄŸretmen uygunluk kontrolÃ¼
  if (state.availability.teachers[teacherId]?.[day]?.[slot] !== true){
    alert("SeÃ§ilen Ã¶ÄŸretmen bu gÃ¼n/saati iÃ§in mÃ¼sait deÄŸil. LÃ¼tfen uygun bir Ã¶ÄŸretmen seÃ§in.");
    return;
  }

  // 2) Grup uygunluk kontrolÃ¼ (isteÄŸe baÄŸlÄ±)
  if (state.availability.groups[group]?.[day]?.[slot] !== true){
    alert("Bu grup bu gÃ¼n/saati iÃ§in mÃ¼sait deÄŸil.");
    return;
  }

  // 3) Ã‡akÄ±ÅŸma uyarÄ±larÄ± (yalnÄ±z aynÄ± saat)
  if (isTeacherBusy(teacherId, day, slot))
    if(!confirm("Ã–ÄŸretmen bu saatte baÅŸka derste. Yine de ata?")) return;
  if (isGroupBusy(group, day, slot))
    if(!confirm("Bu gruba bu saatte baÅŸka atama var. Ãœzerine yazÄ±lsÄ±n mÄ±?")) return;

  // 4) AtamayÄ± yaz
  state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
  state.assignments.push({group, day, slot, branch, teacherId});
  dlg.close();
  renderAssignCards(); // why: UI ve uygunluk anÄ±nda gÃ¼ncellensin

  // YazdÄ±r sekmesi aÃ§Ä±ksa anÄ±nda tazele (why: manuel atama sonrasÄ± Ã¶nizleme gÃ¼ncel kalsÄ±n)
  const printPanel = $('#step6');
  if (printPanel && !printPanel.hasAttribute('hidden')) {
    refreshPrintFilters();
    renderPrintPreview();
  }
};
// index.html â€” Auto Assign (V4.1): Maks YerleÅŸim OdaklÄ±, YÃ¼k Dengesi YOK

/**
 * AmaÃ§: Ã–ÄŸretmen yÃ¼k dengesini tamamen devre dÄ±ÅŸÄ± bÄ±rakarak,
 * mÃ¼mkÃ¼n olan EN Ã‡OK derse atama yapan varyasyonu bulup uygulamak.
 */

function autoAssign() {
  const D = state.program.days.length;
  const S = state.program.slots;

  // =============================
  //  AYARLAR (hÄ±z / kalite dengesi)
  // =============================
  const TIME_LIMIT_MS = 8000;               // backtracking Ã¼st sÄ±nÄ±r
  const KEEP_EXISTING_ASSIGNMENTS = true;   // mevcut atamalarÄ± koru
  const AVOID_CONSECUTIVE_SAME_BRANCH = true; // aynÄ± gruba ardÄ±ÅŸÄ±k aynÄ± branÅŸ yok

  const now0 = performance.now();

  // --- YardÄ±mcÄ±lar ---
  const makeGrid = (rows, cols, fill=null) => Array.from({length:rows}, () => Array(cols).fill(fill));
  const ensureGrid = (mat, id) => (mat[id] ||= makeGrid(D, S, null));
  const keyCell = (gid,d,s) => `${gid}|${d}|${s}`;

  const prevBranchOf = (gGrid, gid, d, s) => {
    if (!AVOID_CONSECUTIVE_SAME_BRANCH) return null;
    if (s > 0) return gGrid[gid]?.[d]?.[s-1]?.branch || null;
    if (d > 0) return gGrid[gid]?.[d-1]?.[S-1]?.branch || null;
    return null;
  };

  const teacherObjById = (() => {
    const map = new Map();
    (state.teachers || []).forEach(t => map.set(t.id, t));
    return map;
  })();
  const teacherName = (tid) => teacherObjById.get(tid)?.name || String(tid);

  // Bu fonksiyon zaten kodda var (manuel atama modalinde de kullanÄ±lÄ±yor).
  // Burada gÃ¼venli Ã§aÄŸÄ±rÄ±yoruz; yoksa basit filtreye dÃ¼ÅŸer.
  const teachersForBranch = (branch) => {
    try {
      const arr = findTeacherOptions(branch);
      if (Array.isArray(arr) && arr.length) return arr;
    } catch { /* ignore */ }
    // fallback: state.teachers.branch eÅŸleÅŸmesi
    return (state.teachers || []).filter(t => String(t.branch||'').toUpperCase() === String(branch||'').toUpperCase());
  };

  // --- Mevcut atamalarÄ± (sabitler) al ---
  const baseAssignments = KEEP_EXISTING_ASSIGNMENTS ? state.assignments.map(a => ({...a})) : [];
  const baseCount = baseAssignments.length;

  // Gridleri doldur (sabitler)
  const gGrid = {};
  const tGrid = {};
  for (const a of baseAssignments) {
    ensureGrid(gGrid, a.group)[a.day][a.slot] = a;
    ensureGrid(tGrid, a.teacherId)[a.day][a.slot] = a;
  }

  // --- Ä°htiyaÃ§larÄ± Ã§Ä±kar (her eksik ders = 1 task) ---
  function buildTasksFromState() {
    const tasks = [];
    for (const g of Object.values(state.groups)) {
      const req = state.requests[g.id] || {};
      const have = {};
      for (const a of baseAssignments) {
        if (a.group === g.id) have[a.branch] = (have[a.branch] || 0) + 1;
      }
      for (const [branch, cnt] of Object.entries(req)) {
        const needed = Math.max(0, (cnt|0) - (have[branch] || 0));
        for (let i=0;i<needed;i++) tasks.push({ gid: g.id, branch });
      }
    }
    return tasks;
  }
  const tasksAll = buildTasksFromState();
  if (tasksAll.length === 0) {
    renderAssignCards();
    showAutoAssignReport(buildAutoAssignReport({
      baseCount,
      placedCount: 0,
      totalNeed: 0,
      timeMs: Math.round(performance.now() - now0),
      exhausted: false
    }));
    return;
  }

  // --- HÄ±z iÃ§in: grup boÅŸ-slot listesi Ã¶n-hesap ---
  const groupFreeSlots = {};
  for (const g of Object.values(state.groups)) {
    const gid = g.id;
    const slots = [];
    for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
      if (state.availability.groups[gid]?.[d]?.[s] !== true) continue;
      if (gGrid[gid]?.[d]?.[s]) continue; // sabit dolu
      slots.push([d,s]);
    }
    groupFreeSlots[gid] = slots;
  }

  // --- Aday Ã¼retimi (dinamik: Ã¶ÄŸretmen doluluÄŸu + ardÄ±ÅŸÄ±k branÅŸ kontrolÃ¼) ---
  function getCandidates(task) {
    const { gid, branch } = task;
    const candidates = [];
    const slots = groupFreeSlots[gid] || [];
    for (const [d,s] of slots) {
      // o an grupta dolu olabilir (backtracking sÄ±rasÄ±nda)
      if (gGrid[gid]?.[d]?.[s]) continue;

      const lastB = prevBranchOf(gGrid, gid, d, s);
      if (lastB && lastB === branch) continue;

      // bu branÅŸ Ã¶ÄŸretmenleri
      const tList = teachersForBranch(branch);
      for (const t of tList) {
        const tid = t.id;
        if (state.availability.teachers[tid]?.[d]?.[s] !== true) continue;
        if (tGrid[tid]?.[d]?.[s]) continue;

        candidates.push({ d, s, tid });
      }
    }
    return candidates;
  }

  // --- MRV: en az seÃ§eneÄŸi olan task Ã¶nce ---
  // Ä°lk sÄ±ralama kaba bir Ã¶n-tahminle yapÄ±lÄ±r; recursion iÃ§inde tekrar MRV seÃ§iyoruz.
  function roughCandidateCount(task) {
    const { gid, branch } = task;
    let c = 0;
    const slots = groupFreeSlots[gid] || [];
    const tList = teachersForBranch(branch);
    // Ã§ok hÄ±zlÄ± kaba hesap (dolu/ardÄ±ÅŸÄ±k kontrolÃ¼ yok)
    for (const [d,s] of slots) {
      for (const t of tList) {
        if (state.availability.teachers[t.id]?.[d]?.[s] === true) c++;
      }
    }
    return c;
  }

  let tasks = tasksAll.slice();
  tasks.sort((a,b) => roughCandidateCount(a) - roughCandidateCount(b));

  // --- Ã–ÄŸretmen yÃ¼kÃ¼ (tie-break) ---
  const teacherLoad = {};
  for (const a of baseAssignments) teacherLoad[a.teacherId] = (teacherLoad[a.teacherId]||0) + 1;

  // --- En iyi kÄ±smi Ã§Ã¶zÃ¼m (maks yerleÅŸim) ---
  let bestPlaced = -1;
  let bestNewAssignments = [];
  let exhausted = false;

  const newAssignments = [];

  function snapshotIfBest() {
    if (newAssignments.length > bestPlaced) {
      bestPlaced = newAssignments.length;
      bestNewAssignments = newAssignments.map(x => ({...x}));
    }
  }

  function timeExceeded() {
    return (performance.now() - now0) >= TIME_LIMIT_MS;
  }

  // Dinamik MRV seÃ§imi: kalan tasklar iÃ§inden en az adaylÄ± olanÄ± seÃ§
  function pickNextTaskIndex(startIdx) {
    let bestIdx = -1;
    let bestC = Infinity;
    for (let i=startIdx; i<tasks.length; i++) {
      // tasks[i] henÃ¼z yerleÅŸtirilmemiÅŸ kabul edilir; yerleÅŸtirdikÃ§e swap ile Ã¶ne alacaÄŸÄ±z
      const c = getCandidates(tasks[i]).length;
      if (c < bestC) {
        bestC = c;
        bestIdx = i;
        if (bestC === 0) break;
      }
    }
    return bestIdx;
  }

  function backtrack(placedSoFar) {
    if (timeExceeded()) { exhausted = true; snapshotIfBest(); return; }

    // en iyiye ulaÅŸma Ã¼st sÄ±nÄ±rÄ±
    const remaining = tasks.length - placedSoFar;
    if (placedSoFar + remaining <= bestPlaced) return;

    if (placedSoFar === tasks.length) {
      snapshotIfBest();
      return;
    }

    // MRV: sÄ±radaki task'Ä± seÃ§ip [placedSoFar] konumuna getir
    const idx = pickNextTaskIndex(placedSoFar);
    if (idx === -1) { snapshotIfBest(); return; }
    if (idx !== placedSoFar) [tasks[placedSoFar], tasks[idx]] = [tasks[idx], tasks[placedSoFar]];

    const task = tasks[placedSoFar];
    const cand = getCandidates(task);

    if (cand.length === 0) {
      // Bu task yerleÅŸemiyor â†’ bu dal biter, ama kÄ±smi Ã§Ã¶zÃ¼mÃ¼ kaydedebiliriz
      snapshotIfBest();
      return;
    }

    // LCV benzeri: Ã¶nce daha az yÃ¼klÃ¼ Ã¶ÄŸretmen, sonra daha erken slot (stabil)
    cand.sort((a,b) => (teacherLoad[a.tid]||0) - (teacherLoad[b.tid]||0) || a.d - b.d || a.s - b.s);

    for (const c of cand) {
      if (timeExceeded()) { exhausted = true; snapshotIfBest(); return; }

      const a = { group: task.gid, day: c.d, slot: c.s, branch: task.branch, teacherId: c.tid };

      // yerleÅŸtir
      ensureGrid(gGrid, a.group)[a.day][a.slot] = a;
      ensureGrid(tGrid, a.teacherId)[a.day][a.slot] = a;
      newAssignments.push(a);
      teacherLoad[a.teacherId] = (teacherLoad[a.teacherId]||0) + 1;

      backtrack(placedSoFar + 1);

      // tam Ã§Ã¶zÃ¼m bulunduysa erken Ã§Ä±kÄ±ÅŸ
      if (bestPlaced === tasks.length) return;

      // geri al
      teacherLoad[a.teacherId] = Math.max(0, (teacherLoad[a.teacherId]||0) - 1);
      newAssignments.pop();
      gGrid[a.group][a.day][a.slot] = null;
      tGrid[a.teacherId][a.day][a.slot] = null;
    }
  }

  backtrack(0);

  // --- En iyi Ã§Ã¶zÃ¼mÃ¼ uygula ---
  const merged = baseAssignments.concat(bestNewAssignments);
  // olasÄ± Ã§ift kayÄ±tlarÄ± temizle (aynÄ± grup/slot)
  const seen = new Set();
  state.assignments = merged.filter(a => {
    const k = keyCell(a.group, a.day, a.slot);
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });

  renderAssignCards();

  showAutoAssignReport(buildAutoAssignReport({
    baseCount,
    placedCount: bestPlaced,
    totalNeed: tasksAll.length,
    timeMs: Math.round(performance.now() - now0),
    exhausted
  }));
}


/* =========================================================
   Otomatik Atama SonrasÄ±: Eksik Analizi + Basit Rapor ModalÄ±
   ========================================================= */
function buildAutoAssignReport(meta){
  const D = state.program.days.length;
  const S = state.program.slots;
  const days = state.program.days || [];

  const baseCount = meta?.baseCount ?? 0;
  const totalNeed = meta?.totalNeed ?? 0;
  const placedCount = meta?.placedCount ?? 0;

  const teacherObjById = (() => {
    const map = new Map();
    (state.teachers || []).forEach(t => map.set(t.id, t));
    return map;
  })();
  const teacherName = (tid) => teacherObjById.get(tid)?.name || String(tid);

  const teachersForBranch = (branch) => {
    try {
      const arr = findTeacherOptions(branch);
      if (Array.isArray(arr) && arr.length) return arr;
    } catch { /* ignore */ }
    return (state.teachers || []).filter(t => String(t.branch||'').toUpperCase() === String(branch||'').toUpperCase());
  };

  const assignments = state.assignments || [];

  // --- sayÄ±mlar ---
  const assignedByGroupBranch = {};
  const assignedByGroup = {};
  const assignedByTeacherAt = new Set(); // "tid|d|s"
  for (const a of assignments) {
    assignedByGroupBranch[a.group] ||= {};
    assignedByGroupBranch[a.group][a.branch] = (assignedByGroupBranch[a.group][a.branch]||0) + 1;
    assignedByGroup[a.group] = (assignedByGroup[a.group]||0) + 1;
    assignedByTeacherAt.add(`${a.teacherId}|${a.day}|${a.slot}`);
  }

  // --- grup mÃ¼sait saat ve boÅŸ mÃ¼sait saat ---
  const groupAvail = {};
  const groupFreeAvail = {};
  for (const g of Object.values(state.groups)) {
    const gid = g.id;
    let avail=0, freeAvail=0;
    for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
      if (state.availability.groups[gid]?.[d]?.[s] === true) {
        avail++;
        const hasAssign = assignments.some(a => a.group===gid && a.day===d && a.slot===s);
        if (!hasAssign) freeAvail++;
      }
    }
    groupAvail[gid]=avail;
    groupFreeAvail[gid]=freeAvail;
  }

  // --- aÃ§Ä±k dersler listesi ---
  const open = []; // {gid, branch, cnt, reason, hint, sampleCandidates}
  let openTotal = 0;

  const reasonCounters = { group_time:0, teacher_time:0, distribution:0 };

  function slotLabel(d,s){
    const day = days[d] || `GÃ¼n${d+1}`;
    const lbl = state.program.slotLabels?.[s] || `${s+1}. ders`;
    return `${day} â€¢ ${lbl}`;
  }

  function hasGroupSlot(gid){
    // grupta en az bir BOÅ + MÃœSAÄ°T slot var mÄ±?
    for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
      if (state.availability.groups[gid]?.[d]?.[s] !== true) continue;
      if (assignments.some(a => a.group===gid && a.day===d && a.slot===s)) continue;
      return true;
    }
    return false;
  }

  function findSomeCandidates(gid, branch, max=6){
    // Bu aÃ§Ä±k ders iÃ§in Ã¶rnek adaylar (slot + Ã¶ÄŸretmen)
    const out = [];
    for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
      if (state.availability.groups[gid]?.[d]?.[s] !== true) continue;
      if (assignments.some(a => a.group===gid && a.day===d && a.slot===s)) continue;

      // ardÄ±ÅŸÄ±k aynÄ± branÅŸ kuralÄ± (yaklaÅŸÄ±k)
      const prev = (() => {
        if (s>0) {
          const aPrev = assignments.find(a => a.group===gid && a.day===d && a.slot===s-1);
          return aPrev?.branch || null;
        }
        if (d>0) {
          const aPrev = assignments.find(a => a.group===gid && a.day===d-1 && a.slot===S-1);
          return aPrev?.branch || null;
        }
        return null;
      })();
      if (prev && prev === branch) continue;

      const tList = teachersForBranch(branch);
      for (const t of tList) {
        if (state.availability.teachers[t.id]?.[d]?.[s] !== true) continue;
        if (assignedByTeacherAt.has(`${t.id}|${d}|${s}`)) continue;
        out.push({d,s,tid:t.id});
        if (out.length>=max) return out;
      }
    }
    return out;
  }

  for (const g of Object.values(state.groups)) {
    const gid = g.id;
    const req = state.requests[gid] || {};
    for (const [branch, cntRaw] of Object.entries(req)) {
      const cnt = (cntRaw|0);
      const have = assignedByGroupBranch[gid]?.[branch] || 0;
      const left = Math.max(0, cnt - have);
      if (!left) continue;

      openTotal += left;

      // neden analizi
      let reason = 'distribution';
      let hint = '';

      const anySlot = hasGroupSlot(gid);
      if (!anySlot) {
        reason = 'group_time';
        hint = 'Grubun boÅŸ+mÃ¼sait saati kalmamÄ±ÅŸ.';
      } else {
        const sample = findSomeCandidates(gid, branch, 1);
        if (sample.length === 0) {
          reason = 'teacher_time';
          hint = 'Bu branÅŸ iÃ§in gruba uygun saatlerde boÅŸta Ã¶ÄŸretmen yok.';
        } else {
          reason = (meta?.exhausted ? 'distribution' : 'distribution');
          hint = meta?.exhausted ? 'SÃ¼re limitine takÄ±ldÄ±; el ile tamamlanabilir.' : 'Ã‡akÄ±ÅŸmalar nedeniyle tÃ¼mÃ¼ yerleÅŸemedi.';
        }
      }

      reasonCounters[reason] = (reasonCounters[reason]||0) + left;

      const sampleCandidates = (reason === 'distribution') ? findSomeCandidates(gid, branch, 6) : [];

      open.push({ gid, branch, cnt:left, reason, hint, sampleCandidates });
    }
  }

  // --- BranÅŸ bazÄ±nda talep/kapasite (yaklaÅŸÄ±k) ---
  const branchStats = [];
  const branches = Array.isArray(state.branches) && state.branches.length ? state.branches : ALLOWED_BRANCHES;
  for (const branch of branches) {
    let demand=0, assigned=0;
    for (const g of Object.values(state.groups)) {
      demand += (state.requests[g.id]?.[branch] || 0) | 0;
      assigned += (assignedByGroupBranch[g.id]?.[branch] || 0);
    }
    const tList = teachersForBranch(branch);
    const teacherCount = tList.length;
    let availSlots = 0;
    for (const t of tList) {
      for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
        if (state.availability.teachers[t.id]?.[d]?.[s] === true) availSlots++;
      }
    }
    branchStats.push({
      branch,
      demand,
      assigned,
      open: Math.max(0, demand - assigned),
      teacherCount,
      approxCapacity: availSlots
    });
  }
  branchStats.sort((a,b)=> (b.open - a.open) || (b.demand - a.demand));

  // --- Somut Ã¶neriler (aptal bile anlar modu) ---
  const suggestions = [];

  // 1) Grup bazÄ±nda "talep > mÃ¼sait saat"
  for (const g of Object.values(state.groups)) {
    const gid = g.id;
    let demand=0;
    for (const v of Object.values(state.requests[gid] || {})) demand += (v|0);
    const avail = groupAvail[gid] || 0;
    if (demand > avail) {
      suggestions.push({
        type:'hard',
        text:`${gid}: Talep ${demand} saat ama grup mÃ¼saitliÄŸi ${avail} saat. (Bu haliyle tam Ã§Ã¶zÃ¼m imkÃ¢nsÄ±z)`,
      });
    }
  }

  // 2) BranÅŸ bazÄ±nda "talep > Ã¶ÄŸretmen mÃ¼sait kapasitesi" (yaklaÅŸÄ±k ama Ã§ok faydalÄ±)
  for (const b of branchStats) {
    if (b.open <= 0) continue;
    if (b.teacherCount === 0) {
      suggestions.push({ type:'hard', text:`${b.branch}: Bu branÅŸta hiÃ§ Ã¶ÄŸretmen yok. (${b.open} ders aÃ§Ä±kta)` });
    } else if (b.demand > b.approxCapacity) {
      suggestions.push({ type:'hard', text:`${b.branch}: Talep ${b.demand}, Ã¶ÄŸretmenlerin toplam mÃ¼sait saati ~${b.approxCapacity}. (MÃ¼saitlik/Ã¶ÄŸretmen yetersiz)` });
    }
  }

  // 3) HÄ±zlÄ± aksiyonlar (soft)
  if (reasonCounters.group_time > 0) {
    suggestions.push({ type:'soft', text:`${reasonCounters.group_time} ders, grubun boÅŸ/mÃ¼sait saati kalmadÄ±ÄŸÄ± iÃ§in yerleÅŸemedi. â†’ Grup mÃ¼saitliÄŸinde boÅŸluk aÃ§ veya talepleri azalt.` });
  }
  if (reasonCounters.teacher_time > 0) {
    suggestions.push({ type:'soft', text:`${reasonCounters.teacher_time} ders, branÅŸ Ã¶ÄŸretmeni uygun saatlerde hiÃ§ boÅŸ olmadÄ±ÄŸÄ± iÃ§in yerleÅŸemedi. â†’ Ã–ÄŸretmen mÃ¼saitliÄŸi artÄ±r / ek Ã¶ÄŸretmen / o saatlerdeki Ã§akÄ±ÅŸmalarÄ± azalt.` });
  }
  if (reasonCounters.distribution > 0 && meta?.exhausted) {
    suggestions.push({ type:'soft', text:`Algoritma sÃ¼re limitine takÄ±ldÄ±; ${reasonCounters.distribution} ders iÃ§in adaylar var. â†’ Rapor iÃ§inden â€œHÄ±zlÄ± dÃ¼zeltâ€ ile tamamlayabilirsin.` });
  }

  // quick-fix list (adaylÄ±)
  const quickFix = open
    .filter(x => x.sampleCandidates && x.sampleCandidates.length)
    .slice(0, 12)
    .map(x => ({
      gid: x.gid,
      branch: x.branch,
      cnt: x.cnt,
      // sadece 1 derslik hÄ±zlÄ± atama yapacaÄŸÄ±z (kalan iÃ§in tekrar)
      candidates: x.sampleCandidates
    }));

  return {
    meta: {
      baseCount,
      totalNeed,
      placedCount,
      timeMs: meta?.timeMs ?? 0,
      exhausted: !!meta?.exhausted
    },
    totals: {
      groups: Object.keys(state.groups || {}).length,
      days: D,
      slotsPerDay: S,
      assignedNow: (state.assignments || []).length,
      assignedAdded: Math.max(0, (state.assignments || []).length - baseCount),
      openTotal
    },
    reasons: reasonCounters,
    branchStats: branchStats.slice(0, 10),
    openList: open.sort((a,b)=>b.cnt-a.cnt).slice(0, 40),
    suggestions,
    quickFix
  };
}

function showAutoAssignReport(rep){
  let dlg = document.getElementById('dlgAutoAssignReport');
  if (!dlg) {
    dlg = document.createElement('dialog');
    dlg.id = 'dlgAutoAssignReport';
    dlg.style.padding = '16px';
    dlg.style.borderRadius = '14px';
    dlg.style.maxWidth = '1100px';
    dlg.style.width = 'min(98vw, 1100px)';
    dlg.innerHTML = `
      <header style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="font-weight:900;font-size:18px">ğŸ§¾ Otomatik Atama â€¢ Eksik Analizi</div>
        <button class="btn ghost" id="btnRptCloseX" aria-label="Kapat">Kapat</button>
      </header>
      <section id="autoAssignReportBody" style="max-height:70vh;overflow:auto"></section>
      <footer style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="btnRptCopy">Metni Kopyala</button>
        <button class="btn" id="btnRptClose">Kapat</button>
      </footer>
    `;
    document.body.appendChild(dlg);
    dlg.querySelector('#btnRptClose').onclick = () => dlg.close();
    dlg.querySelector('#btnRptCloseX').onclick = () => dlg.close();
    dlg.querySelector('#btnRptCopy').onclick = () => {
      const txt = dlg.querySelector('#autoAssignReportBody').innerText;
      navigator.clipboard?.writeText(txt);
    };

    // HÄ±zlÄ± dÃ¼zelt: Ata
    dlg.addEventListener('click', (e) => {
      if (!e.target.matches('.btnQuickAssign')) return;
      const row = e.target.closest('[data-qrow="1"]');
      if (!row) return;

      const gid = row.dataset.gid;
      const branch = row.dataset.branch;
      const slotSel = row.querySelector('select.selSlot');
      const teacherSel = row.querySelector('select.selTeacher');

      const val = slotSel?.value || '';
      const tid = teacherSel?.value || '';
      if (!val || !tid) { alert('Slot ve Ã¶ÄŸretmen seÃ§.'); return; }

      const [dStr,sStr] = val.split('|');
      const d = +dStr, s = +sStr;

      const ok = tryQuickAssign({gid, branch, d, s, tid});
      if (!ok) return;

      // raporu yenile (modal aÃ§Ä±k kalsÄ±n)
      const refreshed = buildAutoAssignReport({
        baseCount: +(dlg.dataset.baseCount || 0),
        placedCount: 0,
        totalNeed: +(dlg.dataset.totalNeed || 0),
        timeMs: +(dlg.dataset.timeMs || 0),
        exhausted: (dlg.dataset.exhausted === '1')
      });
      showAutoAssignReport(refreshed);
    });

    // Slot deÄŸiÅŸince Ã¶ÄŸretmenleri filtrele (basit)
    dlg.addEventListener('change', (e) => {
      if (!e.target.matches('select.selSlot')) return;
      const row = e.target.closest('[data-qrow="1"]');
      if (!row) return;
      const gid = row.dataset.gid;
      const branch = row.dataset.branch;
      const [dStr,sStr] = (e.target.value||'').split('|');
      const d=+dStr, s=+sStr;
      const teacherSel = row.querySelector('select.selTeacher');
      if (!teacherSel || Number.isNaN(d) || Number.isNaN(s)) return;

      const tList = (() => {
        try { return findTeacherOptions(branch) || []; } catch { return []; }
      })();
      const opts = [];
      for (const t of tList) {
        if (state.availability.teachers[t.id]?.[d]?.[s] !== true) continue;
        if (state.assignments.some(a => a.teacherId===t.id && a.day===d && a.slot===s)) continue;
        opts.push(`<option value="${escapeAttr(String(t.id))}">${escapeHtml(t.name || t.id)}</option>`);
      }
      teacherSel.innerHTML = opts.join('') || `<option value="">(uygun Ã¶ÄŸretmen yok)</option>`;
    });
  }

  const body = dlg.querySelector('#autoAssignReportBody');

  const t = rep.totals;
  const meta = rep.meta;
  const reasons = rep.reasons;

  const badge = (txt, type='soft') => {
    const bg = type==='hard' ? '#fee2e2' : '#e2f5f2';
    const fg = type==='hard' ? '#991b1b' : '#083c3a';
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:${bg};color:${fg};font-weight:800">${escapeHtml(txt)}</span>`;
  };

  const fmtReason = (r) => ({
    group_time: 'Grup saat yok',
    teacher_time: 'Ã–ÄŸretmen yok/boÅŸ deÄŸil',
    distribution: 'Ã‡akÄ±ÅŸma / sÃ¼re limiti'
  }[r] || r);

  const slotLabel = (d,s) => {
    const day = state.program.days?.[d] || `GÃ¼n${d+1}`;
    const lbl = state.program.slotLabels?.[s] || `${s+1}. ders`;
    return `${day} â€¢ ${lbl}`;
  };

  // quick fix rows
  const qHtml = (rep.quickFix || []).map((q, idx) => {
    const slotOpts = q.candidates
      .map(c => `<option value="${c.d}|${c.s}">${escapeHtml(slotLabel(c.d,c.s))}</option>`)
      .join('');
    // ilk slot iÃ§in Ã¶ÄŸretmen listesi (change event ile yenilenecek)
    const first = q.candidates[0];
    const tList = (() => { try { return findTeacherOptions(q.branch) || []; } catch { return []; } })();
    const tOpts = tList
      .filter(t => state.availability.teachers[t.id]?.[first.d]?.[first.s] === true)
      .filter(t => !state.assignments.some(a => a.teacherId===t.id && a.day===first.d && a.slot===first.s))
      .map(t => `<option value="${escapeAttr(String(t.id))}">${escapeHtml(t.name || t.id)}</option>`)
      .join('') || `<option value="">(uygun Ã¶ÄŸretmen yok)</option>`;

    return `
      <div class="card" data-qrow="1" data-gid="${escapeAttr(q.gid)}" data-branch="${escapeAttr(q.branch)}" style="margin:10px 0">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:900">${escapeHtml(q.gid)} â€¢ ${escapeHtml(q.branch)}</div>
            <div class="mini2">Bu satÄ±r 1 derslik hÄ±zlÄ± tamamlar. AynÄ± satÄ±rÄ± tekrar kullanarak kalanlarÄ± da kapatabilirsin.</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <label class="mini2">Slot
              <select class="selSlot" style="min-width:190px">${slotOpts}</select>
            </label>
            <label class="mini2">Ã–ÄŸretmen
              <select class="selTeacher" style="min-width:190px">${tOpts}</select>
            </label>
            <button class="btn btnQuickAssign">Ata</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  const openRows = (rep.openList || []).map(x => `
    <tr>
      <td class="nowrap"><b>${escapeHtml(String(x.gid))}</b></td>
      <td>${escapeHtml(String(x.branch))}</td>
      <td class="nowrap">${x.cnt}</td>
      <td>${escapeHtml(fmtReason(x.reason))}</td>
      <td class="mini2">${escapeHtml(x.hint || '')}</td>
    </tr>
  `).join('');

  const sugg = (rep.suggestions || []).slice(0, 10).map(s => `<li style="margin:6px 0">${badge(s.type==='hard'?'ZORUNLU':'Ã–NERÄ°', s.type)} <span style="margin-left:6px">${escapeHtml(s.text)}</span></li>`).join('');

  const branchRows = (rep.branchStats || []).map(b => `
    <tr>
      <td><b>${escapeHtml(b.branch)}</b></td>
      <td class="nowrap">${b.demand}</td>
      <td class="nowrap">${b.assigned}</td>
      <td class="nowrap">${b.open}</td>
      <td class="nowrap">${b.teacherCount}</td>
      <td class="nowrap">~${b.approxCapacity}</td>
    </tr>
  `).join('');

    // meta bilgiyi dialog Ã¼zerinde tut (event handler'lar gÃ¼ncel kalsÄ±n)
  dlg.dataset.baseCount = String(meta.baseCount || 0);
  dlg.dataset.totalNeed = String(meta.totalNeed || 0);
  dlg.dataset.timeMs = String(meta.timeMs || 0);
  dlg.dataset.exhausted = meta.exhausted ? '1' : '0';

body.innerHTML = `
    <div class="grid" style="gap:10px">
      <div class="card">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            ${badge(`Atama eklendi: ${t.assignedAdded}`, 'soft')}
            ${badge(`Toplam atama: ${t.assignedNow}`, 'soft')}
            ${badge(`AÃ§Ä±k ders: ${t.openTotal}`, t.openTotal ? 'hard':'soft')}
          </div>
          <div class="mini2">SÃ¼re: ${meta.timeMs} ms ${meta.exhausted ? 'â€¢ (SÃ¼re limitine takÄ±ldÄ±)' : ''}</div>
        </div>
        <div class="mini2" style="margin-top:8px">
          Neden kÄ±rÄ±lÄ±mÄ±: Grup saat yok <b>${reasons.group_time||0}</b> â€¢ Ã–ÄŸretmen yok/boÅŸ deÄŸil <b>${reasons.teacher_time||0}</b> â€¢ Ã‡akÄ±ÅŸma/sÃ¼re <b>${reasons.distribution||0}</b>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:6px">Ne yapmalÄ±sÄ±n?</h3>
        <ul style="margin:0;padding-left:18px">${sugg || '<li class="mini2">AÃ§Ä±k ders yok. ğŸ‰</li>'}</ul>
      </div>

      <div class="card">
        <h3 style="margin-bottom:6px">BranÅŸ Ã–zeti (yaklaÅŸÄ±k kapasite)</h3>
        <div class="mini2" style="margin-bottom:8px">Kapasite = branÅŸ Ã¶ÄŸretmenlerinin toplam mÃ¼sait slot sayÄ±sÄ± (yaklaÅŸÄ±k). Talep kapasiteyi aÅŸÄ±yorsa Ã§Ã¶zÃ¼m iÃ§in mÃ¼saitlik/Ã¶ÄŸretmen gerekir.</div>
        <table class="print-table tight"><thead>
          <tr><th>BranÅŸ</th><th>Talep</th><th>Atanan</th><th>AÃ§Ä±k</th><th>Ã–ÄŸrt.</th><th>~MÃ¼sait Slot</th></tr>
        </thead><tbody>${branchRows || ''}</tbody></table>
      </div>

      <div class="card">
        <h3 style="margin-bottom:6px">AÃ§Ä±k Dersler (en fazla 40 satÄ±r)</h3>
        <table class="print-table tight">
          <thead><tr><th>Grup</th><th>BranÅŸ</th><th>AÃ§Ä±k</th><th>Neden</th><th>Not</th></tr></thead>
          <tbody>${openRows || ''}</tbody>
        </table>
      </div>

      ${rep.quickFix && rep.quickFix.length ? `
      <div class="card">
        <h3 style="margin-bottom:6px">HÄ±zlÄ± DÃ¼zelt (1 tÄ±kla tamamla)</h3>
        <div class="mini2">Burada sadece adaylÄ± (yerleÅŸtirilebilir) aÃ§Ä±k dersler listelenir.</div>
        ${qHtml}
      </div>` : ``}
    </div>
  `;

  if (!dlg.open) dlg.showModal();

  // --- hÄ±zlÄ± atama (modaldan) ---
  function tryQuickAssign({gid, branch, d, s, tid}) {
    // temel doÄŸrulamalar
    if (state.availability.groups[gid]?.[d]?.[s] !== true) { alert('Grup bu saatte mÃ¼sait deÄŸil.'); return false; }
    if (state.availability.teachers[tid]?.[d]?.[s] !== true) { alert('Ã–ÄŸretmen bu saatte mÃ¼sait deÄŸil.'); return false; }
    if (state.assignments.some(a => a.group===gid && a.day===d && a.slot===s)) { alert('Bu slotta grup zaten dolu.'); return false; }
    if (state.assignments.some(a => a.teacherId===tid && a.day===d && a.slot===s)) { alert('Ã–ÄŸretmen bu saatte baÅŸka derste.'); return false; }

    // ardÄ±ÅŸÄ±k aynÄ± branÅŸ kontrolÃ¼ (yaklaÅŸÄ±k)
    const prev = (() => {
      if (s>0) return state.assignments.find(a => a.group===gid && a.day===d && a.slot===s-1)?.branch || null;
      if (d>0) return state.assignments.find(a => a.group===gid && a.day===d-1 && a.slot===S-1)?.branch || null;
      return null;
    })();
    if (prev && prev === branch) {
      if (!confirm('Bu atama aynÄ± gruba ardÄ±ÅŸÄ±k aynÄ± branÅŸ olacak. Yine de atansÄ±n mÄ±?')) return false;
    }

    state.assignments.push({ group: gid, day: d, slot: s, branch, teacherId: tid });
    renderAssignCards();

    // YazdÄ±r sekmesi aÃ§Ä±ksa tazele
    const printPanel = $('#step6');
    if (printPanel && !printPanel.hasAttribute('hidden')) {
      refreshPrintFilters();
      renderPrintPreview();
    }
    return true;
  }
}

// Minimal HTML kaÃ§Ä±ÅŸ (rapor modalÄ±nda XSS riskini azaltmak iÃ§in)
function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('\n',' '); }

const exportAssgn = ()=>download('atamalar.json', state.assignments);
const importAssgn = obj=>{
  if(!Array.isArray(obj)) return alert('GeÃ§ersiz atamalar JSON.');
  state.assignments = obj;
  reconcileAllToProgram(getAssignPolicy());
  renderAssignCards();
};

/*
 * Birden Ã§ok otomatik atama Ã§alÄ±ÅŸtÄ±rarak mÃ¼mkÃ¼n olan en iyi yerleÅŸimi elde etmek iÃ§in
 * sarmalayÄ±cÄ± fonksiyon. KullanÄ±cÄ± dÃ¼ÄŸmesine baÄŸlanÄ±r ve `autoAssign()` fonksiyonunu
 * art arda Ã§aÄŸÄ±rÄ±r. Her Ã§aÄŸrÄ±dan sonra kalan ihtiyaÃ§larÄ± hesaplar ve hedef tÃ¼m
 * talepler karÅŸÄ±lanÄ±ncaya kadar veya `maxAttempts` kadar denemeye devam eder.
 * BÃ¶ylece kullanÄ±cÄ± manuel olarak aynÄ± dÃ¼ÄŸmeye birkaÃ§ kez tÄ±klamak zorunda kalmaz.
 */
function doAutoAssign(maxAttempts = 3) {
  let attempts = 0;
  while (attempts < maxAttempts) {
    autoAssign();
    // Kalan ihtiyaÃ§larÄ± hesapla: her grup iÃ§in talep edilen derslerden atananlar Ã§Ä±kartÄ±lÄ±r
    let remaining = 0;
    for (const g of Object.values(state.groups)) {
      const req = state.requests[g.id] || {};
      // Mevcut atamalar iÃ§inde bu gruba ait ders sayÄ±sÄ±
      const have = {};
      state.assignments.filter(a => a.group === g.id).forEach(a => {
        have[a.branch] = (have[a.branch] || 0) + 1;
      });
      for (const [b, cnt] of Object.entries(req)) {
        const need = Math.max(0, (cnt | 0) - (have[b] || 0));
        remaining += need;
      }
    }
    // TÃ¼m ihtiyaÃ§lar karÅŸÄ±landÄ±ysa dÃ¶ngÃ¼den Ã§Ä±k
    if (remaining === 0) break;
    attempts++;
  }
}

/* ===== 6) YazdÄ±r ===== */
function hasAnyAssignments(){ return state.assignments && state.assignments.length>0; }
function refreshPrintFilters(){
  const mode = $("#printMode").value;
  const sel = $("#printFilter"); sel.innerHTML='';
  if(mode==='group'){
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(TÃ¼m Gruplar)'; sel.appendChild(opt0);
    Object.values(state.groups).sort(groupComparator).forEach(g=>{
      const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
    });
  }else{
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(TÃ¼m Ã–ÄŸretmenler)'; sel.appendChild(opt0);
    state.teachers.forEach(t=>{
      const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} â€” ${t.branch}`; sel.appendChild(opt);
    });
  }
}
function renderPrintPreview(){
  const div = $("#printPreview"); div.innerHTML='';
  const mode = $("#printMode").value;
  const filter = $("#printFilter").value;
  const S = state.program.slots, days = state.program.days, labels = state.program.slotLabels || [];

  if(!hasAnyAssignments()){
    div.innerHTML = '<div class="muted">Atama yok. Ã–nce atama yapÄ±n.</div>';
    $("#btnPrint").disabled = true; return;
  }
  $("#btnPrint").disabled = false;

  const hdr = document.createElement('div'); hdr.className='print-header';
  hdr.innerHTML = `<h2>Fenomen EÄŸitim KurumlarÄ± â€” ${mode==='group'?'Grup':'Ã–ÄŸretmen'} Ders PlanÄ±</h2>`;
  div.appendChild(hdr);

  if(mode==='group'){
    const groups = (filter ? [state.groups[filter]] : Object.values(state.groups))
      .filter(Boolean)
      .filter(g=>state.assignments.some(a=>a.group===g.id))
      .sort(groupComparator);

    groups.forEach(g=>{
      const aForG = state.assignments.filter(a=>a.group===g.id);
      const daysWith = Array.from(new Set(aForG.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // Ã–ÄŸrenciler â€“ iki sÃ¼tun ğŸ‘¤
      const students = state.students.filter(st=>st.group===g.id).map(s=>s.name);
      const title = document.createElement('div'); title.className='print-sub';
      title.innerHTML = `<b>${g.name}</b> â€¢ Ã–ÄŸrenciler:`;
      wr.appendChild(title);

      const stCol = document.createElement('div'); stCol.className='students-2col';
      const ul = document.createElement('ul');
      students.forEach(n=>{
        const li=document.createElement('li'); li.innerHTML=`ğŸ‘¤ ${n}`; ul.appendChild(li);
      });
      stCol.appendChild(ul); wr.appendChild(stCol);

      // Tablo â€“ ortalÄ± Ã¶ÄŸretmen isimleri
      const t = document.createElement('table'); t.className='print-table tight';
      const thead = `<tr><th>GÃ¼n / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      days.forEach((d,di)=>{
        let row=`<tr><td><b>${days[di]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForG.find(x=>x.day===di && x.slot===s);
          const txt = a ? `<div style="text-align:center"><b>${a.branch}</b><br/>ğŸ‘¤ ${state.teachers.find(t=>t.id===a.teacherId)?.name||''}</div>` : '';
          row += `<td>${txt}</td>`;
        }
        row+='</tr>'; body+=row;
      });
      t.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(t);

      page.appendChild(wr); div.appendChild(page);
    });

  } else {
    const teachers = (filter ? [state.teachers.find(t=>t.id===filter)] : state.teachers)
      .filter(Boolean)
      .filter(t=>state.assignments.some(a=>a.teacherId===t.id));

    teachers.forEach(t=>{
      const aForT = state.assignments.filter(a=>a.teacherId===t.id);
      const daysWith = Array.from(new Set(aForT.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // Ãœst tablo â€” Ã¶ÄŸretmene gÃ¶re, ortalÄ±
      const tTbl = document.createElement('table'); tTbl.className='print-table tight';
      const thead = `<tr><th colspan="${S+1}" style="text-align:center">${t.name} â€” ${t.branch}</th></tr>
                     <tr><th>GÃ¼n / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      daysWith.forEach(d=>{
        let row=`<tr><td><b>${days[d]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForT.find(x=>x.day===d && x.slot===s);
          row += a ? `<td style="text-align:center"><b>${a.branch}</b><br/>Grup: ${state.groups[a.group]?.name||''}</td>` : `<td></td>`;
        }
        row+='</tr>'; body+=row;
      });
      tTbl.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(tTbl);

      // Yoklama bloklarÄ± â€” her grup iÃ§in kÃ¼Ã§Ã¼k tablo
      const groupsForT = Array.from(new Set(aForT.map(a=>a.group))).map(gid=>state.groups[gid]).filter(Boolean).sort(groupComparator);
      groupsForT.forEach(g=>{
        const blockTitle = document.createElement('div'); blockTitle.className='print-sub';
        blockTitle.innerHTML = `<b>${g.name}</b> â€¢ Ã–ÄŸrenci Yoklama`;
        wr.appendChild(blockTitle);

        const att = document.createElement('table'); att.className='att-table';
        att.innerHTML = `<thead>
            <tr><th>ğŸ‘¤ Ã–ÄŸrenci</th><th>Geldi</th><th>Gelmedi</th><th>GeÃ§ Geldi</th><th>Ä°zinli</th></tr>
          </thead><tbody></tbody>`;
        const tbody = att.querySelector('tbody');
        state.students.filter(s=>s.group===g.id).forEach(st=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${st.name}</td><td>â–¡</td><td>â–¡</td><td>â–¡</td><td>â–¡</td>`;
          tbody.appendChild(tr);
        });
        wr.appendChild(att);
      });

      page.appendChild(wr); div.appendChild(page);
    });
  }
}

/* ===== Olaylar ===== */
$("#btnFetch").onclick = fetchAll;
$("#btnClear").onclick = ()=>{
  state.teachers=[]; state.students=[]; state.groups={}; state.branches=[];
  renderTeachers(); renderStudents(); renderGroupSummary();
  $("#readStatus").textContent='Temizlendi.';
  reconcileAllToProgram(getAssignPolicy());
};

$("#btnBuildGrid").onclick = ()=>{ buildProgramGrid(false); renderSlotLabels(); };
$("#btnProgExport").onclick = ()=>download('ders-programi.json', state.program);
$("#btnProgImport").onclick = ()=>openFile($("#fileProgImport"), obj=>{
  if(!obj || !Array.isArray(obj.days) || typeof obj.slots!=='number') return alert('GeÃ§ersiz program JSON.');
  state.program = obj; if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels=[];
  $("#daysInput").value = obj.days.join(','); $("#slotsInput").value = obj.slots;
  buildProgramGrid(true); renderSlotLabels();
  reconcileAllToProgram(getAssignPolicy());
  renderAvailGrids(); renderAssignCards(); refreshPrintFilters();
});

$("#btnAvailExport").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport").onclick = ()=>openFile($("#fileAvailImport"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('GeÃ§ersiz mÃ¼saitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});
$("#btnAvailClear").onclick = ()=>{ state.availability={teachers:{},groups:{}}; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); };
$("#btnAvailExport2").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport2").onclick = ()=>openFile($("#fileAvailImport2"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('GeÃ§ersiz mÃ¼saitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});

$("#goto2").onclick = ()=> showTopTab('step2');
$("#goto3").onclick = ()=> showTopTab('step3');
$("#goto4").onclick = ()=> showTopTab('step4');
$("#goto5").onclick = ()=> showTopTab('step5');
$("#goto6").onclick = ()=> showTopTab('step6');

$("#btnReqExport").onclick = exportReq;
$("#btnReqImport").onclick = ()=>openFile($("#fileReqImport"), importReq);
$("#btnReqClear").onclick = ()=>{ state.requests={}; renderRequests(); };
$("#reqGroupSelect").onchange = renderRequests;

// Otomatik Atama dÃ¼ÄŸmesi birden fazla deneme yapacak ÅŸekilde sarmalayÄ±cÄ±yÄ± Ã§aÄŸÄ±rÄ±r.
$("#btnAutoAssign").onclick = () => doAutoAssign();
$("#btnAssgnExport").onclick = exportAssgn;
$("#btnAssgnImport").onclick = ()=>openFile($("#fileAssgnImport"), importAssgn);
$("#btnAssgnClear").onclick = ()=>{ state.assignments=[]; renderAssignCards(); };

$("#printMode").onchange = ()=> { refreshPrintFilters(); renderPrintPreview(); };
$("#btnRenderPrint").onclick = renderPrintPreview;

// Yerel kaydet/yÃ¼kle fonksiyonlarÄ± kaldÄ±rÄ±ldÄ±; Firebase tabanlÄ± iÅŸlemler eklenecek

/* Alt sekmeler (MÃ¼saitlik) */
function showAvailTab(which){
  const teachActive = which==='teach';
  $("#panelTeach").toggleAttribute('hidden', !teachActive);
  $("#panelGroup").toggleAttribute('hidden', teachActive);
  $("#tabTeach").setAttribute('aria-selected', String(teachActive));
  $("#tabGroup").setAttribute('aria-selected', String(!teachActive));
}
$("#tabTeach").addEventListener('click', ()=>showAvailTab('teach'));
$("#tabGroup").addEventListener('click', ()=>showAvailTab('group'));

/* BaÅŸlangÄ±Ã§ */
bindTopTabs();
buildProgramGrid(true);
renderSlotLabels();
showTopTab('step1');
</script>
<style>
:root{ /* ders paleti */ --b-mat:#6366f1; /* Matematik */ --b-fen:#10b981; /* Fen Bilimleri */ --b-trk:#f97316; /* TÃ¼rkÃ§e */ --b-sos:#06b6d4; /* Sosyal Bilgiler */ --b-ing:#22c55e; /* Ä°ngilizce */ --b-din:#a78bfa; /* Din KÃ¼ltÃ¼rÃ¼ */ /* tonlar */ --t-50: 14%; --t-150: 26%; --ring:#94a3b8; } /* Ã¼st sekmeler â€“ daha modern gÃ¶rÃ¼nÃ¼m */ .tabs{gap:8px;border:0;margin-bottom:10px;position:relative} .tabs:after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:1px;background:#e5e7eb} .tab{padding:12px 16px;border-radius:12px;background:#f1f5f9;font-weight:800;color:#0f172a;box-shadow:0 1px 0 #e5e7eb inset} .tab[aria-selected="true"]{background:#fff;border:1px solid #e5e7eb;box-shadow:0 6px 18px rgba(2,8,23,.06);} /* kartlar */ .card{border-radius:16px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 10px 25px rgba(15,23,42,.06)} .card header{font-weight:800;margin-bottom:8px} /* grid hÃ¼creleri â€“ daha â€œtakvimâ€ hissi */ .kgrid[data-cols]{grid-template-columns:160px repeat(var(--cols), minmax(72px,1fr));} .kcell{position:relative;border:1px solid #e5e7eb;background:#fff;min-height:58px;border-radius:12px} .kcell:hover{outline:3px solid rgba(99,102,241,.08);outline-offset:0} .kcell .mini2{opacity:.9} /* atama yapÄ±lmÄ±ÅŸ hÃ¼cre */ .kcell.assigned{color:#0f172a;font-weight:700} .kcell.assigned .mini2{color:#111827;font-weight:600} /* ders renkleri (UI) */ .kcell.assigned.b-mat{ background:color-mix(in srgb, var(--b-mat) var(--t-50), #fff); border-color:color-mix(in srgb, var(--b-mat) var(--t-150), #fff); } .kcell.assigned.b-fen{ background:color-mix(in srgb, var(--b-fen) var(--t-50), #fff); border-color:color-mix(in srgb, var(--b-fen) var(--t-150), #fff); } .kcell.assigned.b-trk{ background:color-mix(in srgb, var(--b-trk) var(--t-50), #fff); border-color:color-mix(in srgb, var(--b-trk) var(--t-150), #fff); } .kcell.assigned.b-sos{ background:color-mix(in srgb, var(--b-sos) var(--t-50), #fff); border-color:color-mix(in srgb, var(--b-sos) var(--t-150), #fff); } .kcell.assigned.b-ing{ background:color-mix(in srgb, var(--b-ing) var(--t-50), #fff); border-color:color-mix(in srgb, var(--b-ing) var(--t-150), #fff); } .kcell.assigned.b-din{ background:color-mix(in srgb, var(--b-din) var(--t-50), #fff); border-color:color-mix(in srgb, var(--b-din) var(--t-150), #fff); } /* mini yoÄŸunluk modu â€“ istersen .app'a .dense ekle */ .app.dense .kcell{min-height:44px;padding:4px 6px;border-radius:10px} /* YazdÄ±r: ders renklerinin hafif tonu ve okunabilirlik */ @media print{ .print-table td.b-mat { background:#e6e8ff; } .print-table td.b-fen { background:#d6f7e9; } .print-table td.b-trk { background:#ffe8d6; } .print-table td.b-sos { background:#d8f6fb; } .print-table td.b-ing { background:#e3f9e9; } .print-table td.b-din { background:#ece7ff; } .print-table td[class^="b-"], .print-table td[class*=" b-"]{ -webkit-print-color-adjust:exact; print-color-adjust:exact; } .print-header{margin-bottom:10px} .print-sub{margin:8px 0 10px} } ``` > Not: mevcut print bloÄŸun temelini koruyoruz, sadece tablo hÃ¼crelerine ders rengine gÃ¶re arka plan veriyoruz. --- # 2) JS â€“ Ders rengi sÄ±nÄ±fÄ± ekle & YazdÄ±r hÃ¼crelerine sÄ±nÄ±f bas AÅŸaÄŸÄ±daki yardÄ±mcÄ±larÄ± `<script>` iÃ§inde bir yere (Ã¶r. global yardÄ±mcÄ±larÄ±n altÄ±) ekle: ```js /* === Ders -> sÄ±nÄ±f kÄ±saltmasÄ± (gÃ¼venli) === */ const BRANCH_CLASS = { 'MATEMATÄ°K':'mat','FEN BÄ°LÄ°MLERÄ°':'fen','TÃœRKÃ‡E':'trk', 'SOSYAL BÄ°LGÄ°LER':'sos','Ä°NGÄ°LÄ°ZCE':'ing','DÄ°N KÃœLTÃœRÃœ':'din' }; const bcls = b => 'b-' + (BRANCH_CLASS[b] || toId(b)); ``` ## 2.a Atama panelinde renkli hÃ¼cre `renderAssignCards()` iÃ§inde, atanmÄ±ÅŸ hÃ¼cre oluÅŸturduÄŸun bÃ¶lÃ¼mde ÅŸu deÄŸiÅŸikliÄŸi yap: **Ã–NCE:** ```js if(cur){ cell.classList.add('busy'); cell.innerHTML = `<div style="text-align:center"><div><b>${cur.branch}</b></div><div class="mini2">ğŸ‘¤ ${state.teachers.find(t=>t.id===cur.teacherId)?.name||''}</div></div>`; } ``` **SONRA:** ```js if(cur){ cell.classList.add('assigned', bcls(cur.branch)); cell.innerHTML = `<div style="text-align:center"> <div><b>${cur.branch}</b></div> <div class="mini2">ğŸ‘¤ ${state.teachers.find(t=>t.id===cur.teacherId)?.name||''}</div> </div>`; } ``` > Bu dÃ¼zenleme, eski â€œbusyâ€ gÃ¶rselini ders rengine gÃ¶re modern panele Ã§evirir. ## 2.b YazdÄ±r tablosunda renk sÄ±nÄ±fÄ± ver `renderPrintPreview()` iÃ§inde hÃ¼cre HTMLâ€™lerini Ã¼retirken, `<td>`â€™lere ders sÄ±nÄ±fÄ±nÄ± ekleyelim. **Grup gÃ¶rÃ¼nÃ¼mÃ¼** satÄ±r oluÅŸturma kÄ±smÄ±nda (td iÃ§eriÄŸi Ã¼retilirken) bu satÄ±rÄ± deÄŸiÅŸtir: ```js const txt = a ? `<div style="text-align:center"><b>${a.branch}</b><br/>ğŸ‘¤ ${state.teachers.find(t=>t.id===a.teacherId)?.name||''}</div>` : ''; row += `<td>${txt}</td>`; ``` **ÅŸu hale getir:** ```js const txt = a ? `<div style="text-align:center"><b>${a.branch}</b><br/>ğŸ‘¤ ${state.teachers.find(t=>t.id===a.teacherId)?.name||''}</div>` : ''; row += a ? `<td class="${bcls(a.branch)}">${txt}</td>` : `<td></td>`; ``` **Ã–ÄŸretmen gÃ¶rÃ¼nÃ¼mÃ¼** iÃ§in de benzer ÅŸekilde: ```js row += a ? `<td style="text-align:center"><b>${a.branch}</b><br/>Grup: ${state.groups[a.group]?.name||''}</td>` : `<td></td>`; ``` **yerine:** ```js row += a ? `<td class="${bcls(a.branch)}" style="text-align:center"><b>${a.branch}</b><br/>Grup: ${state.groups[a.group]?.name||''}</td>` : `<td></td>`; ``` >

</style>
<style>
  :root {
    --bg: #f0f4f8 !important;
    --panel: #ffffff !important;
    --ink: #0a0a0a !important;
    --muted: #6b7280 !important;
    --pri: #1e88e5 !important;
    --pri-ink: #0d47a1 !important;
    --acc: #00bcd4 !important;
    --warn: #fbc02d !important;
    --danger: #e53935 !important;
    --chip: #e3f2fd !important;
    --grid: #e0e0e0 !important;
    --radius: 20px !important;
  }

  body {
    background: var(--bg) !important;
    color: var(--ink) !important;
    font-family: "Google Sans", Roboto, system-ui, sans-serif !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
  }

  .btn {
    background: var(--pri) !important;
    color: #fff !important;
    border-radius: 999px !important;
    font-weight: 600 !important;
    padding: 12px 20px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
  }

  .btn.ghost {
    background: #e0e7ff !important;
    color: var(--pri-ink) !important;
  }

  .card {
    background: var(--panel) !important;
    border-radius: var(--radius) !important;
    box-shadow: 0 8px 20px rgba(0,0,0,0.04) !important;
    border: 1px solid var(--grid) !important;
  }

  .kcell {
  border-radius: 16px !important;
  background: #f3f4f6 !important;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease !important;
  cursor: pointer !important;
}

.kcell:hover {
  transform: scale(1.06) !important;
  background: #e0f2fe !important;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12) !important;
}

.kcell.ok {
  background: #e6f4ea !important;
  border-color: #34d399 !important;
  color: #065f46 !important;
  font-weight: 600 !important;
}

.kcell.bad {
  background: #fee2e2 !important;
  border-color: #f87171 !important;
  color: #991b1b !important;
  font-weight: 600 !important;
}
  input, select, textarea {
    border-radius: 12px !important;
    border: 1px solid #cbd5e1 !important;
    padding: 12px 14px !important;
    background: #fff !important;
  }

  .tab {
    background: #e3f2fd !important;
    color: #0d47a1 !important;
    border-radius: 999px 999px 0 0 !important;
    font-weight: 700 !important;
    padding: 10px 16px !important;
  }

  .tab[aria-selected="true"] {
    background: #fff !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06) !important;
  }

  table th, table td {
    background: #fff !important;
    border: 1px solid #e5e7eb !important;
    padding: 10px 12px !important;
  }

  .pill {
    background: var(--chip) !important;
    border-radius: 999px !important;
    padding: 6px 12px !important;
    font-weight: 600 !important;
    color: var(--pri-ink) !important;
  }

  .pill.bad {
    background: #fce4ec !important;
    color: #b71c1c !important;
  }
  @media print {
  .section-title,
  .no-print,
  #btnRenderPrint,
  #btnPrint {
    display: none !important;
  }
}
</style>
<script>
  function computeBranchTeacherCapacity(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const caps = Object.fromEntries(state.branches.map(b => [b, 0]));

  // neden: branÅŸ eÅŸleÅŸen her Ã¶ÄŸretmenin tÃ¼m true hÃ¼creleri ayrÄ± kapasitedir (eÅŸzamanlÄ± sÄ±nÄ±flar)
  state.teachers.forEach(t => {
    const b = t.branch;
    const mat = state.availability.teachers[t.id] || [];
    for (let d = 0; d < D; d++){
      const row = mat[d] || [];
      for (let s = 0; s < S; s++){
        if (row[s] === true) caps[b] = (caps[b] || 0) + 1;
      }
    }
  });
  return caps;
}

// === BranÅŸ bazlÄ± toplam talepler (tÃ¼m gruplarÄ±n toplam talebi) ===
function computeBranchRequestsTotal(){
  const totals = Object.fromEntries(state.branches.map(b => [b, 0]));
  Object.values(state.requests || {}).forEach(reqByBranch => {
    state.branches.forEach(b => {
      totals[b] += +(reqByBranch?.[b] || 0);
    });
  });
  return totals;
}

// === BaÅŸlÄ±k altÄ± Ã¶zet rozetler: {branÅŸ}: Kalan/Toplam (Kalan = Kapasite - Talep) ===
// === BaÅŸlÄ±k altÄ± Ã¶zet rozetler: {branÅŸ}: Kalan/Toplam (Kalan = Kapasite - Talep) ===
function renderBranchChipsSummary(){
  const host = document.getElementById('branchChips');
  if(!host) return;
  host.innerHTML = '';

  const caps = computeBranchTeacherCapacity();
  const reqs = computeBranchRequestsTotal();

  state.branches.forEach(b => {
    const total = caps[b] || 0;
    const used = reqs[b] || 0;
    const left = Math.max(0, total - used);

    const chip = document.createElement('span');
    chip.className = 'pill' + (left <= 0 && total > 0 ? ' bad' : '');
    chip.textContent = `${b} â€” ${left}/${total} mÃ¼sait`;
    host.appendChild(chip);
  });
}

</script>
<script>
/* ==== BaÄŸÄ±msÄ±z: sÄ±nÄ±f gruplarÄ± (5-8) iÃ§in tam liste yazdÄ±r ==== */
// Bu fonksiyon, atanmÄ±ÅŸ gruplarÄ±n sÄ±nÄ±f dÃ¼zeylerine gÃ¶re (5, 6, 7, 8) kompakt bir
// tablo halinde yazdÄ±rÄ±lmasÄ±nÄ± saÄŸlar. EÄŸer ilgili sÄ±nÄ±f dÃ¼zeyi iÃ§in grup ve
// atama yoksa o sayfa oluÅŸturulmaz. Her sÄ±nÄ±f bÃ¶lÃ¼mÃ¼ yeni bir sayfada baÅŸlar.
(function injectPrintAllButton(){
  const host = document.querySelector('#step6 .row.no-print');
  if (!host || document.getElementById('btnPrintAll')) return;
  const btn = document.createElement('button');
  btn.id = 'btnPrintAll';
  btn.className = 'btn warn';
  btn.textContent = 'TÃ¼m listeyi yazdÄ±r';
  // DeÄŸiÅŸtirilen fonksiyon Ã§aÄŸrÄ±sÄ±: tÃ¼m sÄ±nÄ±flar iÃ§in liste yazdÄ±rÄ±lÄ±r
  btn.addEventListener('click', printAllGrades);
  host.appendChild(btn);
})();

/**
 * AtanmÄ±ÅŸ gruplarÄ± 5, 6, 7 ve 8. sÄ±nÄ±f dÃ¼zeylerine gÃ¶re yazdÄ±rÄ±r. Her bir sÄ±nÄ±f
 * bÃ¶lÃ¼mÃ¼ yeni bir sayfada baÅŸlar. EÄŸer bir sÄ±nÄ±fa ait grup yoksa veya o sÄ±nÄ±f
 * iÃ§in atama bulunmuyorsa, o bÃ¶lÃ¼m atlanÄ±r.
 */
function printAllGrades() {
  const hasAny = Array.isArray(state.assignments) && state.assignments.length > 0;
  if (!hasAny) { alert('Atama yok. Ã–nce atama yapÄ±n.'); return; }

  const days   = state.program?.days || ["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"];
  const S      = +state.program?.slots || 8;
  const labels = Array.isArray(state.program?.slotLabels) ? state.program.slotLabels : [];

  const esc = s => String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');

  // Belirli bir sÄ±nÄ±f dÃ¼zeyine ait, atamasÄ± yapÄ±lmÄ±ÅŸ gruplarÄ± getirir
  const byGrade = (grade) => Object.values(state.groups || {})
    .filter(g => (parseGroupName(g.name || g.id || '')?.grade === grade))
    .filter(g => state.assignments.some(a => a.group === g.id))
    .sort(groupComparator);

  // YazdÄ±rma penceresini oluÅŸtur
  const w = window.open('', '_blank');
  const css = `
    @page { size: A4; margin: 8mm; }
    * { box-sizing: border-box; }
    body { font: 11px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; color:#0a0a0a; }
    h1 { font-size: 16px; margin: 0 0 6px; text-align:center; font-weight:800; }
    h2 { font-size: 13px; margin: 8px 0 6px; font-weight:800; border-bottom:1px solid #ddd; padding-bottom:3px; }
    .grade-section + .grade-section { break-before: page; page-break-before: always; }
    .group-block { margin: 6px 0 10px; page-break-inside: avoid; }
    .g-head { font-weight:700; margin-bottom:4px; }
    .students { font-weight: 500; color:#374151; }
    table { width:100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border:1px solid #dcdcdc; padding: 2px 4px; vertical-align: top; }
    th { background:#f3f4f6; font-weight:700; text-align:center; }
    td.day { white-space:nowrap; font-weight:700; }
    .mini { font-size: 10px; color:#374151; }
    .tight th, .tight td { padding: 2px 4px; }
    .grade-badge { display:inline-block; padding:2px 8px; border-radius:8px; background:#eef2ff; color:#1e3a8a; font-weight:800; }
    .muted { color:#6b7280; }
    th,td { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  `;

  w.document.write(`<!DOCTYPE html><html lang="tr"><head>
    <meta charset="utf-8">
    <title>Fenomen EÄŸitim KurumlarÄ± birebir ve Grup Listesi</title>
    <style>${css}</style>
  </head><body>`);

  w.document.write(`<h1>Fenomen EÄŸitim KurumlarÄ± birebir ve Grup Listesi</h1>`);

  // BaskÄ±ya dahil edilecek sÄ±nÄ±f dÃ¼zeyleri; 5-8 arasÄ±ndaki tÃ¼m sÄ±nÄ±flar
  [5,6,7,8].forEach(grade => {
    const groups = byGrade(grade);
    if (groups.length === 0) return; // Bu sÄ±nÄ±f iÃ§in grup veya atama yoksa atla

    w.document.write(`<section class="grade-section">`);
    w.document.write(`<h2><span class="grade-badge">${grade}. SÄ±nÄ±flar</span></h2>`);

    groups.forEach(g => {
      const aForG = state.assignments.filter(a => a.group === g.id);
      const daysWith = Array.from(new Set(aForG.map(a => a.day))).sort((a,b)=>a-b);
      if (daysWith.length === 0) return;

      const studentNames = (state.students || [])
        .filter(s => s.group === g.id)
        .map(s => esc(s.name));

      w.document.write(`<div class="group-block">`);
      w.document.write(`<div class="g-head">${esc(g.name)} â€” <span class="students">${studentNames.join(', ') || '<span class="muted">Ã¶ÄŸrenci yok</span>'}</span></div>`);

      let thead = `<tr><th style="width:90px">GÃ¼n / Saat</th>${
        Array.from({length:S}, (_,i)=>`<th>${esc(labels[i] || (String(i+1)+'. Ders'))}</th>`).join('')
      }</tr>`;

      let body = '';
      daysWith.forEach(d => {
        let row = `<tr><td class="day">${esc(days[d] || '')}</td>`;
        for (let s=0; s<S; s++) {
          const a = aForG.find(x => x.day === d && x.slot === s);
          if (a) {
            const tname = state.teachers.find(t => t.id === a.teacherId)?.name || '';
            row += `<td><div style="text-align:center"><b>${esc(a.branch)}</b><br><span class="mini">${esc(tname)}</span></div></td>`;
          } else {
            row += `<td></td>`;
          }
        }
        row += `</tr>`;
        body += row;
      });

      w.document.write(`<table class="tight"><thead>${thead}</thead><tbody>${body}</tbody></table>`);
      w.document.write(`</div>`);
    });

    w.document.write(`</section>`);
  });

  w.document.write(`</body></html>`);
  w.document.close();
  w.focus();
  setTimeout(() => { try { w.print(); } catch(_){} }, 50);
}
</script>
<!-- ==== TEACHER PRINT V2 â€“ KOMPAKT, TEK A4 ==== -->
<style>
/* ===========================
   PRINT: Ã–ÄŸretmen V2 (LÃ¼ks)
   =========================== */

/* Genel deÄŸiÅŸkenler; fit fonksiyonu bunlarÄ± ayarlar */
:root{
  --tpv2-font: 11px;
  --tpv2-pad: 4px;
  --tpv2-gap: 8px;
  --tpv2-ink: #0f172a;
  --tpv2-muted: #6b7280;
  --tpv2-gold: #b45309;      /* lÃ¼ks vurgu */
  --tpv2-gold-ink: #78350f;
  --tpv2-grid: #0f172a;
}

.print-teacher-v2{
  color: var(--tpv2-ink);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Helvetica Neue", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
}

.print-teacher-v2 .page{
  font-size: var(--tpv2-font);
  line-height: 1.35;
  position: relative;
}

.print-teacher-v2 .brandbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom: calc(var(--tpv2-gap) - 2px);
  padding-bottom: 6px;
  border-bottom: 2px solid var(--tpv2-gold);
}
.print-teacher-v2 .brandbar .org{
  font-weight:900; letter-spacing:.2px; font-size:1.25em;
}
.print-teacher-v2 .brandbar .chip{
  font-weight:800; font-size:.85em; color:var(--tpv2-gold-ink);
  border:1px solid var(--tpv2-gold); padding:2px 8px; border-radius:999px;
}

.print-teacher-v2 .title{
  font-weight:900; font-size: 1.4em; text-align:center; margin:0 0 calc(var(--tpv2-gap) - 2px) 0;
}
.print-teacher-v2 .t-meta{
  display:flex; justify-content:center; gap:10px; font-weight:700;
  margin-bottom: calc(var(--tpv2-gap) - 2px);
}
.print-teacher-v2 .muted{ color: var(--tpv2-muted) }

/* Tablo temeli */
.print-teacher-v2 table{
  width:100%; border-collapse:collapse; table-layout:fixed;
}
.print-teacher-v2 th, .print-teacher-v2 td{
  border: 1px solid var(--tpv2-grid);
  padding: var(--tpv2-pad); vertical-align:top;
}
.print-teacher-v2 thead th{
  background: #f7f7fb;
}

/* HaftalÄ±k plan */
.print-teacher-v2 .sched th:first-child,
.print-teacher-v2 .sched td:first-child{
  width:92px; white-space:nowrap; font-weight:800; background:#fbfbfe;
}
.print-teacher-v2 .sched small{
  display:block; font-size:.9em; color:#334155;
}
.print-teacher-v2 .slot-head{
  font-weight:800; text-align:center;
}

/* Yoklama */
.print-teacher-v2 .att-head{
  margin: var(--tpv2-gap) 0 4px; font-weight:900; text-align:center;
  border-top: 2px solid #e5e7eb; padding-top: 6px;
}
.print-teacher-v2 .att-grid{
  display:grid; grid-template-columns: 1fr 1fr; gap: var(--tpv2-gap);
}
.print-teacher-v2 .att-card{
  border:1.2px solid var(--tpv2-grid); border-radius:8px;
  padding: calc(var(--tpv2-pad) - 1px);
  break-inside: avoid; page-break-inside: avoid;
  background: #fff;
}
.print-teacher-v2 .att-card .g-title{
  font-weight:800; margin-bottom:2px;
}
.print-teacher-v2 .att{
  width:100%; border-collapse:collapse;
}
.print-teacher-v2 .att th, .print-teacher-v2 .att td{
  border:1.2px solid #0f172a; padding: calc(var(--tpv2-pad) - 2px);
}
.print-teacher-v2 .att th{ background:#f9fafb; text-align:center; }
.print-teacher-v2 .att th:first-child, .print-teacher-v2 .att td:first-child{ text-align:left; }

/* Dip bilgi */
.print-teacher-v2 .foot{
  display:flex; justify-content:space-between; align-items:center;
  margin-top: 6px; color:#475569; font-size:.9em;
}

/* BaskÄ± */
@media print{
  @page{ size: A4; margin: 12mm; }
  .print-teacher-v2 .page{ break-after: page; page-break-after: always; }
  th,td{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
}
</style>

<script>
/* =========================================================
   PRINT: Ã–ÄŸretmen V2 â€” LÃ¼ks TasarÄ±m + 6 slot / sayfa kuralÄ±
   ========================================================= */

/* ==== BUTON EKLE ==== */
(function injectTeacherV2Btn(){
  const host = document.querySelector('#step6 .row.no-print') || document.querySelector('#step6') || document.body;
  if(!host || document.getElementById('btnTeacherV2')) return;
  const btn = document.createElement('button');
  btn.id = 'btnTeacherV2';
  btn.className = 'btn';
  btn.textContent = 'Ã–ÄŸretmene gÃ¶re (Yeni TasarÄ±m)';
  btn.addEventListener('click', ()=> printTeachersV2());
  host.appendChild(btn);
})();

/* ==== YARDIMCILAR ==== */
function mmToPx(mm){
  const el = document.createElement('div');
  el.style.width='1mm'; el.style.position='absolute'; el.style.visibility='hidden';
  document.body.appendChild(el);
  const one = el.getBoundingClientRect().width || 3.78; el.remove();
  return one * mm;
}
function esc(s){
  return String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function getTeacherAssignmentsMap(){
  const map = new Map();
  (state.assignments || []).forEach(a=>{
    if(!map.has(a.teacherId)) map.set(a.teacherId, []);
    map.get(a.teacherId).push(a);
  });
  return map;
}
function groupBy(arr, keyFn){
  const m = new Map();
  arr.forEach(x=>{
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  });
  return m;
}
function uniq(arr){ return Array.from(new Set(arr)); }

/* ==== SAYFAYI A4'E SIÄDIR ==== */
function fitPageToA4(rootEl){
  const A4H = 297, MARGIN = 12; // mm
  const usableH = mmToPx(A4H - 2*MARGIN);

  // BaÅŸlangÄ±Ã§: yÃ¼kselt â†’ gerekiyorsa kÄ±s
  let font = 12.5, pad = 5;
  const MIN_F = 8, MAX_F = 13.5;
  const apply = ()=>{
    rootEl.style.setProperty('--tpv2-font', font+'px');
    rootEl.style.setProperty('--tpv2-pad', pad+'px');
    rootEl.style.setProperty('--tpv2-gap', Math.max(6, Math.round(font*0.75))+'px');
  };
  font = Math.min(MAX_F, font); pad = Math.max(2, Math.round(font*0.36)); apply();

  if(rootEl.scrollHeight > usableH){
    let guard = 50;
    while(rootEl.scrollHeight > usableH && font > MIN_F && guard--){
      font -= 0.5; pad = Math.max(1, Math.round(font*0.33)); apply();
    }
  }else{
    let guard = 20;
    while(rootEl.scrollHeight < usableH*0.96 && font < MAX_F && guard--){
      font += 0.5; pad = Math.max(2, Math.round(font*0.36)); apply();
      if(rootEl.scrollHeight > usableH){ font -= 0.5; pad = Math.max(1, Math.round(font*0.33)); apply(); break; }
    }
  }
}

/* ==== YardÄ±m: veriler ==== */
const getGroup = id => (state.groups || {})[id] || { id, name:id };
const getTeacher = id => (state.teachers || []).find(t=>t.id===id) || { id, name:'-' };

/* ==== HTML Ã¼reticiler ==== */
function renderSchedTableForWindow(days, labels, byDay, S, start, end){
  const cols = [];
  for(let s=start; s<end; s++){
    const lab = esc(labels?.[s] || ((s+1)+'. Ders'));
    cols.push(`<th class="slot-head">${lab}</th>`);
  }
  const thead = `
    <thead>
      <tr>
        <th>GÃ¼n / Saat</th>
        ${cols.join('')}
      </tr>
    </thead>
  `;

  const bodyRows = days.map((dName, dIdx)=>{
    const list = byDay.get(dIdx) || [];
    const cells = [];
    for(let s=start; s<end; s++){
      const a = list.find(x=>x.slot===s);
      if(!a){ cells.push('<td></td>'); continue; }
      const g = getGroup(a.group);
      const br = esc(a.branch || '');
      const gname = esc(g.name || g.id);
      const room = g.room ? ` â€¢ ${esc(g.room)}` : '';
      cells.push(`<td><b>${gname}</b><small>${br}${room}</small></td>`);
    }
    return `<tr><td><b>${esc(dName)}</b></td>${cells.join('')}</tr>`;
  }).join('');

  return `<table class="sched">${thead}<tbody>${bodyRows}</tbody></table>`;
}

function renderAttendance(groups, ATT_HEADERS){
  if(groups.length===0) return '';
  const cards = groups.map(g=>{
    const students = (state.students || []).filter(s=>s.group===g.id);
    const rows = (students.length
      ? students.map(st=>`
        <tr>
          <td>${esc(st.name || '')}</td>
          ${ATT_HEADERS.map(()=>'<td>â–¡</td>').join('')}
        </tr>`).join('')
      : `<tr><td colspan="${1+ATT_HEADERS.length}" class="muted">Ã–ÄŸrenci yok</td></tr>`
    );
    return `
      <div class="att-card">
        <div class="g-title">${esc(g.name || g.id)}</div>
        <table class="att">
          <thead>
            <tr>
              <th style="width:46%">Ã–ÄŸrenci</th>
              ${ATT_HEADERS.map(h=>`<th>${esc(h)}</th>`).join('')}
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }).join('');
  return `
    <div class="att-head">Ã–ÄŸrenci Yoklama</div>
    <div class="att-grid">${cards}</div>
  `;
}

/* ==== YENÄ° TASARIM: Ã–ÄRETMENE GÃ–RE YAZDIR ==== */
function printTeachersV2(){
  const asgByTeacher = getTeacherAssignmentsMap();
  if(!asgByTeacher.size){
    alert('Atama yok. Ã–nce atama yapÄ±n.');
    return;
  }

  const days = state.program?.days || ["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"];
  const S = Math.min(12, +state.program?.slots || 8); // 12â€™ye kadar destek
  const labels = Array.isArray(state.program?.slotLabels)
    ? state.program.slotLabels
    : Array.from({length:S},(_,i)=> (i+1)+'. Ders');

  const ATT_HEADERS = ['Var','Yok','GeÃ§','Ä°zin'];

  const w = window.open('', '_blank');
  const baseCSS = Array.from(document.querySelectorAll('style')).map(s=>s.innerHTML).join('\n');

  w.document.write(`<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Ã–ÄŸretmen YazdÄ±r (Yeni)</title>
  <style>${baseCSS}</style>
</head>
<body class="print-teacher-v2">
</body></html>`);

  const addPage = (html)=> w.document.body.insertAdjacentHTML('beforeend', `<section class="page">${html}</section>`);

  // === YENÄ°: Toplam sayfa ve global sayfa sayacÄ± ===
  const windowsPerTeacher = Math.max(1, Math.ceil(S / 6));              // her Ã¶ÄŸretmene dÃ¼ÅŸen sayfa
  const totalPages = asgByTeacher.size * windowsPerTeacher;              // toplam sayfa
  let pageNo = 0;                                                        // global sayaÃ§

  asgByTeacher.forEach((asgList, tId)=>{
    const t = getTeacher(tId);
    const byDay = groupBy(asgList, a=>a.day);

    // GruplarÄ±, Ã¶ÄŸretmenin haftalÄ±k ders sÄ±rasÄ±na gÃ¶re sÄ±rala (Pazartesi 1. dersten Cuma 4. derse kadar)
    const groupFirstSlot = new Map();
    asgList.forEach(a => {
      const score = a.day * 100 + a.slot;
      const prev = groupFirstSlot.get(a.group);
      if (prev == null || score < prev) groupFirstSlot.set(a.group, score);
    });

    const groups = uniq(asgList.map(a=>a.group))
      .sort((g1, g2) => {
        const k1 = groupFirstSlot.get(g1) ?? 999999;
        const k2 = groupFirstSlot.get(g2) ?? 999999;
        if (k1 !== k2) return k1 - k2;
        const n1 = (state.groups?.[g1]?.name || g1);
        const n2 = (state.groups?.[g2]?.name || g2);
        return String(n1).localeCompare(String(n2), 'tr');
      })
      .map(getGroup);

    const windows = windowsPerTeacher;
    for(let wIx=0; wIx<windows; wIx++){
      const start = wIx*6;
      const end   = Math.min(start+6, S);

      const head = `
        <div class="brandbar">
          <div class="org">Fenomen EÄŸitim KurumlarÄ±</div>
          <div class="chip">${++pageNo}. Sayfa / ${totalPages}</div>
        </div>
        <div class="title">Ã–ÄŸretmen Ders PlanÄ±</div>
        <div class="t-meta">
          <div>${esc(t.name)}</div>
          ${t.branch ? `<div class="muted">â€” ${esc(t.branch)}</div>` : ''}
        </div>
      `;

      const sched = renderSchedTableForWindow(days, labels, byDay, S, start, end);

      // Yoklama: tek sayfa ise aynÄ± sayfada; iki sayfa ise 2. sayfada
      const showAttendanceHere = (windows === 1) || (windows > 1 && wIx === windows-1);
      const att = showAttendanceHere ? renderAttendance(groups, ATT_HEADERS) : '';

      const foot = `
        <div class="foot">
          <span class="muted">Ã–ÄŸretmen: ${esc(t.name)}${t.branch?` â€¢ ${esc(t.branch)}`:''}</span>
        </div>
      `;

      addPage(`${head}${sched}${att}${foot}`);
    }
  });

  w.document.close();

  const onReady = ()=>{
    const pages = w.document.querySelectorAll('.print-teacher-v2 .page');
    pages.forEach(pg=> fitPageToA4(pg));
    try{ w.focus(); w.print(); }catch(_){}
  };
  if (w.document.readyState === 'complete') onReady();
  else w.addEventListener('load', onReady);
}

</script>

<!-- Firebase entegrasyonu: program, mÃ¼saitlikler, talepler ve atamalar iÃ§in kaydet/yÃ¼kle/sil iÅŸlemleri -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

// Firebase yapÄ±landÄ±rmasÄ± (kullanÄ±cÄ± tarafÄ±ndan saÄŸlandÄ±)
const firebaseConfig = {
  apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
  authDomain: "odevfeno.firebaseapp.com",
  databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "odevfeno",
  storageBucket: "odevfeno.firebasestorage.app",
  messagingSenderId: "662757516934",
  appId: "1:662757516934:web:0042188832f63deb6fd307",
  measurementId: "G-4Q99NQRB38"
};

// Firebase baÅŸlatma
const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

// Veriyi Firebase Realtime Database'e kaydet
async function saveDataToFirebase(path, data) {
  try {
    await set(ref(db, path), data);
    alert('Firebase kaydedildi.');
  } catch (err) {
    alert('Firebase kayÄ±t hatasÄ±: ' + err.message);
  }
}

// Firebase'den veri yÃ¼kle
async function loadDataFromFirebase(path, callback) {
  try {
    const snapshot = await get(ref(db, path));
    if (snapshot.exists()) {
      callback(snapshot.val());
      alert('Firebase yÃ¼klendi.');
    } else {
      alert('Firebase kayÄ±t bulunamadÄ±.');
    }
  } catch (err) {
    alert('Firebase yÃ¼kleme hatasÄ±: ' + err.message);
  }
}

// Firebase'deki veriyi sil
async function deleteDataFromFirebase(path) {
  try {
    await remove(ref(db, path));
    alert('Firebase silindi.');
  } catch (err) {
    alert('Firebase silme hatasÄ±: ' + err.message);
  }
}

// Program iÃ§in Firebase dÃ¼ÄŸmeleri
const btnProgSaveFb = document.getElementById('btnProgSaveFb');
const btnProgLoadFb = document.getElementById('btnProgLoadFb');
const btnProgDeleteFb = document.getElementById('btnProgDeleteFb');
if (btnProgSaveFb) {
  btnProgSaveFb.addEventListener('click', () => {
    saveDataToFirebase('program', state.program);
  });
}
if (btnProgLoadFb) {
  btnProgLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('program', obj => {
      // 1. Veri kontrolÃ¼
      if (!obj || !Array.isArray(obj.days) || typeof obj.slots !== 'number') {
        alert('GeÃ§ersiz program verisi veya kayÄ±t yok.');
        return;
      }

      // 2. Global state'i gÃ¼ncelle
      // ModÃ¼l iÃ§inden global state'e eriÅŸim iÃ§in window.state veya direkt state kullanÄ±lÄ±r 
      // (1. maddedeki deÄŸiÅŸikliÄŸi yaptÄ±ysanÄ±z)
      state.program = obj;

      // 3. Eksik alt objeleri tamamla (Hata Ã¶nleyici kritik kÄ±sÄ±m)
      if (!state.program.cells) state.program.cells = {};
      if (!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];

      // 4. InputlarÄ± gÃ¼ncelle
      const daysInp = document.getElementById('daysInput');
      const slotsInp = document.getElementById('slotsInput');
      if (daysInp) daysInp.value = obj.days.join(',');
      if (slotsInp) slotsInp.value = obj.slots;

      // 5. Gridleri ve gÃ¶rÃ¼nÃ¼mÃ¼ yenile
      // Global fonksiyonlarÄ± Ã§aÄŸÄ±rÄ±yoruz
      if (typeof buildProgramGrid === 'function') {
        buildProgramGrid(true);
        renderSlotLabels();
        reconcileAllToProgram(getAssignPolicy());
        renderAvailGrids();
        renderAssignCards();
        if (typeof refreshPrintFilters === 'function') refreshPrintFilters();
      }
    });
  });
}
if (btnProgDeleteFb) {
  btnProgDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('program');
  });
}

// MÃ¼saitlik iÃ§in Firebase dÃ¼ÄŸmeleri (Ã¶ÄŸretmen paneli)
const btnAvailSaveFb = document.getElementById('btnAvailSaveFb');
const btnAvailLoadFb = document.getElementById('btnAvailLoadFb');
const btnAvailDeleteFb = document.getElementById('btnAvailDeleteFb');
if (btnAvailSaveFb) {
  btnAvailSaveFb.addEventListener('click', () => {
    saveDataToFirebase('availability', state.availability);
  });
}
if (btnAvailLoadFb) {
  btnAvailLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('availability', obj => {
      if (!obj || !obj.teachers || !obj.groups) {
        alert('GeÃ§ersiz mÃ¼saitlik verisi.');
        return;
      }
      state.availability = obj;
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
    });
  });
}
if (btnAvailDeleteFb) {
  btnAvailDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('availability');
  });
}

// MÃ¼saitlik iÃ§in Firebase dÃ¼ÄŸmeleri (grup paneli) â€“ aynÄ± veriyi kullanÄ±r
const btnAvailSaveFb2 = document.getElementById('btnAvailSaveFb2');
const btnAvailLoadFb2 = document.getElementById('btnAvailLoadFb2');
const btnAvailDeleteFb2 = document.getElementById('btnAvailDeleteFb2');
if (btnAvailSaveFb2) {
  btnAvailSaveFb2.addEventListener('click', () => {
    saveDataToFirebase('availability', state.availability);
  });
}
if (btnAvailLoadFb2) {
  btnAvailLoadFb2.addEventListener('click', () => {
    loadDataFromFirebase('availability', obj => {
      if (!obj || !obj.teachers || !obj.groups) {
        alert('GeÃ§ersiz mÃ¼saitlik verisi.');
        return;
      }
      state.availability = obj;
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
    });
  });
}
if (btnAvailDeleteFb2) {
  btnAvailDeleteFb2.addEventListener('click', () => {
    deleteDataFromFirebase('availability');
  });
}

// Talepler iÃ§in Firebase dÃ¼ÄŸmeleri
const btnReqSaveFb = document.getElementById('btnReqSaveFb');
const btnReqLoadFb = document.getElementById('btnReqLoadFb');
const btnReqDeleteFb = document.getElementById('btnReqDeleteFb');
if (btnReqSaveFb) {
  btnReqSaveFb.addEventListener('click', () => {
    saveDataToFirebase('requests', state.requests);
  });
}
if (btnReqLoadFb) {
  btnReqLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('requests', obj => {
      state.requests = obj || {};
      renderRequests();
    });
  });
}
if (btnReqDeleteFb) {
  btnReqDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('requests');
  });
}

// Atamalar iÃ§in Firebase dÃ¼ÄŸmeleri
const btnAssgnSaveFb = document.getElementById('btnAssgnSaveFb');
const btnAssgnLoadFb = document.getElementById('btnAssgnLoadFb');
const btnAssgnDeleteFb = document.getElementById('btnAssgnDeleteFb');
if (btnAssgnSaveFb) {
  btnAssgnSaveFb.addEventListener('click', () => {
    saveDataToFirebase('atamapath', state.assignments);
  });
}
if (btnAssgnLoadFb) {
  btnAssgnLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('atamapath', obj => {
      state.assignments = Array.isArray(obj) ? obj : [];
      renderAssignCards();
    });
  });
}
if (btnAssgnDeleteFb) {
  btnAssgnDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('atamapath');
  });
}

// === MODERN KARTLI SLOT IZGARALARI (scroll + yapÄ±ÅŸkan gÃ¼n sÃ¼tunu) ===
function buildProgramGrid(fromRestore=false){
  if(!fromRestore){
    state.program.days = $("#daysInput").value.split(',').map(s=>s.trim()).filter(Boolean);
    state.program.slots = clamp(parseInt($("#slotsInput").value||"8"), 1, 12);
  }
  ensureSlotLabels();
  const days = state.program.days, S = state.program.slots;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';

  // Scroll Container
  const scrollWrap = document.createElement('div');
  scrollWrap.className = 'grid-scroll-wrapper';

  // BaÅŸlÄ±k SatÄ±rÄ± (Saatler)
  const head = document.createElement('div');
  head.className = 'kgrid header-row';
  head.style.setProperty('--cols', S);
  head.dataset.cols = S;

  const corner = document.createElement('div');
  corner.textContent = 'GÃ¼n / Saat';
  corner.className = 'head-cell';
  head.appendChild(corner);
  slotHeadCells(head, S);
  scrollWrap.appendChild(head);

  // GÃ¼n SatÄ±rlarÄ±
  days.forEach((d,di)=>{
    const row = document.createElement('div');
    row.className = 'kgrid';
    row.style.setProperty('--cols', S);
    row.dataset.cols = S;

    const lbl = document.createElement('div');
    lbl.textContent = d;
    lbl.className = 'head-cell';
    row.appendChild(lbl);

    for(let si=0; si<S; si++){
      const key = keyDS(di,si);
      const cell = document.createElement('div'); cell.className='kcell';
      cell.textContent = state.program.cells[key] || '';
      cell.title = "Not girmek iÃ§in tÄ±klayÄ±n";
      cell.onclick = ()=>{
        const val = prompt(`${d} - ${si+1}. saat iÃ§in not:`, state.program.cells[key]||'');
        if(val!==null){
          state.program.cells[key]=val.trim();
          cell.textContent=state.program.cells[key]||'';
        }
      };
      row.appendChild(cell);
    }
    scrollWrap.appendChild(row);
  });

  wrap.appendChild(scrollWrap);
  reconcileAllToProgram(getAssignPolicy());
}

function renderAvailGrids(){
  const D = state.program.days.length, S = state.program.slots, days = state.program.days;

  // --- A) Ã–ÄRETMEN MÃœSAÄ°TLÄ°KLERÄ° ---
  const tWrap=$("#teacherAvailWrap"); tWrap.innerHTML='';
  if(state.teachers.length===0){
    tWrap.innerHTML = '<div class="muted">Ã–ÄŸretmen verisi yok.</div>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div'); card.className='card';

      const head = document.createElement('div'); head.className='flex';
      head.style.borderBottom='1px solid #f1f5f9'; head.style.paddingBottom='10px'; head.style.marginBottom='10px';
      head.innerHTML = `<b>ğŸ‘¤ ${t.name}</b><span class="tag">${t.branch}</span>`;

      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='TÃ¼mÃ¼nÃ¼ Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='TÃ¼mÃ¼nÃ¼ DeÄŸil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.teachers[t.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.teachers[t.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.teachers[t.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const scrollWrap = document.createElement('div');
      scrollWrap.className = 'grid-scroll-wrapper';

      const gridHead = document.createElement('div'); gridHead.className='kgrid header-row';
      gridHead.style.setProperty('--cols', S); gridHead.dataset.cols = S;
      const hCorner = document.createElement('div');
      hCorner.textContent='GÃ¼n / Saat';
      hCorner.className='head-cell';
      gridHead.appendChild(hCorner);
      slotHeadCells(gridHead,S);
      scrollWrap.appendChild(gridHead);

      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S); row.dataset.cols = S;
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.className='head-cell';
        dayLbl.title='Ã‡ift tÄ±kla: bu gÃ¼nÃ¼ tÃ¼m gÃ¼nlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gÃ¼nÃ¼nÃ¼ kopyala?`)){ copyDayPattern(state.availability.teachers[t.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.teachers[t.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.innerHTML = val ? 'âœ“<br/><span class="mini2">Uygun</span>' : 'âœ•';
          cell.onclick = ()=>{
            state.availability.teachers[t.id][d][s] = !state.availability.teachers[t.id][d][s];
            renderAvailGrids();
          };
          row.appendChild(cell);
        }
        scrollWrap.appendChild(row);
      }
      card.appendChild(scrollWrap); tWrap.appendChild(card);
    });
  }

  // --- B) GRUP MÃœSAÄ°TLÄ°KLERÄ° ---
  const gWrap=$("#groupAvailWrap"); gWrap.innerHTML='';
  const groups = Object.values(state.groups);
  if(groups.length===0){
    gWrap.innerHTML = '<div class="muted">Grup verisi yok.</div>';
  }else{
    groups.sort(groupComparator).forEach(g=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.style.borderBottom='1px solid #f1f5f9'; head.style.paddingBottom='10px'; head.style.marginBottom='10px';
      head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span>`;

      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='TÃ¼mÃ¼nÃ¼ Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='TÃ¼mÃ¼nÃ¼ DeÄŸil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.groups[g.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.groups[g.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.groups[g.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const scrollWrap = document.createElement('div');
      scrollWrap.className = 'grid-scroll-wrapper';

      const gridHead = document.createElement('div'); gridHead.className='kgrid header-row';
      gridHead.style.setProperty('--cols', S); gridHead.dataset.cols = S;
      const hCorner2 = document.createElement('div');
      hCorner2.textContent='GÃ¼n / Saat';
      hCorner2.className='head-cell';
      gridHead.appendChild(hCorner2);
      slotHeadCells(gridHead,S);
      scrollWrap.appendChild(gridHead);

      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S); row.dataset.cols = S;
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.className='head-cell';
        dayLbl.title='Ã‡ift tÄ±kla: bu gÃ¼nÃ¼ tÃ¼m gÃ¼nlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gÃ¼nÃ¼nÃ¼ kopyala?`)){ copyDayPattern(state.availability.groups[g.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.groups[g.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.innerHTML = val ? 'âœ“' : 'âœ•';
          cell.onclick = ()=>{
             state.availability.groups[g.id][d][s] = !state.availability.groups[g.id][d][s];
             renderAvailGrids();
          };
          row.appendChild(cell);
        }
        scrollWrap.appendChild(row);
      }
      card.appendChild(scrollWrap); gWrap.appendChild(card);
    });
  }
}

function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;

  const groups = Object.values(state.groups).slice()
    .sort((a,b)=> (hasAssignmentsForGroup(b.id)?1:0)-(hasAssignmentsForGroup(a.id)?1:0) || groupComparator(a,b));

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='flex';
    head.style.borderBottom='1px solid #f1f5f9'; head.style.paddingBottom='10px'; head.style.marginBottom='10px';
    const count = state.assignments.filter(a=>a.group===g.id).length;
    head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} Ã¶ÄŸrenci</span><span class="pill">${count} atama</span>`;
    card.appendChild(head);

    const scrollWrap = document.createElement('div');
    scrollWrap.className = 'grid-scroll-wrapper';

    const gridHead = document.createElement('div');
    gridHead.className='kgrid header-row';
    gridHead.style.setProperty('--cols', S);
    gridHead.dataset.cols = S;
    const hCorner = document.createElement('div');
    hCorner.textContent='GÃ¼n / Saat';
    hCorner.className='head-cell';
    gridHead.appendChild(hCorner);
    slotHeadCells(gridHead,S);
    scrollWrap.appendChild(gridHead);

    for(let d=0; d<days.length; d++){
      const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S); row.dataset.cols = S;
      const dayCell = document.createElement('div'); dayCell.textContent=days[d]; dayCell.className='head-cell';
      row.appendChild(dayCell);
      
      for(let s=0; s<S; s++){
        const cell = document.createElement('div');
        cell.className = 'kcell';

        // MÃ¼saitlik
        const avail = state.availability?.groups?.[g.id]?.[d]?.[s] === true;
        cell.classList.add(avail ? 'ok' : 'bad');
        if(!avail) cell.style.opacity = '0.5';

        // Atama var mÄ±?
        const cur = state.assignments.find(a => a.group === g.id && a.day === d && a.slot === s);
        if (cur) {
          const brClass = getBranchClass(cur.branch);
          cell.className = 'kcell assigned' + (brClass ? ' ' + brClass : '');
          cell.style.opacity = '1';

          const teacherObj = state.teachers.find(t => t.id === cur.teacherId);
          const teacherName = teacherObj ? teacherObj.name : '';

          cell.innerHTML = `
            <div style="font-size:14px; font-weight:800; line-height:1.2; text-shadow:0 1px 2px rgba(0,0,0,0.1)">
                ${cur.branch}
            </div>
            <div class="mini2" style="font-size:11px; margin-top:4px; opacity:0.95">
                ğŸ‘¤ ${teacherName}
            </div>`;
        } else {
          cell.innerHTML = avail ? '<span style="color:#cbd5e1;font-size:20px">+</span>' : '';
        }

        cell.onclick = () => { openAssignDialog(g.id, d, s); };
        row.appendChild(cell);
      }
      scrollWrap.appendChild(row);
    }
    card.appendChild(scrollWrap);
    wrap.appendChild(card);
  });
}

//
// Modern slot kartÄ± iÅŸlevleri (buildProgramGrid, renderAvailGrids, renderAssignCards)
// sadece Firebase'den yÃ¼kleme sonrasÄ± deÄŸil her zaman kullanÄ±labilmesi iÃ§in
// bu fonksiyonlarÄ± global (window) nesnesine atÄ±yoruz. BÃ¶ylece daha Ã¶nce
// tanÄ±mlanmÄ±ÅŸ eski sÃ¼rÃ¼mlerin Ã¼zerinden yazÄ±lÄ±r ve uygulamanÄ±n tÃ¼m
// bÃ¶lÃ¼mlerinde modern tasarÄ±m geÃ§erli olur.
window.buildProgramGrid = buildProgramGrid;
window.renderAvailGrids = renderAvailGrids;
window.renderAssignCards = renderAssignCards;

</script>

</body>
</html>
