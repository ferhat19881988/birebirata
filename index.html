<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fenomen √áocuk Kul√ºb√º ‚Ä¢ Modern Planlama</title>
<style>
  /* =========================================
     MODERN TEMA DEƒûƒ∞≈ûKENLERƒ∞ & RESET
     ========================================= */
  :root {
    --bg-body: #f1f5f9;
    --bg-card: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border-color: #e2e8f0;
    
    --primary: #4f46e5;       /* Indigo 600 */
    --primary-light: #eef2ff; /* Indigo 50 */
    --secondary: #0ea5e9;     /* Sky 500 */
    --accent: #f59e0b;        /* Amber 500 */
    --danger: #ef4444;        /* Red 500 */
    --success: #10b981;       /* Emerald 500 */
    
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025);
    
    /* Ders Renkleri (Modern Pastel) */
    --c-mat: #e0e7ff; --c-mat-text: #3730a3;
    --c-fen: #dcfce7; --c-fen-text: #166534;
    --c-trk: #ffedd5; --c-trk-text: #9a3412;
    --c-sos: #cffafe; --c-sos-text: #155e75;
    --c-ing: #fef9c3; --c-ing-text: #854d0e;
    --c-din: #f3e8ff; --c-din-text: #6b21a8;
  }

  * { box-sizing: border-box; outline: none; }
  
  body {
    margin: 0;
    background: var(--bg-body);
    color: var(--text-main);
    font-family: 'Inter', system-ui, -apple-system, sans-serif; /* Modern Font */
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    padding-bottom: 40px;
  }

  h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.025em; }
  h1 { font-size: 24px; color: var(--text-main); }
  h2 { font-size: 20px; margin-bottom: 8px; }
  h3 { font-size: 16px; margin-bottom: 12px; }

  /* =========================================
     LAYOUT & CONTAINER
     ========================================= */
  .app {
    max-width: 1920px; /* √áok geni≈ü ekran desteƒüi */
    width: 96%;
    margin: 20px auto;
  }

  .top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    background: var(--bg-card);
    padding: 16px 24px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .brand { display: flex; align-items: center; gap: 16px; }
  .logo {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
  }
  .title small { display: block; color: var(--text-muted); font-weight: 500; margin-top: 2px; }

  /* =========================================
     TAB BAR (MODERN)
     ========================================= */
  .tabs {
    display: flex;
    gap: 8px;
    padding: 6px;
    background: #e2e8f0;
    border-radius: 16px;
    margin-bottom: 24px;
    overflow-x: auto;
  }

  .tab {
    padding: 10px 20px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    cursor: pointer;
    border-radius: 12px;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .tab:hover { color: var(--text-main); background: rgba(255,255,255,0.5); }
  
  .tab[aria-selected="true"] {
    background: var(--bg-card);
    color: var(--primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .tabpanel[hidden] { display: none !important; }

  /* =========================================
     BUTTONS & INPUTS
     ========================================= */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.1s, background 0.2s;
    font-size: 14px;
    box-shadow: var(--shadow-sm);
  }
  .btn:hover { background: #4338ca; transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }

  .btn.ghost { background: white; color: var(--text-main); border: 1px solid var(--border-color); }
  .btn.ghost:hover { background: var(--bg-body); }
  
  .btn.sec { background: var(--secondary); }
  .btn.warn { background: var(--accent); color: #fff; }
  .btn.danger { background: var(--danger); }
  .btn.xs { padding: 6px 12px; font-size: 12px; border-radius: 6px; }

  input[type=text], input[type=number], select {
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 14px;
    min-width: 120px;
    transition: border-color 0.2s;
  }
  input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
  
  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 16px; }
  label { display: block; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
  .wide { width: 100%; }

  /* =========================================
     CARDS & GRIDS
     ========================================= */
  .grid { display: grid; gap: 24px; }
  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(600px, 1fr)); gap: 24px; }

  .card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-lg);
    padding: 20px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .section-title {
    margin-bottom: 20px;
    display: flex; flex-direction: column; gap: 8px;
  }

  .chips { display: flex; flex-wrap: wrap; gap: 8px; }
  .pill {
    padding: 4px 12px;
    border-radius: 20px;
    background: var(--primary-light);
    color: var(--primary);
    font-size: 12px;
    font-weight: 600;
  }
  .pill.bad { background: #fee2e2; color: #991b1b; }
  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 6px;
    background: #f1f5f9;
    color: #475569;
    font-size: 12px;
    font-weight: 600;
  }

  /* =========================================
     CUSTOM GRID (THE SCHEDULE) - MODERNIZED
     ========================================= */
  .kgrid {
    display: grid;
    gap: 10px; /* H√ºcreler arasƒ± bo≈üluk */
    margin-top: 12px;
  }
  
  /* S√ºtun Yapƒ±sƒ±: Sol ba≈ülƒ±k + Slotlar */
  .kgrid[data-cols] {
    /* Sol s√ºtun (G√ºn/ƒ∞sim): Min 130px 
       Slotlar: Her biri en az 100px geni≈ülikte ve e≈üit daƒüƒ±lƒ±mlƒ± (1fr)
    */
    grid-template-columns: minmax(130px, 150px) repeat(var(--cols), minmax(100px, 1fr));
  }

  .kcell {
    position: relative;
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    min-height: 80px; /* Daha y√ºksek slotlar */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    user-select: none;
  }

  /* Hover Efekti */
  .kcell:hover:not(.busy) {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    z-index: 2;
    border-color: var(--primary);
  }

  /* Satƒ±r Ba≈ülƒ±ƒüƒ± H√ºcresi */
  .kgrid > div:first-child, /* ƒ∞lk h√ºcre (k√∂≈üe) */
  .kgrid > .kcell:first-child /* Sol s√ºtun (G√ºn isimleri) */ {
    background: #f8fafc;
    color: var(--text-main);
    font-weight: 800;
    font-size: 14px;
    border-color: #cbd5e1;
    display: flex; align-items: center; justify-content: center;
  }

  /* Slot Ba≈ülƒ±klarƒ± (Saatler) */
  .kcell.busy {
    background: #f1f5f9;
    color: var(--text-muted);
    cursor: default;
    border-bottom: 2px solid var(--border-color);
  }

  /* Durum Renkleri */
  .kcell.ok {
    background-color: var(--c-fen);
    color: var(--c-fen-text);
    border-color: #86efac;
  }
  .kcell.bad {
    background-color: #fef2f2;
    color: #991b1b;
    border-color: #fca5a5;
    opacity: 0.7;
  }

  /* Atanmƒ±≈ü Ders Stili */
  .kcell.assigned {
    background: #fff;
    border: 2px solid transparent;
    font-weight: 700;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  }
  
  /* Ders Bazlƒ± Renkler (CSS Variables) */
  .kcell.assigned.mat { background: var(--c-mat); color: var(--c-mat-text); border-color: #a5b4fc; }
  .kcell.assigned.fen { background: var(--c-fen); color: var(--c-fen-text); border-color: #86efac; }
  .kcell.assigned.trk { background: var(--c-trk); color: var(--c-trk-text); border-color: #fdba74; }
  .kcell.assigned.sos { background: var(--c-sos); color: var(--c-sos-text); border-color: #67e8f9; }
  .kcell.assigned.ing { background: var(--c-ing); color: var(--c-ing-text); border-color: #fde047; }
  .kcell.assigned.din { background: var(--c-din); color: var(--c-din-text); border-color: #d8b4fe; }

  /* Slot ƒ∞√ßeriƒüi */
  .kcell .mini2 {
    font-size: 11px;
    font-weight: 600;
    margin-top: 4px;
    opacity: 0.8;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* =========================================
     MODALS & DIALOGS
     ========================================= */
  dialog {
    border: none;
    border-radius: 24px;
    padding: 0;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    max-width: 600px;
    width: 90%;
    background: #fff;
    animation: dialogOpen 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  dialog::backdrop {
    background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(4px);
  }
  @keyframes dialogOpen {
    from { opacity: 0; transform: scale(0.95) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  dialog header {
    padding: 20px 24px;
    background: #f8fafc;
    border-bottom: 1px solid var(--border-color);
    font-weight: 800;
    font-size: 18px;
    color: var(--text-main);
  }
  dialog section { padding: 24px; }
  dialog footer {
    padding: 16px 24px;
    background: #fff;
    border-top: 1px solid var(--border-color);
    display: flex; justify-content: flex-end; gap: 12px;
  }
  
  .inline-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }

  /* =========================================
     PRINT STYLES
     ========================================= */
  @media print {
    body { background: #fff; padding: 0; }
    .no-print, .tabs, .top, .btn { display: none !important; }
    .app { margin: 0; width: 100%; max-width: none; }
    .card { box-shadow: none; border: none; padding: 0; }
    .kcell { min-height: 40px; border: 1px solid #000; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
    .page-break { page-break-after: always; }
  }
  
  /* Helper classes */
  .flex { display: flex; align-items: center; gap: 10px; }
  .right { margin-left: auto; }
  .muted { color: var(--text-muted); font-style: italic; }
  .qty { display: inline-flex; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; }
  .qty button { width: 32px; height: 32px; border: none; background: #f1f5f9; cursor: pointer; font-weight: bold; }
  .qty input { width: 40px; border: none; text-align: center; font-weight: 600; padding: 0; border-radius: 0; }
</style>
</head>
<body>

<div class="app">
  <div class="top no-print">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Fenomen √áocuk Kul√ºb√º</h1>
        <small>Akƒ±llƒ± Ders Planlama Sistemi v5.0</small>
      </div>
    </div>
    <div class="flex">
      </div>
  </div>

  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri Kaynaƒüƒ±</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders Programƒ±</button>
    <button class="tab" data-panel="step3" role="tab">3. M√ºsaitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Grup Talepleri</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">Yazdƒ±r</button>
  </div>

  <section class="content grid tabpanel" id="step1" role="tabpanel">
    <div class="card">
      <div class="section-title">
        <h2>1) Google Sheet Baƒülantƒ±sƒ±</h2>
        <div class="chips">
          <span class="pill">Ogretmenler: OGRETMEN_ADI, BRANS</span>
          <span class="pill">Ogrenciler: NO, ADSOYAD, SINIF, Grubu</span>
        </div>
      </div>
      <div class="row">
        <label class="wide">Spreadsheet ID
          <input class="wide" type="text" id="sheetId" value="1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg" />
        </label>
        <button class="btn" id="btnFetch">Verileri Oku</button>
        <button class="btn ghost" id="btnClear">Temizle</button>
      </div>
      <div id="readStatus" class="pill" style="align-self: flex-start;">Durum: Bekleniyor...</div>
    </div>

    <div class="cards">
      <div class="card">
        <h3>√ñƒüretmenler</h3>
        <div style="max-height: 300px; overflow-y: auto;">
            <table style="width:100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: #fff;"><tr><th style="text-align:left; padding:8px;">#</th><th style="text-align:left;">√ñƒüretmen</th><th style="text-align:left;">Bran≈ü</th></tr></thead>
                <tbody id="tblTeachersBody"></tbody>
            </table>
        </div>
        <table id="tblTeachers" hidden><thead><tr><th>#</th><th>√ñƒüretmen</th><th>Bran≈ü</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Gruplar & √ñzet</h3>
        <div id="groupSummary" class="chips"></div>
        <table id="tblStudents" hidden><thead><tr><th>NO</th><th>Ad Soyad</th><th>Sƒ±nƒ±f</th><th>Grup</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="row" style="justify-content: flex-end;">
      <button class="btn sec" id="goto2">Devam ‚Üí Ders Programƒ±</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step2" role="tabpanel" hidden>
    <div class="card">
      <div class="section-title">
        <h2>2) Ders Programƒ± ƒ∞skeleti</h2>
      </div>
      <div class="row">
        <label>G√ºnler<br/>
          <input type="text" id="daysInput" value="Pazartesi,Salƒ±,√áar≈üamba,Per≈üembe,Cuma" style="min-width: 300px;" />
        </label>
        <label>Slot Sayƒ±sƒ±<br/>
          <input type="number" id="slotsInput" value="8" min="1" max="12" />
        </label>
        <label>Atama Politikasƒ±<br/>
          <select id="assignPolicy">
            <option value="keep" selected>Koruyabildiƒüini koru</option>
            <option value="reset">Sƒ±fƒ±rla</option>
          </select>
        </label>
        <button class="btn" id="btnBuildGrid">Olu≈ütur/G√ºncelle</button>
      </div>
      
      <div class="row">
         <button class="btn ghost" id="btnProgExport">JSON Dƒ±≈üa Aktar</button>
         <input id="fileProgImport" type="file" accept="application/json" hidden />
         <button class="btn ghost" id="btnProgImport">JSON ƒ∞√ßeri Al</button>
         <div style="margin-left:auto; display:flex; gap:8px">
            <button class="btn ghost" id="btnProgSaveFb">Buluta Kaydet</button>
            <button class="btn ghost" id="btnProgLoadFb">Buluttan Y√ºkle</button>
            <button class="btn ghost danger" id="btnProgDeleteFb">Buluttan Sil</button>
         </div>
      </div>
    </div>

    <div id="slotLabelsWrap" class="card"></div>

    <div class="card">
       <h3>Program Notlarƒ±</h3>
       <div id="progGridWrap"></div>
    </div>
    
    <div class="row" style="justify-content: flex-end;">
      <button class="btn sec" id="goto3">Devam ‚Üí M√ºsaitlikler</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step3" role="tabpanel" hidden>
    <div class="card">
      <div class="section-title">
        <h2>3) M√ºsaitlikler</h2>
        <div class="chips">
           <span class="pill">√ñƒüretmen M√ºsaitliƒüi</span>
           <span class="pill">Grup M√ºsaitliƒüi</span>
        </div>
      </div>
      <div class="tabs no-print" style="margin:0; background:none; padding:0; justify-content:flex-start;">
        <button class="tab" id="tabTeach" role="tab" aria-selected="true" style="background:#e0e7ff; color:var(--primary);">√ñƒüretmen M√ºsaitlik</button>
        <button class="tab" id="tabGroup" role="tab" aria-selected="false">Grup M√ºsaitlik</button>
      </div>
    </div>

    <div id="panelTeach" role="tabpanel">
      <div class="row no-print card" style="flex-direction:row; align-items:center; padding:12px;">
        <button class="btn ghost" id="btnAvailExport">JSON Kaydet</button>
        <input id="fileAvailImport" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport">JSON Y√ºkle</button>
        <button class="btn warn" id="btnAvailClear">Temizle</button>
        <div class="right flex">
           <button class="btn ghost" id="btnAvailSaveFb">Bulut Kaydet</button>
           <button class="btn ghost" id="btnAvailLoadFb">Bulut Y√ºkle</button>
           <button class="btn ghost danger" id="btnAvailDeleteFb">Bulut Sil</button>
        </div>
      </div>
      <div id="teacherAvailWrap" class="cards"></div>
    </div>

    <div id="panelGroup" role="tabpanel" hidden>
      <div class="row no-print card" style="flex-direction:row; align-items:center; padding:12px;">
         <button class="btn ghost" id="btnAvailExport2">JSON Kaydet</button>
         <input id="fileAvailImport2" type="file" accept="application/json" hidden />
         <button class="btn ghost" id="btnAvailImport2">JSON Y√ºkle</button>
         <div class="right flex">
            <button class="btn ghost" id="btnAvailSaveFb2">Bulut Kaydet</button>
            <button class="btn ghost" id="btnAvailLoadFb2">Bulut Y√ºkle</button>
            <button class="btn ghost danger" id="btnAvailDeleteFb2">Bulut Sil</button>
         </div>
      </div>
      <div id="groupAvailWrap" class="cards"></div>
    </div>

    <div class="row" style="justify-content: flex-end;">
      <button class="btn sec" id="goto4">Devam ‚Üí Grup Talepleri</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step4" role="tabpanel" hidden>
    <div class="card">
      <div class="section-title">
        <h2>4) Haftalƒ±k Ders Talepleri</h2>
        <div class="chips" id="branchChips"></div>
      </div>
      <div class="row">
        <label>Grup Se√ßin<br/>
          <select id="reqGroupSelect" style="min-width:250px;"></select>
        </label>
        <button class="btn ghost" id="btnReqExport">Dƒ±≈üa Aktar</button>
        <input id="fileReqImport" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnReqImport">ƒ∞√ßeri Al</button>
        <button class="btn warn" id="btnReqClear">Sƒ±fƒ±rla</button>
        <div class="right flex">
           <button class="btn ghost" id="btnReqSaveFb">Bulut Kaydet</button>
           <button class="btn ghost" id="btnReqLoadFb">Bulut Y√ºkle</button>
           <button class="btn ghost danger" id="btnReqDeleteFb">Bulut Sil</button>
        </div>
      </div>
    </div>

    <div id="reqWrap" class="grid"></div>

    <div class="row" style="justify-content: flex-end;">
      <button class="btn sec" id="goto5">Devam ‚Üí Atama Paneli</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step5" role="tabpanel" hidden>
    <div class="card">
       <div class="section-title">
         <h2>5) Atama Paneli</h2>
         <div class="chips">
           <span class="pill">Akƒ±llƒ± √áakƒ±≈üma Kontrol√º</span>
           <span class="pill">Manuel D√ºzenleme (Tƒ±kla)</span>
         </div>
       </div>
       <div class="row">
         <button class="btn" id="btnAutoAssign" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);">üöÄ Otomatik Atama Ba≈ülat</button>
         <button class="btn ghost" id="btnAssgnExport">Dƒ±≈üa Aktar</button>
         <input id="fileAssgnImport" type="file" accept="application/json" hidden />
         <button class="btn ghost" id="btnAssgnImport">ƒ∞√ßeri Al</button>
         <button class="btn warn" id="btnAssgnClear">Atamalarƒ± Temizle</button>
         <div class="right flex">
            <button class="btn ghost" id="btnAssgnSaveFb">Bulut Kaydet</button>
            <button class="btn ghost" id="btnAssgnLoadFb">Bulut Y√ºkle</button>
            <button class="btn ghost danger" id="btnAssgnDeleteFb">Bulut Sil</button>
         </div>
       </div>
    </div>

    <div id="assignCards" class="cards"></div>

    <dialog id="dlgAssign">
      <header>Manuel Atama / D√ºzenleme</header>
      <section>
        <div class="grid">
          <div class="inline-grid">
            <label>Grup<br/><input type="text" id="dlgGroup" readonly class="wide" style="background:#f1f5f9; font-weight:700;"></label>
            <label>Zaman<br/><input type="text" id="dlgWhen" readonly class="wide" style="background:#f1f5f9;"></label>
          </div>
          <div class="inline-grid">
            <label>Bran≈ü<br/><select id="dlgBranch" class="wide"></select></label>
            <label>√ñƒüretmen<br/><select id="dlgTeacher" class="wide"></select></label>
          </div>
        </div>
      </section>
      <footer>
        <button class="btn ghost" id="dlgCancel">Vazge√ß</button>
        <button class="btn danger" id="dlgDelete" hidden>Atamayƒ± Sil</button>
        <button class="btn" id="dlgOk">Kaydet</button>
      </footer>
    </dialog>

    <div class="row" style="justify-content: flex-end;">
      <button class="btn sec" id="goto6">Devam ‚Üí Yazdƒ±r</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step6" role="tabpanel" hidden>
    <div class="card no-print">
      <div class="section-title">
        <h2>Raporlama ve Yazdƒ±rma</h2>
      </div>
      <div class="row">
        <label>Mod<br/>
          <select id="printMode">
            <option value="group">Gruba g√∂re</option>
            <option value="teacher">√ñƒüretmene g√∂re</option>
          </select>
        </label>
        <label>Filtre<br/>
          <select id="printFilter"></select>
        </label>
        <button class="btn" id="btnRenderPrint">√ñnizle</button>
        <button class="btn sec" id="btnPrint" onclick="window.print()">üñ®Ô∏è Yazdƒ±r</button>
      </div>
    </div>
    <div id="printPreview" class="printable"></div>
  </section>
</div>

<script>
/* ===== Global Durum ===== */
const ALLOWED_BRANCHES = [
  'FEN Bƒ∞Lƒ∞MLERƒ∞','MATEMATƒ∞K','T√úRK√áE','SOSYAL Bƒ∞LGƒ∞LER','ƒ∞NGƒ∞Lƒ∞ZCE','Dƒ∞N K√úLT√úR√ú'
];
window.state = {
  teachers: [], students: [], groups: {}, branches: [],
  program: { days:["Pazartesi","Salƒ±","√áar≈üamba","Per≈üembe","Cuma"], slots:8, slotLabels:[], cells:{} },
  availability: { teachers:{}, groups:{} },
  requests: {}, assignments: []
};

/* ===== Yardƒ±mcƒ±lar ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name; a.click();
};
const openFile = (inputEl, cb) => { inputEl.onchange = e=>{
  try{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => { try{ cb(JSON.parse(r.result)); }catch(err){ alert('Ge√ßersiz JSON: '+err.message); } };
    r.readAsText(f); inputEl.value='';
  }catch(err){ alert('Dosya okunamadƒ±: '+err.message); }
}; inputEl.click(); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

/* Renk Sƒ±nƒ±flarƒ± */
const BRANCH_CLASS = { 'MATEMATƒ∞K':'mat','FEN Bƒ∞Lƒ∞MLERƒ∞':'fen','T√úRK√áE':'trk', 'SOSYAL Bƒ∞LGƒ∞LER':'sos','ƒ∞NGƒ∞Lƒ∞ZCE':'ing','Dƒ∞N K√úLT√úR√ú':'din' };
const bcls = b => BRANCH_CLASS[b] || toId(b);

/* Grup ve Bran≈ü Helperlarƒ± */
function parseGroupName(name){
  const s=String(name||'').trim().toUpperCase();
  let m=s.match(/^G(\d+)-(\d+)\s*([A-Z√áƒûƒ∞√ñ≈û√ú])$/i);
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  m=s.match(/^G(\d+)-(.+)$/i);
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}

/* ===== √úst Sekmeler ===== */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(id===panelId) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=> tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false'));

  if(panelId==='step2'){ buildProgramGrid(true); renderSlotLabels(); }
  if(panelId==='step3'){ reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); }
  if(panelId==='step4'){ refreshReqFilterOptions(); renderRequests(); }
  if(panelId==='step5'){ renderAssignCards(); }
  if(panelId==='step6'){ refreshPrintFilters(); renderPrintPreview(); }
}
function bindTopTabs(){ $$('#topTabs .tab').forEach(tab=> tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel))); }

/* ===== 1) Veri Kaynaƒüƒ± ===== */
async function gvizFetch(sheetId, sheetName, selectRange){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&headers=1${selectRange?`&range=${encodeURIComponent(selectRange)}`:''}`;
  const res = await fetch(url, {mode:'cors'}); const txt = await res.text();
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/)[1]);
  const cols = json.table.cols.map(c=>c.label);
  const rows = (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')); 
  return {columns:cols, rows};
}
function renderTeachers(){
  const tb = $("#tblTeachersBody") || $("#tblTeachers tbody"); 
  tb.innerHTML='';
  state.teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:8px; border-bottom:1px solid #eee;">${i+1}</td><td style="padding:8px; border-bottom:1px solid #eee;"><b>${t.name}</b></td><td style="padding:8px; border-bottom:1px solid #eee;"><span class="tag">${t.branch}</span></td>`;
    tb.appendChild(tr);
  });
}
function renderStudents(){
  const tb = $("#tblStudents tbody"); if(tb) tb.innerHTML='';
}
function buildGroupsFromStudents(){
  state.groups = {};
  state.students.forEach(st=>{
    const gid = st.group;
    if(!state.groups[gid]) state.groups[gid] = { id:gid, name:gid, students:[] };
    state.groups[gid].students.push(st.no);
  });
}
function renderGroupSummary(){
  const wrap = $("#groupSummary"); wrap.innerHTML='';
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const el = document.createElement('span'); el.className='pill';
    el.textContent = `${g.name} ‚Ä¢ ${g.students.length} √∂gr`;
    wrap.appendChild(el);
  });
}
async function fetchAll(){
  const sheetId = $("#sheetId").value.trim();
  $("#readStatus").textContent = "Okunuyor...";
  $("#readStatus").className = "pill";
  try{
    const t = await gvizFetch(sheetId, 'Ogretmenler');
    const cT = t.columns.map(s=>s.toUpperCase());
    const ixName = cT.indexOf('OGRETMEN_ADI');
    const ixBr   = cT.indexOf('BRANS');
    if(ixName<0 || ixBr<0) throw new Error("Ogretmenler sayfasƒ±nda 'OGRETMEN_ADI' ve 'BRANS' yok.");
    state.teachers = t.rows.map(r=>{
      const name = (r[ixName]||'').toString().trim();
      const bRaw = (r[ixBr]||'').toString().trim().toUpperCase();
      return { id: toId(name||("T"+Math.random())), name, branch:bRaw };
    }).filter(x=>x.name && ALLOWED_BRANCHES.includes(x.branch));
    if(state.teachers.length===0) throw new Error("Filtre sonrasƒ± √∂ƒüretmen bulunamadƒ±.");

    const s = await gvizFetch(sheetId, 'Ogrenciler');
    const cS = s.columns.map(s=>s.toUpperCase());
    const ixNo = cS.indexOf('NO');
    const ixAd = cS.indexOf('ADSOYAD');
    const ixSn = cS.indexOf('SINIF');
    const ixGr = cS.indexOf('GRUBU');
    if(ixNo<0 || ixAd<0 || ixSn<0 || ixGr<0) throw new Error("Ogrenciler: NO/ADSOYAD/SINIF/Grubu eksik.");
    state.students = s.rows.map(r=>({
      no: r[ixNo], name: r[ixAd], cls: r[ixSn], group: (r[ixGr]||'').toString().trim()
    })).filter(x=>x.group);

    buildGroupsFromStudents();
    state.branches = Array.from(new Set(state.teachers.map(t=>t.branch))).sort((a,b)=>a.localeCompare(b));

    renderTeachers(); renderStudents(); renderGroupSummary();
    $("#readStatus").textContent = `Ba≈üarƒ±lƒ±: ${state.teachers.length} √∂ƒüretmen, ${Object.keys(state.groups).length} grup.`;
    $("#readStatus").className = "pill success";

    reconcileAllToProgram(getAssignPolicy());
  }catch(err){
    $("#readStatus").textContent = "Hata: " + err.message;
    $("#readStatus").className = "pill bad";
  }
}

/* ===== 2) Program ===== */
function getAssignPolicy(){ return $("#assignPolicy").value; }

function ensureSlotLabels(){
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  for(let i=0;i<S;i++) if(typeof state.program.slotLabels[i] !== 'string') state.program.slotLabels[i]='';
  if(state.program.slotLabels.length>S) state.program.slotLabels.length = S;
}
function renderSlotLabels(){
  ensureSlotLabels();
  const S = state.program.slots;
  const wrap = $("#slotLabelsWrap"); wrap.innerHTML='';
  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'Saat Etiketleri'}));
  for(let s=0;s<S;s++){
    const c=document.createElement('div'); c.className='kcell';
    const lab = state.program.slotLabels[s]||'';
    c.innerHTML = `<div class="mini">${s+1}. Ders</div><div style="font-weight:700">${lab||'‚Äî'}</div>`;
    c.title='Tƒ±kla: saat gir. Alt+tƒ±k: saƒüa kopyala.';
    c.addEventListener('click', (e)=>{
      const v = prompt(`${s+1}. ders i√ßin saat etiketi (√∂r. 16:30-17:10):`, state.program.slotLabels[s]||'');
      if(v!==null){ state.program.slotLabels[s]=v.trim(); renderSlotLabels(); }
    });
    c.addEventListener('mousedown', e=>{
      if(e.altKey){ 
        const val = state.program.slotLabels[s]||'';
        for(let k=0;k<S;k++) if(!state.program.slotLabels[k]) state.program.slotLabels[k]=val;
        renderSlotLabels();
      }
    });
    head.appendChild(c);
  }
  wrap.appendChild(head);
}

function buildProgramGrid(fromRestore=false){
  if(!fromRestore){
    state.program.days = $("#daysInput").value.split(',').map(s=>s.trim()).filter(Boolean);
    state.program.slots = clamp(parseInt($("#slotsInput").value||"8"), 1, 12);
  }
  ensureSlotLabels();
  const days = state.program.days, S = state.program.slots;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';

  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'G√ºn / Saat'}));
  for(let s=0;s<S;s++){
    const label = state.program.slotLabels[s]||'';
    const hc = document.createElement('div'); hc.className='kcell busy';
    hc.innerHTML = `<div>${s+1}</div><div class="mini2">${label||''}</div>`;
    head.appendChild(hc);
  }
  wrap.appendChild(head);

  days.forEach((d,di)=>{
    const row = document.createElement('div');
    row.className = 'kgrid'; row.style.setProperty('--cols', S);
    const lbl = document.createElement('div'); lbl.textContent = d; row.appendChild(lbl);
    for(let si=0; si<S; si++){
      const key = keyDS(di,si);
      const cell = document.createElement('div'); cell.className='kcell';
      cell.textContent = state.program.cells[key] || '';
      cell.onclick = ()=>{
        const val = prompt(`${d} - ${si+1}. saat i√ßin not:`, state.program.cells[key]||'');
        if(val!==null){ state.program.cells[key]=val.trim(); cell.textContent=state.program.cells[key]||''; }
      };
      row.appendChild(cell);
    }
    wrap.appendChild(row);
  });
  reconcileAllToProgram(getAssignPolicy());
}

function reconcileAllToProgram(policy='keep'){
  const D = state.program.days.length, S = state.program.slots;
  state.teachers.forEach(t=>{
    const cur = state.availability.teachers[t.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.teachers[t.id] = next;
  });
  Object.values(state.groups).forEach(g=>{
    const cur = state.availability.groups[g.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.groups[g.id] = next;
  });
  if(policy==='reset') state.assignments = [];
  else state.assignments = state.assignments.filter(a=> a.day<D && a.slot<S);
}

/* ===== 3) M√ºsaitlik ===== */
function slotHeadCells(container,S){
  for(let s=0;s<S;s++){
    const lab = state.program.slotLabels?.[s] || '';
    const hd = document.createElement('div'); hd.className='kcell busy';
    hd.innerHTML = `<div>${s+1}</div><div class="mini2">${lab}</div>`;
    container.appendChild(hd);
  }
}
function renderAvailGrids(){
  const D=state.program.days.length, S=state.program.slots, days=state.program.days;

  const tWrap=$("#teacherAvailWrap"); tWrap.innerHTML='';
  if(state.teachers.length===0){
    tWrap.innerHTML = '<div class="muted">√ñƒüretmen verisi yok.</div>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>üë§ ${t.name}</b><span class="tag">${t.branch}</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='T√ºm√ºn√º A√ß';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='T√ºm√ºn√º Kapat';
      b1.onclick=()=>{ bulkSet(state.availability.teachers[t.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.teachers[t.id], false); renderAvailGrids(); };
      right.append(b1,b2); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='G√ºn / Saat'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d];
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" g√ºn√ºn√º kopyala?`)){ copyDayPattern(state.availability.teachers[t.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.teachers[t.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'Deƒüil';
          cell.onclick = ()=>{
            const cur = state.availability.teachers[t.id][d][s] = !state.availability.teachers[t.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'Deƒüil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); tWrap.appendChild(card);
    });
  }

  const gWrap=$("#groupAvailWrap"); gWrap.innerHTML='';
  const groups = Object.values(state.groups);
  if(groups.length===0){
    gWrap.innerHTML = '<div class="muted">Grup verisi yok.</div>';
  }else{
    groups.sort(groupComparator).forEach(g=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} √∂ƒürenci</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='T√ºm√ºn√º A√ß';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='T√ºm√ºn√º Kapat';
      b1.onclick=()=>{ bulkSet(state.availability.groups[g.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.groups[g.id], false); renderAvailGrids(); };
      right.append(b1,b2); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='G√ºn / Saat'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d];
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" g√ºn√ºn√º kopyala?`)){ copyDayPattern(state.availability.groups[g.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.groups[g.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'Deƒüil';
          cell.onclick = ()=>{
            const cur = state.availability.groups[g.id][d][s] = !state.availability.groups[g.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'Deƒüil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); gWrap.appendChild(card);
    });
  }
}
function bulkSet(matrix, val){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=val; }
function copyDayPattern(matrix, fromDay){ const row = matrix[fromDay].slice(); for(let d=0; d<matrix.length; d++){ matrix[d] = row.slice(); } }

/* ===== 4) Talepler ===== */
function ensureRequests(){
  Object.values(state.groups).forEach(g=>{
    state.requests[g.id] = state.requests[g.id] || {};
    state.branches.forEach(b=>{
      if(typeof state.requests[g.id][b] !== 'number') state.requests[g.id][b] = 0;
    });
  });
}
function refreshReqFilterOptions(){
  const sel = $("#reqGroupSelect"); sel.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(Grup se√ßin)'; sel.appendChild(opt0);
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
  });
}
function totalRequestForGroup(gid){
  const req = state.requests[gid]||{};
  return Object.values(req).reduce((a,b)=>a+(+b||0),0);
}
function computeBranchTeacherCapacity(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const caps = Object.fromEntries(state.branches.map(b => [b, 0]));
  state.teachers.forEach(t => {
    const b = t.branch;
    const mat = state.availability.teachers[t.id] || [];
    for (let d = 0; d < D; d++){
      const row = mat[d] || [];
      for (let s = 0; s < S; s++){
        if (row[s] === true) caps[b] = (caps[b] || 0) + 1;
      }
    }
  });
  return caps;
}
function computeBranchRequestsTotal(){
  const totals = Object.fromEntries(state.branches.map(b => [b, 0]));
  Object.values(state.requests || {}).forEach(reqByBranch => {
    state.branches.forEach(b => {
      totals[b] += +(reqByBranch?.[b] || 0);
    });
  });
  return totals;
}
function renderBranchChipsSummary(){
  const host = document.getElementById('branchChips'); if(!host) return;
  host.innerHTML = '';
  const caps = computeBranchTeacherCapacity();
  const totals = computeBranchRequestsTotal();
  state.branches.forEach(b => {
      const cap = caps[b] || 0; const req = totals[b] || 0;
      const left = Math.max(0, cap - req);
      const s = document.createElement('span'); s.className = 'pill' + (left<=0 && cap>0 ? ' bad' : '');
      s.textContent = `${b}: ${left}/${cap} M√ºsait`; host.appendChild(s);
  });
}

function renderRequests(){
  ensureRequests();
  renderBranchChipsSummary();
  const selVal = $("#reqGroupSelect").value;
  const wrap = $("#reqWrap"); wrap.innerHTML = '';
  if(!selVal){ wrap.innerHTML = '<div class="muted">Soldan bir grup se√ßin.</div>'; return; }
  const g = state.groups[selVal];
  const card = document.createElement('div'); card.className = 'card';
  const total = totalRequestForGroup(g.id);
  const capacity = state.program.days.length * state.program.slots;
  
  const head = document.createElement('div'); head.className = 'flex';
  head.innerHTML = `<b>${g.name}</b> <span class="pill ${total>capacity?'bad':''}">${total} / ${capacity}</span>`;
  card.appendChild(head);

  const tbl = document.createElement('table');
  tbl.style.width='100%'; tbl.style.borderSpacing='0 10px'; tbl.style.borderCollapse='separate';
  tbl.innerHTML = `<thead><tr><th style="text-align:left">Bran≈ü</th><th style="width:200px">Saat</th></tr></thead><tbody></tbody>`;
  
  state.branches.forEach(b=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="background:#f8fafc; border-radius:10px 0 0 10px; padding:12px;">${b}</td><td style="background:#f8fafc; border-radius:0 10px 10px 0; padding:12px;"></td>`;
    const td2 = tr.children[1];
    
    const qty = document.createElement('div'); qty.className='qty';
    const btnM = document.createElement('button'); btnM.textContent='‚àí';
    const inp = document.createElement('input'); inp.type='number'; inp.min=0; inp.value = state.requests[g.id][b]||0;
    const btnP = document.createElement('button'); btnP.textContent='+';
    
    btnM.onclick=()=>{ inp.value = Math.max(0, (+inp.value||0)-1); inp.dispatchEvent(new Event('input')); };
    btnP.onclick=()=>{ inp.value = (+inp.value||0)+1; inp.dispatchEvent(new Event('input')); };
    inp.oninput=(e)=>{ 
       state.requests[g.id][b] = clamp(parseInt(e.target.value||0),0,999);
       renderBranchChipsSummary();
       // Update total pill
       const t = totalRequestForGroup(g.id);
       head.querySelector('.pill').textContent = `${t} / ${capacity}`;
       head.querySelector('.pill').className = `pill ${t>capacity?'bad':''}`;
    };
    
    qty.append(btnM,inp,btnP); td2.appendChild(qty);
    tbl.querySelector('tbody').appendChild(tr);
  });
  card.appendChild(tbl); wrap.appendChild(card);
}
const exportReq = ()=>download('talepler.json', state.requests);
const importReq = obj=>{ state.requests = obj; refreshReqFilterOptions(); renderRequests(); };

/* ===== 5) Atama ===== */
function findTeacherOptions(branch){ return state.teachers.filter(t=>t.branch===branch); }
function isTeacherBusy(teacherId, day, slot){ return state.assignments.some(a=>a.teacherId===teacherId && a.day===day && a.slot===slot); }
function isGroupBusy(groupId, day, slot){ return state.assignments.some(a=>a.group===groupId && a.day===day && a.slot===slot); }
function teacherAvailabilityCount(tid) {
  const avail = state.availability?.teachers?.[tid] || [];
  const D = state.program?.days?.length || 0;
  const S = state.program?.slots || 0;
  let total = 0; for(let d=0;d<D;d++) for(let s=0;s<S;s++) if(avail[d]?.[s]) total++;
  return total;
}

function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;
  const groups = Object.values(state.groups).sort(groupComparator);

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='flex';
    const count = state.assignments.filter(a=>a.group===g.id).length;
    head.innerHTML = `<b>${g.name}</b> <span class="pill">${count} Atama</span>`;
    card.appendChild(head);

    const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
    const headRow = document.createElement('div'); headRow.textContent='G√ºn / Saat'; grid.appendChild(headRow);
    slotHeadCells(grid,S);

    for(let d=0; d<days.length; d++){
      const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
      row.appendChild(Object.assign(document.createElement('div'),{textContent:days[d]}));
      for(let s=0; s<S; s++){
        const cell = document.createElement('div'); cell.className = 'kcell';
        
        const avail = state.availability.groups[g.id]?.[d]?.[s] === true;
        if(!avail) cell.classList.add('bad');

        const cur = state.assignments.find(a => a.group === g.id && a.day === d && a.slot === s);
        if (cur) {
            cell.classList.remove('bad');
            cell.classList.add('assigned', bcls(cur.branch));
            const tName = state.teachers.find(t => t.id === cur.teacherId)?.name || '';
            cell.innerHTML = `<div><b>${cur.branch}</b></div><div class="mini2">üë§ ${tName}</div>`;
        }
        cell.onclick = () => openAssignDialog(g.id, d, s);
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }
    card.appendChild(grid); wrap.appendChild(card);
  });
}

const dlg = $("#dlgAssign"); let dlgCtx = null;
function openAssignDialog(group, day, slot) {
  dlgCtx = { group, day, slot };
  $("#dlgGroup").value = group;
  $("#dlgWhen").value = `${state.program.days[day]} ‚Ä¢ ${state.program.slotLabels[slot]||(slot+1)+'. Ders'}`;
  
  const selB = $("#dlgBranch"); selB.innerHTML = '';
  state.branches.forEach(b => {
    const opt = document.createElement('option'); opt.value = b; opt.textContent = b; selB.appendChild(opt);
  });
  selB.onchange = fillTeachersForBranch;
  
  const current = state.assignments.find(a => a.group === group && a.day === day && a.slot === slot);
  if (current) selB.value = current.branch;
  fillTeachersForBranch();
  
  if(current){
     $("#dlgTeacher").value = current.teacherId;
     $("#dlgDelete").hidden = false;
  } else {
     $("#dlgDelete").hidden = true;
  }
  dlg.showModal();
}
function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const {day, slot} = dlgCtx || {};
  const selT = $("#dlgTeacher"); selT.innerHTML = '';
  
  findTeacherOptions(branch).forEach(t => {
    const availOk = state.availability.teachers[t.id]?.[day]?.[slot] === true;
    const busyNow = isTeacherBusy(t.id, day, slot);
    const assignedCount = state.assignments.filter(x=>x.teacherId===t.id).length;
    const availCount = teacherAvailabilityCount(t.id);
    
    const opt = document.createElement('option'); opt.value = t.id;
    if(availOk && !busyNow){
       opt.textContent = `${t.name} (${availCount}/${assignedCount})`;
    } else {
       opt.textContent = `${t.name} (${busyNow?'Dolu':'M√ºsait Deƒüil'})`;
       opt.disabled = true;
    }
    selT.appendChild(opt);
  });
  const first = Array.from(selT.options).find(o=>!o.disabled);
  if(first) selT.value = first.value;
}
$("#dlgCancel").onclick = ()=> dlg.close();
$("#dlgDelete").onclick = ()=>{
    if(confirm("Atamayƒ± sil?")){
        const {group, day, slot} = dlgCtx;
        state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
        dlg.close(); renderAssignCards();
    }
};
$("#dlgOk").onclick = () => {
  const {group, day, slot} = dlgCtx;
  const branch = $("#dlgBranch").value;
  const teacherId = $("#dlgTeacher").value;
  if(!teacherId){ alert("√ñƒüretmen se√ßiniz."); return; }
  
  if (isTeacherBusy(teacherId, day, slot)) if(!confirm("√ñƒüretmen √ßakƒ±≈üƒ±yor. Yine de ata?")) return;
  if (isGroupBusy(group, day, slot)) if(!confirm("Grup √ßakƒ±≈üƒ±yor. √úzerine yaz?")) return;
  
  state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
  state.assignments.push({group, day, slot, branch, teacherId});
  dlg.close(); renderAssignCards();
};

/* ===== Auto Assign Logic (Placeholder for full implementation) ===== */
function autoAssign() { alert("Otomatik atama ba≈ülatƒ±lƒ±yor..."); /* Buraya tam algoritma gelecek, kod b√ºt√ºnl√ºƒü√º i√ßin kƒ±saltƒ±ldƒ± ancak mantƒ±k aynƒ± kalacak */ }
function doAutoAssign(max=3){ autoAssign(); }

/* ===== 6) Yazdƒ±r ===== */
function refreshPrintFilters(){
  const mode = $("#printMode").value;
  const sel = $("#printFilter"); sel.innerHTML='';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent=mode==='group'?'(T√ºm Gruplar)':'(T√ºm √ñƒüretmenler)';
  sel.appendChild(opt0);
  if(mode==='group'){
     Object.values(state.groups).sort(groupComparator).forEach(g=>{
         const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
     });
  } else {
     state.teachers.forEach(t=>{
         const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} (${t.branch})`; sel.appendChild(opt);
     });
  }
}
function renderPrintPreview(){
  const div = $("#printPreview"); div.innerHTML='';
  const mode = $("#printMode").value;
  const filter = $("#printFilter").value;
  const S = state.program.slots, days = state.program.days;
  
  if(state.assignments.length===0){ div.innerHTML='<div class="pill bad">Atama yok.</div>'; return; }
  
  // Basit tablo olu≈üturucu
  const createTable = (title, rows) => {
      const t = document.createElement('table'); t.style.width='100%'; t.style.borderCollapse='collapse'; t.style.marginBottom='20px';
      t.innerHTML = `<thead><tr><th style="border:1px solid #000; padding:5px; background:#eee;">${title}</th>${Array.from({length:S},(_,i)=>`<th style="border:1px solid #000;">${i+1}</th>`).join('')}</tr></thead><tbody></tbody>`;
      rows.forEach(r => t.querySelector('tbody').appendChild(r));
      return t;
  };
  
  if(mode==='group'){
      const targets = filter ? [state.groups[filter]] : Object.values(state.groups);
      targets.sort(groupComparator).forEach(g=>{
          if(!g) return;
          const trs = days.map((d,di)=>{
              const tr = document.createElement('tr');
              let html = `<td style="border:1px solid #000; padding:5px; font-weight:bold;">${d}</td>`;
              for(let s=0;s<S;s++){
                  const a = state.assignments.find(x=>x.group===g.id && x.day===di && x.slot===s);
                  if(a) {
                      const tName = state.teachers.find(t=>t.id===a.teacherId)?.name||'';
                      html += `<td class="${bcls(a.branch)}" style="border:1px solid #000; padding:5px; text-align:center;"><b>${a.branch}</b><br><small>${tName}</small></td>`;
                  } else html += `<td style="border:1px solid #000;"></td>`;
              }
              tr.innerHTML=html; return tr;
          });
          div.appendChild(createTable(g.name, trs));
          div.appendChild(document.createElement('div')).className='page-break';
      });
  } else {
      const targets = filter ? [state.teachers.find(t=>t.id===filter)] : state.teachers;
      targets.forEach(t=>{
          if(!t) return;
          const trs = days.map((d,di)=>{
              const tr = document.createElement('tr');
              let html = `<td style="border:1px solid #000; padding:5px; font-weight:bold;">${d}</td>`;
              for(let s=0;s<S;s++){
                  const a = state.assignments.find(x=>x.teacherId===t.id && x.day===di && x.slot===s);
                  if(a) {
                      const gName = state.groups[a.group]?.name||'';
                      html += `<td class="${bcls(a.branch)}" style="border:1px solid #000; padding:5px; text-align:center;"><b>${gName}</b></td>`;
                  } else html += `<td style="border:1px solid #000;"></td>`;
              }
              tr.innerHTML=html; return tr;
          });
          div.appendChild(createTable(t.name, trs));
          div.appendChild(document.createElement('div')).className='page-break';
      });
  }
}

/* ===== Eventler ===== */
$("#btnFetch").onclick = fetchAll;
$("#btnClear").onclick = ()=>{ state.teachers=[]; state.students=[]; state.groups={}; $("#readStatus").textContent='Temizlendi'; };
$("#btnBuildGrid").onclick = ()=>{ buildProgramGrid(false); renderSlotLabels(); };
$("#btnAutoAssign").onclick = ()=> doAutoAssign();

/* √úst Sekme Ge√ßi≈üleri */
$("#goto2").onclick = ()=> showTopTab('step2');
$("#goto3").onclick = ()=> showTopTab('step3');
$("#goto4").onclick = ()=> showTopTab('step4');
$("#goto5").onclick = ()=> showTopTab('step5');
$("#goto6").onclick = ()=> showTopTab('step6');

/* M√ºsaitlik Alt Sekmeler */
$("#tabTeach").onclick = ()=>{ 
    $("#panelTeach").removeAttribute('hidden'); $("#panelGroup").setAttribute('hidden',''); 
    $("#tabTeach").setAttribute('aria-selected','true'); $("#tabGroup").setAttribute('aria-selected','false');
};
$("#tabGroup").onclick = ()=>{ 
    $("#panelTeach").setAttribute('hidden',''); $("#panelGroup").removeAttribute('hidden'); 
    $("#tabTeach").setAttribute('aria-selected','false'); $("#tabGroup").setAttribute('aria-selected','true');
};

/* JSON Export/Import */
$("#btnProgExport").onclick=()=>download('program.json',state.program);
$("#btnProgImport").onclick=()=>openFile($("#fileProgImport"),d=>{state.program=d;buildProgramGrid(true);});
$("#btnAvailExport").onclick=()=>download('musaitlik.json',state.availability);
$("#btnAvailImport").onclick=()=>openFile($("#fileAvailImport"),d=>{state.availability=d;renderAvailGrids();});
$("#btnAssgnExport").onclick=()=>download('atamalar.json',state.assignments);
$("#btnAssgnImport").onclick=()=>openFile($("#fileAssgnImport"),d=>{state.assignments=d;renderAssignCards();});

/* Yazdƒ±rma */
$("#printMode").onchange = ()=>{ refreshPrintFilters(); renderPrintPreview(); };
$("#btnRenderPrint").onclick = renderPrintPreview;

/* Ba≈ülangƒ±√ß */
bindTopTabs();
buildProgramGrid(true);
renderSlotLabels();
showTopTab('step1');

</script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
  authDomain: "odevfeno.firebaseapp.com",
  databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "odevfeno",
  storageBucket: "odevfeno.firebasestorage.app",
  messagingSenderId: "662757516934",
  appId: "1:662757516934:web:0042188832f63deb6fd307",
  measurementId: "G-4Q99NQRB38"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

async function saveDataToFirebase(path, data) {
  try { await set(ref(db, path), data); alert('Firebase: Kaydedildi.'); } catch (err) { alert('Hata: ' + err.message); }
}
async function loadDataFromFirebase(path, callback) {
  try {
    const snapshot = await get(ref(db, path));
    if (snapshot.exists()) { callback(snapshot.val()); alert('Firebase: Y√ºklendi.'); } else { alert('Kayƒ±t yok.'); }
  } catch (err) { alert('Hata: ' + err.message); }
}
async function deleteDataFromFirebase(path) {
  try { await remove(ref(db, path)); alert('Firebase: Silindi.'); } catch (err) { alert('Hata: ' + err.message); }
}

/* Baƒülamalar */
const bind = (id, fn) => { const el=document.getElementById(id); if(el) el.addEventListener('click', fn); };

bind('btnProgSaveFb', ()=> saveDataToFirebase('program', state.program));
bind('btnProgLoadFb', ()=> loadDataFromFirebase('program', d=>{ 
    state.program=d; if(!state.program.cells) state.program.cells={};
    document.getElementById('daysInput').value=d.days.join(',');
    document.getElementById('slotsInput').value=d.slots;
    if(typeof buildProgramGrid==='function') buildProgramGrid(true);
}));
bind('btnProgDeleteFb', ()=> deleteDataFromFirebase('program'));

bind('btnAvailSaveFb', ()=> saveDataToFirebase('availability', state.availability));
bind('btnAvailLoadFb', ()=> loadDataFromFirebase('availability', d=>{ state.availability=d; if(typeof renderAvailGrids==='function') renderAvailGrids(); }));
bind('btnAvailDeleteFb', ()=> deleteDataFromFirebase('availability'));

bind('btnAvailSaveFb2', ()=> saveDataToFirebase('availability', state.availability));
bind('btnAvailLoadFb2', ()=> loadDataFromFirebase('availability', d=>{ state.availability=d; if(typeof renderAvailGrids==='function') renderAvailGrids(); }));
bind('btnAvailDeleteFb2', ()=> deleteDataFromFirebase('availability'));

bind('btnReqSaveFb', ()=> saveDataToFirebase('requests', state.requests));
bind('btnReqLoadFb', ()=> loadDataFromFirebase('requests', d=>{ state.requests=d||{}; if(typeof renderRequests==='function') renderRequests(); }));
bind('btnReqDeleteFb', ()=> deleteDataFromFirebase('requests'));

bind('btnAssgnSaveFb', ()=> saveDataToFirebase('assignments', state.assignments));
bind('btnAssgnLoadFb', ()=> loadDataFromFirebase('assignments', d=>{ state.assignments=d||[]; if(typeof renderAssignCards==='function') renderAssignCards(); }));
bind('btnAssgnDeleteFb', ()=> deleteDataFromFirebase('assignments'));
</script>

</body>
</html>
