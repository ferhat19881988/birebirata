<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fenomen √áocuk Kul√ºb√º ‚Ä¢ Grup Ders Planlama</title>
<style>
  /* =========================================
     1. DEƒûƒ∞≈ûKENLER & TEMA (Indigo/Slate)
     ========================================= */
  :root {
    /* Ana Renkler */
    --primary: #4f46e5;       /* Indigo 600 */
    --primary-hover: #4338ca; /* Indigo 700 */
    --primary-light: #eef2ff; /* Indigo 50 */
    --primary-ink: #312e81;   /* Indigo 900 */
    
    /* N√∂tr Renkler (Arka plan & Metin) */
    --bg-body: #f8fafc;       /* Slate 50 */
    --bg-surface: #ffffff;
    --text-main: #0f172a;     /* Slate 900 */
    --text-muted: #64748b;    /* Slate 500 */
    --border: #e2e8f0;        /* Slate 200 */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    
    /* Durum Renkleri */
    --success-bg: #dcfce7; --success-text: #166534; --success-border: #bbf7d0;
    --danger-bg: #fee2e2;  --danger-text: #991b1b;  --danger-border: #fecaca;
    --warn-bg: #fef3c7;    --warn-text: #92400e;
    
    /* Ders Renkleri (Pastel & Modern) */
    --b-mat: #6366f1; /* Matematik - Indigo */
    --b-fen: #10b981; /* Fen - Emerald */
    --b-trk: #f97316; /* T√ºrk√ße - Orange */
    --b-sos: #06b6d4; /* Sosyal - Cyan */
    --b-ing: #8b5cf6; /* ƒ∞ngilizce - Violet */
    --b-din: #ec4899; /* Din - Pink */

    /* Yapƒ±sal Ayarlar */
    --radius: 12px;
    --header-height: 40px;
    --sidebar-w: 280px;
  }

  /* =========================================
     2. TEMEL SIFIRLAMA & Tƒ∞POGRAFƒ∞
     ========================================= */
  *, *::before, *::after { box-sizing: border-box; }
  
  body {
    margin: 0;
    background: var(--bg-body);
    color: var(--text-main);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  h1, h2, h3 { margin: 0; font-weight: 700; letter-spacing: -0.025em; }
  h1 { font-size: 24px; color: var(--text-main); }
  h2 { font-size: 18px; margin-bottom: 0.5rem; }
  h3 { font-size: 15px; margin-bottom: 0.5rem; }

  /* =========================================
     3. D√úZEN (LAYOUT)
     ========================================= */
  .app {
    max-width: 1600px; /* Geni≈ü ekranlar i√ßin optimize */
    margin: 0 auto;
    padding: 20px;
  }

  .top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand .logo {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--primary), #8b5cf6);
    border-radius: 10px;
  }
  .brand .title small { display: block; color: var(--text-muted); font-size: 12px; font-weight: 500; }

  .content {
    animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .grid { display: grid; gap: 16px; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
  .wide { width: 100%; }
  .right { margin-left: auto; }
  .flex { display: flex; gap: 8px; align-items: center; }

  /* =========================================
     4. Bƒ∞LE≈ûENLER (Buton, Input, Kart)
     ========================================= */
  /* Butonlar */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 10px 16px;
    background: var(--primary);
    color: white;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    box-shadow: var(--shadow-sm);
  }
  .btn:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
  .btn:active { transform: translateY(0); }
  
  .btn.ghost { background: white; color: var(--text-main); border: 1px solid var(--border); }
  .btn.ghost:hover { background: var(--bg-body); border-color: #cbd5e1; }
  
  .btn.sec { background: var(--text-main); color: white; }
  .btn.warn { background: var(--warn-bg); color: var(--warn-text); border: 1px solid #fcd34d; }
  .btn.danger { background: var(--danger-bg); color: var(--danger-text); border: 1px solid var(--danger-border); }
  
  .btn.sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; }
  .btn.xs { padding: 4px 8px; font-size: 11px; border-radius: 4px; height: 24px; }

  /* Inputlar */
  input[type=text], input[type=number], select, textarea {
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    min-width: 180px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
  }
  label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }

  /* Kartlar */
  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow-sm);
    overflow: hidden; /* Ta≈ümalarƒ± gizle */
  }
  .card h3 { color: var(--text-main); font-weight: 700; font-size: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 12px; }

  /* Sekmeler (Tabs) */
  .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 20px; overflow-x: auto; padding-bottom: 2px; }
  .tab {
    padding: 10px 16px;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 13px;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    position: relative;
    transition: color 0.2s;
    white-space: nowrap;
  }
  .tab:hover { color: var(--primary); background: var(--primary-light); }
  .tab[aria-selected="true"] {
    color: var(--primary);
    background: white;
    border: 1px solid var(--border);
    border-bottom-color: white;
    margin-bottom: -1px;
    z-index: 1;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
  }

  /* Rozetler (Chips/Pills) */
  .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
  .pill {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--bg-body);
    border: 1px solid var(--border);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-main);
  }
  .pill.bad { background: var(--danger-bg); color: var(--danger-text); border-color: var(--danger-border); }
  .tag { background: var(--primary-light); color: var(--primary-ink); padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }

  /* =========================================
     5. GRID & TABLO Sƒ∞STEMƒ∞ (Profesyonel D√ºzeltme)
     ========================================= */
  
  /* Sorun: Slot sayƒ±sƒ± artƒ±nca h√ºcreler eziliyor.
     √á√∂z√ºm: Grid container'a overflow-x ekle ve min-width tanƒ±mla.
  */

  .grid-scroll-wrapper {
    overflow-x: auto; /* Yatay scroll a√ß */
    padding-bottom: 12px; /* Scrollbar i√ßin bo≈üluk */
    margin: -16px -16px 0 -16px; /* Kart paddingini n√∂trle */
    padding: 16px; /* ƒ∞√ßeriƒüi tekrar it */
  }

  .kgrid {
    display: grid;
    /* Sol s√ºtun (G√ºnler) sabit 140px, diƒüerleri e≈üit ve en az 90px */
    grid-template-columns: 140px repeat(var(--cols), minmax(90px, 1fr));
    gap: 8px;
    /* Eƒüer √ßok fazla slot varsa (√∂rn. 12), tablo geni≈ülesin ve scroll olu≈üsun */
    min-width: max-content; 
    align-items: stretch;
    margin-bottom: 8px;
  }
  
  /* Ba≈ülƒ±k satƒ±rƒ± */
  .kgrid.head { font-weight: 700; color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }

  .kcell {
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    min-height: 70px; /* Sabit minimum y√ºkseklik */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 4px;
    font-size: 13px;
    color: var(--text-muted);
    transition: all 0.15s ease;
    cursor: pointer;
    user-select: none;
    position: relative;
    overflow: hidden;
  }
  
  /* Hover efekti (bo≈ü h√ºcrelerde) */
  .kcell:hover:not(.assigned):not(.busy) {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
    z-index: 2;
  }

  /* Durumlar */
  .kcell.busy { background: var(--bg-body); color: var(--text-muted); cursor: default; }
  .kcell.ok { background: var(--success-bg); color: var(--success-text); border-color: var(--success-border); font-weight: 600; }
  .kcell.bad { background: var(--danger-bg); color: var(--danger-text); border-color: var(--danger-border); opacity: 0.7; }

  /* Atanmƒ±≈ü H√ºcreler - Modern Stil */
  .kcell.assigned {
    background: white; /* Arka planƒ± yumu≈üat */
    color: var(--text-main);
    border: 1px solid transparent; /* Border rengi sƒ±nƒ±ftan gelecek */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  /* Bran≈ü Renkleri (Sol kenarlƒ±k ve hafif arka plan tonu) */
  .kcell.assigned.b-mat { border-left: 4px solid var(--b-mat); background: linear-gradient(to bottom right, white, #e0e7ff); }
  .kcell.assigned.b-fen { border-left: 4px solid var(--b-fen); background: linear-gradient(to bottom right, white, #d1fae5); }
  .kcell.assigned.b-trk { border-left: 4px solid var(--b-trk); background: linear-gradient(to bottom right, white, #ffedd5); }
  .kcell.assigned.b-sos { border-left: 4px solid var(--b-sos); background: linear-gradient(to bottom right, white, #cffafe); }
  .kcell.assigned.b-ing { border-left: 4px solid var(--b-ing); background: linear-gradient(to bottom right, white, #ede9fe); }
  .kcell.assigned.b-din { border-left: 4px solid var(--b-din); background: linear-gradient(to bottom right, white, #fce7f3); }
  
  .kcell.assigned b { display: block; font-size: 13px; margin-bottom: 2px; }
  .kcell.assigned .mini2 { font-size: 11px; opacity: 0.8; font-weight: 500; }

  /* Tablo ƒ∞√ßi Metin Sƒ±kƒ±≈ütƒ±rma */
  .mini { font-size: 11px; color: var(--text-muted); }
  .mini2 { font-size: 10px; color: var(--text-muted); line-height: 1.2; }
  
  /* M√ºsaitlik Paneli √ñzel Grid (AvGrid) */
  .avGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(600px, 1fr)); /* Geni≈ü ekranlarda yan yana */
    gap: 20px;
  }
  
  /* Talep Sayacƒ± */
  .qty { display: inline-flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: white; }
  .qty button { width: 32px; height: 32px; border: none; background: var(--bg-body); cursor: pointer; font-weight: bold; }
  .qty button:hover { background: #e2e8f0; }
  .qty input { border: none; width: 50px; text-align: center; padding: 0; height: 32px; -moz-appearance: textfield; }
  
  /* Dialog (Modal) */
  dialog {
    border: none;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    padding: 0;
    min-width: 400px;
    max-width: 90vw;
    animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  }
  dialog::backdrop { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(2px); }
  dialog header { padding: 16px 20px; background: var(--bg-body); border-bottom: 1px solid var(--border); font-weight: 700; font-size: 16px; }
  dialog section { padding: 20px; }
  dialog footer { padding: 16px 20px; background: var(--bg-body); border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
  @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  
  /* Auto Assign Report List */
  #autoAssignReportBody ul, #autoAssignReportBody ol { padding-left: 20px; margin: 0; }
  #autoAssignReportBody li { margin-bottom: 6px; }
  .conflict-row { background: var(--warn-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px !important; border: 1px solid #fcd34d; }

  /* =========================================
     6. YAZDIRMA (PRINT) STƒ∞LLERƒ∞
     ========================================= */
  @media print {
    @page { size: A4 landscape; margin: 10mm; }
    body { background: white; font-size: 11px; color: black; }
    .no-print, .top, .tabs, .btn { display: none !important; }
    .app { max-width: none; padding: 0; margin: 0; }
    .card { border: none; box-shadow: none; padding: 0; overflow: visible; }
    .grid-scroll-wrapper { overflow: visible; }
    
    /* Yazdƒ±rma Tablolarƒ± */
    .print-page { page-break-after: always; margin-bottom: 20px; }
    .avoid-break { page-break-inside: avoid; }
    
    table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    th, td { border: 1px solid #000; padding: 4px; vertical-align: top; }
    th { background: #f3f4f6 !important; -webkit-print-color-adjust: exact; font-weight: 800; text-align: center; }
    
    /* Renklerin yazƒ±cƒ±da √ßƒ±kmasƒ± i√ßin */
    .b-mat { background-color: #e0e7ff !important; -webkit-print-color-adjust: exact; }
    .b-fen { background-color: #d1fae5 !important; -webkit-print-color-adjust: exact; }
    .b-trk { background-color: #ffedd5 !important; -webkit-print-color-adjust: exact; }
    .b-sos { background-color: #cffafe !important; -webkit-print-color-adjust: exact; }
    .b-ing { background-color: #ede9fe !important; -webkit-print-color-adjust: exact; }
    .b-din { background-color: #fce7f3 !important; -webkit-print-color-adjust: exact; }
    
    /* √ñƒürenci listeleri */
    .students-2col { column-count: 2; column-gap: 20px; font-size: 9px; }
    .att-table th, .att-table td { height: 20px; text-align: center; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="top no-print">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Fenomen √áocuk Kul√ºb√º</h1>
        <small>Grup dersleri planlama ‚Ä¢ Tablƒ± Sistem</small>
      </div>
    </div>
    <div class="flex">
       </div>
  </div>

  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri Kaynaƒüƒ±</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders Programƒ±</button>
    <button class="tab" data-panel="step3" role="tab">3. M√ºsaitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Grup Talepleri</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">Yazdƒ±r</button>
  </div>

  <section class="content grid tabpanel" id="step1" role="tabpanel">
    <div class="card">
      <div class="row" style="align-items: center; justify-content: space-between;">
         <h2>1) Google Sheet Baƒülantƒ±sƒ±</h2>
         <div class="chips">
            <span class="pill">√ñƒüretmenler</span>
            <span class="pill">√ñƒürenciler</span>
            <span class="pill">Gruplar</span>
         </div>
      </div>
      <div class="row">
        <label class="wide">Spreadsheet ID
          <input class="wide" type="text" id="sheetId" value="1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg" />
        </label>
        <button class="btn" id="btnFetch">Verileri Oku</button>
        <button class="btn ghost" id="btnClear">Temizle</button>
      </div>
      <div id="readStatus" class="tag" style="display:inline-block; margin-bottom:10px">Durum: Bekleniyor...</div>
    </div>

    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
      <div class="card">
        <h3>√ñƒüretmenler</h3>
        <div style="max-height: 300px; overflow-y: auto;">
            <table id="tblTeachers" style="width:100%; border-collapse: collapse;">
                <thead style="position:sticky; top:0; background:white; z-index:1;">
                    <tr><th style="text-align:left; border-bottom:2px solid var(--border); padding:8px;">#</th><th style="text-align:left; border-bottom:2px solid var(--border);">ƒ∞sim</th><th style="text-align:left; border-bottom:2px solid var(--border);">Bran≈ü</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      <div class="card">
        <h3>√ñƒürenciler</h3>
        <div style="max-height: 300px; overflow-y: auto;">
             <table id="tblStudents" style="width:100%; border-collapse: collapse;">
                <thead style="position:sticky; top:0; background:white; z-index:1;">
                    <tr><th style="text-align:left; border-bottom:2px solid var(--border); padding:8px;">No</th><th style="text-align:left; border-bottom:2px solid var(--border);">ƒ∞sim</th><th style="text-align:left; border-bottom:2px solid var(--border);">Grup</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      <div class="card">
        <h3>Gruplar</h3>
        <div id="groupSummary" class="chips"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn sec right" id="goto2">Devam ‚Üí Ders Programƒ±</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step2" role="tabpanel" hidden>
    <div class="card">
        <div class="row" style="align-items: center; justify-content: space-between;">
             <h2>2) Ders Programƒ± ƒ∞skele</h2>
             <div class="flex">
                <button class="btn ghost sm" id="btnProgSaveFb">Kaydet (FB)</button>
                <button class="btn ghost sm" id="btnProgLoadFb">Y√ºkle (FB)</button>
             </div>
        </div>
        <div class="row">
          <label>G√ºnler (virg√ºl ile)<br/>
            <input type="text" id="daysInput" value="Pazartesi,Salƒ±,√áar≈üamba,Per≈üembe,Cuma" />
          </label>
          <label>G√ºnl√ºk Ders Sayƒ±sƒ±<br/>
            <input type="number" id="slotsInput" value="8" min="1" max="12" />
          </label>
          <label>G√ºncelleme Politikasƒ±<br/>
            <select id="assignPolicy">
              <option value="keep" selected>Mevcut atamalarƒ± koru</option>
              <option value="reset">Atamalarƒ± sƒ±fƒ±rla</option>
            </select>
          </label>
          <button class="btn" id="btnBuildGrid">Programƒ± Olu≈ütur</button>
          
           <div class="right flex">
                <button class="btn ghost" id="btnProgExport">JSON ƒ∞ndir</button>
                <input id="fileProgImport" type="file" accept="application/json" hidden />
                <button class="btn ghost" id="btnProgImport">JSON Y√ºkle</button>
           </div>
        </div>
    </div>

    <div class="card">
        <h3>Saat Etiketleri (√ñr: 09:00 - 09:40)</h3>
        <div class="grid-scroll-wrapper">
             <div id="slotLabelsWrap"></div>
        </div>
    </div>

    <div class="card">
        <h3>Program Notlarƒ±</h3>
        <div class="grid-scroll-wrapper">
             <div id="progGridWrap"></div>
        </div>
    </div>
    
    <div class="row">
      <button class="btn sec right" id="goto3">Devam ‚Üí M√ºsaitlikler</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step3" role="tabpanel" hidden>
    <div class="row" style="align-items: center; justify-content: space-between;">
        <h2>3) M√ºsaitlik Y√∂netimi</h2>
        <div class="chips">
            <span class="pill ok">Uygun</span>
            <span class="pill bad">Uygun Deƒüil</span>
        </div>
    </div>

    <div class="tabs no-print" role="tablist">
      <button class="tab" id="tabTeach" role="tab" aria-selected="true">√ñƒüretmen M√ºsaitlik</button>
      <button class="tab" id="tabGroup" role="tab" aria-selected="false">Grup M√ºsaitlik</button>
    </div>

    <div id="panelTeach" role="tabpanel">
      <div class="row no-print card" style="padding:10px; margin-bottom:16px; background:var(--primary-light); border-color:var(--primary);">
        <div class="flex">
             <button class="btn ghost" id="btnAvailSaveFb">Firebase Kaydet</button>
             <button class="btn ghost" id="btnAvailLoadFb">Firebase Y√ºkle</button>
        </div>
        <div class="right flex">
             <button class="btn ghost" id="btnAvailExport">JSON ƒ∞ndir</button>
             <input id="fileAvailImport" type="file" accept="application/json" hidden />
             <button class="btn ghost" id="btnAvailImport">JSON Y√ºkle</button>
             <button class="btn danger" id="btnAvailClear">Temizle</button>
        </div>
      </div>
      <div id="teacherAvailWrap" class="avGrid"></div>
    </div>

    <div id="panelGroup" role="tabpanel" hidden>
      <div class="row no-print card" style="padding:10px; margin-bottom:16px; background:var(--bg-body);">
         <div class="flex">
             <button class="btn ghost" id="btnAvailSaveFb2">Firebase Kaydet</button>
             <button class="btn ghost" id="btnAvailLoadFb2">Firebase Y√ºkle</button>
        </div>
        <div class="right flex">
            <button class="btn ghost" id="btnAvailExport2">JSON ƒ∞ndir</button>
            <input id="fileAvailImport2" type="file" accept="application/json" hidden />
            <button class="btn ghost" id="btnAvailImport2">JSON Y√ºkle</button>
        </div>
      </div>
      <div id="groupAvailWrap" class="avGrid"></div>
    </div>

    <div class="row">
      <button class="btn sec right" id="goto4">Devam ‚Üí Grup Talepleri</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step4" role="tabpanel" hidden>
    <div class="card">
        <div class="row" style="align-items: center; justify-content: space-between;">
            <h2>4) Ders Talepleri</h2>
            <div class="chips" id="branchChips"></div>
        </div>
        
        <div class="row">
          <label>Grup Se√ßin<br/>
            <select id="reqGroupSelect"></select>
          </label>
          <div class="flex" style="margin-left:20px;">
              <button class="btn ghost" id="btnReqSaveFb">FB Kaydet</button>
              <button class="btn ghost" id="btnReqLoadFb">FB Y√ºkle</button>
          </div>
          <div class="right flex">
             <button class="btn ghost" id="btnReqExport">JSON ƒ∞ndir</button>
             <input id="fileReqImport" type="file" accept="application/json" hidden />
             <button class="btn ghost" id="btnReqImport">JSON Y√ºkle</button>
             <button class="btn warn" id="btnReqClear">Sƒ±fƒ±rla</button>
          </div>
        </div>
    </div>

    <div id="reqWrap" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));"></div>

    <div class="row">
      <button class="btn sec right" id="goto5">Devam ‚Üí Atama Paneli</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step5" role="tabpanel" hidden>
    <div class="card" style="position: sticky; top: 10px; z-index: 10; border-color: var(--primary);">
        <div class="row" style="align-items: center; justify-content: space-between;">
            <h2>5) Atama Paneli</h2>
            <div class="flex">
                <button class="btn" id="btnAutoAssign" style="background: linear-gradient(135deg, var(--primary), #8b5cf6);">‚ú® Otomatik Daƒüƒ±t</button>
                <div style="width:1px; height:24px; background:#ccc; margin:0 8px;"></div>
                <button class="btn ghost" id="btnAssgnSaveFb">Kaydet</button>
                <button class="btn ghost" id="btnAssgnLoadFb">Y√ºkle</button>
            </div>
        </div>
        <div class="row" style="margin-bottom:0">
            <div class="chips">
                <span class="pill" style="border-left:4px solid var(--b-mat)">Matematik</span>
                <span class="pill" style="border-left:4px solid var(--b-fen)">Fen</span>
                <span class="pill" style="border-left:4px solid var(--b-trk)">T√ºrk√ße</span>
                <span class="pill" style="border-left:4px solid var(--b-sos)">Sosyal</span>
                <span class="pill" style="border-left:4px solid var(--b-ing)">ƒ∞ngilizce</span>
                <span class="pill" style="border-left:4px solid var(--b-din)">Din K.</span>
            </div>
            <div class="right flex">
                <button class="btn ghost" id="btnAssgnExport">JSON ƒ∞ndir</button>
                <input id="fileAssgnImport" type="file" accept="application/json" hidden />
                <button class="btn ghost" id="btnAssgnImport">JSON Y√ºkle</button>
                <button class="btn danger" id="btnAssgnClear">Temizle</button>
            </div>
        </div>
    </div>
    
    <div id="assignCards" class="grid" style="grid-template-columns: 1fr;"></div>

    <dialog id="dlgAssign">
      <header>Manuel Atama</header>
      <section>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px;">
          <div>
            <label>Grup</label>
            <input type="text" id="dlgGroup" readonly style="background:#f1f5f9; font-weight:700;">
          </div>
          <div>
            <label>G√ºn / Saat</label>
            <input type="text" id="dlgWhen" readonly style="background:#f1f5f9; font-weight:700;">
          </div>
          <div>
            <label>Bran≈ü Se√ßin</label>
            <select id="dlgBranch"></select>
          </div>
          <div>
            <label>√ñƒüretmen Se√ßin</label>
            <select id="dlgTeacher"></select>
          </div>
        </div>
      </section>
      <footer>
        <button class="btn ghost" id="dlgCancel">Vazge√ß</button>
        <button class="btn danger" id="dlgDelete" hidden>Atamayƒ± Sil</button>
        <button class="btn" id="dlgOk">Kaydet</button>
      </footer>
    </dialog>

    <div class="row">
      <button class="btn sec right" id="goto6">Devam ‚Üí Yazdƒ±r</button>
    </div>
  </section>

  <section class="content grid tabpanel" id="step6" role="tabpanel" hidden>
    <div class="card no-print">
         <div class="row">
             <h2>Yazdƒ±r / Rapor</h2>
         </div>
         <div class="row">
          <label>G√∂r√ºn√ºm Modu<br/>
            <select id="printMode">
              <option value="group">Gruba g√∂re (Liste)</option>
              <option value="teacher">√ñƒüretmene g√∂re (Program)</option>
            </select>
          </label>
          <label>Filtre (Opsiyonel)<br/>
            <select id="printFilter"></select>
          </label>
          <button class="btn" id="btnRenderPrint">√ñnizleme Getir</button>
          <button class="btn sec" id="btnPrint" onclick="window.print()">üñ®Ô∏è Yazdƒ±r</button>
        </div>
    </div>
    <div id="printPreview" class="printable"></div>
  </section>
</div>

<script>
/* ===== Global Durum ===== */
const ALLOWED_BRANCHES = [
  'FEN Bƒ∞Lƒ∞MLERƒ∞','MATEMATƒ∞K','T√úRK√áE','SOSYAL Bƒ∞LGƒ∞LER','ƒ∞NGƒ∞Lƒ∞ZCE','Dƒ∞N K√úLT√úR√ú'
];
const state = {
  teachers: [], students: [], groups: {}, branches: [],
  program: { days:["Pazartesi","Salƒ±","√áar≈üamba","Per≈üembe","Cuma"], slots:8, slotLabels:[], cells:{} },
  availability: { teachers:{}, groups:{} },
  requests: {}, assignments: []
};

/* ===== Yardƒ±mcƒ±lar ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name; a.click();
};
const openFile = (inputEl, cb) => { inputEl.onchange = e=>{
  try{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => { try{ cb(JSON.parse(r.result)); }catch(err){ alert('Ge√ßersiz JSON: '+err.message); } };
    r.readAsText(f); inputEl.value='';
  }catch(err){ alert('Dosya okunamadƒ±: '+err.message); }
}; inputEl.click(); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

// ========== Branch Color Helpers ==========
// In order to visually distinguish different course assignments in the schedule,
// we generate pastel colors based off of the branch name. These colors are
// deterministic (same branch ‚Üí same color) and cached for performance. The
// lightness and saturation values are tuned for good contrast while keeping
// the colors soft. A slightly darker border color is also produced to
// delineate the cells.
const branchColorCache = {};
function getColorForBranch(branch) {
  if (!branch) return null;
  if (branchColorCache[branch]) return branchColorCache[branch];
  let sum = 0;
  for (let i = 0; i < branch.length; i++) {
    sum = (sum + branch.charCodeAt(i)) & 0xffff;
  }
  const hue = (sum * 37) % 360;
  const color = `hsl(${hue}, 70%, 85%)`;
  branchColorCache[branch] = color;
  return color;
}
function getBorderColorForBranch(branch) {
  if (!branch) return null;
  let sum = 0;
  for (let i = 0; i < branch.length; i++) {
    sum = (sum + branch.charCodeAt(i)) & 0xffff;
  }
  const hue = (sum * 37) % 360;
  return `hsl(${hue}, 65%, 75%)`;
}

/* Grup sƒ±ralama:  G1-7A, G2-7A, G3-7A, ... G1-7B ... */
function parseGroupName(name){
  const s=String(name||'').trim().toUpperCase();
  // G<number>-<grade><section> -> G1-7A
  let m=s.match(/^G(\d+)-(\d+)\s*([A-Z√áƒûƒ∞√ñ≈û√ú])$/i);
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  // Fallback: G<number>-<label>
  m=s.match(/^G(\d+)-(.+)$/i);
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}

/* ===== √úst Sekmeler ===== */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(id===panelId) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=> tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false'));

  if(panelId==='step2'){ buildProgramGrid(true); renderSlotLabels(); }
  if(panelId==='step3'){ reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); }
  if(panelId==='step4'){ refreshReqFilterOptions(); renderRequests(); }
  if(panelId==='step5'){ renderAssignCards(); }
  if(panelId==='step6'){ refreshPrintFilters(); renderPrintPreview(); }
}
function bindTopTabs(){ $$('#topTabs .tab').forEach(tab=> tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel))); }

/* ===== 1) Veri Kaynaƒüƒ± ===== */
async function gvizFetch(sheetId, sheetName, selectRange){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&headers=1${selectRange?`&range=${encodeURIComponent(selectRange)}`:''}`;
  const res = await fetch(url, {mode:'cors'}); const txt = await res.text();
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/)[1]);
  const cols = json.table.cols.map(c=>c.label);
  const rows = (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')); // why: bo≈ü h√ºcreler i√ßin
  return {columns:cols, rows};
}
function renderTeachers(){
  const tb = $("#tblTeachers tbody"); tb.innerHTML='';
  state.teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td><span class="tag">${t.branch}</span></td>`;
    tb.appendChild(tr);
  });
}
function renderStudents(){
  const tb = $("#tblStudents tbody"); tb.innerHTML='';
  state.students.forEach(st=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="nowrap">${st.no}</td><td>${st.name}</td><td>${st.cls}</td><td><b>${st.group}</b></td>`;
    tb.appendChild(tr);
  });
}
function buildGroupsFromStudents(){
  state.groups = {};
  state.students.forEach(st=>{
    const gid = st.group;
    if(!state.groups[gid]) state.groups[gid] = { id:gid, name:gid, students:[] };
    state.groups[gid].students.push(st.no);
  });
}
function renderGroupSummary(){
  const wrap = $("#groupSummary"); wrap.innerHTML='';
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const el = document.createElement('span'); el.className='pill';
    el.textContent = `${g.name} ‚Ä¢ ${g.students.length} √∂ƒürenci`;
    wrap.appendChild(el);
  });
}
async function fetchAll(){
  const sheetId = $("#sheetId").value.trim();
  $("#readStatus").textContent = "Okunuyor...";
  try{
    const t = await gvizFetch(sheetId, 'Ogretmenler');
    const cT = t.columns.map(s=>s.toUpperCase());
    const ixName = cT.indexOf('OGRETMEN_ADI');
    const ixBr   = cT.indexOf('BRANS');
    if(ixName<0 || ixBr<0) throw new Error("Ogretmenler sayfasƒ±nda 'OGRETMEN_ADI' ve 'BRANS' yok.");
    state.teachers = t.rows.map(r=>{
      const name = (r[ixName]||'').toString().trim();
      const bRaw = (r[ixBr]||'').toString().trim().toUpperCase();
      return { id: toId(name||("T"+Math.random())), name, branch:bRaw };
    }).filter(x=>x.name && ALLOWED_BRANCHES.includes(x.branch));
    if(state.teachers.length===0) throw new Error("Filtre sonrasƒ± √∂ƒüretmen bulunamadƒ±.");

    const s = await gvizFetch(sheetId, 'Ogrenciler');
    const cS = s.columns.map(s=>s.toUpperCase());
    const ixNo = cS.indexOf('NO');
    const ixAd = cS.indexOf('ADSOYAD');
    const ixSn = cS.indexOf('SINIF');
    const ixGr = cS.indexOf('GRUBU');
    if(ixNo<0 || ixAd<0 || ixSn<0 || ixGr<0) throw new Error("Ogrenciler: NO/ADSOYAD/SINIF/Grubu eksik.");
    state.students = s.rows.map(r=>({
      no: r[ixNo], name: r[ixAd], cls: r[ixSn], group: (r[ixGr]||'').toString().trim()
    })).filter(x=>x.group);

    buildGroupsFromStudents();
    state.branches = Array.from(new Set(state.teachers.map(t=>t.branch))).sort((a,b)=>a.localeCompare(b));

    renderTeachers(); renderStudents(); renderGroupSummary();
    $("#readStatus").textContent = `Tamam: ${state.teachers.length} √∂ƒüretmen, ${state.students.length} √∂ƒürenci, ${Object.keys(state.groups).length} grup.`;

    reconcileAllToProgram(getAssignPolicy());
  }catch(err){
    $("#readStatus").textContent = "Hata: " + err.message;
  }
}

/* ===== 2) Program ===== */
function getAssignPolicy(){ return $("#assignPolicy").value; }

function ensureSlotLabels(){ // why: yazdƒ±r ve m√ºsaitlikte saatleri kullanmak
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  for(let i=0;i<S;i++) if(typeof state.program.slotLabels[i] !== 'string') state.program.slotLabels[i]='';
  if(state.program.slotLabels.length>S) state.program.slotLabels.length = S;
}
function renderSlotLabels(){
  ensureSlotLabels();
  const S = state.program.slots;
  const wrap = $("#slotLabelsWrap"); wrap.innerHTML='';
  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'Saat Etiketleri',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const c=document.createElement('div'); c.className='kcell';
    const lab = state.program.slotLabels[s]||'';
    c.innerHTML = `<div class="mini">${s+1}. Ders</div><div>${lab||'‚Äî'}</div>`;
    c.title='Tƒ±kla: saat gir (√∂r. 16:30-17:10). Alt+tƒ±k: bu etiketi bo≈ü slotlara kopyala.';
    c.addEventListener('click', (e)=>{
      const v = prompt(`${s+1}. ders i√ßin saat etiketi (√∂r. 16:30-17:10):`, state.program.slotLabels[s]||'');
      if(v!==null){ state.program.slotLabels[s]=v.trim(); renderSlotLabels(); }
    });
    c.addEventListener('auxclick', e=>{ e.preventDefault(); });
    c.addEventListener('mousedown', e=>{
      if(e.altKey){ // why: hƒ±zlƒ± kopya
        const val = state.program.slotLabels[s]||'';
        for(let k=0;k<S;k++) if(!state.program.slotLabels[k]) state.program.slotLabels[k]=val;
        renderSlotLabels();
      }
    });
    head.appendChild(c);
  }
  wrap.appendChild(head);

  const tools=document.createElement('div'); tools.className='row';
  tools.innerHTML = `
    <div class="qty">
      <button class="xs" id="btnFillForward">Bo≈ülarƒ± soldan doldur</button>
    </div>
    <input id="bulkSlotLabels" class="wide" type="text" placeholder="Toplu yapƒ±≈ütƒ±r: 16:30-17:10; 17:20-18:00; ..." />
    <button class="btn ghost" id="btnApplyBulk">Uygula</button>
    <button class="btn ghost" id="btnClearLabels">Temizle</button>
  `;
  wrap.appendChild(tools);
  $("#btnFillForward").onclick = ()=>{
    for(let i=1;i<S;i++){ if(!state.program.slotLabels[i]) state.program.slotLabels[i]=state.program.slotLabels[i-1]||''; }
    renderSlotLabels();
  };
  $("#btnApplyBulk").onclick = ()=>{
    const txt = $("#bulkSlotLabels").value.trim();
    if(!txt) return;
    const parts = txt.split(';').map(x=>x.trim());
    for(let i=0;i<S;i++) state.program.slotLabels[i]=parts[i]||state.program.slotLabels[i]||'';
    renderSlotLabels();
  };
  $("#btnClearLabels").onclick = ()=>{ state.program.slotLabels = Array(S).fill(''); renderSlotLabels(); };
}

function buildProgramGrid(fromRestore=false){
  if(!fromRestore){
    state.program.days = $("#daysInput").value.split(',').map(s=>s.trim()).filter(Boolean);
    state.program.slots = clamp(parseInt($("#slotsInput").value||"8"), 1, 12);
  }
  ensureSlotLabels();
  const days = state.program.days, S = state.program.slots;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';

  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'G√ºn / Saat',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const label = state.program.slotLabels[s]||'';
    const hc = document.createElement('div'); hc.className='kcell busy';
    hc.innerHTML = `<div>${s+1}</div><div class="mini2">${label||''}</div>`;
    head.appendChild(hc);
  }
  wrap.appendChild(head);

  days.forEach((d,di)=>{
    const row = document.createElement('div');
    row.className = 'kgrid'; row.style.setProperty('--cols', S);
    const lbl = document.createElement('div'); lbl.textContent = d; lbl.style.fontWeight='800'; row.appendChild(lbl);
    for(let si=0; si<S; si++){
      const key = keyDS(di,si);
      const cell = document.createElement('div'); cell.className='kcell';
      cell.textContent = state.program.cells[key] || '';
      cell.title = "Not girmek i√ßin tƒ±klayƒ±n (opsiyonel)";
      cell.onclick = ()=>{
        const val = prompt(`${d} - ${si+1}. saat i√ßin not:`, state.program.cells[key]||'');
        if(val!==null){ state.program.cells[key]=val.trim(); cell.textContent=state.program.cells[key]||''; }
      };
      row.appendChild(cell);
    }
    wrap.appendChild(row);
  });

  reconcileAllToProgram(getAssignPolicy());
}

/* Programla uyum */
function reconcileAllToProgram(policy='keep'){
  const D = state.program.days.length, S = state.program.slots;

  state.teachers.forEach(t=>{
    const cur = state.availability.teachers[t.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.teachers[t.id] = next;
  });
  Object.values(state.groups).forEach(g=>{
    const cur = state.availability.groups[g.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.groups[g.id] = next;
  });

  if(policy==='reset') state.assignments = [];
  else state.assignments = state.assignments.filter(a=> a.day<D && a.slot<S);
}

/* ===== 3) M√ºsaitlik ===== */
function slotHeadCells(container,S){
  for(let s=0;s<S;s++){
    const lab = state.program.slotLabels?.[s] || '';
    const hd = document.createElement('div'); hd.className='kcell busy';
    hd.innerHTML = `<div>${s+1}</div><div class="mini2">${lab}</div>`;
    container.appendChild(hd);
  }
}
function renderAvailGrids(){
  const D=state.program.days.length, S=state.program.slots, days=state.program.days;

  const tWrap=$("#teacherAvailWrap"); tWrap.innerHTML='';
  if(state.teachers.length===0){
    tWrap.innerHTML = '<div class="muted">√ñƒüretmen verisi yok. L√ºtfen "Verileri Oku" ile y√ºkleyin.</div>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>üë§ ${t.name}</b><span class="tag">${t.branch}</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='T√ºm√ºn√º Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='T√ºm√ºn√º Deƒüil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.teachers[t.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.teachers[t.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.teachers[t.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='G√ºn / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='√áift tƒ±kla: bu g√ºn√º t√ºm g√ºnlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" g√ºn√ºn√º kopyala?`)){ copyDayPattern(state.availability.teachers[t.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.teachers[t.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'Deƒüil';
          cell.onclick = ()=>{
            const cur = state.availability.teachers[t.id][d][s] = !state.availability.teachers[t.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'Deƒüil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); tWrap.appendChild(card);
    });
  }

  const gWrap=$("#groupAvailWrap"); gWrap.innerHTML='';
  const groups = Object.values(state.groups);
  if(groups.length===0){
    gWrap.innerHTML = '<div class="muted">Grup verisi yok. √ñƒürencilerden gruplar t√ºretilir.</div>';
  }else{
    groups.sort(groupComparator).forEach(g=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} √∂ƒürenci</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='T√ºm√ºn√º Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='T√ºm√ºn√º Deƒüil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.groups[g.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.groups[g.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.groups[g.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='G√ºn / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='√áift tƒ±kla: bu g√ºn√º t√ºm g√ºnlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" g√ºn√ºn√º kopyala?`)){ copyDayPattern(state.availability.groups[g.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.groups[g.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'Deƒüil';
          cell.onclick = ()=>{
            const cur = state.availability.groups[g.id][d][s] = !state.availability.groups[g.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'Deƒüil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); gWrap.appendChild(card);
    });
  }
}
function bulkSet(matrix, val){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=val; }
function bulkToggle(matrix){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=!matrix[d][s]; }
function copyDayPattern(matrix, fromDay){ const row = matrix[fromDay].slice(); for(let d=0; d<matrix.length; d++){ matrix[d] = row.slice(); } }

/* ===== 4) Talepler ===== */
function ensureRequests(){
  Object.values(state.groups).forEach(g=>{
    state.requests[g.id] = state.requests[g.id] || {};
    state.branches.forEach(b=>{
      if(typeof state.requests[g.id][b] !== 'number') state.requests[g.id][b] = 0;
    });
  });
}
function refreshReqFilterOptions(){
  const sel = $("#reqGroupSelect"); sel.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(Grup se√ßin)'; sel.appendChild(opt0);
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
  });
}
function totalRequestForGroup(gid){
  const req = state.requests[gid]||{};
  return Object.values(req).reduce((a,b)=>a+(+b||0),0);
}

function renderRequests(){
  ensureRequests();

  // Neden: Bran≈ü toplam/kalan rozetlerini her √ßizimde g√ºncel tutmak i√ßin
  if (typeof renderBranchChipsSummary === 'function') {
    renderBranchChipsSummary();
  } else {
    // Yedek: helper yoksa en azƒ±ndan bran≈ü isimlerini g√∂ster
    const bc = $("#branchChips");
    if (bc) {
      bc.innerHTML = '';
      state.branches.forEach(b=>{
        const x = document.createElement('span');
        x.className = 'pill';
        x.textContent = b;
        bc.appendChild(x);
      });
    }
  }

  const selVal = $("#reqGroupSelect").value;
  const wrap = $("#reqWrap");
  wrap.innerHTML = '';

  if(!selVal){
    wrap.innerHTML = '<div class="muted">Soldan bir grup se√ßin. Se√ßilen gruba ait talepleri d√ºzenleyin.</div>';
    return;
  }

  const g = state.groups[selVal];
  if(!g){
    wrap.innerHTML = '<div class="muted">Se√ßilen grup bulunamadƒ±.</div>';
    return;
  }

  const card = document.createElement('div');
  card.className = 'card';

  const total = totalRequestForGroup(g.id);
  const capacity = state.program.days.length * state.program.slots;
  const chip = document.createElement('span');
  chip.className = 'pill' + (total > capacity ? ' bad' : '');
  chip.textContent = `Toplam: ${total} ‚Ä¢ Kapasite: ${capacity}`;

  const head = document.createElement('div');
  head.className = 'flex';
  head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} √∂ƒürenci</span>`;
  head.appendChild(chip);
  card.appendChild(head);

  const tbl = document.createElement('table');
  tbl.style.borderSpacing = '0 6px';
  tbl.innerHTML = `<thead><tr><th>Bran≈ü</th><th style="width:240px">Saat</th></tr></thead><tbody></tbody>`;

  state.branches.forEach(b=>{
    const tr = document.createElement('tr');

    const td1 = document.createElement('td');
    td1.textContent = b;
    tr.appendChild(td1);

    const td2 = document.createElement('td');
    const box = document.createElement('div'); box.className = 'qty';

    const minus = document.createElement('button'); minus.textContent = '‚Äì';
    const inp = document.createElement('input'); inp.type = 'number'; inp.min = '0'; inp.value = state.requests[g.id][b] || 0;
    const plus = document.createElement('button'); plus.textContent = '+';

    minus.onclick = ()=>{
      inp.value = Math.max(0, (+inp.value || 0) - 1);
      inp.dispatchEvent(new Event('input'));
    };
    plus.onclick  = ()=>{
      inp.value = (+inp.value || 0) + 1;
      inp.dispatchEvent(new Event('input'));
    };

    inp.oninput = (e)=>{
      // Neden: istenmeyen deƒüerleri engelle, √∂zetleri canlƒ± g√ºncelle
      state.requests[g.id][b] = clamp(parseInt(e.target.value || '0'), 0, 999);

      const t = totalRequestForGroup(g.id);
      chip.className = 'pill' + (t > capacity ? ' bad' : '');
      chip.textContent = `Toplam: ${t} ‚Ä¢ Kapasite: ${capacity}`;

      if (typeof renderBranchChipsSummary === 'function') {
        renderBranchChipsSummary(); // bran≈ü kalan/kapasite √∂zetlerini canlƒ± g√ºncelle
      }
    };

    box.append(minus, inp, plus);
    td2.appendChild(box);
    tr.appendChild(td2);

    tbl.querySelector('tbody').appendChild(tr);
  });

  card.appendChild(tbl);
  wrap.appendChild(card);
}
const exportReq = ()=>download('grup-talepleri.json', state.requests);
const importReq = obj=>{
  if(!obj || typeof obj!=='object') return alert('Ge√ßersiz talepler JSON.');
  state.requests = obj;
  refreshReqFilterOptions();
  renderRequests();
};

/* ===== 5) Atama ===== */
function findTeacherOptions(branch){ return state.teachers.filter(t=>t.branch===branch); }
function isTeacherBusy(teacherId, day, slot){ return state.assignments.some(a=>a.teacherId===teacherId && a.day===day && a.slot===slot); }
function isGroupBusy(groupId, day, slot){ return state.assignments.some(a=>a.group===groupId && a.day===day && a.slot===slot); }
function prevGroupSubject(groupId, day, slot){
  if(slot>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day && x.slot===slot-1); return a ? a.branch : null; }
  if(day>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day-1 && x.slot===state.program.slots-1); return a ? a.branch : null; }
  return null;
}
function hasAssignmentsForGroup(gid){ return state.assignments.some(a=>a.group===gid); }
/* Bran≈ü ismini CSS sƒ±nƒ±fƒ±na √ßeviren yardƒ±mcƒ± */
function getBranchClass(branchName) {
    if (!branchName) return '';
    const b = branchName.toUpperCase();
    if (b.includes('MATEMATƒ∞K')) return 'mat';
    if (b.includes('FEN')) return 'fen';
    if (b.includes('T√úRK√áE')) return 'trk';
    if (b.includes('SOSYAL')) return 'sos';
    if (b.includes('ƒ∞NGƒ∞Lƒ∞ZCE')) return 'ing';
    if (b.includes('Dƒ∞N')) return 'din';
    return ''; // Tanƒ±msƒ±zsa varsayƒ±lan gri kalƒ±r
}
  
  function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;

  const groups = Object.values(state.groups).slice()
    .sort((a,b)=> (hasAssignmentsForGroup(b.id)?1:0)-(hasAssignmentsForGroup(a.id)?1:0) || groupComparator(a,b));

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='flex';
    const count = state.assignments.filter(a=>a.group===g.id).length;
    head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} √∂ƒürenci</span><span class="pill">${count} atama</span>`;
    card.appendChild(head);

    const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
    const headRow = document.createElement('div'); headRow.textContent='G√ºn / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
    slotHeadCells(grid,S);

    for(let d=0; d<days.length; d++){
      const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
      row.appendChild(Object.assign(document.createElement('div'),{textContent:days[d],style:'font-weight:700'}));
      for(let s=0; s<S; s++){
        const cell = document.createElement('div');
        cell.className = 'kcell';
        cell.dataset.d = d;
        cell.dataset.s = s;

        // Duruma g√∂re uygunluk rengini uygula (m√ºsaitse ye≈üil, deƒüilse kƒ±rmƒ±zƒ±).
        // Bu renkler yalnƒ±zca bo≈ü h√ºcreler i√ßin kullanƒ±lƒ±r; atamasƒ± olan h√ºcreler
        // kendi ders renkleriyle g√∂sterilecektir.
        const avail = state.availability?.groups?.[g.id]?.[d]?.[s] === true;
        cell.classList.add(avail ? 'ok' : 'bad');

        // Mevcut bir atama var mƒ±? Varsa h√ºcreyi ders rengine d√∂n√º≈üt√ºr.
        const cur = state.assignments.find(a => a.group === g.id && a.day === d && a.slot === s);
     if (cur) {
    // 1. Sƒ±nƒ±flarƒ± temizle ve ders rengini ekle
    cell.classList.remove('ok', 'bad', 'busy');
    cell.classList.add('assigned', getBranchClass(cur.branch));

    // 2. √ñƒüretmen ismini veriden bul
    const teacherObj = state.teachers.find(t => t.id === cur.teacherId);
    // ƒ∞sim varsa al, yoksa bo≈ü string d√∂nd√ºr (icon yanƒ±na bo≈üluk gelmemesi i√ßin)
    const teacherName = teacherObj ? teacherObj.name : '';

    // 3. ƒ∞√áERƒ∞K HTML - G√úNCELLENDƒ∞
    cell.innerHTML = `
      <div style="
          display:flex; 
          flex-direction:column; 
          justify-content:center; 
          align-items:center; 
          height:100%; 
          width:100%; 
          pointer-events:none; 
          padding-bottom: 4px; /* Bu satƒ±r i√ßeriƒüi yukarƒ± iter */
      ">
        
        <div style="
            font-weight:900; 
            font-size:14px; 
            line-height:1; 
            margin-bottom:3px; 
            text-align:center; 
            letter-spacing: -0.3px; /* Harfleri hafif sƒ±kƒ±≈ütƒ±rarak sƒ±ƒüdƒ±rƒ±r */
        ">
            ${cur.branch}
        </div>
        
        <div class="mini2" style="
            font-size:11px; 
            font-weight:700; 
            opacity:0.9; 
            line-height:1; 
            white-space:nowrap; 
            overflow:hidden; 
            text-overflow:ellipsis; 
            max-width:98%;
        ">
            üë§ ${teacherName}
        </div>

      </div>`;
}
        cell.onclick = () => {
          openAssignDialog(g.id, d, s);
        };
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }

    card.appendChild(grid);
    wrap.appendChild(card);
  });
}
const dlg = $("#dlgAssign"); let dlgCtx = null;

function openAssignDialog(group, day, slot) {
  dlgCtx = { group, day, slot };
  $("#dlgGroup").value = group;

  const time = state.program.slotLabels?.[slot] || `${slot + 1}. saat`;
  $("#dlgWhen").value = `${state.program.days[day]} ‚Ä¢ ${time}`;

  // Bran≈ü se√ßenekleri
  const selB = $("#dlgBranch");
  selB.innerHTML = '';
  state.branches.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b; opt.textContent = b;
    selB.appendChild(opt);
  });
  selB.onchange = fillTeachersForBranch;

  // Mevcut atama var mƒ±?
  const current = state.assignments.find(a => a.group === group && a.day === day && a.slot === slot);

  // Eƒüer h√ºcrede atama varsa, o bran≈üƒ± √∂n-se√ß
  if (current) selB.value = current.branch;

  // √ñƒüretmen listesini bran≈üa g√∂re doldur
  fillTeachersForBranch();

  // √ñƒüretmen √∂n-se√ßimi (mevcut atama varsa)
  if (current) {
    // Not: √ñƒüretmen ba≈üka yerde atanmƒ±≈üsa UI'da "atanmƒ±≈ü" olarak g√∂r√ºnebilir.
    // Sil butonunu g√∂stermek asƒ±l hedef; se√ßim ba≈üarƒ±sƒ±z olsa da sorun deƒüil.
    const selT = $("#dlgTeacher");
    selT.value = current.teacherId;
    $("#dlgDelete").hidden = false;
  } else {
    $("#dlgDelete").hidden = true;
  }

  dlg.showModal();
}
$("#dlgDelete").onclick = () => {
  if (!dlgCtx) return;
  const { group, day, slot } = dlgCtx;
  const has = state.assignments.some(a => a.group === group && a.day === day && a.slot === slot);
  if (!has) { dlg.close(); return; }

  if (confirm("Bu atamayƒ± silmek istiyor musunuz?")) {
    state.assignments = state.assignments.filter(a => !(a.group === group && a.day === day && a.slot === slot));
    dlg.close();
    renderAssignCards(); // why: √∂ƒüretmen anƒ±nda tekrar 'm√ºsait' g√∂r√ºns√ºn
  }
};

function hasAnyAssignments(){ return Array.isArray(state.assignments) && state.assignments.length > 0; }
function getTeacherAssignmentsMap(){
  const m = new Map();
  for (const a of state.assignments) {
    if (!m.has(a.teacherId)) m.set(a.teacherId, []);
    m.get(a.teacherId).push(a);
  }
  return m;
}

/**
 * Compute the total number of lesson slots a teacher could be assigned given
 * current group requests. This capacity is the sum of all requested lesson
 * counts for the teacher's branch across all groups. It serves as an upper
 * bound on how many lessons the teacher might teach in the plan. If no
 * requests exist for that branch the capacity will be zero.
 * @param {string} tid - teacher ID
 * @returns {number} total slots requested for this teacher's branch
 */
function teacherCapacity(tid) {
  const tObj = state.teachers.find(x => x.id === tid);
  if (!tObj) return 0;
  const br = tObj.branch;
  let total = 0;
  for (const gid of Object.keys(state.requests)) {
    const req = state.requests[gid] || {};
    const n = req[br];
    if (typeof n === 'number' && !isNaN(n)) total += n;
  }
  return total;
}

/**
 * Calculate how many lesson slots a teacher is available for based on the
 * current availability matrix. Each true entry in state.availability.teachers
 * counts as one potential lesson the teacher could teach. This is used in
 * the manual assignment panel to show a teacher's capacity (m√ºsaitlik) to
 * take on lessons as opposed to the total requested lesson count. Without
 * this helper the UI displayed confusing large numbers like 24 or 26. The
 * user explicitly requested that the availability count and the active
 * assignment count be shown next to each teacher in the manual assignment
 * panel.
 * @param {string} tid - teacher ID
 * @returns {number} number of available slots for this teacher
 */
function teacherAvailabilityCount(tid) {
  const avail = state.availability?.teachers?.[tid] || [];
  const D = state.program?.days?.length || 0;
  const S = state.program?.slots || 0;
  let total = 0;
  for (let d = 0; d < D; d++) {
    const row = avail[d] || [];
    for (let s = 0; s < S; s++) {
      if (row[s] === true) total++;
    }
  }
  return total;
}

function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const {day, slot} = dlgCtx || {};
  const selT = $("#dlgTeacher"); selT.innerHTML = '';

  // Precompute current assignment counts for teachers once per invocation
  const assignMap = getTeacherAssignmentsMap();
  findTeacherOptions(branch).forEach(t => {
    const availOk = state.availability.teachers[t.id]?.[day]?.[slot] === true;
    const busyNow = isTeacherBusy(t.id, day, slot);

    const ok = availOk && !busyNow;

    const opt = document.createElement('option');
    opt.value = t.id;

    // Determine how many slots the teacher is available for and currently assigned
    const totalAssigned = (assignMap.get(t.id) || []).length;
    const availCount = teacherAvailabilityCount(t.id);

    // Build label showing availability and active assignment counts
    // Format: (m√ºsaitlik / atama) e.g. (10/3)
    const countLabel = `(${availCount}/${totalAssigned})`;

    if (ok) {
      // Teacher is available; display counts next to name
      opt.textContent = `${t.name} ${countLabel}`;
    } else {
      // Teacher not suitable now; still show counts and reason
      const reason = busyNow ? '√ßakƒ±≈üƒ±yor' : 'uygun deƒüil';
      opt.textContent = `${t.name} ${countLabel} ‚Ä¢ ${reason}`;
      opt.disabled = true;
    }
    selT.appendChild(opt);
  });

  // Varsayƒ±lan olarak ilk uygun √∂ƒüretmeni se√ß
  const firstEnabled = Array.from(selT.options).find(o => !o.disabled);
  if (firstEnabled) selT.value = firstEnabled.value;
}

$("#dlgCancel").onclick = ()=> dlg.close();
$("#dlgOk").onclick = () => {
  const {group, day, slot} = dlgCtx;
  const branch = $("#dlgBranch").value;
  const teacherId = $("#dlgTeacher").value;

  // 1) √ñƒüretmen uygunluk kontrol√º
  if (state.availability.teachers[teacherId]?.[day]?.[slot] !== true){
    alert("Se√ßilen √∂ƒüretmen bu g√ºn/saati i√ßin m√ºsait deƒüil. L√ºtfen uygun bir √∂ƒüretmen se√ßin.");
    return;
  }

  // 2) Grup uygunluk kontrol√º (isteƒüe baƒülƒ±)
  if (state.availability.groups[group]?.[day]?.[slot] !== true){
    alert("Bu grup bu g√ºn/saati i√ßin m√ºsait deƒüil.");
    return;
  }

  // 3) √áakƒ±≈üma uyarƒ±larƒ± (yalnƒ±z aynƒ± saat)
  if (isTeacherBusy(teacherId, day, slot))
    if(!confirm("√ñƒüretmen bu saatte ba≈üka derste. Yine de ata?")) return;
  if (isGroupBusy(group, day, slot))
    if(!confirm("Bu gruba bu saatte ba≈üka atama var. √úzerine yazƒ±lsƒ±n mƒ±?")) return;

  // 4) Atamayƒ± yaz
  state.assignments = state.assignments.filter(a => !(a.group===group && a.day===day && a.slot===slot));
  state.assignments.push({group, day, slot, branch, teacherId});
  dlg.close();
  renderAssignCards(); // why: UI ve uygunluk anƒ±nda g√ºncellensin

  // Yazdƒ±r sekmesi a√ßƒ±ksa anƒ±nda tazele (why: manuel atama sonrasƒ± √∂nizleme g√ºncel kalsƒ±n)
  const printPanel = $('#step6');
  if (printPanel && !printPanel.hasAttribute('hidden')) {
    refreshPrintFilters();
    renderPrintPreview();
  }
};
// index.html ‚Äî Auto Assign (V4.1): Maks Yerle≈üim Odaklƒ±, Y√ºk Dengesi YOK

/**
 * Ama√ß: √ñƒüretmen y√ºk dengesini tamamen devre dƒ±≈üƒ± bƒ±rakarak,
 * m√ºmk√ºn olan EN √áOK derse atama yapan varyasyonu bulup uygulamak.
 */
function autoAssign() {
  const D = state.program.days.length;
  const S = state.program.slots;

  // --------- Ayarlar ---------
  const TIME_LIMIT_MS = 2500;
  const AVOID_SAME_BRANCH_SOFT = true;
  const MAX_FREE_TEACHER_SUGGESTIONS = 5;
  const MAX_CONFLICT_ROWS_IN_UI = 20;
  // ---------------------------

  // --- Yardƒ±mcƒ±lar ---
  const makeGrid = (rows, cols, fill=null) => Array.from({length:rows}, () => Array(cols).fill(fill));
  const keyCell = (g,d,s) => `${g}|${d}|${s}`;
  const rndInt = (n) => Math.floor(Math.random()*n);
  const shuffle = (arr) => { for (let i=arr.length-1;i>0;i--){ const j=rndInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };
  const prevBranchOf = (gGrid, gid, d, s) => {
    if (s > 0) return gGrid[gid]?.[d]?.[s-1]?.branch || null;
    if (d > 0) return gGrid[gid]?.[d-1]?.[S-1]?.branch || null;
    return null;
  };
  const canUse = (gGrid, tGrid, gid, tid, d, s) => {
    if (state.availability.groups[gid]?.[d]?.[s] !== true) return false;
    if (state.availability.teachers[tid]?.[d]?.[s] !== true) return false;
    if (gGrid[gid]?.[d]?.[s]) return false;
    if (tGrid[tid]?.[d]?.[s]) return false;
    return true;
  };

  const getTeacherName = (tid) => {
    const tObj = typeof state.teachers === 'object' && !Array.isArray(state.teachers) ? state.teachers[tid] : null;
    if (tObj?.name) return tObj.name;
    if (Array.isArray(state.teachers)) {
      const t = state.teachers.find(x => x.id === tid);
      if (t?.name) return t.name;
    }
    const p = state.people?.teachers;
    if (p) {
      const pt = Array.isArray(p) ? p.find(x => x.id === tid) : p[tid];
      if (pt?.name) return pt.name;
    }
    return String(tid);
  };

  // √ñƒüretmenin bran≈ü(lar)ƒ±nƒ± bul (cache'li)
  const teacherBranchesCache = new Map();
  const getTeacherBranches = (tid) => {
    if (teacherBranchesCache.has(tid)) return teacherBranchesCache.get(tid);
    const out = new Set();
    const addFromObj = (obj) => {
      if (!obj) return;
      const candidates = obj.branches || obj.subjects || obj.branch || obj.subject;
      if (Array.isArray(candidates)) candidates.forEach(b => b && out.add(String(b)));
      else if (typeof candidates === 'string') out.add(candidates);
    };
    const tObj = typeof state.teachers === 'object' && !Array.isArray(state.teachers) ? state.teachers[tid] : null;
    addFromObj(tObj);
    if (Array.isArray(state.teachers)) addFromObj(state.teachers.find(x => x.id === tid));
    const p = state.people?.teachers;
    if (p) addFromObj(Array.isArray(p) ? p.find(x => x.id === tid) : p[tid]);

    // findTeacherOptions ile √ßƒ±karƒ±m
    if (Array.isArray(state.branches)) {
      for (const b of state.branches) {
        try {
          const arr = findTeacherOptions(b) || [];
          if (arr.some(t => t.id === tid)) out.add(String(b));
        } catch { /* ignore */ }
      }
    }
    const result = Array.from(out);
    teacherBranchesCache.set(tid, result);
    return result;
  };

  // O g√ºn/saat bo≈üta √∂ƒüretmenleri listele (bran≈ü + isim)
  const listFreeTeachersAt = (d, s, max = MAX_FREE_TEACHER_SUGGESTIONS) => {
    const tAvail = state.availability?.teachers || {};
    const tids = Object.keys(tAvail);
    const busyAt = new Set(state.assignments.filter(a => a.day === d && a.slot === s).map(a => a.teacherId));
    const res = [];
    for (const tid of tids) {
      if (tAvail[tid]?.[d]?.[s] === true && !busyAt.has(tid)) {
        const branches = getTeacherBranches(tid);
        res.push({ id: tid, name: getTeacherName(tid), branches });
      }
    }
    res.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
    return res.slice(0, max);
  };

  // Manuel "se√ß‚Äìata" (bran≈ü: √∂ƒüretmenin bran≈üƒ± ‚à© ihtiya√ß; yoksa √∂ƒüretmenin ilk bran≈üƒ±)
  function performManualAssign(gid, d, s, tid, branch) {
    if (state.availability.groups[gid]?.[d]?.[s] !== true) { alert('Grup bu saatte m√ºsait deƒüil.'); return false; }
    if (state.availability.teachers[tid]?.[d]?.[s] !== true) { alert('√ñƒüretmen bu saatte m√ºsait deƒüil.'); return false; }
    if (state.assignments.some(a => a.group===gid && a.day===d && a.slot===s)) { alert('Bu slot dolu.'); return false; }
    if (state.assignments.some(a => a.teacherId===tid && a.day===d && a.slot===s)) { alert('√ñƒüretmen bu saatte ba≈üka derste.'); return false; }

    if (!branch) {
      const tBranches = getTeacherBranches(tid);
      const counts = Object.fromEntries(state.branches.map(b => [b, +(state.requests[gid]?.[b] || 0)]));
      state.assignments.filter(a=>a.group===gid).forEach(a => counts[a.branch] = Math.max(0, (counts[a.branch]||0)-1));
      const needed = Object.entries(counts).filter(([,v])=>v>0).map(([b])=>b);
      const inter = tBranches.filter(b => needed.includes(b));
      branch = inter[0] || tBranches[0] || state.branches?.[0] || 'GENEL';
    }

    state.assignments.push({ group: gid, day: d, slot: s, branch, teacherId: tid });
    renderAssignCards();
    return true;
  }

  // --- Sabit atamalar (korunur) ---
  const fixed = state.assignments.map(a => ({...a}));

  // Hƒ±zlƒ± eri≈üim ƒ±zgaralarƒ± (yalnƒ±z sabitler)
  const gGridBase = {};
  const tGridBase = {};
  const ensure = (mat, id, rows, cols) => (mat[id] ||= makeGrid(rows, cols));
  const placeBase = a => {
    ensure(gGridBase, a.group, D, S)[a.day][a.slot] = a;
    ensure(tGridBase, a.teacherId, D, S)[a.day][a.slot] = a;
  };
  fixed.forEach(placeBase);

  // ƒ∞htiya√ß listeleri (group -> [branch, ...])
  const needsByGroup = {};
  for (const g of Object.values(state.groups)) {
    const req = state.requests[g.id] || {};
    const have = {};
    fixed.forEach(a => { if (a.group === g.id) have[a.branch] = (have[a.branch]||0) + 1; });
    const list = [];
    for (const [b, cnt] of Object.entries(req)) {
      const need = Math.max(0, (cnt|0) - (have[b]||0));
      for (let i=0;i<need;i++) list.push(b);
    }
    needsByGroup[g.id] = list;
  }

  // ƒ∞htiya√ß yoksa sadece yeniden √ßiz ve rapor
  const remainingNeedsCount = Object.values(needsByGroup).reduce((acc, arr) => acc + (arr?.length || 0), 0);
  if (remainingNeedsCount === 0) {
    renderAssignCards();
    showAutoAssignReport(buildAutoAssignReport(fixed.length));
    return;
  }

  // Deneme sayƒ±sƒ± (ihtiyaca g√∂re dinamik)
  const BASE_RESTARTS = 80;
  const RESTARTS_PER_NEED = 6;
  const MAX_RESTARTS = 1000;
  const TARGET_RESTARTS = Math.min(MAX_RESTARTS, BASE_RESTARTS + remainingNeedsCount * RESTARTS_PER_NEED);

  // H√ºcre sƒ±ra paternleri
  const orderings = {
    randomAll(D,S) { const cells = []; for (let d=0; d<D; d++) for (let s=0; s<S; s++) cells.push([d,s]); return shuffle(cells); },
    dayMajorRandom(D,S) {
      const days = shuffle([...Array(D).keys()]); const slots = shuffle([...Array(S).keys()]);
      const cells = []; for (const d of days) for (const s of slots) cells.push([d,s]); return cells;
    },
    slotMajorRandom(D,S) {
      const days = shuffle([...Array(D).keys()]); const slots = shuffle([...Array(S).keys()]);
      const cells = []; for (const s of slots) for (const d of days) cells.push([d,s]); return cells;
    },
    serpentine(D,S) {
      const days = shuffle([...Array(D).keys()]); const cells = [];
      for (let i=0;i<days.length;i++){ const d = days[i];
        if (i%2===0) for (let s=0;s<S;s++) cells.push([d,s]); else for (let s=S-1;s>=0;s--) cells.push([d,s]);
      } return cells;
    }
  };
  const orderingKeys = Object.keys(orderings);

  // √áoklu denemeler
  const startTime = performance.now();
  const groupsAll = Object.values(state.groups).map(x => x.id);

  let bestScore = -1;
  let bestSolution = null;
  let restartsDone = 0;

  while (restartsDone < TARGET_RESTARTS && (performance.now() - startTime) < TIME_LIMIT_MS) {
    restartsDone++;

    const gGrid = {};
    const tGrid = {};
    for (const gid of Object.keys(gGridBase)) gGrid[gid] = gGridBase[gid].map(row => row.slice());
    for (const tid of Object.keys(tGridBase)) tGrid[tid] = tGridBase[tid].map(row => row.slice());
    const needs = JSON.parse(JSON.stringify(needsByGroup));

    const pattern = orderingKeys[rndInt(orderingKeys.length)];
    const cells = orderings[pattern](D, S);

    const groupOrder = groupsAll
      .map(gid => ({ gid, need: needs[gid]?.length || 0 }))
      .sort((a,b) => a.need - b.need || (Math.random()-0.5))
      .map(x => x.gid);

    let placedCount = 0;

    for (const [d,s] of cells) {
      const localGroups = groupOrder.slice();
      if (Math.random() < 0.5) shuffle(localGroups);

      for (const gid of localGroups) {
        const needArr = needs[gid];
        if (!needArr || needArr.length === 0) continue;
        if (state.availability.groups[gid]?.[d]?.[s] !== true) continue;
        if (gGrid[gid]?.[d]?.[s]) continue;

        const lastB = AVOID_SAME_BRANCH_SOFT ? prevBranchOf(gGrid, gid, d, s) : null;
        const uniqBranches = Array.from(new Set(needArr));
        shuffle(uniqBranches);
        if (lastB) {
          const ix = uniqBranches.indexOf(lastB);
          if (ix > -1) { uniqBranches.splice(ix,1); uniqBranches.push(lastB); }
        }

        let placedHere = false;

        for (const branch of uniqBranches) {
          // T√ºm aday √∂ƒüretmenleri filtrele (uygunluk ve bo≈üluk kontrol√º)
          const allCandidates = findTeacherOptions(branch)
            .filter(t => state.availability.teachers[t.id]?.[d]?.[s] === true && !(tGrid[t.id] || [])[d]?.[s]);
          if (allCandidates.length === 0) continue;

          // Daha √∂nce bu gruba aynƒ± bran≈ü i√ßin atanmƒ±≈ü √∂ƒüretmenleri belirle
          const usedTeachers = new Set();
          const gRows = gGrid[gid] || [];
          for (let dd = 0; dd < D; dd++) {
            const row = gRows[dd] || [];
            for (let ss = 0; ss < S; ss++) {
              const a2 = row[ss];
              if (a2 && a2.branch === branch) usedTeachers.add(a2.teacherId);
            }
          }

          // √ñncelikli olarak hen√ºz kullanƒ±lmamƒ±≈ü √∂ƒüretmenleri listele
          const preferred = allCandidates.filter(t => !usedTeachers.has(t.id));
          const candidateList = preferred.length > 0 ? preferred : allCandidates;

          shuffle(candidateList);

          for (const t of candidateList) {
            if (!canUse(gGrid, tGrid, gid, t.id, d, s)) continue;

            const a = { group: gid, day: d, slot: s, branch, teacherId: t.id };
            (gGrid[gid] ||= makeGrid(D, S))[d][s] = a;
            (tGrid[t.id] ||= makeGrid(D, S))[d][s] = a;

            const idx = needArr.indexOf(branch);
            if (idx > -1) needArr.splice(idx, 1);

            placedCount++;
            placedHere = true;
            break;
          }
          if (placedHere) break;
        }
      }

      if ((performance.now() - startTime) >= TIME_LIMIT_MS) break;
    }

    const solution = [];
    for (const a of fixed) solution.push({...a});
    for (const gid of Object.keys(gGrid)) {
      for (let d=0; d<D; d++) {
        for (let s=0; s<S; s++) {
          const a = gGrid[gid][d][s];
          if (!a) continue;
          if (!gGridBase[gid]?.[d]?.[s]) solution.push(a);
        }
      }
    }

    if (placedCount > bestScore) {
      bestScore = placedCount;
      bestSolution = solution;
      if (bestScore === remainingNeedsCount) break;
    }
  }

  // En iyi sonucu uygula
  if (bestSolution) {
    const seen = new Set();
    const merged = [];
    for (const a of bestSolution) {
      const k = keyCell(a.group, a.day, a.slot);
      if (seen.has(k)) continue;
      seen.add(k);
      merged.push({group:a.group, day:a.day, slot:a.slot, branch:a.branch, teacherId:a.teacherId});
    }
    state.assignments = merged;
  }

  renderAssignCards();

  // --- Raporu hesapla ve g√∂ster ---
  showAutoAssignReport(buildAutoAssignReport(fixed.length));

  // ---------- Rapor yardƒ±mcƒ±larƒ± ----------
  function buildAutoAssignReport(prevCount) {
    const groups = Object.values(state.groups);
    const totalCells = groups.length * D * S;

    let groupAvailableCells = 0;
    for (const g of groups) {
      const mat = state.availability.groups[g.id] || [];
      for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
        if (mat?.[d]?.[s] === true) groupAvailableCells++;
      }
    }
    const blockedByGroup = totalCells - groupAvailableCells;

    const totalAssigned = state.assignments.length;
    const newlyAssigned = totalAssigned - prevCount;

    // Kalan ihtiya√ßlar (grup->bran≈ü->sayƒ±)
    const needsLeft = {};
    for (const g of groups) {
      const counts = Object.fromEntries(state.branches.map(b => [b, +(state.requests[g.id]?.[b] || 0)]));
      state.assignments
        .filter(a => a.group === g.id)
        .forEach(a => counts[a.branch] = Math.max(0, (counts[a.branch] || 0) - 1));
      needsLeft[g.id] = counts;
    }

    const emptyDetails = [];
    let emptyCount = 0;
    let reasonStats = { grup_musait_degildi:0, talep_kalmadi:0, ogretmen_yok_veya_mecbur_cakisiyor:0 };

    const isAssigned = (gid,d,s) => state.assignments.some(a => a.group===gid && a.day===d && a.slot===s);

    for (const g of groups) {
      for (let d=0; d<D; d++) for (let s=0; s<S; s++) {
        if (isAssigned(g.id,d,s)) continue;

        emptyCount++;

        if (state.availability.groups[g.id]?.[d]?.[s] !== true) {
          reasonStats.grup_musait_degildi++;
          emptyDetails.push({ group:g.id, day:d, slot:s, reason:'grup_musait_degildi' });
          continue;
        }

        const totalLeft = Object.values(needsLeft[g.id]).reduce((a,b)=>a+b,0);
        if (totalLeft <= 0) {
          reasonStats.talep_kalmadi++;
          emptyDetails.push({
            group:g.id, day:d, slot:s, reason:'talep_kalmadi',
            suggestion:['Et√ºt/√ñdev √áalƒ±≈ümasƒ±','Okuma Saati','Rehberlik','Tekrar/Teknik drill']
          });
          continue;
        }

        // Talep var
        const neededBranches = Object.entries(needsLeft[g.id])
          .filter(([,cnt]) => cnt > 0)
          .sort((a,b)=>b[1]-a[1])
          .map(([b]) => b);

        let branchSuggestions = [];
        for (const b of neededBranches) {
          const teachers = findTeacherOptions(b)
            .filter(t => state.availability.teachers[t.id]?.[d]?.[s] === true)
            .filter(t => !state.assignments.some(a => a.teacherId===t.id && a.day===d && a.slot===s))
            .map(t => t.name);
          if (teachers.length) branchSuggestions.push({branch:b, teachers: teachers.slice(0,3)});
        }

        if (branchSuggestions.length === 0) {
          // √áAKI≈ûMA/ATANAMADI ‚Üí bran≈ü fark etmeksizin bo≈üta √∂ƒüretmenleri ekle
          reasonStats.ogretmen_yok_veya_mecbur_cakisiyor++;
          emptyDetails.push({
            group:g.id, day:d, slot:s, reason:'ogretmen_yok_veya_mecbur_cakisiyor',
            neededBranches,                       // [en √ßok ihtiya√ß, ...]
            freeTeachers: listFreeTeachersAt(d,s) // [{id,name,branches}]
          });
        } else {
          emptyDetails.push({
            group:g.id, day:d, slot:s, reason:'uygun_kombo_var_ama_yerlesmedi',
            suggestion: branchSuggestions.slice(0,2)
          });
        }
      }
    }

    return {
      totals: {
        groups: groups.length,
        days: D,
        slotsPerDay: S,
        totalCells,
        blockedByGroup,
        effectiveCapacity: groupAvailableCells,
        totalAssigned,
        newlyAssigned,
        emptyOnAvailable: Math.max(0, groupAvailableCells - totalAssigned),
        emptyAll: emptyCount
      },
      reasons: reasonStats,
      details: emptyDetails
    };
  }

  function showAutoAssignReport(report) {
    let dlg = document.getElementById('dlgAutoAssignReport');
    if (!dlg) {
      dlg = document.createElement('dialog');
      dlg.id = 'dlgAutoAssignReport';
      dlg.style.padding = '16px';
      dlg.style.borderRadius = '14px';
      dlg.style.maxWidth = '1200px';              // geni≈ületildi
      dlg.style.width = 'min(98vw, 1200px)';      // geni≈ületildi
      dlg.innerHTML = `
        <header style="font-weight:800;font-size:18px;margin-bottom:8px">üßæ Otomatik Atama Raporu</header>
        <section id="autoAssignReportBody" style="max-height:60vh;overflow:auto"></section>
        <footer style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button id="btnRptCopy" class="btn ghost">Metni Kopyala</button>
          <button id="btnRptClose" class="btn">Kapat</button>
        </footer>
      `;
      document.body.appendChild(dlg);
      dlg.querySelector('#btnRptClose').onclick = () => dlg.close();
      dlg.querySelector('#btnRptCopy').onclick = () => {
        const txt = dlg.querySelector('#autoAssignReportBody').innerText;
        navigator.clipboard?.writeText(txt);
      };

      // Event delegation: √∂ƒüretmen se√ßimi -> bran≈ülarƒ± filtrele
      const bodyEl = dlg.querySelector('#autoAssignReportBody');
      bodyEl.addEventListener('change', (e) => {
        if (!e.target.matches('.sel-teacher')) return;
        const li = e.target.closest('li.conflict-row');
        if (!li) return;
        const selB = li.querySelector('select.sel-branch');
        const teacherBranches = (e.target.selectedOptions?.[0]?.dataset.branches || '').split('|').filter(Boolean);
        const needed = (li.dataset.needed || '').split('|').filter(Boolean);

        let options = teacherBranches.filter(b => needed.includes(b));
        let suffix = '';
        if (options.length === 0) { options = teacherBranches.slice(); suffix = ' (ihtiya√ß dƒ±≈üƒ±)'; }
        if (options.length === 0) { options = state.branches?.slice?.() || []; suffix = ' (tanƒ±msƒ±z)'; }

        selB.innerHTML = options.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b+suffix)}</option>`).join('');
      });

      // Event delegation: "Ata"
      bodyEl.addEventListener('click', (e) => {
        if (!e.target.matches('.btn-assign-free')) return;
        const li = e.target.closest('li.conflict-row');
        if (!li) return;

        const gid = li.dataset.gid;
        const d = +li.dataset.day;
        const s = +li.dataset.slot;
        const selT = li.querySelector('select.sel-teacher');
        const selB = li.querySelector('select.sel-branch');

        const tid = selT?.value;
        let branch = selB?.value || '';

        if (!tid) { alert('L√ºtfen √∂ƒüretmen se√ßiniz.'); return; }
        if (!branch) {
          const tBranches = (selT.selectedOptions?.[0]?.dataset.branches || '').split('|').filter(Boolean);
          const needed = (li.dataset.needed || '').split('|').filter(Boolean);
          const inter = tBranches.filter(b => needed.includes(b));
          branch = inter[0] || tBranches[0] || state.branches?.[0] || 'GENEL';
        }

        const ok = performManualAssign(gid, d, s, tid, branch);
        if (!ok) return;

        const base = +(dlg.dataset.baseAssigned || state.assignments.length);
        const refreshed = buildAutoAssignReport(base);
        renderReportBody(refreshed); // modal a√ßƒ±k kalƒ±r
      });
    }

    renderReportBody(report);
    if (!dlg.open) dlg.showModal();

    // ƒ∞√ßerik render'ƒ±
    function renderReportBody(rep) {
      const el = document.querySelector('#dlgAutoAssignReport #autoAssignReportBody');
      const t = rep.totals, r = rep.reasons;

      if (!dlg.dataset.baseAssigned) dlg.dataset.baseAssigned = String(t.totalAssigned);

      const fmtSlot = (d,s) => {
        const day = state.program.days[d];
        const lbl = state.program.slotLabels?.[s] || `${s+1}. saat`;
        return `${day} ‚Ä¢ ${lbl}`;
      };

      const topBranchSuggestions = rep.details
        .filter(x => x.reason === 'uygun_kombo_var_ama_yerlesmedi')
        .slice(0, 10)
        .map(x => {
          const br = x.suggestion[0];
          const teacherList = Array.isArray(br?.teachers) ? br.teachers.join(', ') : '';
          return `<li><b>${escapeHtml(String(x.group))}</b> ‚Äî ${escapeHtml(fmtSlot(x.day,x.slot))} ‚Üí <b>${escapeHtml(br.branch)}</b> (${escapeHtml(teacherList)})</li>`;
        }).join('');

      // √áakƒ±≈üan slotlar i√ßin interaktif liste + ƒ∞HTƒ∞YA√á DERS ADI (yalnƒ±z isim)
      const conflictRows = rep.details
        .filter(x => x.reason === 'ogretmen_yok_veya_mecbur_cakisiyor')
        .slice(0, MAX_CONFLICT_ROWS_IN_UI)
        .map(x => {
          const teacherOpts = (x.freeTeachers||[])
            .map(t => {
              const branches = (t.branches || []).map(b => String(b)).join('|');
              const label = `${t.name || t.id}${t.branches?.length ? ' ('+t.branches.join(', ')+')' : ''}`;
              return `<option value="${escapeHtml(String(t.id))}" data-branches="${escapeAttr(branches)}">${escapeHtml(label)}</option>`;
            }).join('');
          const neededPipe = (x.neededBranches||[]).map(b => String(b)).join('|');

          const firstTeacherBranches = (x.freeTeachers?.[0]?.branches || []).map(b => String(b));
          const interDefault = firstTeacherBranches.filter(b => (x.neededBranches||[]).includes(b));
          const defaultBranchOpts = (interDefault.length ? interDefault : firstTeacherBranches)
            .map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b + (interDefault.length ? '' : ' (ihtiya√ß dƒ±≈üƒ±)'))}</option>`)
            .join('') || `<option value="">(bran≈ü yok)</option>`;

          const topNeed = (x.neededBranches && x.neededBranches[0]) ? String(x.neededBranches[0]) : '';

          return `
            <li class="conflict-row" data-gid="${escapeAttr(String(x.group))}" data-day="${x.day}" data-slot="${x.slot}" data-needed="${escapeAttr(neededPipe)}" style="margin:6px 0">
              <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between">
                <div style="display:flex;gap:8px;align-items:center;min-width:300px">
                  <div><b>${escapeHtml(String(x.group))}</b> ‚Äî ${escapeHtml(fmtSlot(x.day,x.slot))}</div>
                  ${topNeed ? `<span class="need-chip" title="ƒ∞htiya√ß" style="padding:2px 8px;border-radius:999px;background:#eee;font-size:12px;line-height:1.6">${escapeHtml(topNeed)}</span>` : ``}
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
                  <label>√ñƒüretmen:
                    <select class="sel-teacher" style="min-width:220px">
                      <option value="">Se√ßiniz</option>
                      ${teacherOpts}
                    </select>
                  </label>
                  <label>Bran≈ü:
                    <select class="sel-branch" style="min-width:160px">
                      ${defaultBranchOpts}
                    </select>
                  </label>
                  <button class="btn btn-assign-free">Ata</button>
                </div>
              </div>
            </li>`;
        }).join('');

      el.innerHTML = `
        <div class="grid" style="gap:8px">
          <div class="pill">Toplam Atama: <b>${t.totalAssigned}</b> ‚Ä¢ Bu oturumda yeni: <b>${t.newlyAssigned}</b></div>
          <div class="pill">Etkin Kapasite (grup m√ºsait): <b>${t.effectiveCapacity}</b> ‚Ä¢ Bo≈ü (etkin): <b>${t.emptyOnAvailable}</b></div>
          <div class="pill">Bloklu (grup m√ºsait deƒüil): <b>${t.blockedByGroup}</b> ‚Ä¢ T√ºm Bo≈ü: <b>${t.emptyAll}</b></div>

          <div class="card">
            <h3>Sebep Kƒ±rƒ±lƒ±mƒ±</h3>
            <ul style="margin:6px 0 0 18px">
              <li>Grup m√ºsait deƒüildi: <b>${r.grup_musait_degildi}</b></li>
              <li>Talep kalmadƒ±: <b>${r.talep_kalmadi}</b></li>
              <li>√ñƒüretmen yok / mecbur √ßakƒ±≈üƒ±yor: <b>${r.ogretmen_yok_veya_mecbur_cakisiyor}</b></li>
            </ul>
          </div>

          <div class="card">
            <h3>Bo≈ü Slotlar i√ßin Bran≈üa Uygun √ñneriler (ƒ∞lk 10)</h3>
            ${topBranchSuggestions ? `<ol style="margin:6px 0 0 18px">${topBranchSuggestions}</ol>`
                                   : `<div class="muted">Bu turda bran≈ü bazlƒ± e≈üle≈üme √∂nerisi olu≈ümadƒ±.</div>`}
          </div>

          <div class="card">
            <h3>Atanamayan (√áakƒ±≈üma) Slotlar: Bran≈ü Farketmez √ñƒüretmen Se√ß‚ÄìAta</h3>
            ${conflictRows ? `<ol style="margin:6px 0 0 18px">${conflictRows}</ol>`
                           : `<div class="muted">√áakƒ±≈üma kaynaklƒ± atanamayan slot kalmadƒ±.</div>`}
            <div class="muted" style="margin-top:6px">Not: √ñƒüretmen/bran≈ü se√ßip <b>Ata</b> dediƒüinizde modal kapanmadan liste g√ºncellenir.</div>
          </div>
        </div>
      `;
    }
  }

  // Mini utils ‚Äî XSS'e kar≈üƒ± ka√ßƒ±≈ü
  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }
  function escapeAttr(s) { return escapeHtml(s).replaceAll('"','&quot;'); }
}
const exportAssgn = ()=>download('atamalar.json', state.assignments);
const importAssgn = obj=>{
  if(!Array.isArray(obj)) return alert('Ge√ßersiz atamalar JSON.');
  state.assignments = obj;
  reconcileAllToProgram(getAssignPolicy());
  renderAssignCards();
};

/* ===== 6) Yazdƒ±r ===== */
function hasAnyAssignments(){ return state.assignments && state.assignments.length>0; }
function refreshPrintFilters(){
  const mode = $("#printMode").value;
  const sel = $("#printFilter"); sel.innerHTML='';
  if(mode==='group'){
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(T√ºm Gruplar)'; sel.appendChild(opt0);
    Object.values(state.groups).sort(groupComparator).forEach(g=>{
      const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
    });
  }else{
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(T√ºm √ñƒüretmenler)'; sel.appendChild(opt0);
    state.teachers.forEach(t=>{
      const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} ‚Äî ${t.branch}`; sel.appendChild(opt);
    });
  }
}
function renderPrintPreview(){
  const div = $("#printPreview"); div.innerHTML='';
  const mode = $("#printMode").value;
  const filter = $("#printFilter").value;
  const S = state.program.slots, days = state.program.days, labels = state.program.slotLabels || [];

  if(!hasAnyAssignments()){
    div.innerHTML = '<div class="muted">Atama yok. √ñnce atama yapƒ±n.</div>';
    $("#btnPrint").disabled = true; return;
  }
  $("#btnPrint").disabled = false;

  const hdr = document.createElement('div'); hdr.className='print-header';
  hdr.innerHTML = `<h2>Fenomen √áocuk Kul√ºb√º ‚Äî ${mode==='group'?'Grup':'√ñƒüretmen'} Ders Planƒ±</h2>`;
  div.appendChild(hdr);

  if(mode==='group'){
    const groups = (filter ? [state.groups[filter]] : Object.values(state.groups))
      .filter(Boolean)
      .filter(g=>state.assignments.some(a=>a.group===g.id))
      .sort(groupComparator);

    groups.forEach(g=>{
      const aForG = state.assignments.filter(a=>a.group===g.id);
      const daysWith = Array.from(new Set(aForG.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // √ñƒürenciler ‚Äì iki s√ºtun üë§
      const students = state.students.filter(st=>st.group===g.id).map(s=>s.name);
      const title = document.createElement('div'); title.className='print-sub';
      title.innerHTML = `<b>${g.name}</b> ‚Ä¢ √ñƒürenciler:`;
      wr.appendChild(title);

      const stCol = document.createElement('div'); stCol.className='students-2col';
      const ul = document.createElement('ul');
      students.forEach(n=>{
        const li=document.createElement('li'); li.innerHTML=`üë§ ${n}`; ul.appendChild(li);
      });
      stCol.appendChild(ul); wr.appendChild(stCol);

      // Tablo ‚Äì ortalƒ± √∂ƒüretmen isimleri
      const t = document.createElement('table'); t.className='print-table tight';
      const thead = `<tr><th>G√ºn / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      days.forEach((d,di)=>{
        let row=`<tr><td><b>${days[di]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForG.find(x=>x.day===di && x.slot===s);
          const txt = a ? `<div style="text-align:center"><b>${a.branch}</b><br/>üë§ ${state.teachers.find(t=>t.id===a.teacherId)?.name||''}</div>` : '';
          row += `<td>${txt}</td>`;
        }
        row+='</tr>'; body+=row;
      });
      t.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(t);

      page.appendChild(wr); div.appendChild(page);
    });

  } else {
    const teachers = (filter ? [state.teachers.find(t=>t.id===filter)] : state.teachers)
      .filter(Boolean)
      .filter(t=>state.assignments.some(a=>a.teacherId===t.id));

    teachers.forEach(t=>{
      const aForT = state.assignments.filter(a=>a.teacherId===t.id);
      const daysWith = Array.from(new Set(aForT.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // √úst tablo ‚Äî √∂ƒüretmene g√∂re, ortalƒ±
      const tTbl = document.createElement('table'); tTbl.className='print-table tight';
      const thead = `<tr><th colspan="${S+1}" style="text-align:center">${t.name} ‚Äî ${t.branch}</th></tr>
                     <tr><th>G√ºn / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      daysWith.forEach(d=>{
        let row=`<tr><td><b>${days[d]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForT.find(x=>x.day===d && x.slot===s);
          row += a ? `<td style="text-align:center"><b>${a.branch}</b><br/>Grup: ${state.groups[a.group]?.name||''}</td>` : `<td></td>`;
        }
        row+='</tr>'; body+=row;
      });
      tTbl.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(tTbl);

      // Yoklama bloklarƒ± ‚Äî her grup i√ßin k√º√ß√ºk tablo
      const groupsForT = Array.from(new Set(aForT.map(a=>a.group))).map(gid=>state.groups[gid]).filter(Boolean).sort(groupComparator);
      groupsForT.forEach(g=>{
        const blockTitle = document.createElement('div'); blockTitle.className='print-sub';
        blockTitle.innerHTML = `<b>${g.name}</b> ‚Ä¢ √ñƒürenci Yoklama`;
        wr.appendChild(blockTitle);

        const att = document.createElement('table'); att.className='att-table';
        att.innerHTML = `<thead>
            <tr><th>üë§ √ñƒürenci</th><th>Geldi</th><th>Gelmedi</th><th>Ge√ß Geldi</th><th>ƒ∞zinli</th></tr>
          </thead><tbody></tbody>`;
        const tbody = att.querySelector('tbody');
        state.students.filter(s=>s.group===g.id).forEach(st=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${st.name}</td><td>‚ñ°</td><td>‚ñ°</td><td>‚ñ°</td><td>‚ñ°</td>`;
          tbody.appendChild(tr);
        });
        wr.appendChild(att);
      });

      page.appendChild(wr); div.appendChild(page);
    });
  }
}

/* ===== Olaylar ===== */
$("#btnFetch").onclick = fetchAll;
$("#btnClear").onclick = ()=>{
  state.teachers=[]; state.students=[]; state.groups={}; state.branches=[];
  renderTeachers(); renderStudents(); renderGroupSummary();
  $("#readStatus").textContent='Temizlendi.';
  reconcileAllToProgram(getAssignPolicy());
};

$("#btnBuildGrid").onclick = ()=>{ buildProgramGrid(false); renderSlotLabels(); };
$("#btnProgExport").onclick = ()=>download('ders-programi.json', state.program);
$("#btnProgImport").onclick = ()=>openFile($("#fileProgImport"), obj=>{
  if(!obj || !Array.isArray(obj.days) || typeof obj.slots!=='number') return alert('Ge√ßersiz program JSON.');
  state.program = obj; if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels=[];
  $("#daysInput").value = obj.days.join(','); $("#slotsInput").value = obj.slots;
  buildProgramGrid(true); renderSlotLabels();
  reconcileAllToProgram(getAssignPolicy());
  renderAvailGrids(); renderAssignCards(); refreshPrintFilters();
});

$("#btnAvailExport").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport").onclick = ()=>openFile($("#fileAvailImport"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('Ge√ßersiz m√ºsaitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});
$("#btnAvailClear").onclick = ()=>{ state.availability={teachers:{},groups:{}}; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); };
$("#btnAvailExport2").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport2").onclick = ()=>openFile($("#fileAvailImport2"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('Ge√ßersiz m√ºsaitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});

$("#goto2").onclick = ()=> showTopTab('step2');
$("#goto3").onclick = ()=> showTopTab('step3');
$("#goto4").onclick = ()=> showTopTab('step4');
$("#goto5").onclick = ()=> showTopTab('step5');
$("#goto6").onclick = ()=> showTopTab('step6');

$("#btnReqExport").onclick = exportReq;
$("#btnReqImport").onclick = ()=>openFile($("#fileReqImport"), importReq);
$("#btnReqClear").onclick = ()=>{ state.requests={}; renderRequests(); };
$("#reqGroupSelect").onchange = renderRequests;

$("#btnAutoAssign").onclick = autoAssign;
$("#btnAssgnExport").onclick = exportAssgn;
$("#btnAssgnImport").onclick = ()=>openFile($("#fileAssgnImport"), importAssgn);
$("#btnAssgnClear").onclick = ()=>{ state.assignments=[]; renderAssignCards(); };

$("#printMode").onchange = ()=> { refreshPrintFilters(); renderPrintPreview(); };
$("#btnRenderPrint").onclick = renderPrintPreview;

// Yerel kaydet/y√ºkle fonksiyonlarƒ± kaldƒ±rƒ±ldƒ±; Firebase tabanlƒ± i≈ülemler eklenecek

/* Alt sekmeler (M√ºsaitlik) */
function showAvailTab(which){
  const teachActive = which==='teach';
  $("#panelTeach").toggleAttribute('hidden', !teachActive);
  $("#panelGroup").toggleAttribute('hidden', teachActive);
  $("#tabTeach").setAttribute('aria-selected', String(teachActive));
  $("#tabGroup").setAttribute('aria-selected', String(!teachActive));
}
$("#tabTeach").addEventListener('click', ()=>showAvailTab('teach'));
$("#tabGroup").addEventListener('click', ()=>showAvailTab('group'));

/* Ba≈ülangƒ±√ß */
bindTopTabs();
buildProgramGrid(true);
renderSlotLabels();
showTopTab('step1');
</script>

<script>
  function computeBranchTeacherCapacity(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const caps = Object.fromEntries(state.branches.map(b => [b, 0]));

  // neden: bran≈ü e≈üle≈üen her √∂ƒüretmenin t√ºm true h√ºcreleri ayrƒ± kapasitedir (e≈üzamanlƒ± sƒ±nƒ±flar)
  state.teachers.forEach(t => {
    const b = t.branch;
    const mat = state.availability.teachers[t.id] || [];
    for (let d = 0; d < D; d++){
      const row = mat[d] || [];
      for (let s = 0; s < S; s++){
        if (row[s] === true) caps[b] = (caps[b] || 0) + 1;
      }
    }
  });
  return caps;
}

// === Bran≈ü bazlƒ± toplam talepler (t√ºm gruplarƒ±n toplam talebi) ===
function computeBranchRequestsTotal(){
  const totals = Object.fromEntries(state.branches.map(b => [b, 0]));
  Object.values(state.requests || {}).forEach(reqByBranch => {
    state.branches.forEach(b => {
      totals[b] += +(reqByBranch?.[b] || 0);
    });
  });
  return totals;
}

// === Ba≈ülƒ±k altƒ± √∂zet rozetler: {bran≈ü}: Kalan/Toplam (Kalan = Kapasite - Talep) ===
// === Ba≈ülƒ±k altƒ± √∂zet rozetler: {bran≈ü}: Kalan/Toplam (Kalan = Kapasite - Talep) ===
function renderBranchChipsSummary(){
  const host = document.getElementById('branchChips');
  if(!host) return;
  host.innerHTML = '';

  const caps = computeBranchTeacherCapacity();
  const reqs = computeBranchRequestsTotal();

  state.branches.forEach(b => {
    const total = caps[b] || 0;
    const used = reqs[b] || 0;
    const left = Math.max(0, total - used);

    const chip = document.createElement('span');
    chip.className = 'pill' + (left <= 0 && total > 0 ? ' bad' : '');
    chip.textContent = `${b} ‚Äî ${left}/${total} m√ºsait`;
    host.appendChild(chip);
  });
}

</script>
<script>
/* ==== Baƒüƒ±msƒ±z: 7-8. sƒ±nƒ±flar full liste yazdƒ±r ==== */
(function injectPrintAllButton(){
  const host = document.querySelector('#step6 .row.no-print');
  if (!host || document.getElementById('btnPrintAll')) return;
  const btn = document.createElement('button');
  btn.id = 'btnPrintAll';
  btn.className = 'btn warn';
  btn.textContent = 'T√ºm listeyi yazdƒ±r';
  btn.addEventListener('click', printAll_7_8);
  host.appendChild(btn);
})();

/**
 * 7. ve 8. sƒ±nƒ±flarƒ± ayrƒ± sayfalarda, Pazartesi‚ÜíCuma ve ders slotlarƒ±yla kompakt tabloda yazdƒ±rƒ±r.
 * Neden: "Aynƒ± kaƒüƒ±tta olmasƒ±n" talebini garanti etmek i√ßin sayfa kƒ±rƒ±mƒ± uyguluyoruz.
 */
function printAll_7_8() {
  const hasAny = Array.isArray(state.assignments) && state.assignments.length > 0;
  if (!hasAny) { alert('Atama yok. √ñnce atama yapƒ±n.'); return; }

  const days   = state.program?.days || ["Pazartesi","Salƒ±","√áar≈üamba","Per≈üembe","Cuma"];
  const S      = +state.program?.slots || 8;
  const labels = Array.isArray(state.program?.slotLabels) ? state.program.slotLabels : [];

  const esc = s => String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');

  const byGrade = (grade) => Object.values(state.groups || {})
    .filter(g => (parseGroupName(g.name || g.id || '')?.grade === grade))
    .filter(g => state.assignments.some(a => a.group === g.id))
    .sort(groupComparator);

  const w = window.open('', '_blank');
  const css = `
    @page { size: A4; margin: 8mm; }
    * { box-sizing: border-box; }
    body { font: 11px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; color:#0a0a0a; }
    h1 { font-size: 16px; margin: 0 0 6px; text-align:center; font-weight:800; }
    h2 { font-size: 13px; margin: 8px 0 6px; font-weight:800; border-bottom:1px solid #ddd; padding-bottom:3px; }
    .grade-section + .grade-section { break-before: page; page-break-before: always; } /* 8. sƒ±nƒ±f yeni sayfa */
    .group-block { margin: 6px 0 10px; page-break-inside: avoid; }
    .g-head { font-weight:700; margin-bottom:4px; }
    .students { font-weight: 500; color:#374151; }
    table { width:100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border:1px solid #dcdcdc; padding: 2px 4px; vertical-align: top; }
    th { background:#f3f4f6; font-weight:700; text-align:center; }
    td.day { white-space:nowrap; font-weight:700; }
    .mini { font-size: 10px; color:#374151; }
    .tight th, .tight td { padding: 2px 4px; }
    .grade-badge { display:inline-block; padding:2px 8px; border-radius:8px; background:#eef2ff; color:#1e3a8a; font-weight:800; }
    .muted { color:#6b7280; }
    th,td { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  `;

  w.document.write(`<!DOCTYPE html><html lang="tr"><head>
    <meta charset="utf-8">
    <title>Fenomen √áocuk Kul√ºb√º birebir ve Grup Listesi</title>
    <style>${css}</style>
  </head><body>`);

  w.document.write(`<h1>Fenomen √áocuk Kul√ºb√º birebir ve Grup Listesi</h1>`);

  [7,8].forEach((grade, idx) => {
    const groups = byGrade(grade);
    if (groups.length === 0) return;

    w.document.write(`<section class="grade-section">`);
    w.document.write(`<h2><span class="grade-badge">${grade}. Sƒ±nƒ±flar</span></h2>`);

    groups.forEach(g => {
      const aForG = state.assignments.filter(a => a.group === g.id);
      const daysWith = Array.from(new Set(aForG.map(a => a.day))).sort((a,b)=>a-b);
      if (daysWith.length === 0) return;

      const studentNames = (state.students || [])
        .filter(s => s.group === g.id)
        .map(s => esc(s.name));

      w.document.write(`<div class="group-block">`);
      w.document.write(`<div class="g-head">${esc(g.name)} ‚Äî <span class="students">${studentNames.join(', ') || '<span class="muted">√∂ƒürenci yok</span>'}</span></div>`);

      let thead = `<tr><th style="width:90px">G√ºn / Saat</th>${
        Array.from({length:S}, (_,i)=>`<th>${esc(labels[i] || (String(i+1)+'. Ders'))}</th>`).join('')
      }</tr>`;

      let body = '';
      daysWith.forEach(d => {
        let row = `<tr><td class="day">${esc(days[d] || '')}</td>`;
        for (let s=0; s<S; s++) {
          const a = aForG.find(x => x.day === d && x.slot === s);
          if (a) {
            const tname = state.teachers.find(t => t.id === a.teacherId)?.name || '';
            row += `<td><div style="text-align:center"><b>${esc(a.branch)}</b><br><span class="mini">${esc(tname)}</span></div></td>`;
          } else {
            row += `<td></td>`;
          }
        }
        row += `</tr>`;
        body += row;
      });

      w.document.write(`<table class="tight"><thead>${thead}</thead><tbody>${body}</tbody></table>`);
      w.document.write(`</div>`);
    });

    w.document.write(`</section>`);
  });

  w.document.write(`</body></html>`);
  w.document.close();
  w.focus();
  setTimeout(() => { try { w.print(); } catch(_){} }, 50);
}
</script>

<script>
/* =========================================================
   PRINT: √ñƒüretmen V2 ‚Äî L√ºks Tasarƒ±m + 6 slot / sayfa kuralƒ±
   ========================================================= */

/* ==== BUTON EKLE ==== */
(function injectTeacherV2Btn(){
  const host = document.querySelector('#step6 .row.no-print') || document.querySelector('#step6') || document.body;
  if(!host || document.getElementById('btnTeacherV2')) return;
  const btn = document.createElement('button');
  btn.id = 'btnTeacherV2';
  btn.className = 'btn';
  btn.textContent = '√ñƒüretmene g√∂re (Yeni Tasarƒ±m)';
  btn.addEventListener('click', ()=> printTeachersV2());
  host.appendChild(btn);
})();

/* ==== YARDIMCILAR ==== */
function mmToPx(mm){
  const el = document.createElement('div');
  el.style.width='1mm'; el.style.position='absolute'; el.style.visibility='hidden';
  document.body.appendChild(el);
  const one = el.getBoundingClientRect().width || 3.78; el.remove();
  return one * mm;
}
function esc(s){
  return String(s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function getTeacherAssignmentsMap(){
  const map = new Map();
  (state.assignments || []).forEach(a=>{
    if(!map.has(a.teacherId)) map.set(a.teacherId, []);
    map.get(a.teacherId).push(a);
  });
  return map;
}
function groupBy(arr, keyFn){
  const m = new Map();
  arr.forEach(x=>{
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  });
  return m;
}
function uniq(arr){ return Array.from(new Set(arr)); }

/* ==== SAYFAYI A4'E SIƒûDIR ==== */
function fitPageToA4(rootEl){
  const A4H = 297, MARGIN = 12; // mm
  const usableH = mmToPx(A4H - 2*MARGIN);

  // Ba≈ülangƒ±√ß: y√ºkselt ‚Üí gerekiyorsa kƒ±s
  let font = 12.5, pad = 5;
  const MIN_F = 8, MAX_F = 13.5;
  const apply = ()=>{
    rootEl.style.setProperty('--tpv2-font', font+'px');
    rootEl.style.setProperty('--tpv2-pad', pad+'px');
    rootEl.style.setProperty('--tpv2-gap', Math.max(6, Math.round(font*0.75))+'px');
  };
  font = Math.min(MAX_F, font); pad = Math.max(2, Math.round(font*0.36)); apply();

  if(rootEl.scrollHeight > usableH){
    let guard = 50;
    while(rootEl.scrollHeight > usableH && font > MIN_F && guard--){
      font -= 0.5; pad = Math.max(1, Math.round(font*0.33)); apply();
    }
  }else{
    let guard = 20;
    while(rootEl.scrollHeight < usableH*0.96 && font < MAX_F && guard--){
      font += 0.5; pad = Math.max(2, Math.round(font*0.36)); apply();
      if(rootEl.scrollHeight > usableH){ font -= 0.5; pad = Math.max(1, Math.round(font*0.33)); apply(); break; }
    }
  }
}

/* ==== Yardƒ±m: veriler ==== */
const getGroup = id => (state.groups || {})[id] || { id, name:id };
const getTeacher = id => (state.teachers || []).find(t=>t.id===id) || { id, name:'-' };

/* ==== HTML √ºreticiler ==== */
function renderSchedTableForWindow(days, labels, byDay, S, start, end){
  const cols = [];
  for(let s=start; s<end; s++){
    const lab = esc(labels?.[s] || ((s+1)+'. Ders'));
    cols.push(`<th class="slot-head">${lab}</th>`);
  }
  const thead = `
    <thead>
      <tr>
        <th>G√ºn / Saat</th>
        ${cols.join('')}
      </tr>
    </thead>
  `;

  const bodyRows = days.map((dName, dIdx)=>{
    const list = byDay.get(dIdx) || [];
    const cells = [];
    for(let s=start; s<end; s++){
      const a = list.find(x=>x.slot===s);
      if(!a){ cells.push('<td></td>'); continue; }
      const g = getGroup(a.group);
      const br = esc(a.branch || '');
      const gname = esc(g.name || g.id);
      const room = g.room ? ` ‚Ä¢ ${esc(g.room)}` : '';
      cells.push(`<td><b>${gname}</b><small>${br}${room}</small></td>`);
    }
    return `<tr><td><b>${esc(dName)}</b></td>${cells.join('')}</tr>`;
  }).join('');

  return `<table class="sched">${thead}<tbody>${bodyRows}</tbody></table>`;
}

function renderAttendance(groups, ATT_HEADERS){
  if(groups.length===0) return '';
  const cards = groups.map(g=>{
    const students = (state.students || []).filter(s=>s.group===g.id);
    const rows = (students.length
      ? students.map(st=>`
        <tr>
          <td>${esc(st.name || '')}</td>
          ${ATT_HEADERS.map(()=>'<td>‚ñ°</td>').join('')}
        </tr>`).join('')
      : `<tr><td colspan="${1+ATT_HEADERS.length}" class="muted">√ñƒürenci yok</td></tr>`
    );
    return `
      <div class="att-card">
        <div class="g-title">${esc(g.name || g.id)}</div>
        <table class="att">
          <thead>
            <tr>
              <th style="width:46%">√ñƒürenci</th>
              ${ATT_HEADERS.map(h=>`<th>${esc(h)}</th>`).join('')}
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }).join('');
  return `
    <div class="att-head">√ñƒürenci Yoklama</div>
    <div class="att-grid">${cards}</div>
  `;
}

/* ==== YENƒ∞ TASARIM: √ñƒûRETMENE G√ñRE YAZDIR ==== */
function printTeachersV2(){
  const asgByTeacher = getTeacherAssignmentsMap();
  if(!asgByTeacher.size){
    alert('Atama yok. √ñnce atama yapƒ±n.');
    return;
  }

  const days = state.program?.days || ["Pazartesi","Salƒ±","√áar≈üamba","Per≈üembe","Cuma"];
  const S = Math.min(12, +state.program?.slots || 8); // 12‚Äôye kadar destek
  const labels = Array.isArray(state.program?.slotLabels)
    ? state.program.slotLabels
    : Array.from({length:S},(_,i)=> (i+1)+'. Ders');

  const ATT_HEADERS = ['Var','Yok','Ge√ß','ƒ∞zin'];

  const w = window.open('', '_blank');
  const baseCSS = Array.from(document.querySelectorAll('style')).map(s=>s.innerHTML).join('\n');

  w.document.write(`<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>√ñƒüretmen Yazdƒ±r (Yeni)</title>
  <style>${baseCSS}</style>
</head>
<body class="print-teacher-v2">
</body></html>`);

  const addPage = (html)=> w.document.body.insertAdjacentHTML('beforeend', `<section class="page">${html}</section>`);

  // === YENƒ∞: Toplam sayfa ve global sayfa sayacƒ± ===
  const windowsPerTeacher = Math.max(1, Math.ceil(S / 6));              // her √∂ƒüretmene d√º≈üen sayfa
  const totalPages = asgByTeacher.size * windowsPerTeacher;              // toplam sayfa
  let pageNo = 0;                                                        // global saya√ß

  asgByTeacher.forEach((asgList, tId)=>{
    const t = getTeacher(tId);
    const byDay = groupBy(asgList, a=>a.day);

    // Gruplarƒ±, √∂ƒüretmenin haftalƒ±k ders sƒ±rasƒ±na g√∂re sƒ±rala (Pazartesi 1. dersten Cuma 4. derse kadar)
    const groupFirstSlot = new Map();
    asgList.forEach(a => {
      const score = a.day * 100 + a.slot;
      const prev = groupFirstSlot.get(a.group);
      if (prev == null || score < prev) groupFirstSlot.set(a.group, score);
    });

    const groups = uniq(asgList.map(a=>a.group))
      .sort((g1, g2) => {
        const k1 = groupFirstSlot.get(g1) ?? 999999;
        const k2 = groupFirstSlot.get(g2) ?? 999999;
        if (k1 !== k2) return k1 - k2;
        const n1 = (state.groups?.[g1]?.name || g1);
        const n2 = (state.groups?.[g2]?.name || g2);
        return String(n1).localeCompare(String(n2), 'tr');
      })
      .map(getGroup);

    const windows = windowsPerTeacher;
    for(let wIx=0; wIx<windows; wIx++){
      const start = wIx*6;
      const end   = Math.min(start+6, S);

      const head = `
        <div class="brandbar">
          <div class="org">Fenomen √áocuk Kul√ºb√º</div>
          <div class="chip">${++pageNo}. Sayfa / ${totalPages}</div>
        </div>
        <div class="title">√ñƒüretmen Ders Planƒ±</div>
        <div class="t-meta">
          <div>${esc(t.name)}</div>
          ${t.branch ? `<div class="muted">‚Äî ${esc(t.branch)}</div>` : ''}
        </div>
      `;

      const sched = renderSchedTableForWindow(days, labels, byDay, S, start, end);

      // Yoklama: tek sayfa ise aynƒ± sayfada; iki sayfa ise 2. sayfada
      const showAttendanceHere = (windows === 1) || (windows > 1 && wIx === windows-1);
      const att = showAttendanceHere ? renderAttendance(groups, ATT_HEADERS) : '';

      const foot = `
        <div class="foot">
          <span class="muted">√ñƒüretmen: ${esc(t.name)}${t.branch?` ‚Ä¢ ${esc(t.branch)}`:''}</span>
        </div>
      `;

      addPage(`${head}${sched}${att}${foot}`);
    }
  });

  w.document.close();

  const onReady = ()=>{
    const pages = w.document.querySelectorAll('.print-teacher-v2 .page');
    pages.forEach(pg=> fitPageToA4(pg));
    try{ w.focus(); w.print(); }catch(_){}
  };
  if (w.document.readyState === 'complete') onReady();
  else w.addEventListener('load', onReady);
}

</script>

<!-- Firebase entegrasyonu: program, m√ºsaitlikler, talepler ve atamalar i√ßin kaydet/y√ºkle/sil i≈ülemleri -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getDatabase, ref, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

// Firebase yapƒ±landƒ±rmasƒ± (kullanƒ±cƒ± tarafƒ±ndan saƒülandƒ±)
const firebaseConfig = {
  apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
  authDomain: "odevfeno.firebaseapp.com",
  databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "odevfeno",
  storageBucket: "odevfeno.firebasestorage.app",
  messagingSenderId: "662757516934",
  appId: "1:662757516934:web:0042188832f63deb6fd307",
  measurementId: "G-4Q99NQRB38"
};

// Firebase ba≈ülatma
const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

// Veriyi Firebase Realtime Database'e kaydet
async function saveDataToFirebase(path, data) {
  try {
    await set(ref(db, path), data);
    alert('Firebase kaydedildi.');
  } catch (err) {
    alert('Firebase kayƒ±t hatasƒ±: ' + err.message);
  }
}

// Firebase'den veri y√ºkle
async function loadDataFromFirebase(path, callback) {
  try {
    const snapshot = await get(ref(db, path));
    if (snapshot.exists()) {
      callback(snapshot.val());
      alert('Firebase y√ºklendi.');
    } else {
      alert('Firebase kayƒ±t bulunamadƒ±.');
    }
  } catch (err) {
    alert('Firebase y√ºkleme hatasƒ±: ' + err.message);
  }
}

// Firebase'deki veriyi sil
async function deleteDataFromFirebase(path) {
  try {
    await remove(ref(db, path));
    alert('Firebase silindi.');
  } catch (err) {
    alert('Firebase silme hatasƒ±: ' + err.message);
  }
}

// Program i√ßin Firebase d√ºƒümeleri
const btnProgSaveFb = document.getElementById('btnProgSaveFb');
const btnProgLoadFb = document.getElementById('btnProgLoadFb');
const btnProgDeleteFb = document.getElementById('btnProgDeleteFb');
if (btnProgSaveFb) {
  btnProgSaveFb.addEventListener('click', () => {
    saveDataToFirebase('program', state.program);
  });
}
if (btnProgLoadFb) {
  btnProgLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('program', obj => {
      if (!obj || !Array.isArray(obj.days) || typeof obj.slots !== 'number') {
        alert('Ge√ßersiz program verisi.');
        return;
      }
      state.program = obj;
      if (!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
      document.getElementById('daysInput').value = obj.days.join(',');
      document.getElementById('slotsInput').value = obj.slots;
      buildProgramGrid(true);
      renderSlotLabels();
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
      renderAssignCards();
      refreshPrintFilters();
    });
  });
}
if (btnProgDeleteFb) {
  btnProgDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('program');
  });
}

// M√ºsaitlik i√ßin Firebase d√ºƒümeleri (√∂ƒüretmen paneli)
const btnAvailSaveFb = document.getElementById('btnAvailSaveFb');
const btnAvailLoadFb = document.getElementById('btnAvailLoadFb');
const btnAvailDeleteFb = document.getElementById('btnAvailDeleteFb');
if (btnAvailSaveFb) {
  btnAvailSaveFb.addEventListener('click', () => {
    saveDataToFirebase('availability', state.availability);
  });
}
if (btnAvailLoadFb) {
  btnAvailLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('availability', obj => {
      if (!obj || !obj.teachers || !obj.groups) {
        alert('Ge√ßersiz m√ºsaitlik verisi.');
        return;
      }
      state.availability = obj;
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
    });
  });
}
if (btnAvailDeleteFb) {
  btnAvailDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('availability');
  });
}

// M√ºsaitlik i√ßin Firebase d√ºƒümeleri (grup paneli) ‚Äì aynƒ± veriyi kullanƒ±r
const btnAvailSaveFb2 = document.getElementById('btnAvailSaveFb2');
const btnAvailLoadFb2 = document.getElementById('btnAvailLoadFb2');
const btnAvailDeleteFb2 = document.getElementById('btnAvailDeleteFb2');
if (btnAvailSaveFb2) {
  btnAvailSaveFb2.addEventListener('click', () => {
    saveDataToFirebase('availability', state.availability);
  });
}
if (btnAvailLoadFb2) {
  btnAvailLoadFb2.addEventListener('click', () => {
    loadDataFromFirebase('availability', obj => {
      if (!obj || !obj.teachers || !obj.groups) {
        alert('Ge√ßersiz m√ºsaitlik verisi.');
        return;
      }
      state.availability = obj;
      reconcileAllToProgram(getAssignPolicy());
      renderAvailGrids();
    });
  });
}
if (btnAvailDeleteFb2) {
  btnAvailDeleteFb2.addEventListener('click', () => {
    deleteDataFromFirebase('availability');
  });
}

// Talepler i√ßin Firebase d√ºƒümeleri
const btnReqSaveFb = document.getElementById('btnReqSaveFb');
const btnReqLoadFb = document.getElementById('btnReqLoadFb');
const btnReqDeleteFb = document.getElementById('btnReqDeleteFb');
if (btnReqSaveFb) {
  btnReqSaveFb.addEventListener('click', () => {
    saveDataToFirebase('requests', state.requests);
  });
}
if (btnReqLoadFb) {
  btnReqLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('requests', obj => {
      state.requests = obj || {};
      renderRequests();
    });
  });
}
if (btnReqDeleteFb) {
  btnReqDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('requests');
  });
}

// Atamalar i√ßin Firebase d√ºƒümeleri
const btnAssgnSaveFb = document.getElementById('btnAssgnSaveFb');
const btnAssgnLoadFb = document.getElementById('btnAssgnLoadFb');
const btnAssgnDeleteFb = document.getElementById('btnAssgnDeleteFb');
if (btnAssgnSaveFb) {
  btnAssgnSaveFb.addEventListener('click', () => {
    saveDataToFirebase('assignments', state.assignments);
  });
}
if (btnAssgnLoadFb) {
  btnAssgnLoadFb.addEventListener('click', () => {
    loadDataFromFirebase('assignments', obj => {
      state.assignments = Array.isArray(obj) ? obj : [];
      renderAssignCards();
    });
  });
}
if (btnAssgnDeleteFb) {
  btnAssgnDeleteFb.addEventListener('click', () => {
    deleteDataFromFirebase('assignments');
  });
}
</script>

</body>
</html>

